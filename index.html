<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂºÇÁïåËßÇÊµãÁ™óÂè£ v4.5</title>
    <!-- PWAÈÖçÁΩÆ -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FFB7B2">
    <meta name="description" content="‰∏Ä‰∏™Á•ûÁßòÁöÑÂºÇÁïåËßÇÊµãÂ∫îÁî®">
    <!-- iOSÊîØÊåÅ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ÂºÇÁïåÁ™óÂè£">
    <link rel="apple-touch-icon" href="https://file.icve.com.cn/file_doc/qdqqd/3081768742385572.jpg">
    <style>
        :root {
            --bg-color: #FFF0F5;
            --card-bg: #FFFFFF;
            --primary-pink: #FFB7B2;
            --primary-blue: #A2E1DB;
            --primary-purple: #CBAACB;
            --text-color: #6D6D6D;
            --accent-color: #FF9AA2;
            --border-radius: 24px;
        }

        @font-face {
            font-family: 'Handwriting';
            src: local('Courier New');
        }

        body {
            font-family: 'Nunito', 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: auto;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            padding: 10px;
            box-sizing: border-box;
        }

        #game-container {
            width: 100%;
            max-width: 380px;
            height: 92vh;
            max-height: 800px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: relative;
            border: 6px solid #fff;
            overflow: hidden;
            touch-action: pan-y pinch-zoom;
        }

        header {
            background: linear-gradient(90deg, var(--primary-pink), var(--accent-color));
            padding: 12px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            font-weight: bold;
            z-index: 10;
            flex-shrink: 0;
            touch-action: none;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #avatar-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        /* ËÉåÊôØÈÄâÊã©Âô® */
        #bg-selector {
            position: absolute;
            top: 15px;
            right: 60px;
            z-index: 10;
            background: white;
            border-radius: 15px;
            padding: 5px 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }

        #bg-selector-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
        }

        #room-view {
            flex: 1;
            background: linear-gradient(180deg, #E3FDFD 0%, #FFFFFF 100%);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 40px;
            overflow: hidden;
            transition: background 0.5s;
            touch-action: pan-y pinch-zoom;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .weather-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .sunny-effect {
            background: radial-gradient(circle at 30% 20%, rgba(255, 255, 200, 0.3) 0%, transparent 70%);
        }
        .rainy-effect {
            background: linear-gradient(to bottom, rgba(173, 216, 230, 0.1) 0%, transparent 30%);
        }
        .snowy-effect {
            background: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
        }
        .foggy-effect {
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
        }

        /* ÂèØÊãñÂä®ÁöÑÂ¥ΩÂ¥ΩÂÆπÂô® */
        #character-wrapper {
            position: absolute;
            z-index: 15;
            text-align: center;
            transition: transform 0.3s;
            cursor: grab;
            touch-action: none;
            user-select: none;
            left: 115px;
            top: 200px;
        }
        #character-wrapper:active {
            cursor: grabbing;
        }
        /* ÈÄèÊòéÂ§¥ÂÉèÊ°ÜÊ†∑Âºè */
        #zaizai-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: none; /* ÁßªÈô§ËæπÊ°Ü */
            box-shadow: none; /* ÁßªÈô§Èò¥ÂΩ± */
            background: transparent; /* ÈÄèÊòéËÉåÊôØ */
            pointer-events: none;
            /* Ê∑ªÂä†Ê∞îÊ≥°ÊïàÊûú */
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
            -webkit-mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 70%, rgba(0, 0, 0, 0.3) 85%, rgba(0, 0, 0, 0) 100%);
            mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 70%, rgba(0, 0, 0, 0.3) 85%, rgba(0, 0, 0, 0) 100%);
        }
		
        #touch-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            z-index: 20;
            cursor: pointer;
            touch-action: none;
            /* Ê∑ªÂä†Ê∞îÊ≥°ÊïàÊûú */
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 30%, transparent 70%);
        }
		/* Âú®ÂÖ®Â±èÊ®°Âºè‰∏≠‰πüÊ∑ªÂä†Ê∞îÊ≥°ÊïàÊûú */
		#fullscreen-zaizai {
		    position: relative;
		    margin-bottom: 40px;
		}
		
		#fullscreen-zaizai::before {
		    content: '';
		    position: absolute;
		    top: 50%;
		    left: 50%;
		    transform: translate(-50%, -50%);
		    width: 140px;
		    height: 140px;
		    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
		    border-radius: 50%;
		    z-index: -1;
		    animation: bubblePulse 3s infinite alternate;
		}
		@keyframes bubblePulse {
		    0% {
		        transform: translate(-50%, -50%) scale(1);
		        opacity: 0.2;
		    }
		    100% {
		        transform: translate(-50%, -50%) scale(1.1);
		        opacity: 0.3;
		    }
		}
		
        .pat-anim { animation: pat 0.3s; }
        @keyframes pat { 0% {transform: scale(1);} 50% {transform: scale(1.1, 0.9);} 100% {transform: scale(1);} }
        .poke-anim { animation: poke 0.3s; }
        @keyframes poke { 0% {transform: rotate(0);} 25% {transform: rotate(-10deg);} 75% {transform: rotate(10deg);} 100% {transform: rotate(0);} }
        .using-furniture { animation: furniture-use 2s ease-in-out; }
        @keyframes furniture-use { 
            0% { transform: scale(1); }
            25% { transform: scale(1.05); }
            50% { transform: scale(1); }
            75% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ‰øÆÊîπÂØπËØùÊ°ÜÊ∞îÊ≥°Ê†∑Âºè‰ª•ÂåπÈÖç */
        #bubble {
            position: absolute;
            top: -100px; 
            left: 50%; 
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); /* ÂçäÈÄèÊòéÁôΩËâ≤ËÉåÊôØ */
            backdrop-filter: blur(5px); /* ÊØõÁéªÁíÉÊïàÊûú */
            padding: 12px 16px;
            border-radius: 16px; 
            border-bottom-left-radius: 2px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-size: 13px; 
            color: #555; 
            width: 180px;
            opacity: 0; 
            pointer-events: none;
            transition: opacity 0.4s;
            z-index: 25;
            border: 1px solid rgba(255, 255, 255, 0.3); /* ÂçäÈÄèÊòéËæπÊ°Ü */
        }

        .room-item {
            position: absolute;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 10;
            touch-action: manipulation;
        }
        .room-item:active { transform: scale(0.9); }
        
        #diary-book { 
            bottom: 20px; left: 20px; font-size: 40px; 
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            animation: float 3s infinite ease-in-out;
            display: none;
        }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
        
        /* ‰øÆÂ§çÔºöÂàùÂßãÂè™ÊúâÁ™óÊà∑ÔºåÂéªÊéâÁªøÊ§ç */
        #window {
            top: 50px; left: 30px; font-size: 50px;
            color: #87CEEB;
        }
        #bed {
            bottom: 30px; right: 30px; font-size: 40px;
            color: #795548;
            display: none; /* ÂàùÂßã‰∏çÊòæÁ§∫Â∫ä */
        }

        #stats-bar {
            padding: 8px 15px; background: #fff;
            border-top: 1px solid #f5f5f5;
            display: flex; gap: 10px;
            flex-shrink: 0;
        }
        .stat-box { flex: 1; }
        .stat-label { font-size: 10px; color: #999; margin-bottom: 2px; display: block; }
        .progress-bg { background: #eee; height: 6px; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s; }

        /* ÂØºËà™ÊåâÈíÆ‰ºòÂåñ - Âõ∫ÂÆö5ÂàóÂ∏ÉÂ±Ä */
        nav {
            padding: 10px; background: #FAFAFA;
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }
        .nav-btn {
            background: white; 
            border: 1px solid #eee; 
            padding: 10px 5px;
            border-radius: 12px; 
            font-size: 10px; 
            text-align: center;
            color: var(--text-color); 
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50px;
            word-break: break-word;
            line-height: 1.3;
        }
        .nav-btn:active { 
            background: #f0f0f0; 
            transform: scale(0.95); 
        }
        .nav-btn-emoji {
            font-size: 16px;
            margin-bottom: 2px;
        }
        .nav-btn-text {
            font-size: 10px;
        }

        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
            display: none; justify-content: center; align-items: center;
            z-index: 100;
            padding: 15px;
            box-sizing: border-box;
        }
        .modal-content {
            background: white; width: 100%; max-width: 500px; max-height: 90vh;
            border-radius: 20px; padding: 25px;
            overflow-y: auto; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            animation: popUp 0.3s;
            box-sizing: border-box;
        }
        @keyframes popUp { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; color: #ccc; cursor: pointer; }

        #avatar-modal .modal-content {
            max-width: 350px;
        }
        /* Â§¥ÂÉèÈ¢ÑËßàÂÆπÂô®Ê∑ªÂä†Ê∞îÊ≥°ËÉåÊôØ */
        .avatar-preview-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }
        
        .avatar-preview-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            background: radial-gradient(circle, var(--primary-blue) 0%, transparent 70%);
            opacity: 0.2;
            border-radius: 50%;
            z-index: -1;
        }
		
        /* Â§¥ÂÉèÈ¢ÑËßàÊ†∑Âºè */
        #avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: none; /* ÁßªÈô§ËæπÊ°Ü */
            background: transparent; /* ÈÄèÊòéËÉåÊôØ */
            /* Ê∑ªÂä†Ê∞îÊ≥°ÊïàÊûú */
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
            -webkit-mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 70%, rgba(0, 0, 0, 0.3) 85%, rgba(0, 0, 0, 0) 100%);
            mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 70%, rgba(0, 0, 0, 0.3) 85%, rgba(0, 0, 0, 0) 100%);
        }
        
        /* ÂÖ®Â±èÊ®°ÂºèÂ§¥ÂÉèÊ†∑Âºè */
        #fullscreen-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none; /* ÁßªÈô§ËæπÊ°Ü */
            cursor: pointer;
            /* Ê∑ªÂä†Ê∞îÊ≥°ÊïàÊûú */
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
            -webkit-mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 70%, rgba(0, 0, 0, 0.3) 85%, rgba(0, 0, 0, 0) 100%);
            mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 70%, rgba(0, 0, 0, 0.3) 85%, rgba(0, 0, 0, 0) 100%);
            background: transparent; /* ÈÄèÊòéËÉåÊôØ */
        }
		
        .avatar-upload-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            display: block;
            margin: 0 auto 15px;
            text-align: center;
            width: 80%;
        }
        .avatar-hint {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }
        #avatar-upload-input {
            display: none;
        }

        /* ÂèØÈÄâÔºö‰∏∫ÈÄèÊòéÂõæÁâáÊ∑ªÂä†Êõ¥ÊòéÊòæÁöÑÊ∞îÊ≥°ÊïàÊûú */
        .transparent-avatar-effect {
            position: relative;
        }
        
        .transparent-avatar-effect::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 30%,
                rgba(255, 255, 255, 0.02) 60%,
                transparent 80%);
            pointer-events: none;
        }
		
        /* ËÉåÊôØÈÄâÊã©Ê†∑Âºè */
        #bg-modal .modal-content {
            max-width: 350px;
        }
        .bg-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .bg-item {
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .bg-item:hover {
            transform: scale(1.05);
            border-color: var(--primary-pink);
        }
        .bg-item.active {
            border-color: var(--primary-blue);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .bg-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .bg-name {
            text-align: center;
            font-size: 11px;
            margin-top: 5px;
            color: #666;
        }
        .bg-upload-container {
            margin-top: 20px;
            text-align: center;
        }
        #bg-upload-input {
            display: none;
        }
        .bg-upload-btn {
            background: var(--primary-purple);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
        }

        #task-list-modal .modal-content {
            max-width: 350px;
        }
        .task-item {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-info {
            flex: 1;
        }
        .task-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        .task-desc {
            font-size: 12px;
            color: #888;
        }
        .task-reward {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: #FF9800;
        }
        .task-btn {
            background: var(--primary-blue);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }
        .task-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .task-progress {
            width: 100%;
            height: 4px;
            background: #eee;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        .task-progress-fill {
            height: 100%;
            background: var(--primary-pink);
            transition: width 0.3s;
        }

        .diary-paper {
            background-color: #fffcf5;
            background-image: linear-gradient(#e6e6e6 1px, transparent 1px);
            background-size: 100% 25px;
            font-family: 'Handwriting', monospace;
            line-height: 25px;
            color: #444;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 5px 5px 10px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            transition: transform 0.3s;
        }
        .diary-paper:hover {
            transform: translateY(-2px);
            box-shadow: 5px 7px 12px rgba(0,0,0,0.08);
        }
        .diary-date { 
            color: var(--accent-color); 
            font-weight: bold; 
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .diary-mood {
            font-size: 0.8em;
            color: #888;
            font-style: italic;
        }

        #story-modal .modal-content { 
            border: 4px solid var(--primary-pink); 
            text-align: center; 
            max-width: 320px;
        }
        .story-chapter { 
            font-size: 12px; 
            color: var(--primary-pink); 
            letter-spacing: 2px; 
            margin-bottom: 10px;
            font-weight: bold;
        }
        .story-text { 
            font-size: 14px; 
            line-height: 1.6; 
            text-align: left; 
            margin: 15px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        .story-choice {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .story-btn {
            background: var(--primary-purple);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .story-btn:hover {
            background: var(--primary-pink);
            transform: translateY(-2px);
        }

        #toast {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(50,50,50,0.9); color: white; padding: 8px 16px;
            border-radius: 20px; font-size: 12px; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 200; white-space: nowrap;
            text-align: center;
            max-width: 90%;
        }

        .item-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 10px 0; 
            border-bottom: 1px dashed #eee; 
            font-size: 13px; 
            align-items: center;
        }
        .btn-action { 
            background: var(--primary-blue); 
            border: none; 
            color: white; 
            padding: 4px 10px; 
            border-radius: 15px; 
            font-size: 11px; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        .btn-action:hover { transform: scale(1.05); }
        .btn-action:active { transform: scale(0.95); }
        .btn-secondary {
            background: var(--primary-purple);
        }
        .btn-warning {
            background: #FF9800;
        }

        #task-modal .modal-content {
            max-width: 350px;
        }
        .schedule-item {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-blue);
        }
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .schedule-title {
            font-weight: bold;
            color: #555;
        }
        .schedule-time {
            font-size: 11px;
            color: #888;
            background: #fff;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .schedule-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .schedule-effects {
            display: flex;
            gap: 10px;
            font-size: 11px;
            color: #777;
        }
        .effect-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        #room-shop-modal .modal-content {
            max-width: 350px;
        }
        .furniture-item {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #8BC34A;
        }
        .furniture-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .furniture-title {
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        .furniture-price {
            font-size: 12px;
            color: #FF9800;
            font-weight: bold;
        }
        .furniture-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        .furniture-effect {
            font-size: 11px;
            color: #4CAF50;
            font-style: italic;
        }
        .furniture-owned {
            font-size: 10px;
            color: #888;
            margin-top: 5px;
        }

        #chat-modal .modal-content {
            max-width: 350px;
        }
        .chat-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 5px;
        }
        .chat-message {
            margin-bottom: 12px;
            clear: both;
        }
        .user-message {
            text-align: right;
        }
        .zaizai-message {
            text-align: left;
        }
        .message-bubble {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-bubble {
            background: var(--primary-blue);
            color: white;
            border-bottom-right-radius: 5px;
        }
        .zaizai-bubble {
            background: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 5px;
        }
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        #chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 13px;
            outline: none;
        }
        #send-chat-btn {
            background: var(--primary-pink);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
        }

        .item-unlocked {
            animation: unlockPulse 2s infinite;
        }
        @keyframes unlockPulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 154, 162, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 154, 162, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 154, 162, 0); }
        }
        .locked-item {
            opacity: 0.6;
            filter: grayscale(0.7);
            position: relative;
        }
        .lock-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            color: #ccc;
            font-size: 14px;
        }
        .unlock-condition {
            font-size: 10px;
            color: #FF9800;
            margin-top: 3px;
        }

        #memo-modal .modal-content {
            max-width: 350px;
        }
        .memo-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        #memo-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--primary-blue);
            border-radius: 15px;
            font-size: 13px;
            outline: none;
        }
        #add-memo-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
        }
        .memo-item {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--primary-blue);
            transition: all 0.2s;
        }
        .memo-item.completed {
            opacity: 0.6;
            border-left-color: #ccc;
        }
        .memo-content {
            flex: 1;
            font-size: 13px;
            color: #555;
            padding-right: 10px;
            word-break: break-word;
        }
        .memo-completed {
            font-size: 11px;
            color: #4CAF50;
            margin-left: 10px;
        }
        .memo-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
        .memo-action-btn {
            background: var(--primary-pink);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 11px;
            cursor: pointer;
            min-width: 50px;
            touch-action: manipulation;
        }
        .memo-action-btn.complete {
            background: #4CAF50;
        }
        .memo-action-btn.delete {
            background: #FF5252;
        }
        .empty-memo {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 13px;
        }

        .mood-indicator {
            position: absolute;
            top: 80px;
            right: 15px;
            z-index: 10;
            background: white;
            border-radius: 15px;
            padding: 5px 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #666;
        }
        .mood-emoji {
            font-size: 14px;
        }
        .mood-text {
            font-weight: bold;
        }

        #record-modal .modal-content {
            max-width: 380px;
            max-height: 85%;
        }
        .record-item {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-purple);
        }
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .record-title {
            font-weight: bold;
            color: #555;
            font-size: 13px;
        }
        .record-time {
            font-size: 10px;
            color: #888;
            background: #fff;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .record-content {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        .record-tag {
            display: inline-block;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 5px;
            margin-top: 5px;
        }
        .tag-trust { background: #FFE0E0; color: #FF5252; }
        .tag-mood { background: #E0F7FA; color: #00ACC1; }
        .tag-event { background: #F3E5F5; color: #8E24AA; }
        .tag-story { background: #E8F5E8; color: #4CAF50; }
        
        #game-select-modal .modal-content {
            max-width: 350px;
        }
        .game-item {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .game-item:hover {
            transform: translateY(-5px);
            border-color: var(--primary-blue);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .game-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        .game-title {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }
        .game-desc {
            font-size: 12px;
            color: #777;
            margin-bottom: 10px;
        }
        .game-reward {
            font-size: 11px;
            color: #FF9800;
            font-weight: bold;
        }
        
        /* ‰øÆÂ§ç2048Ê∏∏ÊàèÊ†∑Âºè - Á°Æ‰øùÊï∞Â≠óÂùóÂáÜÁ°ÆÂÆö‰Ωç */
        .game2048-container {
            text-align: center;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .game2048-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            width: 100%;
            max-width: 100%;
        }
        .game2048-score {
            font-weight: bold;
            color: #FF9800;
            font-size: 18px;
        }
        .game2048-grid {
            width: 90vw;
            max-width: 320px;
            height: 90vw;
            max-height: 320px;
            margin: 0 auto;
            background: #bbada0;
            border-radius: 6px;
            padding: 10px;
            position: relative;
            display: block;
            touch-action: none;
            box-sizing: border-box;
        }
        .game2048-cell {
            background: rgba(238, 228, 218, 0.35);
            border-radius: 3px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 0; /* ÈöêËóèÊï∞Â≠ó */
        }
        /* ‰øÆÂ§çÊï∞Â≠óÂùóÂÆö‰Ωç */
        .game2048-tile {
            position: absolute;
            width: calc(25% - 1px);
            height: calc(25% - 1px);
            border-radius: 3px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 24px;
            transition: all 0.15s;
            z-index: 10;
            box-sizing: border-box;
        }
        .tile-2 { background: #eee4da; color: #776e65; }
        .tile-4 { background: #ede0c8; color: #776e65; }
        .tile-8 { background: #f2b179; color: #f9f6f2; }
        .tile-16 { background: #f59563; color: #f9f6f2; }
        .tile-32 { background: #f67c5f; color: #f9f6f2; }
        .tile-64 { background: #f65e3b; color: #f9f6f2; }
        .tile-128 { background: #edcf72; color: #f9f6f2; font-size: 20px; }
        .tile-256 { background: #edcc61; color: #f9f6f2; font-size: 20px; }
        .tile-512 { background: #edc850; color: #f9f6f2; font-size: 20px; }
        .tile-1024 { background: #edc53f; color: #f9f6f2; font-size: 18px; }
        .tile-2048 { background: #edc22e; color: #f9f6f2; font-size: 18px; }
        

        
        /* ÊâìÁ†ñÂùóÊ∏∏ÊàèÊ†∑Âºè */
        .brickbreaker-container {
            text-align: center;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .brickbreaker-canvas {
            border: 2px solid #333;
            border-radius: 5px;
            background: #000;
            margin: 10px auto;
            display: block;
            touch-action: none;
            max-width: 100%;
            box-sizing: border-box;
        }
        .brickbreaker-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            width: 100%;
            max-width: 100%;
        }
        .brickbreaker-score {
            font-weight: bold;
            color: #FF9800;
        }
        
        .brickbreaker-touch-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 0 15px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        .brickbreaker-touch-btn {
            width: 80px;
            height: 80px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: white;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            position: relative;
            box-sizing: border-box;
        }
        .brickbreaker-touch-btn:active {
            background: rgba(0, 0, 0, 0.5);
        }
        
        /* ‰øÑÁΩóÊñØÊñπÂùóÊ∏∏ÊàèÊ†∑Âºè */
        .tetris-container {
            text-align: center;
	padding-bottom: 10px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .tetris-canvas {
            border: 2px solid #333;
            border-radius: 5px;
            background: #000;
            margin: 10px auto;
            display: block;
            touch-action: none;
            max-width: 100%;
            box-sizing: border-box;
        }
        .tetris-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            width: 100%;
            max-width: 100%;
        }
        .tetris-score {
            font-weight: bold;
            color: #FF9800;
        }
        
        .tetris-touch-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-top: 15px;
            width: 100%;
            max-width: 100%;
        }
        .tetris-touch-btn {
            width: 70px;
            height: 70px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: white;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            position: relative;
            box-sizing: border-box;
        }
        .tetris-touch-btn:active {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
        }
        .tetris-touch-btn.up { grid-area: up; }
        .tetris-touch-btn.down { grid-area: down; }
        .tetris-touch-btn.left { grid-area: left; }
        .tetris-touch-btn.right { grid-area: right; }
        
        .tetris-touch-btn.fast-drop {
            grid-area: fast-drop;
            width: 100px;
            font-size: 14px;
        }
        
        .game-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        .game-back-btn {
            background: var(--primary-purple);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            touch-action: manipulation;
        }
        .game-restart-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            touch-action: manipulation;
        }
        .game-back-btn:active, .game-restart-btn:active {
            transform: scale(0.95);
        }

        /* Áï™ËåÑÈíüÊ†∑Âºè */
        #pomodoro-modal .modal-content {
            max-width: 320px;
        }
        
        #pomodoro-fullscreen {
            background: rgba(0,0,0,0.95);
        }
        
        #pomodoro-fullscreen .modal-content {
            background: transparent;
            box-shadow: none;
            max-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        @media (max-height: 700px) {
            #game-container {
                height: 95vh;
                max-height: none;
            }
            #room-view {
                padding-bottom: 20px;
            }
            #zaizai-img {
                width: 120px;
                height: 120px;
            }
            nav {
                padding: 8px;
            }
            .nav-btn {
                min-height: 45px;
                padding: 8px 4px;
            }
        }

        /* ‰øÆÂ§çÂ∞èÊ∏∏ÊàèÂú®ÊâãÊú∫‰∏äÁöÑÈÄÇÈÖçÈóÆÈ¢ò */
        @media (max-width: 380px) and (max-height: 700px) {
            /* 2048Ê∏∏ÊàèÈÄÇÈÖç - ‰øÆÂ§çÊï∞Â≠óÂùó‰ΩçÁΩÆ */
            .game2048-grid {
                width: 250px !important;
                height: 250px !important;
                padding: 8px !important;
            }
            .game2048-tile {
                font-size: 18px !important;
            }
            .game2048-cell {
                font-size: 18px !important;
            }

            
            /* ÊâìÁ†ñÂùóÊ∏∏ÊàèÈÄÇÈÖç */
            .brickbreaker-canvas {
                width: 260px !important;
                height: 346px !important;
            }
            .brickbreaker-touch-btn {
                width: 60px !important;
                height: 60px !important;
                font-size: 20px !important;
            }
            
            /* ‰øÑÁΩóÊñØÊñπÂùóÊ∏∏ÊàèÈÄÇÈÖç */
            .tetris-canvas {
                width: 160px !important;
                height: 320px !important;
            }
            .tetris-touch-btn {
                width: 50px !important;
                height: 50px !important;
                font-size: 20px !important;
            }
            .tetris-touch-btn.rotate {
                width: 80px !important;
                font-size: 16px !important;
            }
            .tetris-touch-btn.fast-drop {
                width: 80px !important;
                font-size: 12px !important;
            }
            
            /* Ê∏∏ÊàèÂÆπÂô®ÈÄÇÈÖç */
            .game2048-container,
            .brickbreaker-container,
            .tetris-container {
                transform: scale(0.9);
                transform-origin: top center;
            }
            
            /* Ê∏∏ÊàèÊéßÂà∂ÊåâÈíÆÈÄÇÈÖç */
            .game-controls {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            .game-back-btn,
            .game-restart-btn {
                width: 100%;
                max-width: 200px;
                padding: 10px 20px;
            }
        }
        
        /* Ëß¶Êë∏ÊéßÂà∂‰ºòÂåñ */
        .brickbreaker-touch-btn:active,
        .tetris-touch-btn:active {
            background: var(--primary-purple) !important;
            transform: scale(0.9) !important;
        }
        
        /* Èò≤Ê≠¢ÁÇπÂáªÁ©øÈÄè */
        .brickbreaker-touch-btn,
        .tetris-touch-btn {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* PWAÊ∑ªÂä†Âà∞Ê°åÈù¢ÊåâÈíÆÊ†∑Âºè */
        #install-pwa-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--primary-pink), var(--accent-color));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 183, 178, 0.4);
            z-index: 1000;
            display: none;
            transition: all 0.3s ease;
        }
        
        #install-pwa-btn:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 183, 178, 0.6);
        }
        
        #install-pwa-btn:active {
            transform: translateX(-50%) translateY(0);
            box-shadow: 0 2px 10px rgba(255, 183, 178, 0.4);
        }
        
        /* PWAÂÆâË£ÖÊèêÁ§∫Ê®°ÊÄÅÊ°Ü */
        #pwa-install-modal {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .pwa-install-content {
            text-align: center;
            padding: 30px 20px;
        }
        
        .pwa-install-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .pwa-install-title {
            font-size: 18px;
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
        }
        
        .pwa-install-desc {
            font-size: 14px;
            color: #777;
            margin-bottom: 30px;
        }
        
        .pwa-install-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        /* Ê∏∏ÊàèÂÖ®Â±èÈÄÇÈÖç */
        @media (min-width: 768px) {
            /* Âπ≥ÊùøÂíåÊ°åÈù¢ËÆæÂ§áÈÄÇÈÖç */
            .brickbreaker-canvas {
                max-width: 400px;
                max-height: 533px;
            }
            
            .tetris-canvas {
                max-width: 240px;
                max-height: 480px;
            }
            
            /* Â¢ûÂ§ßÊéßÂà∂ÊåâÈíÆ */
            .brickbreaker-touch-btn,
            .tetris-touch-btn {
                width: 80px;
                height: 80px;
                font-size: 32px;
            }
        }
        
        @media (min-width: 1024px) {
            /* Â§ßÂ±èÂπïËÆæÂ§áÈÄÇÈÖç */
            .game2048-container,
            .brickbreaker-container,
            .tetris-container {
                transform: scale(1.2);
                margin: 20px 0;
            }
            
            .brickbreaker-canvas {
                max-width: 480px;
                max-height: 640px;
            }
            
            .tetris-canvas {
                max-width: 280px;
                max-height: 560px;
            }
        }
        
        /* Ê®™Á´ñÂ±èÈÄÇÈÖç */
        @media (orientation: landscape) {
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .game2048-container,
            .brickbreaker-container,
            .tetris-container {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 20px;
            }
            
            .brickbreaker-canvas {
                width: 50vw !important;
                max-width: 500px;
                height: auto !important;
                aspect-ratio: 3/4;
            }
        }
        
        /* Â∞èÂ±èÂπïÊâãÊú∫ÈÄÇÈÖç */
        @media (max-width: 320px) {
            nav {
                grid-template-columns: repeat(3, 1fr) !important;
                grid-template-rows: repeat(3, 1fr) !important;
            }
            
            .nav-btn {
                font-size: 9px !important;
                padding: 6px 3px !important;
            }
            
            /* ‰øÆÂ§ç2048Âú®Â∞èÂ±èÂπï‰∏äÁöÑ‰ΩçÁΩÆ */
            .game2048-grid {
                width: 240px !important;
                height: 240px !important;
                padding: 6px !important;
            }
            .game2048-tile {
                font-size: 16px !important;
            }
            
            .brickbreaker-canvas {
                width: 240px !important;
                height: 320px !important;
            }
            
            .tetris-canvas {
                width: 140px !important;
                height: 280px !important;
            }
            
            .modal-content {
                padding: 15px !important;
            }
        }
    </style>
</head>
<body>

<div id="game-container">
    <header>
        <div class="header-left">
            <button id="avatar-btn" onclick="openModal('avatar-modal')">üë§</button>
            <div id="day-display">Day 1</div>
        </div>
        <div id="money-display">üí∞ 0</div>
    </header>

    <!-- ËÉåÊôØÈÄâÊã©Âô® -->
    <div id="bg-selector" onclick="openModal('bg-modal')">
        <span>üé® ËÉåÊôØ</span>
    </div>

    <!-- Â§©Ê∞îÊïàÊûúÂ±Ç -->
    <div id="weather-effect" class="weather-effect"></div>

    <!-- ÂøÉÊÉÖÊåáÁ§∫Âô® -->
    <div id="mood-indicator" class="mood-indicator" style="display: none;">
        <span class="mood-emoji" id="mood-emoji">üò∞</span>
        <span class="mood-text" id="mood-text">Ë≠¶ÊÉï</span>
    </div>

    <div id="room-view">
        <!-- Âü∫Á°ÄÊàøÈó¥Áâ©ÂìÅ - ‰øÆÂ§çÔºöÂàùÂßãÂè™ÊúâÁ™óÊà∑ -->
        <div class="room-item" id="window" title="Á™óÊà∑" onclick="interactWithWindow()">ü™ü</div>
        
        <!-- Âä®ÊÄÅÁîüÊàêÁöÑÂÆ∂ÂÖ∑ -->
        <div id="furniture-container"></div>
        
        <!-- Êó•ËÆ∞Êú¨ÂÖ•Âè£ -->
        <div class="room-item" id="diary-book" onclick="openDiary()" title="ÂÅ∑ÁúãÊó•ËÆ∞">üìî</div>
        
        <!-- ÂèØÊãñÂä®ÁöÑÂ¥ΩÂ¥Ω -->
        <div id="character-wrapper">
            <div id="bubble">...</div>
            <img id="zaizai-img" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='150' height='150'><rect width='150' height='150' fill='%23ffdfbf' rx='75'/><text x='50%' y='55%' font-size='80' text-anchor='middle' dy='.3em'>üê±</text></svg>" alt="Â¥ΩÂ¥Ω">
            <!-- Ëß¶Êë∏‰∫§‰∫íÂå∫Âüü -->
            <div id="touch-area"></div>
        </div>
    </div>

    <div id="stats-bar">
        <div class="stat-box">
            <span class="stat-label">È•±ËÖπÊÑü</span>
            <div class="progress-bg"><div class="progress-fill" id="hunger-bar" style="width:50%; background:#FFD166"></div></div>
        </div>
        <div class="stat-box">
            <span class="stat-label">‰ø°‰ªªÂÄº (Trust)</span>
            <div class="progress-bg"><div class="progress-fill" id="trust-bar" style="width:0%; background:var(--accent-color)"></div></div>
        </div>
    </div>

    <!-- ‰ºòÂåñÂêéÁöÑÂØºËà™ÊåâÈíÆÂ∏ÉÂ±Ä -->
    <nav>
        <div class="nav-btn" onclick="openModal('shop-modal'); renderShop()">
            <div class="nav-btn-emoji">üè™</div>
            <div class="nav-btn-text">Ë°•Áªô</div>
        </div>
        <div class="nav-btn" onclick="openModal('room-shop-modal'); renderRoomShop()">
            <div class="nav-btn-emoji">üõãÔ∏è</div>
            <div class="nav-btn-text">ÊîπÈÄ†</div>
        </div>
        <div class="nav-btn" onclick="openModal('task-modal')">
            <div class="nav-btn-emoji">üìÖ</div>
            <div class="nav-btn-text">Êó•Á®ã</div>
        </div>
        <div class="nav-btn" onclick="openModal('task-list-modal')">
            <div class="nav-btn-emoji">üìã</div>
            <div class="nav-btn-text">‰ªªÂä°</div>
        </div>
        <div class="nav-btn" onclick="openModal('game-select-modal')">
            <div class="nav-btn-emoji">üéÆ</div>
            <div class="nav-btn-text">Â∞èÊ∏∏Êàè</div>
        </div>
        <div class="nav-btn" onclick="openModal('record-modal')">
            <div class="nav-btn-emoji">üìä</div>
            <div class="nav-btn-text">ËÆ∞ÂΩï</div>
        </div>
        <div class="nav-btn" onclick="openModal('chat-modal')">
            <div class="nav-btn-emoji">üí¨</div>
            <div class="nav-btn-text">ÂØπËØù</div>
        </div>
        <div class="nav-btn" onclick="openModal('memo-modal')">
            <div class="nav-btn-emoji">üìù</div>
            <div class="nav-btn-text">Â§áÂøòÂΩï</div>
        </div>
        <div class="nav-btn" onclick="openModal('bag-modal'); renderBag()">
            <div class="nav-btn-emoji">üéí</div>
            <div class="nav-btn-text">ËÉåÂåÖ</div>
        </div>
        <div class="nav-btn" onclick="openPomodoro()">
            <div class="nav-btn-emoji">üçÖ</div>
            <div class="nav-btn-text">Áï™ËåÑÈíü</div>
        </div>
    </nav>

    <div id="toast">ÊèêÁ§∫‰ø°ÊÅØ</div>

    <!-- Ëá™ÂÆö‰πâÂ§¥ÂÉèÊ®°ÊÄÅÊ°Ü -->
    <div id="avatar-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('avatar-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">Ëá™ÂÆö‰πâÂ¥ΩÂ¥ΩÂ§¥ÂÉè</h3>
            
            <div class="avatar-preview-container">
                <img id="avatar-preview" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='150' height='150'><rect width='150' height='150' fill='%23ffdfbf' rx='75'/><text x='50%' y='55%' font-size='80' text-anchor='middle' dy='.3em'>üê±</text></svg>" alt="Â§¥ÂÉèÈ¢ÑËßà">
            </div>
            
            <input type="file" id="avatar-upload-input" accept="image/*">
            <button class="avatar-upload-btn" onclick="document.getElementById('avatar-upload-input').click()">
                ÈÄâÊã©ÂõæÁâá‰∏ä‰º†
            </button>
            
            <!-- Âú® avatar-modal ‰∏≠‰øÆÊîπÊèêÁ§∫‰ø°ÊÅØ -->
            <p class="avatar-hint">ÊîØÊåÅ JPG„ÄÅPNG Ê†ºÂºèÔºåÂª∫ËÆÆ‰ΩøÁî®ÈÄèÊòéËÉåÊôØÁöÑPNGÂõæÁâáÊïàÊûúÊúÄ‰Ω≥</p>
            
            <div style="text-align:center; margin-top:20px;">
                <button class="btn-action" onclick="applyCustomAvatar()" style="padding:8px 20px;">Â∫îÁî®Â§¥ÂÉè</button>
            </div>
        </div>
    </div>

    <!-- ËÉåÊôØÈÄâÊã©Ê®°ÊÄÅÊ°Ü -->
    <div id="bg-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('bg-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">ÈÄâÊã©ÊàøÈó¥ËÉåÊôØ</h3>
            
            <div class="bg-grid" id="bg-grid"></div>
            
            <div class="bg-upload-container">
                <input type="file" id="bg-upload-input" accept="image/*">
                <button class="bg-upload-btn" onclick="document.getElementById('bg-upload-input').click()">
                    ‰∏ä‰º†Ëá™ÂÆö‰πâËÉåÊôØ
                </button>
                <p style="font-size:10px; color:#999; margin-top:5px;">ÊîØÊåÅJPG„ÄÅPNGÊ†ºÂºèÔºåÂª∫ËÆÆÂ∞∫ÂØ∏380√ó600px</p>
            </div>
        </div>
    </div>

    <!-- ÊàøÈó¥ÊîπÈÄ†ÂïÜÂ∫ó -->
    <div id="room-shop-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('room-shop-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">ÊàøÈó¥ÊîπÈÄ†ÂïÜÂ∫ó</h3>
            <p style="font-size:12px; color:#999; text-align:center">Ë¥≠‰π∞ÂÆ∂ÂÖ∑ËÆ©ÊàøÈó¥Êõ¥Ê∏©È¶®</p>
            <div id="room-shop-list"></div>
        </div>
    </div>

    <!-- ÂØπËØùÊ®°ÊÄÅÊ°Ü -->
    <div id="chat-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('chat-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">‰∏éÂ¥ΩÂ¥ΩÂØπËØù</h3>
            <div class="chat-container" id="chat-container"></div>
            <div class="chat-input-container">
                <input type="text" id="chat-input" placeholder="ËæìÂÖ•ÊÉ≥ËØ¥ÁöÑËØù..." maxlength="50">
                <button id="send-chat-btn" onclick="sendChat()">ÂèëÈÄÅ</button>
            </div>
            <p style="font-size:10px; color:#999; text-align:center; margin-top:10px;">
                ‰ø°‰ªªÂÄºË∂äÈ´òÔºåÂ¥ΩÂ¥ΩË∂äÊÑøÊÑè‰∏é‰Ω†‰∫§ÊµÅ
            </p>
        </div>
    </div>

    <!-- ‰ªªÂä°ÂàóË°®Ê®°ÊÄÅÊ°Ü -->
    <div id="task-list-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('task-list-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">ÊØèÊó•‰ªªÂä°</h3>
            <p style="font-size:12px; color:#999; text-align:center">ÂÆåÊàêÊó•Â∏∏‰ªªÂä°Ëé∑ÂèñÈáëÂ∏Å</p>
            <div id="task-list"></div>
            <div style="text-align:center; margin-top:20px; font-size:12px; color:#777;">
                ÊØèÊó•‰ªªÂä°Â∞ÜÂú®24Â∞èÊó∂ÂêéÂà∑Êñ∞
            </div>
        </div>
    </div>

    <!-- Â§áÂøòÂΩïÊ®°Âùó -->
    <div id="memo-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('memo-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">ÊàëÁöÑÂ§áÂøòÂΩï</h3>
            <div class="memo-input-container">
                <input type="text" id="memo-input" placeholder="Ê∑ªÂä†ÂæÖÂäû‰∫ãÈ°π..." maxlength="100">
                <button id="add-memo-btn" onclick="addMemo()">Ê∑ªÂä†</button>
            </div>
            <div id="memo-list"></div>
            <p style="font-size:10px; color:#999; text-align:center; margin-top:15px;">
                Â¥ΩÂ¥Ω‰ºöÁúãÂà∞Â§áÂøòÂΩïÂÜÖÂÆπÂπ∂ÂÅöÂá∫ÂèçÂ∫î
            </p>
        </div>
    </div>

    <!-- Êó•Á®ãÊ®°Âùó -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('task-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">Â¥ΩÂ¥ΩÁöÑÊó•Á®ã</h3>
            <p style="font-size:12px; color:#999; text-align:center; margin-bottom:20px;">ÈÄâÊã©Ë°åÂä®‰ºöÂΩ±Âìç‰∏ñÁïåÁ∫ø</p>
            
            <div class="schedule-item">
                <div class="schedule-header">
                    <span class="schedule-title">ÊâìÊâ´ÊàøÈó¥</span>
                    <span class="schedule-time">1Â∞èÊó∂</span>
                </div>
                <div class="schedule-desc">Â¥ΩÂ¥Ω‰ºöËÆ§ÁúüÊâìÊâ´ÊàøÈó¥Ôºå‰øùÊåÅÁéØÂ¢ÉÊï¥Ê¥Å</div>
                <div class="schedule-effects">
                    <div class="effect-item">üí∞ +20</div>
                    <div class="effect-item">üçΩÔ∏è -5</div>
                </div>
                <button class="btn-action" style="width:100%; margin-top:10px;" onclick="doSchedule('clean', 20, 1)">ÂºÄÂßãË°åÂä®</button>
            </div>
            
            <div class="schedule-item">
                <div class="schedule-header">
                    <span class="schedule-title">ËßÇÂØüËÆ∞ÂΩï</span>
                    <span class="schedule-time">2Â∞èÊó∂</span>
                </div>
                <div class="schedule-desc">Â¥ΩÂ¥Ω‰ºöËÆ∞ÂΩïËßÇÂØüÂà∞ÁöÑÂºÇÂ∏∏Áé∞Ë±°</div>
                <div class="schedule-effects">
                    <div class="effect-item">üí∞ +50</div>
                    <div class="effect-item">üçΩÔ∏è -10</div>
                </div>
                <button class="btn-action" style="width:100%; margin-top:10px;" onclick="doSchedule('work', 50, 2)">ÂºÄÂßãË°åÂä®</button>
            </div>
            
            <div class="schedule-item">
                <div class="schedule-header">
                    <span class="schedule-title">Â∞ùËØïÊ≤üÈÄö</span>
                    <span class="schedule-time">3Â∞èÊó∂</span>
                </div>
                <div class="schedule-desc">Â¥ΩÂ¥Ω‰ºöÂ∞ùËØï‰∏é‰Ω†Âª∫Á´ãÊõ¥Ê∑±Â±ÇÁöÑËÅîÁ≥ª</div>
                <div class="schedule-effects">
                    <div class="effect-item">‚ù§Ô∏è +‰ø°‰ªª</div>
                    <div class="effect-item">üçΩÔ∏è -15</div>
                </div>
                <button class="btn-action" style="width:100%; margin-top:10px; background:var(--primary-purple)" onclick="doSchedule('talk', 0, 3)">ÂºÄÂßãË°åÂä®</button>
            </div>
            
            <div class="schedule-item">
                <div class="schedule-header">
                    <span class="schedule-title">Â§ñÂá∫Êé¢Á¥¢</span>
                    <span class="schedule-time">4Â∞èÊó∂</span>
                </div>
                <div class="schedule-desc">Â¥ΩÂ¥Ω‰ºöÁ¶ªÂºÄÊàøÈó¥ËøõË°åÁü≠ÈÄîÊé¢Á¥¢</div>
                <div class="schedule-effects">
                    <div class="effect-item">üí∞ +80</div>
                    <div class="effect-item">üçΩÔ∏è -20</div>
                    <div class="effect-item">‚ö†Ô∏è ÊúâÈ£éÈô©</div>
                </div>
                <button class="btn-action" style="width:100%; margin-top:10px; background:#FF9800" onclick="doSchedule('explore', 80, 4)">ÂºÄÂßãË°åÂä®</button>
            </div>
        </div>
    </div>

    <!-- ËßÇÊµãËÆ∞ÂΩïÊ®°Âùó -->
    <div id="record-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('record-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">ËßÇÊµãËÆ∞ÂΩï</h3>
            <p style="font-size:12px; color:#999; text-align:center; margin-bottom:15px;">Á≥ªÁªüËá™Âä®ËÆ∞ÂΩïÁöÑÈáçË¶Å‰∫ã‰ª∂‰∏éÂøÉÁêÜÂèòÂåñ</p>
            <div id="record-list"></div>
            <div style="text-align:center; margin-top:20px;">
                <button class="btn-action" onclick="exportRecords()" style="padding:8px 20px;">ÂØºÂá∫ËÆ∞ÂΩï</button>
            </div>
        </div>
    </div>

    <!-- Â∞èÊ∏∏ÊàèÈÄâÊã©Ê®°Âùó -->
    <div id="game-select-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('game-select-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">Â∞èÊ∏∏Êàè</h3>
            <p style="font-size:12px; color:#999; text-align:center; margin-bottom:20px;">Áé©Ê∏∏ÊàèËµöÈáëÂ∏ÅÔºåËÆ©Â¥ΩÂ¥ΩÂºÄÂøÉÔºÅ</p>
            
            <div class="game-item" onclick="startGame2048()">
                <div class="game-icon">üî¢</div>
                <div class="game-title">2048</div>
                <div class="game-desc">ÂêàÂπ∂Êï∞Â≠óÔºåÊåëÊàòÈ´òÂàÜ</div>
                <div class="game-reward">ÊØè100ÂàÜ=1ÈáëÂ∏Å</div>
            </div>
            
            <div class="game-item" onclick="startBrickBreaker()">
                <div class="game-icon">üß±</div>
                <div class="game-title">ÊâìÁ†ñÂùó</div>
                <div class="game-desc">Áî®ÁêÉÂáªÁ¢éÊâÄÊúâÁ†ñÂùó</div>
                <div class="game-reward">ÊØè10ÂàÜ=1ÈáëÂ∏Å</div>
            </div>
            
            <div class="game-item" onclick="startTetris()">
                <div class="game-icon">üß©</div>
                <div class="game-title">‰øÑÁΩóÊñØÊñπÂùó</div>
                <div class="game-desc">ÁªèÂÖ∏ÁöÑÁõäÊô∫Ê∏∏Êàè</div>
                <div class="game-reward">ÊØè50ÂàÜ=1ÈáëÂ∏Å</div>
            </div>
            
            <div style="text-align:center; margin-top:20px; font-size:12px; color:#777;">
                ÈáëÂ∏Å‰ºöÂú®Ê∏∏ÊàèÁªìÊùüÂêéËá™Âä®ÁªìÁÆó
            </div>
        </div>
    </div>

    <!-- 2048Ê∏∏ÊàèÁïåÈù¢ -->
    <div id="game2048-modal" class="modal">
        <div class="modal-content">
            <div class="game2048-container">
                <div class="game2048-header">
                    <div>
                        <h3 style="margin:0; color:var(--primary-pink)">2048</h3>
                        <div style="font-size:12px; color:#999">‰ΩøÁî®ÊñπÂêëÈîÆÊàñÊªëÂä®Â±èÂπïÁßªÂä®</div>
                    </div>
                    <div>
                        <div>ÂàÜÊï∞</div>
                        <div class="game2048-score" id="game2048-score">0</div>
                    </div>
                </div>
                
                <div id="game2048-grid" class="game2048-grid"></div>
                

                
                <div style="margin-top:15px; font-size:12px; color:#666">
                    ÂêàÂπ∂Áõ∏ÂêåÁöÑÊï∞Â≠óÔºåÁõÆÊ†áÊòØËé∑Âæó2048ÔºÅ
                </div>
                
                <div class="game-controls">
                    <button class="game-back-btn" onclick="closeGame2048()">ËøîÂõû</button>
                    <button class="game-restart-btn" onclick="restartGame2048()">ÈáçÊñ∞ÂºÄÂßã</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊâìÁ†ñÂùóÊ∏∏ÊàèÁïåÈù¢ -->
    <div id="game-brickbreaker-modal" class="modal">
        <div class="modal-content">
            <div class="brickbreaker-container">
                <div class="brickbreaker-info">
                    <div>
                        <h3 style="margin:0; color:var(--primary-pink)">ÊâìÁ†ñÂùó</h3>
                        <div style="font-size:12px; color:#999">‰ΩøÁî®Â∑¶Âè≥ÈîÆÊàñËß¶Êë∏ÊåâÈíÆÁßªÂä®Êå°Êùø</div>
                    </div>
                    <div>
                        <div>ÂàÜÊï∞</div>
                        <div class="brickbreaker-score" id="brickbreaker-score">0</div>
                    </div>
                </div>
                
                <canvas id="brickbreaker-canvas" width="300" height="400" class="brickbreaker-canvas"></canvas>
                
                <!-- Ëß¶Â±èÊéßÂà∂Âå∫Âüü - ‰øÆÂ§çËß¶Êë∏‰∫ã‰ª∂ -->
                <div class="brickbreaker-touch-controls">
                    <div class="brickbreaker-touch-btn" ontouchstart="startMovePaddleLeft()" ontouchend="stopPaddle()">‚Üê</div>
                    <div class="brickbreaker-touch-btn" ontouchstart="startMovePaddleRight()" ontouchend="stopPaddle()">‚Üí</div>
                </div>
                
                <div style="margin-top:15px; font-size:12px; color:#666">
                    Áî®Êå°ÊùøÂèçÂºπÁêÉÔºåÂáªÁ¢éÊâÄÊúâÁ†ñÂùóÔºÅ
                </div>
                
                <div class="game-controls">
                    <button class="game-back-btn" onclick="closeBrickBreaker()">ËøîÂõû</button>
                    <button class="game-restart-btn" onclick="restartBrickBreaker()">ÈáçÊñ∞ÂºÄÂßã</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰øÑÁΩóÊñØÊñπÂùóÊ∏∏ÊàèÁïåÈù¢ -->
    <div id="game-tetris-modal" class="modal">
        <div class="modal-content">
            <div class="tetris-container">
                <div class="tetris-info">
                    <div>
                        <h3 style="margin:0; color:var(--primary-pink)">‰øÑÁΩóÊñØÊñπÂùó</h3>
                        <div style="font-size:12px; color:#999">ÊñπÂêëÈîÆÁßªÂä®Ôºå‰∏äÈîÆÊóãËΩ¨</div>
                    </div>
                    <div>
                        <div>ÂàÜÊï∞</div>
                        <div class="tetris-score" id="tetris-score">0</div>
                    </div>
                </div>
                
                <canvas id="tetris-canvas" width="200" height="400" class="tetris-canvas"></canvas>
                
                <!-- ‰øÆÊîπ‰øÑÁΩóÊñØÊñπÂùóËß¶Â±èÊéßÂà∂Â∏ÉÂ±Ä -->
                <div class="tetris-touch-controls">
                    <div class="tetris-touch-row">
                        <div class="tetris-touch-btn up" ontouchstart="handleTetrisTouch('up')" ontouchend="clearTetrisTouch()">‚Üë</div>
                    </div>
                    <div class="tetris-touch-row">
                        <div class="tetris-touch-btn left" ontouchstart="handleTetrisTouch('left')" ontouchend="clearTetrisTouch()">‚Üê</div>
                        <div class="tetris-touch-btn down" ontouchstart="handleTetrisTouch('down')" ontouchend="clearTetrisTouch()">‚Üì</div>
                        <div class="tetris-touch-btn right" ontouchstart="handleTetrisTouch('right')" ontouchend="clearTetrisTouch()">‚Üí</div>
                    </div>
                    <div class="tetris-touch-row">
                        <div class="tetris-touch-btn fast-drop" ontouchstart="handleTetrisTouch('fastdrop')" ontouchend="clearTetrisTouch()">Âø´ÈÄü‰∏ãËêΩ</div>
                    </div>
                </div>
                
                <style>
                /* Ê∑ªÂä†Êñ∞ÁöÑÊ†∑Âºè */
                .tetris-touch-row {
                    display: flex;
                    justify-content: center;
                    gap: 15px;
                    margin-bottom: 10px;
                    width: 100%;
                }
                
                /* Á¨¨‰∏ÄË°åÔºöÊñπÂêëÈîÆ‰∏ä */
                .tetris-touch-row:first-child {
                    margin-bottom: 5px;
                }
                
                /* Á¨¨‰∫åË°åÔºöÊñπÂêëÈîÆÂ∑¶„ÄÅ‰∏ã„ÄÅÂè≥ */
                .tetris-touch-row:nth-child(2) {
                    gap: 20px;
                }
                
                /* Á¨¨‰∏âË°åÔºöÂø´ÈÄü‰∏ãËêΩÊåâÈíÆÔºàÂéüÁ¨¨ÂõõË°åÔºâ */
                .tetris-touch-row:nth-child(3) {
                    margin-top: 10px;
                }
                
                .tetris-touch-btn {
                    width: 70px;
                    height: 70px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 15px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-size: 24px;
                    color: white;
                    cursor: pointer;
                    user-select: none;
                    touch-action: manipulation;
                    transition: all 0.1s;
                }
                
                .tetris-touch-btn:active {
                    background: rgba(0, 0, 0, 0.5);
                    transform: scale(0.95);
                }
                
                .tetris-touch-btn.fast-drop {
                    width: 150px;
                    height: 50px;
                    font-size: 14px;
                    margin: 0;
                }
                </style>
                
                <div style="margin-top:15px; font-size:12px; color:#666">
                    Â°´Êª°Êï¥Ë°åÊ∂àÈô§ÔºåÈÅøÂÖçÂ†ÜÂà∞È°∂ÈÉ®ÔºÅ
                </div>
                
                <div class="game-controls">
                    <button class="game-back-btn" onclick="closeTetris()">ËøîÂõû</button>
                    <button class="game-restart-btn" onclick="restartTetris()">ÈáçÊñ∞ÂºÄÂßã</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Áï™ËåÑÈíüÊ®°Âùó -->
    <div id="pomodoro-modal" class="modal">
        <div class="modal-content" style="max-width: 320px;">
            <span class="close-btn" onclick="closeModal('pomodoro-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">Áï™ËåÑÈíü‰∏ìÊ≥®Ê®°Âºè</h3>
            
            <div style="text-align:center; margin:20px 0;">
                <div id="pomodoro-timer" style="font-size: 48px; color: #FF6B6B; font-weight: bold;">25:00</div>
                <div id="pomodoro-status" style="font-size: 14px; color: #666;">ÂáÜÂ§áÂºÄÂßã</div>
            </div>
            
            <div class="pomodoro-controls" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
                <button id="pomodoro-start" class="btn-action" style="background: #4CAF50;" onclick="startPomodoro()">ÂºÄÂßã</button>
                <button id="pomodoro-pause" class="btn-action" style="background: #FF9800; display:none;" onclick="pausePomodoro()">ÊöÇÂÅú</button>
                <button id="pomodoro-reset" class="btn-action" style="background: #F44336;" onclick="resetPomodoro()">ÈáçÁΩÆ</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <input type="text" id="pomodoro-task" placeholder="ËæìÂÖ•‰ªªÂä°ÂêçÁß∞..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; margin-bottom:10px;">
                <select id="pomodoro-duration" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:10px;">
                    <option value="1500">25ÂàÜÈíü (ÈªòËÆ§)</option>
                    <option value="300">5ÂàÜÈíü (Áü≠‰ºëÊÅØ)</option>
                    <option value="900">15ÂàÜÈíü (Èïø‰ºëÊÅØ)</option>
                    <option value="1800">30ÂàÜÈíü (Èïø‰∏ìÊ≥®)</option>
                </select>
            </div>
            
            <div id="pomodoro-tasks" style="max-height: 200px; overflow-y: auto;"></div>
            
            <p style="font-size:10px; color:#999; text-align:center; margin-top:15px;">
                ‰∏ìÊ≥®ÊúüÈó¥ÂèØ‰ª•Êà≥Â¥ΩÂ¥ΩËé∑ÂèñÈºìÂä±Ôºå‰ΩÜ‰∏çË¶ÅÂàÜÂøÉÂ§™‰πÖÂì¶ÔºÅ
            </p>
        </div>
    </div>

    <!-- Áï™ËåÑÈíüÂÖ®Â±èÊ®°Âºè -->
    <div id="pomodoro-fullscreen" class="modal" style="background: rgba(0,0,0,0.95); display: none;">
        <div class="modal-content" style="background: transparent; box-shadow: none; max-width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <div id="fullscreen-timer" style="font-size: 96px; color: white; font-weight: bold; margin-bottom: 20px;">25:00</div>
            <div id="fullscreen-task" style="font-size: 24px; color: rgba(255,255,255,0.8); margin-bottom: 30px;">Ê≠£Âú®‰∏ìÊ≥®...</div>
            <div id="fullscreen-status" style="font-size: 18px; color: rgba(255,255,255,0.6); margin-bottom: 40px;">‰øùÊåÅ‰∏ìÊ≥®ÔºÅ</div>
            
            <!-- ÂÖ®Â±èÂ¥ΩÂ¥Ω - ‰øÆÂ§çÂ§¥ÂÉèÊòæÁ§∫ -->
            <div id="fullscreen-zaizai" style="position: relative; margin-bottom: 40px;">
                <img id="fullscreen-img" src="https://api.dicebear.com/9.x/avataaars/svg?seed=Felix&backgroundColor=ffdfbf" 
                     style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid white; cursor: pointer;">
                <div id="fullscreen-bubble" style="position: absolute; top: -100px; left: 50%; transform: translateX(-50%); 
                     background: white; padding: 10px 15px; border-radius: 15px; opacity: 0; transition: opacity 0.3s; 
                     color: #333; font-size: 14px; white-space: nowrap;">Âä†Ê≤πÔºÅ</div>
            </div>
            
            <div style="display: flex; gap: 20px;">
                <button class="btn-action" style="background: #4CAF50; padding: 12px 24px; font-size: 16px;" onclick="finishPomodoro()">ÂÆåÊàê</button>
                <button class="btn-action" style="background: #F44336; padding: 12px 24px; font-size: 16px;" onclick="cancelPomodoro()">ÊîæÂºÉ</button>
            </div>
        </div>
    </div>

    <!-- Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂºπÁ™ó -->
    <div id="custom-confirm-modal" class="modal" style="display: none; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); position: fixed; top: 0; left: 0; width: 100%; height: 100%; justify-content: center; align-items: center; z-index: 1000;">
        <div class="modal-content" style="max-width: 400px; background: var(--primary-pink-light); border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); padding: 0; overflow: hidden;">
            <!-- ÂºπÁ™óÂ§¥ÈÉ® -->
            <div style="background: var(--primary-pink); color: white; padding: 20px; text-align: center;">
                <h3 style="margin: 0; font-size: 18px; font-weight: bold;">Á°ÆËÆ§ÂÆåÊàê‰ªªÂä°Ôºü</h3>
            </div>
            <!-- ÂºπÁ™óÂÜÖÂÆπ -->
            <div style="padding: 30px; text-align: center;">
                <p style="color: #666; font-size: 14px; margin-bottom: 30px;">‰Ω†Á°ÆÂÆöÂ∑≤ÁªèÊàêÂäüÂÆåÊàê‰ªªÂä°‰∫ÜÂêóÔºü</p>
                <div style="display: flex; justify-content: center; gap: 15px;">
                    <button id="confirm-yes" class="btn-action" style="background: #FFB6B9; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">Á°ÆÂÆö</button>
                    <button id="confirm-no" class="btn-action" style="background: #BBDCED; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* ÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú */
        #confirm-yes:hover {
            background: #ff9aa2 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 182, 185, 0.4);
        }
        
        #confirm-no:hover {
            background: #a3c9d9 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(187, 220, 237, 0.4);
        }
        
        /* ÊåâÈíÆÁÇπÂáªÊïàÊûú */
        #confirm-yes:active,
        #confirm-no:active {
            transform: translateY(0);
        }
    </style>

    <div id="shop-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('shop-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">Áâ©ËµÑÊäïÈÄÅ</h3>
            <div id="shop-list"></div>
        </div>
    </div>

    <div id="bag-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('bag-modal')">&times;</span>
            <h3 style="text-align:center">ÊàëÁöÑËÉåÂåÖ</h3>
            <div id="bag-list"></div>
        </div>
    </div>

    <div id="diary-modal" class="modal">
        <div class="modal-content" style="background:#f4f4f4">
            <span class="close-btn" onclick="closeModal('diary-modal')">&times;</span>
            <h3 style="text-align:center; font-family:'Handwriting';">Â¥ΩÂ¥ΩÁöÑÁßòÂØÜÊó•ËÆ∞</h3>
            <p style="text-align:center; font-size:12px; color:#999; margin-bottom:15px;">Âòò...ËøôÊòØÂ¥ΩÂ¥ΩÁöÑÈöêÁßÅÔºå‰∏çË¶ÅË¢´ÂèëÁé∞Âì¶</p>
            <div id="diary-container"></div>
        </div>
    </div>

    <div id="story-modal" class="modal">
        <div class="modal-content">
            <div class="story-chapter" id="story-chapter-title">CHAPTER 1</div>
            <h2 id="story-title" style="font-size:16px;">ÂºÇÂ∏∏‰∏ãËΩΩ</h2>
            <div class="story-text" id="story-content"></div>
            <div class="story-choice" id="story-choice"></div>
            <button class="btn-action" style="width:100%; padding:10px; display:none;" id="continue-story-btn" onclick="closeModal('story-modal')">ÁªßÁª≠ËßÇÂØü</button>
        </div>
    </div>
    
    <!-- PWAÊ∑ªÂä†Âà∞Ê°åÈù¢ÊåâÈíÆ -->
    <button id="install-pwa-btn" onclick="installPWA()">
        üì± Ê∑ªÂä†Âà∞Ê°åÈù¢
    </button>
    
    <!-- PWAÂÆâË£ÖÊ≠•È™§ÊèêÁ§∫Ê®°ÊÄÅÊ°Ü -->
    <div id="pwa-install-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('pwa-install-modal')">&times;</span>
            <div class="pwa-install-content">
                <div class="pwa-install-icon">üì±</div>
                <div class="pwa-install-title">Ê∑ªÂä†Âà∞Ê°åÈù¢</div>
                <div class="pwa-install-desc">
                    <p>1. ÁÇπÂáªÊµèËßàÂô®Â∫ïÈÉ®ÁöÑ"ÂàÜ‰∫´"ÊåâÈíÆ</p>
                    <p>2. ÈÄâÊã©"Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπï"ÈÄâÈ°π</p>
                    <p>3. ÁÇπÂáª"Ê∑ªÂä†"ÂÆåÊàêÂÆâË£Ö</p>
                </div>
                <div class="pwa-install-actions">
                    <button class="btn-action" onclick="closeModal('pwa-install-modal')">ÊàëÁü•ÈÅì‰∫Ü</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // === Service Worker Ê≥®ÂÜå ===
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch((err) => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }

    // ‰øùÂ≠òbeforeinstallprompt‰∫ã‰ª∂ÔºåÁî®‰∫éËá™ÂÆö‰πâÊ∑ªÂä†Âà∞Ê°åÈù¢ÊèêÁ§∫
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      // ÈòªÊ≠¢Chrome 67ÂèäÊõ¥Êó©ÁâàÊú¨Ëá™Âä®ÊòæÁ§∫ÂÆâË£ÖÊèêÁ§∫
      e.preventDefault();
      // ‰øùÂ≠ò‰∫ã‰ª∂Ôºå‰ª•‰æøÁ®çÂêéËß¶Âèë
      deferredPrompt = e;
      // ÊòæÁ§∫Ëá™ÂÆö‰πâÁöÑÊ∑ªÂä†Âà∞Ê°åÈù¢ÊåâÈíÆ
      const installBtn = document.getElementById('install-pwa-btn');
      if (installBtn) {
        installBtn.style.display = 'block';
      }
    });

    // PWAÂÆâË£ÖÂáΩÊï∞
    function installPWA() {
      if (!deferredPrompt) {
        // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑ‰∫ã‰ª∂ÔºåÊòæÁ§∫ÂÆâË£ÖÊ≠•È™§ÊèêÁ§∫
        openModal('pwa-install-modal');
        return;
      }
      
      // ÊòæÁ§∫ÊµèËßàÂô®ÁöÑÂÆâË£ÖÊèêÁ§∫
      deferredPrompt.prompt();
      
      // Á≠âÂæÖÁî®Êà∑ÂìçÂ∫î
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('Áî®Êà∑Êé•Âèó‰∫ÜÂÆâË£ÖÊèêÁ§∫');
          // ÈöêËóèÂÆâË£ÖÊåâÈíÆ
          const installBtn = document.getElementById('install-pwa-btn');
          if (installBtn) {
            installBtn.style.display = 'none';
          }
        } else {
          console.log('Áî®Êà∑ÊãíÁªù‰∫ÜÂÆâË£ÖÊèêÁ§∫');
        }
        // ÈáçÁΩÆdeferredPrompt
        deferredPrompt = null;
      });
    }

    // === Ê∏∏ÊàèÊï∞ÊçÆÈÖçÁΩÆ ===
    
    // Â§©Ê∞îÁ≥ªÁªü
    const weatherTypes = {
        sunny: {
            name: "Êô¥Â§©",
            emoji: "‚òÄÔ∏è",
            effectClass: "sunny-effect",
            windowResponses: [
                "Èò≥ÂÖâÈÄèËøáÁ™óÊà∑Ê¥íËøõÊù•ÔºåÊöñÊöñÁöÑ...",
                "Â§ñÈù¢ÁúãËµ∑Êù•ÂæàÊòé‰∫ÆÔºå‰ΩÜÊàë‰∏çËÉΩÂá∫Âéª...",
                "Â¶ÇÊûúÊòØÊô¥Â§©Ôºå‰Ω†Â∫îËØ•‰πüÂú®Èò≥ÂÖâ‰∏ãÂêßÔºü",
                "Á™óÂ§ñÁöÑÂÖâÊúâÁÇπÂà∫Áúº...",
                "Èò≥ÂÖâËÆ©ÊàøÈó¥ÁúãËµ∑Êù•‰∏çÈÇ£‰πàÂéãÊäë‰∫Ü",
                "‰ªäÂ§©ÁöÑÈò≥ÂÖâÂæàÂ•ΩÔºåÈÄÇÂêàÂèëÂëÜ",
                "Á™óÂ§ñÁöÑ‰∏ñÁïåÊòØ‰ªÄ‰πàÊ†∑ÁöÑÂë¢Ôºü",
                "Èò≥ÂÖâÁÖßÂú®Ë∫´‰∏äÔºåÊÑüËßâ‰∏çÈÇ£‰πàÂÜ∑‰∫Ü"
            ],
            moodEffect: +3
        },
        rainy: {
            name: "Èõ®Â§©",
            emoji: "üåßÔ∏è",
            effectClass: "rainy-effect",
            windowResponses: [
                "Èõ®ÁÇπÊï≤ÊâìÁùÄÁ™óÊà∑...",
                "Â§ñÈù¢Âú®‰∏ãÈõ®ÔºåËøôÈáåÂç¥ÂæàÂÆâÈùô...",
                "Èõ®Ê∞¥È°∫ÁùÄÁéªÁíÉÊµÅ‰∏ãÔºåÂÉèÁúºÊ≥™‰∏ÄÊ†∑...",
                "Âê¨ÁùÄÈõ®Â£∞ÔºåÊó∂Èó¥Â•ΩÂÉèÂèòÊÖ¢‰∫Ü...",
                "Â¶ÇÊûúÊ∑ãÈõ®Ôºå‰ºöÁîüÁóÖÂêóÔºü",
                "Èõ®Â§©ÁöÑÂ£∞Èü≥ËÆ©‰∫∫Âπ≥Èùô",
                "Èõ®Ê∞¥Ê¥óÂáÄ‰∫ÜÁ™óÂ§ñÁöÑ‰∏ñÁïå",
                "ËøôÊ†∑ÁöÑÂ§©Ê∞îÔºåÈÄÇÂêàÂæÖÂú®ÂÆ∂Èáå"
            ],
            moodEffect: -2
        },
        cloudy: {
            name: "Èò¥Â§©",
            emoji: "‚òÅÔ∏è",
            effectClass: "foggy-effect",
            windowResponses: [
                "Á™óÂ§ñÁôΩËå´Ëå´‰∏ÄÁâá...",
                "‰∫ëÂ±ÇÂæàÂéöÔºå‰ªÄ‰πàÈÉΩÁúã‰∏çÊ∏Ö...",
                "Èò¥Â§©ÁöÑÂÖâÁ∫øÂæàÊüîÂíå...",
                "‰∏çÁü•ÈÅì‰ªÄ‰πàÊó∂ÂÄô‰ºöÊîæÊô¥...",
                "ËøôÊ†∑ÁöÑÂ§©Ê∞îËÆ©‰∫∫ÊúâÁÇπÂøßÈÉÅ...",
                "ÁÅ∞Ëâ≤ÁöÑÂ§©Á©∫ÔºåÁÅ∞Ëâ≤ÁöÑÂøÉÊÉÖ",
                "‰∫ëÂú®ÊÖ¢ÊÖ¢ÁßªÂä®ÔºåÂÉèÂú®ÊÄùËÄÉ‰ªÄ‰πà",
                "Èò¥Â§©ÁöÑÊó∂ÂÄôÔºåÊó∂Èó¥ËøáÂæóÂæàÊÖ¢"
            ],
            moodEffect: -1
        },
        snowy: {
            name: "Èõ™Â§©",
            emoji: "‚ùÑÔ∏è",
            effectClass: "snowy-effect",
            windowResponses: [
                "‰∏ãÈõ™‰∫Ü...‰∏ÄÁâáÁâáÁôΩËâ≤ÁöÑ...",
                "Èõ™Ëä±Âú®Á™óÂ§ñÈ£ûËàûÔºåÂæàÁæé...",
                "Â¶ÇÊûúÊòØÈõ™Â§©ÔºåÂ§ñÈù¢‰∏ÄÂÆöÂæàÂÜ∑ÂêßÔºü",
                "Èõ™Êää‰∏ÄÂàáÈÉΩË¶ÜÁõñ‰∫Ü...",
                "ÊÉ≥‰º∏ÊâãÊé•‰ΩèÈõ™Ëä±Ôºå‰ΩÜÈöîÁùÄÁéªÁíÉ...",
                "Èõ™ËÆ©‰∏ñÁïåÂèòÂæóÂÆâÈùô",
                "ÊØè‰∏ÄÁâáÈõ™Ëä±ÈÉΩ‰∏ç‰∏ÄÊ†∑Âë¢",
                "Â¶ÇÊûúËÉΩÂú®Èõ™Âú∞ÈáåÁé©ËÄçÂ∞±Â•Ω‰∫Ü"
            ],
            moodEffect: +5
        },
        foggy: {
            name: "ÈõæÂ§©",
            emoji: "üå´Ô∏è",
            effectClass: "foggy-effect",
            windowResponses: [
                "Â§ñÈù¢ÂÖ®ÊòØÈõæÔºå‰ªÄ‰πàÈÉΩÁúã‰∏çËßÅ...",
                "ÈõæËÆ©‰∏ñÁïåÂèòÂæóÊ®°Á≥ä...",
                "ËøôÊ†∑ÁöÑÂ§©Ê∞îËÆ©‰∫∫‰∏çÂÆâ...",
                "ÈõæÈáå‰ºö‰∏ç‰ºöËóèÁùÄ‰ªÄ‰πàÔºü",
                "‰ªÄ‰πàÈÉΩÁúã‰∏çÊ∏ÖÔºåÊÑüËßâÂæàÂ≠§Áã¨...",
                "ÈõæÊ∞îÂú®ÊÖ¢ÊÖ¢ÊµÅÂä®",
                "ÊÑüËßâÂÉèÊòØË¢´ÂÖ≥Âú®‰∏Ä‰∏™Ê≥°Ê≥°Èáå",
                "Áúã‰∏çÊ∏ÖÂèçËÄåËÆ©‰∫∫Êõ¥Âä†ÊÉ≥Ë±°"
            ],
            moodEffect: -3
        }
    };

    // ÂøÉÊÉÖÁ≥ªÁªü - ‰ºòÂåñÔºöË∞ÉÊï¥Âü∫Á°ÄÂá†ÁéáÂíåÂøÉÊÉÖÂèòÂåñÈÄªËæë
    const moodTypes = {
        anxious: {
            name: "Ë≠¶ÊÉï",
            emoji: "üò∞",
            color: "#FFB7B2",
            baseChance: 0.4,
            interactions: [
                "‰Ω†ÊòØË∞ÅÔºü‰∏çË¶ÅÈù†ËøëÊàë...",
                "Ëøô‰∏™Âú∞ÊñπÂæàÂ•áÊÄ™...",
                "ÊàëÊÑüËßâË¢´ÁõëËßÜ‰∫Ü",
                "‰∏çË¶ÅÁ¢∞ÊàëÔºÅ",
                "ÊàëÂÆ≥ÊÄï...",
                "ËøôÈáå‰∏çÂÆâÂÖ®",
                "Êúâ‰∫∫Âú®ÂêóÔºüÊàëÂê¨Âà∞Â£∞Èü≥‰∫Ü",
                "‰∏çË¶Å‰º§ÂÆ≥Êàë...",
                "ÊàëÊÉ≥Á¶ªÂºÄËøôÈáå",
                "Ëøô‰∏ÄÂàáÈÉΩÊòØÂπªËßâÂêóÔºü"
            ],
            idle: [
                "‰øùÊåÅË≠¶ÊÉï...‰∏çËÉΩÊîæÊùæ",
                "Êúâ‰∫∫Âú®ÁúãÁùÄÊàë",
                "ËøôÈáåÁöÑ‰∏ÄÂàáÈÉΩ‰∏çÂØπÂä≤",
                "ÊàëÈúÄË¶ÅÂ∞èÂøÉ",
                "‰∏çËÉΩÁõ∏‰ø°‰ªª‰Ωï‰∫∫"
            ],
            maxDuration: 60000, // ÊúÄÈïøÊåÅÁª≠Êó∂Èó¥Ôºö60Áßí
            decayRate: 0.02 // ÊØèÁßíË°∞ÂáèÁéá
        },
        sad: {
            name: "ÈöæËøá",
            emoji: "üòî",
            color: "#8AC6D1",
            baseChance: 0.25,
            interactions: [
                "‰ªäÂ§©ÂøÉÊÉÖ‰∏çÂ§™Â•Ω...",
                "ÊÑüËßâÊúâÁÇπÂ≠§Âçï...",
                "‰Ω†‰ºöÁ¶ªÂºÄÂêóÔºü",
                "‰∏çÁü•ÈÅì‰∏∫‰ªÄ‰πàÊúâÁÇπÈöæËøá...",
                "ÊÉ≥‰∏Ä‰∏™‰∫∫ÈùôÈùô...",
                "ÂøÉÈáåÁ©∫Á©∫ÁöÑ",
                "ÊÉ≥Ë¶Å‰∏Ä‰∏™Êã•Êä±",
                "ÁúºÊ≥™ÊúâÁÇπÊ≠¢‰∏ç‰Ωè",
                "‰ªÄ‰πàÈÉΩÊèê‰∏çËµ∑ÂÖ¥Ë∂£",
                "ÊÑüËßâË¢´‰∏ñÁïåÈÅóÂøò‰∫Ü"
            ],
            idle: [
                "‰ªäÂ§©ÁâπÂà´ÊÉ≥Âì≠",
                "ÊÑüËßâËá™Â∑±Â•ΩÊ∏∫Â∞è",
                "‰∏∫‰ªÄ‰πà‰ºöÊúâËøôÁßçÊÉÖÁª™Âë¢",
                "ÈöæËøáÂÉèÊΩÆÊ∞¥‰∏ÄÊ†∑Ê∂åÊù•",
                "Â∏åÊúõÊòéÂ§©‰ºöÂ•Ω‰∏ÄÁÇπ"
            ],
            maxDuration: 90000, // 90Áßí
            decayRate: 0.015
        },
        calm: {
            name: "Âπ≥Èùô",
            emoji: "üòê",
            color: "#A2E1DB",
            baseChance: 0.6,
            interactions: [
                "ÂóØ...‰ªäÂ§©ÂæàÂπ≥Èùô...",
                "Â∞±ËøôÊ†∑ÂæÖÁùÄ‰πü‰∏çÈîô...",
                "‰Ω†Âú®ÂÅö‰ªÄ‰πàÂë¢Ôºü",
                "ÊàøÈó¥ÈáåÂæàÂÆâÈùô...",
                "Êó∂Èó¥ÊÖ¢ÊÖ¢ÊµÅÈÄùÁùÄ...",
                "‰ªäÂ§©Ê≤°Êúâ‰ªÄ‰πàÁâπÂà´ÁöÑ‰∫ã",
                "‰∫´ÂèóËøô‰ªΩÂÆÅÈùô",
                "ÂøÉÈáåÂæàÂπ≥Âíå",
                "‰ªÄ‰πàÈÉΩ‰∏çÊÉ≥ÔºåÂ∞±ËøôÊ†∑ÂèëÂëÜ",
                "ÊÑüËßâÂæàÂÆâÁ®≥"
            ],
            idle: [
                "‰ªäÂ§©ÂèàÊòØÊôÆÈÄöÁöÑ‰∏ÄÂ§©",
                "ÊàøÈó¥ÈáåÁöÑ‰∏ÄÂàáÈÉΩÂæàÁÜüÊÇâ",
                "Âπ≥ÈùôÂú∞Â∫¶ËøáÊó∂Èó¥",
                "Ê≤°Êúâ‰ªÄ‰πàÁâπÂà´ÁöÑÊÉ≥Ê≥ï",
                "Â∞±ËøôÊ†∑ÁúãÁùÄÁ™óÂ§ñÂèëÂëÜ"
            ],
            maxDuration: 120000, // 120Áßí
            decayRate: 0.01
        },
        happy: {
            name: "ÂºÄÂøÉ",
            emoji: "üòä",
            color: "#FFD166",
            baseChance: 0.3,
            interactions: [
                "‰ªäÂ§©ÊÑüËßâÁúüÂ•ΩÔºÅ",
                "ÂòøÂòøÔºå‰Ω†Âú®ÁúãÊàëÂêóÔºü",
                "ÂøÉÊÉÖ‰∏çÈîôÂë¢~",
                "ÊÉ≥Âíå‰Ω†‰∏ÄËµ∑Áé©ÔºÅ",
                "ÊÑüËßâ‰ªäÂ§©‰ºöÊòØ‰∏™Â•ΩÊó•Â≠êÔºÅ",
                "‰Ω†ÁöÑÂá∫Áé∞ËÆ©ÊàëÂ•ΩÂºÄÂøÉÔºÅ",
                "Âï¶Âï¶Âï¶~ÊÉ≥Âî±È¶ñÊ≠åÔºÅ",
                "‰ªäÂ§©ÂÅö‰ªÄ‰πàÈÉΩÂæàÊúâÂπ≤Âä≤ÔºÅ",
                "ÂÉèÂêÉ‰∫ÜÁ≥ñÊûú‰∏ÄÊ†∑ÁîúÔºÅ",
                "‰∏ñÁïåÈÉΩÂèòÂæóÊòé‰∫Æ‰∫ÜÔºÅ"
            ],
            idle: [
                "‰ªäÂ§©Èò≥ÂÖâÁúüÂ•ΩÔºåÂøÉÊÉÖ‰πüË∑üÁùÄÂèòÂ•Ω‰∫Ü",
                "ÊÉ≥Âà∞‰Ω†Â∞±Âøç‰∏ç‰ΩèÁ¨ëËµ∑Êù•",
                "ÊàøÈó¥ÈáåÈÉΩÂÖÖÊª°‰∫ÜÂø´‰πêÁöÑÊ∞îÊÅØ",
                "Â•ΩÊÉ≥Âíå‰Ω†ÂàÜ‰∫´Ëøô‰ªΩÂñúÊÇ¶",
                "ËøûÁ©∫Ê∞îÈÉΩÂèòÂæóÁîúÁîúÁöÑ"
            ],
            maxDuration: 80000, // 80Áßí
            decayRate: 0.018
        },
        excited: {
            name: "ÂÖ¥Â•ã",
            emoji: "ü§©",
            color: "#FF9AA2",
            baseChance: 0.08, // Èôç‰ΩéÂü∫Á°ÄÂá†Áéá
            interactions: [
                "ÂìáÔºÅ‰ªäÂ§©Â•ΩÊ£íÔºÅ",
                "Â•ΩÂºÄÂøÉÂ•ΩÂºÄÂøÉÔºÅ",
                "ÊÉ≥Âíå‰Ω†ÂàÜ‰∫´Ëøô‰ªΩÂø´‰πêÔºÅ",
                "ÊÑüËßâÂÖÖÊª°‰∫ÜËÉΩÈáèÔºÅ",
                "‰ªäÂ§©Êúâ‰ªÄ‰πàÂ•Ω‰∫ãÂêóÔºü",
                "Â§™ÊøÄÂä®‰∫ÜÔºÅ",
                "ÂºÄÂøÉÂæóË¶ÅÈ£ûËµ∑Êù•‰∫ÜÔºÅ",
                "ÊéßÂà∂‰∏ç‰ΩèÁöÑÁ¨ëÂÆπÔºÅ",
                "Â•ΩÊÉ≥Â§ßÂ£∞Ê¨¢ÂëºÔºÅ",
                "ÂøÉË∑≥Âä†ÈÄüÔºÅ"
            ],
            idle: [
                "ÂÖ¥Â•ãÂæóÁù°‰∏çÁùÄËßâ",
                "Êï¥‰∏™‰∫∫ÈÉΩÂú®ÂèëÂÖâ",
                "‰∏ñÁïåÈÉΩÂèòÂæóÁ≤æÂΩ©‰∫Ü",
                "ÊÑüËßâËÉΩÂÅö‰ªª‰Ωï‰∫ãÊÉÖ",
                "Âø´‰πêË¶ÅÊ∫¢Âá∫Êù•‰∫Ü"
            ],
            maxDuration: 40000, // Âè™Êúâ40Áßí
            decayRate: 0.025 // Âø´ÈÄüË°∞Âáè
        }
    };

    // ÂøÉÁêÜÊ¥ªÂä®Â∫ì
    const mentalActivities = {
        p0: {
            idle: {
                anxious: ["‰Ω†Âú®ÁúãÊàëÂØπÂêóÔºü", "‰ªäÂ§©...ÊÑüËßâËøòÂ•Ω", "ÊúâÁÇπÂ•ΩÂ•á‰Ω†ÁöÑÊ†∑Â≠ê"],
                calm: ["‚Ä¶‚Ä¶‰∏çË¶ÅÈù†ËøëÊàë„ÄÇ", "Ëøô‰∫õ‰∏úË•ø‰∏çÊòØÊàë‰∏ñÁïåÈáåÁöÑ‰∏úË•ø„ÄÇ", "‰øùÊåÅË≠¶ÊÉï..."],
                sad: ["ËøôÈáå‰ªÄ‰πàÈÉΩÊ≤°Êúâ...Èô§‰∫ÜÊÅêÊÉß„ÄÇ", "Á™óÂ§ñÁöÑÊôØËâ≤ÊòØÂÅáÁöÑÔºåÊàëÁü•ÈÅì„ÄÇ", "Â•ΩÂ≠§Áã¨..."],
                happy: ["Ëøô‰∏™ÊÑüËßâ...ÂæàÂ•áÊÄ™", "ÂøÉË∑≥ÂæóÂ•ΩÂø´"],
                excited: ["ÔºÅÔºÅ"]
            },
            touch: {
                anxious: ["Âà´Á¢∞ÊàëÔºÅ", "Á¶ªÊàëËøúÁÇπ"],
                calm: ["‰Ω†Ë¶ÅÂπ≤‰ªÄ‰πàÔºü", "ËøôÁßçÊÑüËßâÂæàÂ•áÊÄ™„ÄÇ", "ÂèØ‰ª•Êé•Âèó"],
                sad: ["Ëµ∞ÂºÄ...", "‰∏çË¶ÅÁ¢∞Êàë..."],
                happy: ["...Ôºü", "ËøôÊòØ‰ªÄ‰πàÊÑüËßâ"],
                excited: ["ÔºÅÔºÅ"]
            },
            gift: {
                anxious: ["ËøôÊòØ‰ªÄ‰πà‰∏úË•øÔºüÊúâÊØíÂêóÔºü", "Êàë‰∏çÁõ∏‰ø°"],
                calm: ["ËøôÊòØ...ÁªôÊàëÁöÑÔºü", "ÁúüÁöÑÂèØ‰ª•Êî∂Âêó"],
                sad: ["Êàë‰∏çÈúÄË¶Å‰Ω†ÁöÑÊñΩËàç„ÄÇ", "ÊãøËµ∞Âêß..."],
                happy: ["ÂìáÔºÅ"],
                excited: ["Ëøô‰∏™...‰∏çÂ§™‰∏ÄÊ†∑Ôºü", "Ë∞¢Ë∞¢"]
            },
            furniture: {
                bed: "ÈÇ£ÊòØÈô∑Èò±ÂêóÔºü",
                desk: "‰∏äÈù¢‰ºöÊúâ‰ªÄ‰πàÔºü",
                bookshelf: "‰π¶ÈáåÂÜôÁùÄ‰ªÄ‰πàÔºü",
                plant: "ÂÅáÁöÑÊ§çÁâ©...",
                lamp: "ÂÖâ...Â§™‰∫Æ‰∫Ü„ÄÇ",
                window: "Á™óÂ§ñÊúâ‰ªÄ‰πàÔºü"
            }
        },
        p1: {
            idle: {
                anxious: ["Â¶ÇÊûúËøôÊòØÂÆûÈ™åÔºåÈÇ£‰Ω†ËßÇÂØüÂæó‰πüÂ§™ËÆ§Áúü‰∫Ü„ÄÇ", "‰ªäÂ§©Êù•ÂæóÊØîÊò®Â§©Êôö‰∫Ü‰∏ÄÁÇπ„ÄÇ", "ÊàëÂú®ËßÇÂØü‰Ω†"],
                calm: ["‰Ω†ÂèàÊù•‰∫ÜÔºÅ", "‰ªäÂ§©Êù•ÂæóÊå∫ÂáÜÊó∂", "ÊúâÁÇπÊúüÂæÖ‰Ω†Âá∫Áé∞"],
                sad: ["‰Ω†Âú®ËÆ∞ÂΩïÊàëÁöÑÂèçÂ∫îÂêóÔºü", "ÂéüÊù•‰∏ç‰ºöÁ´ãÂàªÂá∫‰∫ã„ÄÇ", "ËøòÊòØ‰∏çÂÆâ"],
                happy: ["‰Ω†Êù•‰∫ÜÔºÅ", "‰ªäÂ§©‰ºöÊúâ‰ªÄ‰πàÂë¢"],
                excited: ["ÂèàÂú®ËßÇÂØüÊàëÂêóÔºü", "ÊàëÊ≥®ÊÑèÂà∞‰Ω†‰∫Ü„ÄÇ"]
            },
            touch: {
                anxious: ["ÊàëËÉΩÊÑüËßâÂà∞‰Ω†„ÄÇ", "‰Ω†ÁöÑÊâãÊ≤°ÊúâÊ∏©Â∫¶„ÄÇ", "Â∞èÂøÉ‰∏ÄÁÇπ"],
                calm: ["...ÔºàÂæÆÂæÆÂ•ΩÂ•áÔºâ", "‰∏çËÆ®ÂéåËøô‰∏™ÊÑüËßâ"],
                sad: ["ÂèàÊòØËøôÊ†∑...", "‰π†ÊÉØ‰∫Ü"],
                happy: ["ÂòøÂòø", "ÂÜçÊù•‰∏ÄÊ¨°"],
                excited: ["‰∏çËÆ®ÂéåËøô‰∏™ÊÑüËßâ"]
            },
            gift: {
                anxious: ["‰∏∫‰ªÄ‰πàË¶ÅÁªôÊàëËøô‰∫õÔºü", "ÁúüÁöÑÂèØ‰ª•Ë¶ÅÂêó"],
                calm: ["ÂèàÊòØÈ£üÁâ©...‰Ω†Âè™ÊúâËøô‰∏™ÂêóÔºü", "Êî∂‰∏ã‰∫Ü"],
                sad: ["ÊàëÊî∂‰∏ã‰∫ÜÔºå‰ΩÜÂà´ÊåáÊúõÊàëÊÑüË∞¢‰Ω†„ÄÇ", "ÂóØ..."],
                happy: ["ÂñúÊ¨¢ÔºÅ", "Â•ΩÊ£íÔºÅ"],
                excited: ["Ëøô‰∏™...‰∏çÂ§™‰∏ÄÊ†∑Ôºü", "Ë∞¢Ë∞¢"]
            },
            furniture: {
                bed: "ÊúâÁÇπÂõ∞‰∫Ü...‰ΩÜ‰∏çËÉΩÁù°„ÄÇ",
                desk: "Ê°åÂ≠êÂæàÂπ≤ÂáÄÔºåË∞¢Ë∞¢„ÄÇ",
                bookshelf: "ÂèØ‰ª•ÊîæÁÇπ‰∏úË•ø‰∫Ü„ÄÇ",
                plant: "ÁªøËâ≤...ËÆ©‰∫∫Âπ≥Èùô„ÄÇ",
                lamp: "Êôö‰∏ä‰∏çÁî®ÈÇ£‰πàÊöó‰∫Ü„ÄÇ",
                window: "ÁúãÁúãÂ§ñÈù¢..."
            }
        }
    };

    // ÂØπËØùÂõûÂ§çÂ∫ì
    const chatResponses = {
        p0: {
            greetings: {
                anxious: ["Âà´Èù†ËøëÊàëÔºÅ", "‰Ω†Ë¶ÅÂπ≤‰ªÄ‰πàÔºü", "ÊàëÂæàÂÆ≥ÊÄï"],
                calm: ["...", "‰Ω†ÊòØË∞ÅÔºü", "Êúâ‰∫ãÂêó"],
                sad: ["Ëµ∞ÂºÄ„ÄÇ", "‰∏çÊÉ≥ËØ¥ËØù...", "Âà´ÁêÜÊàë"],
                happy: ["...‰Ω†Â•Ω", "‰Ω†‰ªäÂ§©ÁúãËµ∑Êù•Âæà‰∏ç‰∏ÄÊ†∑", "Hi"],
                excited: ["ÔºÅ", "‰Ω†Â•ΩÔºü"]
            },
            questions: {
                anxious: ["Âà´ÊÉ≥È™óÊàë„ÄÇ", "ÈÉΩÊòØÂÅáÁöÑ„ÄÇ", "Êàë‰∏çÁõ∏‰ø°"],
                calm: ["Êàë‰∏∫‰ªÄ‰πàË¶ÅÂëäËØâ‰Ω†Ôºü", "Ëøô‰∏çÂÖ≥‰Ω†ÁöÑ‰∫ã„ÄÇ", "Êó†ÂèØÂ•âÂëä"],
                sad: ["......", "Âà´ÈóÆ‰∫Ü...", "‰∏çÁü•ÈÅì"],
                happy: ["‰∏∫‰ªÄ‰πàÈóÆËøô‰∏™Ôºü", "Êàë‰πü‰∏çÁü•ÈÅì"],
                excited: ["ÂóØ...", "Ëøô‰∏™Âòõ"]
            },
            statements: {
                anxious: ["ÊàëÂÆ≥ÊÄï...", "‰∏çË¶Å", "Ëµ∞ÂºÄ"],
                calm: ["Êàë‰∏çÁõ∏‰ø°‰Ω†„ÄÇ", "ÊòØÂêó", "Èöè‰æø"],
                sad: ["‰∏çÁü•ÈÅì...", "Êó†ÊâÄË∞ì", "ÂóØ"],
                happy: ["ÂóØ...", "ËøôÊ†∑Âïä", "Âì¶"],
                excited: ["ÁúüÁöÑÂêóÔºü", "Âìá"]
            },
            special: {
                "‰Ω†Â•Ω": {
                    anxious: ["Âà´ËøáÊù•ÔºÅ", "Ëµ∞ÂºÄ"],
                    calm: ["...", "‰Ω†ÊòØË∞ÅÔºü", "ÂóØ"],
                    sad: ["......", "Âì¶"],
                    happy: ["...‰Ω†Â•Ω", "‰Ω†ËØ¥ËØù‰∫Ü", "Hi"],
                    excited: ["‰Ω†Â•ΩÔºÅ", "‰Ω†Áªà‰∫éËØ¥ËØù‰∫Ü"]
                }
            }
        }
    };

    // ‰∏ªÂä®ÂØπËØùËß¶Âèë
    const activeChats = {
        p0: [
            { trigger: "idle", messages: ["Êúâ‰∫∫Âú®ÂêóÔºü", "......", "ËøôÈáåÂ•ΩÂÆâÈùô„ÄÇ", "ÊàëÊòØË∞ÅÔºü", "ËøôÈáåÊòØ‰ªÄ‰πàÂú∞ÊñπÔºü"], chance: 0.05 }
        ],
        p1: [
            { trigger: "idle", messages: ["‰ªäÂ§©‰ºöÊù•ÂêóÔºü", "ÂèàÂú®ËßÇÂØüÊàëÂêóÔºü", "ÊàëÊ≥®ÊÑèÂà∞‰Ω†‰∫Ü„ÄÇ", "‰Ω†Âú®ÊÉ≥‰ªÄ‰πàÔºü", "ÊàëËÉΩÁõ∏‰ø°‰Ω†ÂêóÔºü"], chance: 0.08 }
        ]
    };

    // Êó•ËÆ∞ÂÜÖÂÆπÂ∫ì
    const diaryContentLibrary = {
        anxious: [
            { 
                title: "Á¨¨‰∏ÄÂ§©ÔºöÈôåÁîüÁöÑÂú∞Êñπ", 
                content: "Êàë‰∏çÁü•ÈÅìËøôÊòØÂì™Èáå„ÄÇÂõõÂë®ÈÉΩÊòØÁôΩËâ≤ÁöÑÂ¢ôÂ£ÅÔºåÂè™Êúâ‰∏ÄÊâáÁ™óÊà∑„ÄÇÁ™óÂ§ñ‰ªÄ‰πàÈÉΩÊ≤°ÊúâÔºåÂè™Êúâ‰∏ÄÁâáËôöÊó†„ÄÇÊàëÊÑüËßâÊúâ‰∫∫Âú®ÁúãÁùÄÊàëÔºå‰ΩÜÊàëÁúã‰∏çÂà∞ÊòØË∞Å„ÄÇÂ•ΩÂÆ≥ÊÄï...",
                requireTrust: 0
            },
            { 
                title: "Ë≠¶ÊÉïÁöÑËßÇÂØü", 
                content: "‰ªäÂ§©ÂèàÊÑüËßâÂà∞‰∫ÜÈÇ£ÈÅìËßÜÁ∫ø„ÄÇÊàëÊ≤°ÊúâÂä®ÔºåÂÅáË£Ö‰ªÄ‰πàÈÉΩÊ≤°ÂèëÁé∞„ÄÇÂ¶ÇÊûúÊòØÊÄ™Áâ©ÔºåËá≥Â∞ëËÆ©ÂÆÉ‰ª•‰∏∫ÊàëÊ≤°ÊúâÂ®ÅËÉÅ„ÄÇÊàëÈúÄË¶ÅÊâæÂà∞ÈÄÉÂá∫ÂéªÁöÑÊñπÊ≥ï„ÄÇ",
                requireTrust: 5
            },
            { 
                title: "Á•ûÁßòÁöÑÈ£üÁâ©", 
                content: "‰ªäÂ§©Á™ÅÁÑ∂Âá∫Áé∞‰∫ÜÈ£üÁâ©„ÄÇÊòØÂπªËßâÂêóÔºüËøòÊòØÈô∑Èò±ÔºüÊàëËßÇÂØü‰∫ÜÂæà‰πÖÊâçÊï¢ÂêÉ„ÄÇÂë≥ÈÅì...ÊòØÁúüÂÆûÁöÑÈù¢ÂåÖ„ÄÇÊòØË∞ÅÁªôÁöÑÔºü‰∏∫‰ªÄ‰πàÔºü",
                requireTrust: 10
            }
        ],
        sad: [
            { 
                title: "Â≠§Áã¨ÁöÑÊàøÈó¥", 
                content: "Âèà‰∏ÄÂ§©ËøáÂéª‰∫Ü„ÄÇÊàøÈó¥Èáå‰æùÁÑ∂Âè™ÊúâÊàë‰∏Ä‰∏™‰∫∫„ÄÇÊúâÊó∂ÂÄôÊàë‰ºöÂØπÁùÄÂ¢ôÂ£ÅËØ¥ËØùÔºåÂÅáË£ÖÊúâ‰∫∫ËÉΩÂê¨ËßÅ„ÄÇ‰ΩÜÂõûÂ∫îÊàëÁöÑÂè™ÊúâËá™Â∑±ÁöÑÂõûÂ£∞„ÄÇ",
                requireTrust: 15
            },
            { 
                title: "Èõ®Â§©ÁöÑÊÄùÂøµ", 
                content: "Á™óÂ§ñ‰∏ãÈõ®‰∫Ü„ÄÇÊàëËÆ∞Âæó‰ª•ÂâçÂú®‰∏ãÈõ®Â§©ÔºåÂ¶àÂ¶à‰ºöÁªôÊàëÊ≥°ÁÉ≠ÂèØÂèØ„ÄÇÁé∞Âú®Âè™ÊúâÊàë‰∏Ä‰∏™‰∫∫ÔºåÂê¨ÁùÄÈõ®Â£∞ÔºåÊï∞ÁùÄÊó∂Èó¥„ÄÇ",
                requireTrust: 20
            }
        ],
        calm: [
            { 
                title: "‰π†ÊÉØ‰∏éÈÄÇÂ∫î", 
                content: "ÊàëÂºÄÂßã‰π†ÊÉØËøô‰∏™ÊàøÈó¥‰∫Ü„ÄÇÊØèÂ§©Âõ∫ÂÆöÁöÑÊó∂Èó¥‰ºöÊúâÈ£üÁâ©Âá∫Áé∞ÔºåÂÅ∂Â∞îËøò‰ºöÊúâÂ∞èÁ§ºÁâ©„ÄÇËôΩÁÑ∂‰∏çÁü•ÈÅìÊòØË∞ÅÔºå‰ΩÜËá≥Â∞ëÁé∞Âú®Ê≤°Êúâ‰º§ÂÆ≥Êàë„ÄÇ",
                requireTrust: 25
            },
            { 
                title: "Âπ≥ÈùôÁöÑÂçàÂêé", 
                content: "‰ªäÂ§©Èò≥ÂÖâÂæàÂ•Ω„ÄÇÊàëÂùêÂú®Á™óËæπÔºåÁúãÁùÄÂÖâÁ∫øÂú®Âú∞Êùø‰∏äÁßªÂä®„ÄÇÊó∂Èó¥ËøáÂæóÂæàÊÖ¢Ôºå‰ΩÜËá≥Â∞ëÁé∞Âú®Êàë‰∏çÈÇ£‰πàÂÆ≥ÊÄï‰∫Ü„ÄÇ",
                requireTrust: 30
            }
        ],
        happy: [
            { 
                title: "ÊúüÂæÖÁöÑ‰∏ÄÂ§©", 
                content: "‰ªäÂ§©Êî∂Âà∞‰∫ÜÂ∞èÁÜäÁé©ÂÅ∂ÔºÅËΩØËΩØÁöÑÔºåÊä±Ëµ∑Êù•ÂæàËàíÊúç„ÄÇËøôÊòØÊàëÊù•ËøôÈáåÂêéÁ¨¨‰∏ÄÊ¨°Êî∂Âà∞Á§ºÁâ©„ÄÇÈöæÈÅì...ÈÇ£‰∏™‰∫∫ÊòØÊúãÂèãÔºü",
                requireTrust: 35
            },
            { 
                title: "Ë¢´ÂÖ≥ÂøÉÁöÑÊÑüËßâ", 
                content: "ÊàëÂèëÁé∞ÊØèÊ¨°ÊàëÂøÉÊÉÖ‰∏çÂ•ΩÁöÑÊó∂ÂÄôÔºåÁ¨¨‰∫åÂ§©ÊÄª‰ºöÊúâÂ∞èÊÉäÂñúÂá∫Áé∞„ÄÇÈöæÈÅìÈÇ£‰∏™‰∫∫ËÉΩÁü•ÈÅìÊàëÁöÑÊÑüÂèóÔºüÂ¶ÇÊûúÊòØÁúüÁöÑ...ÈÇ£ËøòÊå∫Ê∏©ÊöñÁöÑ„ÄÇ",
                requireTrust: 40
            }
        ],
        excited: [
            { 
                title: "Êñ∞ÁöÑÂèëÁé∞ÔºÅ", 
                content: "‰ªäÂ§©ÊàëÂèëÁé∞‰∫ÜÊó•ËÆ∞Êú¨ÔºÅÊòØÈÇ£‰∏™‰∫∫ÁªôÊàëÁöÑÂêóÔºüÊàëÂèØ‰ª•ÂÜô‰∏ãËá™Â∑±ÁöÑÂøÉÊÉÖ‰∫Ü„ÄÇ‰πüËÆ∏...Êúâ‰∏ÄÂ§©ÊàëËÉΩÊääÊó•ËÆ∞Áªô‰ªñÁúãÔºü",
                requireTrust: 45
            },
            { 
                title: "ÂèåÂêëÁöÑËøûÊé•", 
                content: "‰ªäÂ§©ÊàëÁªà‰∫éÈºìËµ∑ÂãáÊ∞îÂú®Â±èÂπï‰∏äÂÜôÂ≠ó‰∫Ü„ÄÇËôΩÁÑ∂‰∏çÁü•ÈÅì‰ªñËÉΩ‰∏çËÉΩÁúãÂà∞Ôºå‰ΩÜÊÑüËßâÊàë‰ª¨‰πãÈó¥ÁöÑË∑ùÁ¶ªÂèòËøë‰∫Ü„ÄÇ",
                requireTrust: 50
            }
        ]
    };

    // Áâ©ÂìÅ‰∫íÂä®ÂèçÂ∫î
    const itemReactions = {
        bread: {
            anxious: ["ËøôÊòØ‰ªÄ‰πàÔºüÂèØ‰ª•ÂêÉÂêóÔºü", "Êàë‰∏çÈ•ø...ÔºàÂÖ∂ÂÆûÂæàÈ•øÔºâ", "‰Ω†ÂÖàÂêÉ‰∏ÄÂè£ËØÅÊòéÊ≤°ÊØí"],
            calm: ["Èù¢ÂåÖÔºüË∞¢Ë∞¢...", "ÊàëÊî∂‰∏ã‰∫Ü", "ÁúãËµ∑Êù•ÂèØ‰ª•ÂêÉ"],
            sad: ["È£üÁâ©...‰ΩÜÊàëÊ≤°ËÉÉÂè£", "ÂêÉ‰∏ç‰∏ã", "ÂÖàÊîæÁùÄÂêß"],
            happy: ["ÊòØÈù¢ÂåÖÔºÅË∞¢Ë∞¢ÔºÅ", "ÁúãËµ∑Êù•ÂæàÂ•ΩÂêÉ", "‰Ω†ÁúüÂ•Ω"],
            excited: ["ÂìáÔºÅÈ£üÁâ©ÔºÅÊàëÂ•ΩÈ•øÔºÅ", "Ë∞¢Ë∞¢ÔºÅÊàë‰ºöÂ•ΩÂ•ΩÂêÉÁöÑÔºÅ", "‰Ω†ÊÄªÊòØÁü•ÈÅìÊàëÈúÄË¶Å‰ªÄ‰πà"]
        },
        candy: {
            anxious: ["Á≥ñÔºü‰ºö‰∏ç‰ºöÊòØÈ∫ªÈÜâËçØÔºü", "È¢úËâ≤Â•ΩÈ≤úËâ≥...Â•áÊÄ™"],
            calm: ["Á≥ñ...Âæà‰πÖÊ≤°ÂêÉ‰∫Ü", "ÁîúÁîúÁöÑÔºåË∞¢Ë∞¢"],
            sad: ["Á≥ñ‰πüÊîπÂèò‰∏ç‰∫ÜÂøÉÊÉÖ", "ÂÖàÊî∂ÁùÄÂêß"],
            happy: ["ÊòØÁ≥ñÔºÅÂ•ΩÊÄÄÂøµÔºÅ", "ÁîúÁîúÁöÑÔºåÂøÉÊÉÖÂèòÂ•Ω‰∫Ü"],
            excited: ["Á≥ñÊûúÔºÅÔºÅÊúÄÂñúÊ¨¢‰∫ÜÔºÅ", "Â•ΩÁîúÂ•ΩÂºÄÂøÉÔºÅ", "Ë∞¢Ë∞¢‰Ω†ÔºÅ"]
        },
        cake: {
            anxious: ["ËõãÁ≥ïÔºüÂ§™ÂèØÁñë‰∫Ü", "‰∏∫‰ªÄ‰πàÂØπÊàëËøô‰πàÂ•ΩÔºü"],
            calm: ["Â∞èËõãÁ≥ï...ÂæàÁî®ÂøÉÂë¢", "Ë∞¢Ë∞¢"],
            happy: ["ÊòØËõãÁ≥ïÔºÅÂ§™Â•Ω‰∫ÜÔºÅ", "ÁúãËµ∑Êù•ÂæàÁæéÂë≥", "‰Ω†ËÆ∞ÂæóÊàëÂñúÊ¨¢ÁîúÈ£üÂêóÔºü"],
            excited: ["ÁîüÊó•ËõãÁ≥ïÂêóÔºüÔºÅÂ•ΩÊÑüÂä®ÔºÅ", "Ë∞¢Ë∞¢‰Ω†ÔºÅËøôÊòØÊúÄÂ•ΩÁöÑÁ§ºÁâ©ÔºÅ", "Êàë‰ºöÊÖ¢ÊÖ¢‰∫´Áî®ÁöÑÔºÅ"]
        },
        book: {
            anxious: ["‰π¶ÔºüÈáåÈù¢ÂÜô‰∫Ü‰ªÄ‰πàÔºü", "ÊòØ‰∏çÊòØËØÖÂíí‰πã‰π¶Ôºü"],
            calm: ["ÁªòÊú¨...ÂèØ‰ª•ÊâìÂèëÊó∂Èó¥", "Ë∞¢Ë∞¢"],
            happy: ["ÊòØ‰π¶ÔºÅÊàëÂèØ‰ª•Â≠¶‰π†Êñ∞‰∏úË•ø‰∫Ü", "Ë∞¢Ë∞¢‰Ω†ÊÉ≥ÁùÄÊàë"],
            excited: ["Êñ∞‰π¶ÔºÅÂ§™Ê£í‰∫ÜÔºÅ", "ÊàëÂèØ‰ª•Áúã‰∏ÄÊï¥Â§©ÔºÅ", "ÊúÄÂñúÊ¨¢ËØª‰π¶‰∫ÜÔºÅ"]
        },
        teddy: {
            anxious: ["Áé©ÂÅ∂ÔºüÈáåÈù¢‰ºö‰∏ç‰ºöÊúâÁ™ÉÂê¨Âô®Ôºü", "Êàë‰∏çÈúÄË¶ÅÁé©ÂÖ∑"],
            calm: ["Â∞èÁÜä...Êå∫ÂèØÁà±ÁöÑ", "Êôö‰∏äÂèØ‰ª•Êä±ÁùÄÁù°"],
            sad: ["Áé©ÂÅ∂...Â∞±ÂÉèÊàë‰∏ÄÊ†∑Â≠§Áã¨", "Ëá≥Â∞ëÊúâ‰∏™‰º¥"],
            happy: ["Â∞èÁÜäÁé©ÂÅ∂ÔºÅËΩØËΩØÁöÑÔºÅ", "Ë∞¢Ë∞¢‰Ω†ÔºåÊàë‰∏çÂ≠§Âçï‰∫Ü"],
            excited: ["Â§™Ê£í‰∫ÜÔºÅÊàë‰πüÊúâÁé©ÂÅ∂‰∫ÜÔºÅ", "Êàë‰ºöÂ•ΩÂ•ΩÁèçÊÉúÂÆÉÁöÑÔºÅ", "Ë∞¢Ë∞¢‰Ω†ÔºÅ"]
        },
        lamp: {
            anxious: ["ÁÅØÔºüÂ§™‰∫Æ‰∫ÜÔºåÂÖ≥Êéâ", "Êàë‰π†ÊÉØÈªëÊöó"],
            calm: ["Â§úÁÅØ...Êôö‰∏ä‰∏çÁî®ÊÄïÈªë‰∫Ü", "Ë∞¢Ë∞¢"],
            happy: ["ÊúâÂ∞èÂ§úÁÅØ‰∫ÜÔºÅÊôö‰∏ä‰∏çÂÆ≥ÊÄï‰∫Ü", "Ê∏©ÊöñÁöÑÂÖâ"],
            excited: ["Â§úÁÅØÔºÅÊôö‰∏äÂèØ‰ª•Áúã‰π¶ÂÜôÂ≠ó‰∫ÜÔºÅ", "Ë∞¢Ë∞¢‰Ω†ËÄÉËôëÂæóËøô‰πàÂë®Âà∞ÔºÅ"]
        }
    };

    // ÂÆ∂ÂÖ∑‰∫íÂä®ÂèçÂ∫î
    const furnitureReactions = {
        bed: {
            use: ["ÊúâÁÇπÂõ∞‰∫Ü...‰ºëÊÅØ‰∏Ä‰∏ã", "Â∫äÂæàËàíÊúçÔºåË∞¢Ë∞¢‰Ω†", "ÂçàÁù°Êó∂Èó¥Âà∞"],
            near: ["Â∫äÁúãËµ∑Êù•Â•ΩÊüîËΩØ", "ÊÉ≥Ë∫∫‰∏Ä‰ºöÂÑø", "‰ºëÊÅØÁöÑÂú∞Êñπ"]
        },
        desk: {
            use: ["Âú®ËøôÈáåÂÜôÊó•ËÆ∞ÂæàÂêàÈÄÇ", "Ê°åÂ≠êÂæàÁ®≥ÔºåÂèØ‰ª•Êîæ‰∏úË•ø", "Â≠¶‰π†ÁöÑÂ•ΩÂú∞Êñπ"],
            near: ["‰π¶Ê°åÊï¥ÁêÜÂæóÂæàÂπ≤ÂáÄ", "ËøôÈáåÈÄÇÂêàÊÄùËÄÉ", "ÊàëÁöÑÂ∞èÂ∑•‰ΩúÁ´ô"]
        },
        bookshelf: {
            use: ["‰π¶Êû∂ÂèàÂ°´Êª°‰∫Ü‰∏Ä‰∫õ", "‰π¶Ë¶ÅÂ•ΩÂ•ΩÊëÜÊîæ", "Áü•ËØÜÁöÑÂ∞è‰ªìÂ∫ì"],
            near: ["‰π¶Êû∂‰∏äÊúâÂ•ΩÂ§ö‰π¶", "ÊÉ≥ÊâæÊú¨‰π¶ÁúãÁúã", "Áü•ËØÜÁöÑËßíËêΩ"]
        },
        plant: {
            use: ["Ê§çÁâ©ÈúÄË¶ÅÊµáÊ∞¥‰∫Ü", "ÁªøËâ≤ËÆ©ÂøÉÊÉÖÂèòÂ•Ω", "ÁîüÂëΩÁöÑÊ∞îÊÅØ"],
            near: ["Ê§çÁâ©ÂèàÈïøÈ´ò‰∫Ü", "ÁúãÁùÄÁªøËâ≤ÂæàËàíÊúç", "Ëá™ÁÑ∂ÁöÑ‰ºô‰º¥"]
        },
        lamp: {
            use: ["ÂºÄÁÅØÔºåÊàøÈó¥Âèò‰∫Æ‰∫Ü", "Êôö‰∏äÊúâÂÖâÂ∞±‰∏çÊÄï‰∫Ü", "Ê∏©ÊöñÁöÑÂÖâËäí"],
            near: ["Â§úÁÅØÂÆàÊä§ÁùÄÊàøÈó¥", "ÊúâÂÖâÂ∞±ÊúâÂÆâÂÖ®ÊÑü", "ÈªëÊöó‰∏≠ÁöÑÁÅØÂ°î"]
        },
        carpet: {
            use: ["Âú∞ÊØØËΩØËΩØÁöÑÔºåÂèØ‰ª•Âùê", "Ë∫∫Âú®ËøôÈáåÂæàËàíÊúç", "Ê∏©ÊöñÁöÑËßíËêΩ"],
            near: ["Âú∞ÊØØÂ•ΩÊüîËΩØ", "ÊÉ≥Âú®ËøôÈáå‰ºëÊÅØ", "ËàíÈÄÇÁöÑÂ∞èÂ§©Âú∞"]
        }
    };

    // Âü∫Á°ÄÁâ©ÂìÅÂ∫ì
    const baseItems = [
        { id: 'bread', name: 'ÂÖ®È∫¶Èù¢ÂåÖ', price: 20, type: 'food', val: 10, desc: 'ÊôÆÈÄöÁöÑÈ£üÁâ©', unlockCondition: null },
        { id: 'candy', name: 'ÊòüÊòüÁ≥ñ', price: 50, type: 'food', val: 20, desc: 'ÊàñËÆ∏ËÉΩËÆ©‰ªñÂºÄÂøÉ', unlockCondition: null },
    ];

    // Ëß£ÈîÅÁâ©ÂìÅÂ∫ì
    const unlockableItems = [
        { id: 'book', name: 'ÁªòÊú¨', price: 120, type: 'gift', val: 5, desc: 'Â§ñÈù¢‰∏ñÁïåÁöÑÁîª', unlockCondition: (s) => s.trust >= 25 },
        { id: 'radio', name: 'ÊóßÊî∂Èü≥Êú∫', price: 300, type: 'gift', val: 15, desc: 'Âè™ËÉΩÂèëÂá∫Ê≤ôÊ≤ôÂ£∞', unlockCondition: (s) => s.trust >= 45 },
        { id: 'teddy', name: 'Â∞èÁÜäÁé©ÂÅ∂', price: 200, type: 'gift', val: 25, desc: 'ËΩØËΩØÁöÑÈô™‰º¥', unlockCondition: (s) => s.trust >= 65 },
        { id: 'lamp', name: 'Â§úÁÅØ', price: 150, type: 'gift', val: 10, desc: 'ËÆ©ÊàøÈó¥Êõ¥Ê∏©Êöñ', unlockCondition: (s) => s.trust >= 35 },
        { id: 'cake', name: 'Â∞èËõãÁ≥ï', price: 80, type: 'food', val: 30, desc: 'ÁâπÂà´ÁöÑÁîúÁÇπ', unlockCondition: (s) => s.foodEaten >= 8 },
        { id: 'puzzle', name: 'ÊãºÂõæ', price: 250, type: 'gift', val: 20, desc: 'Ê∂àÁ£®Êó∂Èó¥ÁöÑÂ•Ω‰∏úË•ø', unlockCondition: (s) => s.day >= 15 },
        { id: 'blanket', name: 'ÊØõÊØØ', price: 180, type: 'gift', val: 15, desc: '‰øùÊöñÁî®ÁöÑ', unlockCondition: (s) => s.money >= 800 },
        { id: 'camera', name: 'ÊóßÁõ∏Êú∫', price: 400, type: 'gift', val: 30, desc: 'ËÆ∞ÂΩïÁû¨Èó¥', unlockCondition: (s) => s.trust >= 80 }
    ];

    // ÂÆ∂ÂÖ∑ÂïÜÂ∫ó - ‰øÆÂ§çÔºöÁªøÊ§çÊîπ‰∏∫ÂèØË¥≠‰π∞
    const furnitureItems = [
        {
            id: 'comfortable_bed',
            name: 'ËàíÈÄÇÂ∫äÈì∫',
            price: 300,
            emoji: 'üõèÔ∏è',
            desc: 'ËÆ©Â¥ΩÂ¥ΩÁù°ÂæóÊõ¥ËàíÊúç',
            effect: '‰ΩøÁî®ÂêéÊÅ¢Â§çÁ≤æÂäõ',
            position: { x: 240, y: 220 },
            size: '50px',
            useChance: 0.3
        },
        {
            id: 'study_desk',
            name: 'Â≠¶‰π†‰π¶Ê°å',
            price: 200,
            emoji: 'üìö',
            desc: 'Â¥ΩÂ¥ΩÂèØ‰ª•Âú®‰∏äÈù¢ÂÜôÊó•ËÆ∞',
            effect: '‰ΩøÁî®ÂêéÂ¢ûÂä†‰ø°‰ªª',
            position: { x: 50, y: 180 },
            size: '45px',
            useChance: 0.25
        },
        {
            id: 'bookshelf',
            name: 'Â∞è‰π¶Êû∂',
            price: 250,
            emoji: 'üìñ',
            desc: 'Â≠òÊîæ‰π¶Á±çÂíåÁâ©ÂìÅ',
            effect: 'Ë£ÖÈ•∞ÊàøÈó¥',
            position: { x: 260, y: 130 },
            size: '40px',
            useChance: 0.2
        },
        {
            id: 'green_plant', // ‰øÆÂ§çÔºöÁªøÊ§çÊîπ‰∏∫ÂèØË¥≠‰π∞
            name: 'ÁªøÊ§ç',
            price: 100,
            emoji: 'ü™¥',
            desc: 'ËÆ©ÊàøÈó¥Êõ¥ÊúâÁîüÊú∫',
            effect: 'ÊîπÂñÑÂøÉÊÉÖ',
            position: { x: 80, y: 100 }, // Ë∞ÉÊï¥ÁªøÊ§ç‰ΩçÁΩÆÔºåÈÅøÂÖçÈù†ËøëÁ™óÊà∑
            size: '45px',
            useChance: 0.15
        },
        {
            id: 'night_lamp',
            name: 'Â§úÁÅØ',
            price: 150,
            emoji: 'üí°',
            desc: 'Êôö‰∏äÊèê‰æõÊ∏©ÊöñÁöÑÂÖâ',
            effect: 'ÂáèÂ∞ëÊÅêÊÉß',
            position: { x: 180, y: 80 },
            size: '35px',
            useChance: 0.2
        },
        {
            id: 'soft_carpet',
            name: 'ÊüîËΩØÂú∞ÊØØ',
            price: 180,
            emoji: 'üß∏',
            desc: 'ÂùêÂú®Âú∞‰∏äÊõ¥ËàíÊúç',
            effect: 'Â¢ûÂä†ËàíÈÄÇÂ∫¶',
            position: { x: 130, y: 200 },
            size: '55px',
            useChance: 0.25
        }
    ];

    // ËÉåÊôØÁ≥ªÁªü
    const backgrounds = [
        { 
            id: 'default', 
            name: 'ÈªòËÆ§', 
            type: 'gradient',
            value: 'linear-gradient(180deg, #E3FDFD 0%, #FFFFFF 100%)' 
        },
        { 
            id: 'sunset', 
            name: 'Êó•ËêΩ', 
            type: 'gradient',
            value: 'linear-gradient(180deg, #FFD3A5 0%, #FD6585 100%)' 
        },
        { 
            id: 'night', 
            name: 'ÊòüÁ©∫', 
            type: 'gradient',
            value: 'linear-gradient(180deg, #0C164D 0%, #190B22 100%)' 
        },
        { 
            id: 'forest', 
            name: 'Ê£ÆÊûó', 
            type: 'gradient',
            value: 'linear-gradient(180deg, #C1DFC4 0%, #DEECDD 100%)' 
        },
        { 
            id: 'ocean', 
            name: 'Êµ∑Ê¥ã', 
            type: 'gradient',
            value: 'linear-gradient(180deg, #A1C4FD 0%, #C2E9FB 100%)' 
        },
        { 
            id: 'pastel', 
            name: 'È©¨Âç°Èæô', 
            type: 'gradient',
            value: 'linear-gradient(180deg, #FFD6E7 0%, #FFE6D6 100%)' 
        }
    ];
	// ÂçïÁã¨ÁöÑÂèòÈáèÊù•Â≠òÂÇ®Ëá™ÂÆö‰πâËÉåÊôØ - ‰øÆÂ§çÂà∑Êñ∞Âêé‰∏¢Â§±ÈóÆÈ¢ò
	// ‰ΩøÁî®varÂÆö‰πâ‰∏∫ÂÖ®Â±ÄÂèòÈáèÔºåÁ°Æ‰øùÊâÄÊúâÂáΩÊï∞ÈÉΩËÉΩËÆøÈóÆ
	var customBackgrounds = window.customBackgrounds = [];

    // ‰ªªÂä°ÂàóË°®
    // ‰ªªÂä°ÂàóË°® - ÊõøÊç¢ÂéüÊúâÁöÑtaskListÊï∞ÁªÑ
    const taskList = [
        // ÊØèÊó•‰ªªÂä°
        { 
            id: 'daily_login', 
            title: 'ÊØèÊó•ÁôªÂΩï', 
            desc: 'ÊØèÂ§©È¶ñÊ¨°ÁôªÂΩïÊ∏∏Êàè', 
            reward: 30, 
            progress: 0,
            maxProgress: 1,
            type: 'daily',
            action: 'claimDailyLogin'
        },
        { 
            id: 'feed_zaizai', 
            title: 'ÂñÇÈ£üÂ¥ΩÂ¥Ω', 
            desc: '‰ΩøÁî®‰ªªÊÑèÈ£üÁâ©ÂñÇÈ£üÂ¥ΩÂ¥Ω', 
            reward: 25, 
            progress: 0,
            maxProgress: 1,
            type: 'daily',
            action: 'claimFeedTask'
        },
        { 
            id: 'play_with_zaizai', 
            title: '‰∏éÂ¥ΩÂ¥Ω‰∫íÂä®', 
            desc: 'Êë∏Â§¥ÊàñÊà≥Êà≥Â¥ΩÂ¥Ω5Ê¨°', 
            reward: 20, 
            progress: 0,
            maxProgress: 5,
            type: 'daily',
            action: 'incrementInteraction'
        },
        { 
            id: 'complete_schedule', 
            title: 'ÂÆåÊàêÊó•Á®ã', 
            desc: 'ÊâßË°å‰ªªÊÑèÊó•Á®ãË°åÂä®', 
            reward: 40, 
            progress: 0,
            maxProgress: 1,
            type: 'daily',
            action: 'completeSchedule'
        },
        { 
            id: 'buy_item', 
            title: 'Ë¥≠‰π∞ÂïÜÂìÅ', 
            desc: 'Âú®ÂïÜÂ∫óË¥≠‰π∞‰ªªÊÑèÂïÜÂìÅ', 
            reward: 15, 
            progress: 0,
            maxProgress: 1,
            type: 'daily',
            action: 'buyItem'
        },
        { 
            id: 'read_diary', 
            title: 'ÈòÖËØªÊó•ËÆ∞', 
            desc: 'ÂÅ∑ÁúãÂ¥ΩÂ¥ΩÁöÑÊó•ËÆ∞', 
            reward: 35, 
            progress: 0,
            maxProgress: 1,
            type: 'daily',
            action: 'readDiary'
        },
        { 
            id: 'play_game', 
            title: 'Áé©Â∞èÊ∏∏Êàè', 
            desc: 'ÂÆåÊàê‰ªªÊÑèÂ∞èÊ∏∏Êàè', 
            reward: 30, 
            progress: 0,
            maxProgress: 1,
            type: 'daily',
            action: 'playGame'
        },
        
        // ËøõÂ∫¶‰ªªÂä°
        { 
            id: 'increase_trust', 
            title: 'ÊèêÂçá‰ø°‰ªª', 
            desc: 'ÊèêÂçá‰ø°‰ªªÂÄº10ÁÇπ', 
            reward: 50, 
            progress: 0,
            maxProgress: 10,
            type: 'progress',
            action: 'increaseTrust'
        },
        
        // ÊàêÂ∞±‰ªªÂä°
        { 
            id: 'buy_furniture', 
            title: 'Ë¥≠‰π∞ÂÆ∂ÂÖ∑', 
            desc: 'Âú®ÊîπÈÄ†ÂïÜÂ∫óË¥≠‰π∞ÂÆ∂ÂÖ∑', 
            reward: 45, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'buyFurniture'
        },
        { 
            id: 'first_feed', 
            title: 'ÂàùÊ¨°ÂñÇÈ£ü', 
            desc: 'Á¨¨‰∏ÄÊ¨°ÂñÇÈ£üÂ¥ΩÂ¥Ω', 
            reward: 30, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'feed'
        },
        { 
            id: 'first_gift', 
            title: 'ÂàùÊ¨°ÈÄÅÁ§º', 
            desc: 'Á¨¨‰∏ÄÊ¨°ÁªôÂ¥ΩÂ¥ΩÈÄÅÁ§ºÁâ©', 
            reward: 30, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'gift'
        },
        { 
            id: 'first_diary', 
            title: 'ÂàùÊ¨°ËØªÊó•ËÆ∞', 
            desc: 'Á¨¨‰∏ÄÊ¨°ÈòÖËØªÂ¥ΩÂ¥ΩÁöÑÊó•ËÆ∞', 
            reward: 40, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'readDiary'
        },
        { 
            id: 'trust_30', 
            title: 'ÂàùÊ≠•‰ø°‰ªª', 
            desc: '‰ø°‰ªªÂÄºËææÂà∞30ÁÇπ', 
            reward: 60, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'increaseTrust'
        },
        { 
            id: 'trust_60', 
            title: 'Ê∑±Âéö‰ø°‰ªª', 
            desc: '‰ø°‰ªªÂÄºËææÂà∞60ÁÇπ', 
            reward: 100, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'increaseTrust'
        },
        { 
            id: 'trust_100', 
            title: 'ÂÆåÂÖ®‰ø°‰ªª', 
            desc: '‰ø°‰ªªÂÄºËææÂà∞100ÁÇπ', 
            reward: 200, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'increaseTrust'
        },
        { 
            id: 'feed_10', 
            title: 'ÂñÇÈ£üËææ‰∫∫', 
            desc: 'Á¥ØÁßØÂñÇÈ£ü10Ê¨°', 
            reward: 80, 
            progress: 0,
            maxProgress: 10,
            type: 'achievement',
            action: 'feed'
        },
        { 
            id: 'interact_50', 
            title: '‰∫íÂä®‰∏ìÂÆ∂', 
            desc: 'Á¥ØÁßØ‰∏éÂ¥ΩÂ¥Ω‰∫íÂä®50Ê¨°', 
            reward: 120, 
            progress: 0,
            maxProgress: 50,
            type: 'achievement',
            action: 'interact'
        },
        { 
            id: 'collect_all_furniture', 
            title: 'ÂÆ∂ÂÖ∑Êî∂ËóèÂÆ∂', 
            desc: 'Ë¥≠‰π∞ÊâÄÊúâÂÆ∂ÂÖ∑', 
            reward: 300, 
            progress: 0,
            maxProgress: 1, // Ëøô‰∏™‰ºöÊ†πÊçÆÂÆûÈôÖÂÆ∂ÂÖ∑Êï∞ÈáèÂä®ÊÄÅËÆ°ÁÆó
            type: 'achievement',
            action: 'buyFurniture'
        },
        
        // Êñ∞Â¢ûÈïøÁ∫øËøõÂ∫¶‰ªªÂä°
        { 
            id: 'collect_diary_entries', 
            title: 'Êî∂ÈõÜÊó•ËÆ∞', 
            desc: 'Êî∂ÈõÜ10ÁØáÊó•ËÆ∞', 
            reward: 200, 
            progress: 0,
            maxProgress: 10,
            type: 'progress',
            action: 'collectDiaryEntries'
        },
        { 
            id: 'accumulate_money', 
            title: 'ÁßØÁ¥ØË¥¢ÂØå', 
            desc: 'ÁßØÁ¥Ø1000ÈáëÂ∏Å', 
            reward: 300, 
            progress: 0,
            maxProgress: 10,
            type: 'progress',
            action: 'accumulateMoney'
        },
        { 
            id: 'interact_multiple_times', 
            title: 'È¢ëÁπÅ‰∫íÂä®', 
            desc: '‰∏éÂ¥ΩÂ¥Ω‰∫íÂä®50Ê¨°', 
            reward: 150, 
            progress: 0,
            maxProgress: 50,
            type: 'progress',
            action: 'interactMultipleTimes'
        },
        { 
            id: 'try_different_weather', 
            title: '‰ΩìÈ™åÂ§©Ê∞î', 
            desc: '‰ΩìÈ™å5Áßç‰∏çÂêåÂ§©Ê∞î', 
            reward: 100, 
            progress: 0,
            maxProgress: 5,
            type: 'progress',
            action: 'tryDifferentWeather'
        }
    ];

    // Êó•Á®ãË°åÂä®Êï∞ÊçÆ
    const scheduleActions = [
        {
            id: 'clean',
            name: 'ÊâìÊâ´ÊàøÈó¥',
            time: 1,
            reward: 20,
            hungerCost: 5,
            trustGain: 0.5,
            desc: 'Â¥ΩÂ¥Ω‰ºöËÆ§ÁúüÊâìÊâ´ÊàøÈó¥Ôºå‰øùÊåÅÁéØÂ¢ÉÊï¥Ê¥Å',
            risk: 0
        },
        {
            id: 'work',
            name: 'ËßÇÂØüËÆ∞ÂΩï',
            time: 2,
            reward: 50,
            hungerCost: 10,
            trustGain: 1,
            desc: 'Â¥ΩÂ¥Ω‰ºöËÆ∞ÂΩïËßÇÂØüÂà∞ÁöÑÂºÇÂ∏∏Áé∞Ë±°',
            risk: 0
        },
        {
            id: 'talk',
            name: 'Â∞ùËØïÊ≤üÈÄö',
            time: 3,
            reward: 0,
            hungerCost: 15,
            trustGain: 2,
            desc: 'Â¥ΩÂ¥Ω‰ºöÂ∞ùËØï‰∏é‰Ω†Âª∫Á´ãÊõ¥Ê∑±Â±ÇÁöÑËÅîÁ≥ª',
            risk: 0
        },
        {
            id: 'explore',
            name: 'Â§ñÂá∫Êé¢Á¥¢',
            time: 4,
            reward: 80,
            hungerCost: 20,
            trustGain: 1.5,
            desc: 'Â¥ΩÂ¥Ω‰ºöÁ¶ªÂºÄÊàøÈó¥ËøõË°åÁü≠ÈÄîÊé¢Á¥¢',
            risk: 0.3
        }
    ];

    // ÂâßÊÉÖÂ§ßÁ∫≤
    const storyChapters = [
        { 
            t: 0, 
            title: "CHAPTER 1: ÂºÇÂ∏∏‰∏ãËΩΩ", 
            content: "‰Ω†Âú®‰∏Ä‰∏™Ê∑±Â§ú‰∏ãËΩΩ‰∫Ü‰∏ÄÊ¨æÂêç‰∏∫„ÄåÂºÇÁïåËßÇÊµãÁ™óÂè£„ÄçÁöÑÂ∫îÁî®„ÄÇ<br>ÁÆÄ‰ªãÂÜôÈÅìÔºö„ÄéËßÇÊµãÂè¶‰∏Ä‰∏™‰∏ñÁïåÁöÑÁ™óÂè£Ôºå‰Ω†ÊâÄÂÅöÁöÑ‰∏ÄÂàáÈÉΩÂ∞ÜÂΩ±ÂìçÈÇ£‰∏™‰∏ñÁïå„Äè„ÄÇ<br>ÂΩì‰Ω†ÊâìÂºÄÂ∫îÁî®Êó∂ÔºåÂ±èÂπïÈáåÂá∫Áé∞‰∫Ü‰∏Ä‰∏™ÁúãËµ∑Êù•Ë≠¶ÊÉï‰∏çÂÆâÁöÑÂ≠©Â≠ê„ÄÇ<br><br>Á≥ªÁªüÊèêÁ§∫Ôºö„ÄêËßÇÊµãËÄÖÊùÉÈôêÂ∑≤ÊøÄÊ¥ª„ÄÇÁõÆÊ†áÔºöÊú™Áü•ÁîüÂëΩ‰Ωì„ÄÇÁä∂ÊÄÅÔºöÊûÅÂ∫¶Ë≠¶ÊÉï„Äë",
            choices: [
                { text: "ÁªßÁª≠ËßÇÂØü", effect: () => addTrust(0.5) },
                { text: "Â∞ùËØïÁÇπÂáªÂ±èÂπï", effect: () => { showDialogue('touch'); addTrust(1); } },
                { text: "ÂÖ≥Èó≠Â∫îÁî®", effect: () => { showToast("‰Ω†Êó†Ê≥ïÂÖ≥Èó≠Ëøô‰∏™Â∫îÁî®..."); addTrust(0.2); } }
            ]
        }
    ];

    // === ËßÇÊµãËÆ∞ÂΩïÁ≥ªÁªü ===
    const recordSystem = {
        addRecord: function(title, content, tags = []) {
            const record = {
                id: Date.now(),
                title: title,
                content: content,
                tags: tags,
                time: new Date().toLocaleString(),
                gameDay: state.day,
                trustLevel: Math.floor(state.trust)
            };
            
            if (!state.records) state.records = [];
            state.records.unshift(record);
            
            if (state.records.length > 50) {
                state.records = state.records.slice(0, 50);
            }
            
            saveState();
            
            if (document.getElementById('record-modal').style.display === 'flex') {
                renderRecords();
            }
        },
        
        recordTrustChange: function(oldTrust, newTrust) {
            const change = newTrust - oldTrust;
            if (Math.abs(change) >= 5) {
                const direction = change > 0 ? 'ÊèêÂçá' : '‰∏ãÈôç';
                const level = this.getTrustLevel(newTrust);
                const oldLevel = this.getTrustLevel(oldTrust);
                
                if (oldLevel !== level) {
                    this.addRecord(
                        `‰ø°‰ªªÂÄº${direction}Ëá≥${level}`,
                        `ËßÇÊµãÂØπË±°‰ø°‰ªªÂÄº‰ªé ${oldTrust.toFixed(1)} ${direction}Âà∞ ${newTrust.toFixed(1)}„ÄÇ‰ø°‰ªªÁ≠âÁ∫ßÂèòÂåñÔºö${oldLevel} ‚Üí ${level}„ÄÇ`,
                        ['trust', 'ÂøÉÁêÜÂèòÂåñ']
                    );
                }
            }
        },
        
        recordMoodChange: function(oldMood, newMood) {
            if (oldMood !== newMood) {
                this.addRecord(
                    `ÂøÉÊÉÖÂèòÂåñÔºö${moodTypes[oldMood]?.name || 'Êú™Áü•'} ‚Üí ${moodTypes[newMood]?.name || 'Êú™Áü•'}`,
                    `ËßÇÊµãÂØπË±°ÊÉÖÁª™Áä∂ÊÄÅÂèëÁîüÂèòÂåñ„ÄÇÂèØËÉΩÂéüÂõ†Ôºö‰∫íÂä®È¢ëÁéá„ÄÅÁéØÂ¢ÉÂèòÂåñ„ÄÅ‰ø°‰ªªÂ∫¶ÊîπÂèòÁ≠â„ÄÇÂΩìÂâçÊÉÖÁª™Ôºö${moodTypes[newMood]?.name}„ÄÇ`,
                    ['mood', 'ÂøÉÁêÜÂèòÂåñ']
                );
            }
        },
        
        recordStoryProgress: function(chapterTitle) {
            this.addRecord(
                `ÂâßÊÉÖËøõÂ±ïÔºö${chapterTitle}`,
                `ËßÇÊµãËÄÖ‰∏éËßÇÊµãÂØπË±°ÁöÑÂÖ≥Á≥ªËøõÂÖ•Êñ∞Èò∂ÊÆµ„ÄÇÂâßÊÉÖÁ´†ËäÇËß£ÈîÅÔºö${chapterTitle}„ÄÇ`,
                ['story', '‰∫ã‰ª∂']
            );
        },
        
        recordKeyInteraction: function(type, details) {
            let title = '';
            let content = '';
            
            switch(type) {
                case 'first_feed':
                    title = 'È¶ñÊ¨°ÂñÇÈ£ü';
                    content = 'ËßÇÊµãÂØπË±°Êé•Âèó‰∫ÜËßÇÊµãËÄÖÊèê‰æõÁöÑÈ£üÁâ©„ÄÇËøôÊòØÂèåÊñπÂª∫Á´ã‰ø°‰ªªÂÖ≥Á≥ªÁöÑÈáçË¶ÅÈáåÁ®ãÁ¢ë„ÄÇ';
                    break;
                case 'first_gift':
                    title = 'È¶ñÊ¨°Ëµ†ÈÄÅÁ§ºÁâ©';
                    content = `ËßÇÊµãÂØπË±°Êî∂Âà∞‰∫ÜËßÇÊµãËÄÖËµ†ÈÄÅÁöÑ${details}„ÄÇËßÇÊµãÂØπË±°Ë°®Áé∞Âá∫Â•ΩÂ•á‰∏éÊÑüË∞¢„ÄÇ`;
                    break;
                case 'first_diary':
                    title = 'È¶ñÊ¨°ÂèëÁé∞Êó•ËÆ∞';
                    content = 'ËßÇÊµãÂØπË±°ÁöÑÊó•ËÆ∞Ë¢´ÂèëÁé∞„ÄÇÊó•ËÆ∞ÂÜÖÂÆπÊòæÁ§∫ËßÇÊµãÂØπË±°Â∑≤ÂºÄÂßãËÆ∞ÂΩïËá™Ë∫´ÊÑüÂèó‰∏éÊÄùËÄÉ„ÄÇ';
                    break;
                case 'first_furniture':
                    title = 'È¶ñÊ¨°Ë¥≠‰π∞ÂÆ∂ÂÖ∑';
                    content = `ËßÇÊµãËÄÖ‰∏∫ÊàøÈó¥Ê∑ªÁΩÆ‰∫Ü${details}„ÄÇËßÇÊµãÁéØÂ¢ÉËàíÈÄÇÂ∫¶ÊèêÂçá„ÄÇ`;
                    break;
            }
            
            if (title && content) {
                this.addRecord(title, content, ['‰∫íÂä®', 'ÈáåÁ®ãÁ¢ë']);
            }
        },
        
        getTrustLevel: function(trustValue) {
            if (trustValue >= 85) return 'Ê∑±Â∫¶‰æùËµñ';
            else if (trustValue >= 70) return 'È´òÂ∫¶‰ø°‰ªª';
            else if (trustValue >= 50) return 'Âü∫Êú¨‰ø°‰ªª';
            else if (trustValue >= 30) return 'ÂàùÊ≠•‰ø°‰ªª';
            else if (trustValue >= 15) return 'ËØïÊé¢Èò∂ÊÆµ';
            else return 'ÊûÅÂ∫¶Ë≠¶ÊÉï';
        }
    };

    // Áï™ËåÑÈíüÂØπËØù
    const pomodoroDialogue = {
        start: [
            "Ë¶ÅÂºÄÂßã‰∏ìÊ≥®‰∫ÜÂêóÔºüÂä†Ê≤πÔºÅ",
            "Êàë‰ºöÂú®ËøôÈáåÈô™ÁùÄ‰Ω†",
            "‰∏ìÂøÉÂÅö‰∫ãÔºåÊàë‰ºöÂÆâÈùôÂæÖÁùÄ",
            "ÂºÄÂßãÂêßÔºÅÊàëÁõ∏‰ø°‰Ω†ËÉΩË°å"
        ],
        tick: [
            "Êó∂Èó¥Âú®ÊµÅÈÄù...",
            "‰øùÊåÅ‰∏ìÊ≥®",
            "‰∏çË¶ÅÂàÜÂøÉÂì¶",
            "ÂÅöÂæóÂæàÂ•ΩÔºåÁªßÁª≠"
        ],
        poke: [
            "ÊÄé‰πà‰∫ÜÔºüË¶Å‰∏ìÂøÉÂì¶",
            "Âà´Êà≥ÊàëÂï¶ÔºåÂø´ÂõûÂéªÂÅö‰∫ã",
            "Êó∂Èó¥ËøòÊ≤°Âà∞Âë¢",
            "ÊàëÂú®ËøôÈáåÔºå‰ΩÜ‰Ω†Âæó‰∏ìÂøÉ",
            "Êà≥Êà≥ÂèØ‰ª•Ôºå‰ΩÜÂà´Â§™‰πÖ",
            "‰∏ìÂøÉÔºÅ‰∏ìÂøÉÔºÅ",
            "ËøòÊúâÊó∂Èó¥ÔºåÂä†Ê≤π",
            "‰∏çË¶ÅÂàÜÂøÉÂ§™Â§öÊ¨°Âì¶"
        ],
        almost: [
            "Âø´Âà∞‰∫ÜÔºÅÂùöÊåÅ‰∏Ä‰∏ã",
            "ÊúÄÂêéÂá†ÂàÜÈíü‰∫Ü",
            "È©¨‰∏äÂ∞±ÂÆåÊàê‰∫Ü",
            "ËÉúÂà©Âú®ÊúõÔºÅ"
        ],
        finish: [
            "ÂÆåÊàê‰∫ÜÔºÅÂ•ΩÊ£íÔºÅ",
            "ËæõËã¶Âï¶Ôºå‰ºëÊÅØ‰∏Ä‰∏ãÂêß",
            "ÂÅöÂæóÂ•ΩÔºÅÁúü‰∏∫‰Ω†È™ÑÂÇ≤",
            "‰∏ìÊ≥®Êó∂Èó¥ÁªìÊùüÔºåËØ•‰ºëÊÅØ‰∫Ü"
        ],
        cancel: [
            "ÊîæÂºÉ‰∫ÜÂêó...Ê≤°ÂÖ≥Á≥ª",
            "‰∏ãÊ¨°ÂÜçÂä™ÂäõÂêß",
            "‰ºëÊÅØ‰∏Ä‰∏ã‰πüÂ•Ω",
            "‰∏çË¶ÅÁÅ∞ÂøÉÔºå‰∏ãÊ¨°ÂÜçÊù•"
        ]
    };

    // Ê∏∏ÊàèÁä∂ÊÄÅ - ‰øÆÂ§çÔºöÂàùÂßãÂåñÊõ¥ÂÆåÊï¥ÁöÑÁä∂ÊÄÅ
    let state = {
        day: 1,
        money: 100,
        hunger: 50,
        trust: 0,
        inventory: [],
        foodEaten: 0,
        unlockedDiaries: [],
        unlockedItems: [],
        purchasedFurniture: [],
        currentChapter: 0,
        customAvatar: null,
        lastLoginDate: null,
        lastDailyReset: null,
        weatherHistory: [],
        tasks: [], // ÂàùÂßãÂåñ‰∏∫Á©∫Êï∞ÁªÑÔºåÂú®loadState‰∏≠‰ºöÂ°´ÂÖÖ
        interactionCount: 0,
        dailyLoginClaimed: false,
        feedTaskClaimed: false,
        buyTaskClaimed: false,
        scheduleTaskClaimed: false,
        diaryTaskClaimed: false,
        furnitureTaskClaimed: false,
        gameTaskClaimed: false,
        lastScheduleTime: null,
        characterPosition: { x: 115, y: 200 },
        lastDiaryRead: null,
        chatHistory: [],
        lastActiveChat: 0,
        furnitureUsage: {},
        storyChoices: [],
        currentWeather: 'cloudy',
        lastWeatherChange: 0,
        currentMood: 'anxious',
        lastMoodChange: 0,
        moodValue: 150,
        moodDuration: 0,
        diaryEntries: [],
        lastDiaryGeneration: 0,
        memos: [],
        lastMemoCheck: 0,
        memoReminded: false,
        lastTrustGain: 0,
        trustCooldown: false,
        moodChangeCooldown: 0,
        consecutivePositiveInteractions: 0,
        consecutiveNegativeInteractions: 0,
        records: [],
        gameHistory: [],
        firstFeedDone: false,
        firstGiftDone: false,
        firstDiaryRead: false,
        firstFurnitureBought: false,
        currentBackground: 'default',
        // Êñ∞Â¢ûÔºöÂøÉÊÉÖË°∞ÂáèÁõ∏ÂÖ≥
        moodStartTime: Date.now(),
        moodStability: 50
    };

    // ÂΩìÂâçÈÄâÊã©ÁöÑÂ§¥ÂÉèÊñá‰ª∂
    let selectedAvatarFile = null;
    let autoChatTimer = null;
    let moodDecayTimer = null;
    let autoSaveTimer = null; // Ëá™Âä®‰øùÂ≠òÂÆöÊó∂Âô®
    
    // Êï∞ÊçÆÂ≠òÂÇ®‰ºòÂåñÂèòÈáè
    let lastSavedState = null; // ÂÜÖÂ≠òÁºìÂ≠òÔºåÂ≠òÂÇ®ÊúÄÂêé‰øùÂ≠òÁöÑÁä∂ÊÄÅ
    let isSaving = false; // Èò≤Ê≠¢Âπ∂Âèë‰øùÂ≠ò
    let saveTimeout = null; // Èò≤ÊäñÂÆöÊó∂Âô®
    
    // Â∞èÊ∏∏ÊàèÂèòÈáè
    let game2048 = {
        grid: [],
        score: 0,
        gameOver: false,
        tiles: [],
        initialized: false,
        touchDirection: null,
        touchInterval: null,
        startX: 0,
        startY: 0
    };
    
    let brickBreaker = {
        canvas: null,
        ctx: null,
        paddle: { x: 150, y: 380, width: 80, height: 10 },
        ball: { x: 150, y: 370, radius: 8, dx: 3, dy: -3 },
        bricks: [],
        score: 0,
        gameRunning: false,
        animationId: null,
        paddleSpeed: 5,
        paddleDirection: 0,
        touchInterval: null
    };
    
    let tetris = {
        canvas: null,
        ctx: null,
        grid: [],
        currentPiece: null,
        nextPiece: null,
        score: 0,
        gameOver: false,
        dropCounter: 0,
        dropInterval: 1000,
        lastTime: 0,
        animationId: null,
        touchAction: null,
        touchInterval: null,
        blockSize: 20
    };

    // Áï™ËåÑÈíüÁ≥ªÁªü
    let pomodoro = {
        timer: null,
        timeLeft: 1500,
        totalTime: 1500,
        isRunning: false,
        isPaused: false,
        currentTask: '',
        tasks: [],
        inFullscreen: false
    };

    // === ÂàùÂßãÂåñ ===
    window.onload = function() {
        loadState();
        initCharacterPosition();
        initCharacterDragFixed();
        initCharacterTouch();
        
        document.getElementById('avatar-upload-input').addEventListener('change', handleAvatarUpload);
        document.getElementById('bg-upload-input').addEventListener('change', handleBackgroundUpload);
        
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChat();
            }
        });
        
        document.getElementById('memo-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addMemo();
            }
        });
        
        renderTaskList();
        checkItemUnlocks();
        renderFurniture();
        initWeather();
        updateMoodIndicator();
        renderMemos();
        renderRecords();
        startAutoChat();
        startMoodDecayTimer();
        initBackground();

        // Á°Æ‰øùÊâÄÊúâ‰ªªÂä°ËøõÂ∫¶ÈÉΩÊ≠£Á°Æ
        setTimeout(() => {
            // Êõ¥Êñ∞ÊâÄÊúâ‰ªªÂä°ÁöÑËøõÂ∫¶
            if (state.tasks && state.tasks.length > 0) {
                state.tasks.forEach(task => {
                    updateTaskProgress(task.id);
                });
            }
        }, 1000);

        updateUI();
        checkStoryProgress();
        
        if (state.records.length === 0) {
            recordSystem.addRecord(
                'ËßÇÊµãÂºÄÂßã',
                'ÂºÇÁïåËßÇÊµãÁ™óÂè£Â∫îÁî®ÂêØÂä®„ÄÇÊ£ÄÊµãÂà∞Êú™Áü•ÁîüÂëΩ‰ΩìÔºåÊ†áËÆ∞‰∏∫"Â¥ΩÂ¥Ω"„ÄÇËßÇÊµãËÄÖÊùÉÈôêÂ∑≤ÊøÄÊ¥ªÔºåÂºÄÂßãËÆ∞ÂΩï‰∫§‰∫íÊï∞ÊçÆ„ÄÇ',
                ['Á≥ªÁªü', 'ÂºÄÂßã']
            );
        }
        
        // ÂêØÂä®Ëá™Âä®‰øùÂ≠òÔºåÊØè30Áßí‰øùÂ≠ò‰∏ÄÊ¨°
        autoSaveTimer = setInterval(() => {
            saveStateImmediately();
        }, 30000);
        
        // È°µÈù¢Âç∏ËΩΩÂâç‰øùÂ≠òÁä∂ÊÄÅ
        window.addEventListener('beforeunload', () => {
            saveStateImmediately();
            if (autoSaveTimer) {
                clearInterval(autoSaveTimer);
            }
        });
    };

    // === ‰øùÂ≠ò/Âä†ËΩΩÁä∂ÊÄÅ - ‰øÆÂ§çÔºöÊõ¥ÂÆåÊï¥ÁöÑÊï∞ÊçÆÂ≠òÂÇ® ===
    
    // Ê∑±ÊØîËæÉ‰∏§‰∏™ÂØπË±°ÔºåÂà§Êñ≠ÊòØÂê¶ÈúÄË¶Å‰øùÂ≠ò
    function deepCompare(obj1, obj2) {
        if (obj1 === obj2) return true;
        if (typeof obj1 !== 'object' || obj1 === null || typeof obj2 !== 'object' || obj2 === null) {
            return false;
        }
        
        const keys1 = Object.keys(obj1);
        const keys2 = Object.keys(obj2);
        if (keys1.length !== keys2.length) return false;
        
        for (const key of keys1) {
            if (!keys2.includes(key) || !deepCompare(obj1[key], obj2[key])) {
                return false;
            }
        }
        return true;
    }
    
    // Á´ãÂç≥‰øùÂ≠òÁä∂ÊÄÅÔºå‰∏ç‰ΩøÁî®Èò≤Êäñ
    function saveStateImmediately() {
        if (isSaving) return;
        
        isSaving = true;
        
        try {
            // Êï∞ÊçÆÈ™åËØÅÔºöÁ°Æ‰øùÂÖ≥ÈîÆÊï∞ÊçÆÁ±ªÂûãÊ≠£Á°Æ
            if (typeof state.day !== 'number' || state.day < 1) state.day = 1;
            if (typeof state.money !== 'number') state.money = 0;
            if (typeof state.hunger !== 'number') state.hunger = 50;
            if (typeof state.trust !== 'number') state.trust = 0;
            
            // Á°Æ‰øùÊï∞ÁªÑÂ≠óÊÆµÊúâÊïà
            if (!Array.isArray(state.inventory)) state.inventory = [];
            if (!Array.isArray(state.unlockedDiaries)) state.unlockedDiaries = [];
            if (!Array.isArray(state.unlockedItems)) state.unlockedItems = [];
            if (!Array.isArray(state.purchasedFurniture)) state.purchasedFurniture = [];
            if (!Array.isArray(state.tasks)) state.tasks = [];
            if (!Array.isArray(state.weatherHistory)) state.weatherHistory = [];
            if (!Array.isArray(state.chatHistory)) state.chatHistory = [];
            if (!Array.isArray(state.storyChoices)) state.storyChoices = [];
            if (!Array.isArray(state.diaryEntries)) state.diaryEntries = [];
            if (!Array.isArray(state.memos)) state.memos = [];
            if (!Array.isArray(state.records)) state.records = [];
            if (!Array.isArray(state.gameHistory)) state.gameHistory = [];
            
            // Á°Æ‰øùÂØπË±°Â≠óÊÆµÊúâÊïà
            if (typeof state.characterPosition !== 'object' || state.characterPosition === null) {
                state.characterPosition = { x: 115, y: 200 };
            }
            if (typeof state.furnitureUsage !== 'object' || state.furnitureUsage === null) {
                state.furnitureUsage = {};
            }
            
            // Á°Æ‰øùÂ≠óÁ¨¶‰∏≤Â≠óÊÆµÊúâÊïà
            if (typeof state.currentMood !== 'string') state.currentMood = 'anxious';
            if (typeof state.currentWeather !== 'string') state.currentWeather = 'cloudy';
            if (typeof state.currentBackground !== 'string') state.currentBackground = 'default';
            
            // Á°Æ‰øùÂ∏ÉÂ∞îÂ≠óÊÆµÊúâÊïà
            if (typeof state.dailyLoginClaimed !== 'boolean') state.dailyLoginClaimed = false;
            if (typeof state.feedTaskClaimed !== 'boolean') state.feedTaskClaimed = false;
            if (typeof state.buyTaskClaimed !== 'boolean') state.buyTaskClaimed = false;
            if (typeof state.scheduleTaskClaimed !== 'boolean') state.scheduleTaskClaimed = false;
            if (typeof state.diaryTaskClaimed !== 'boolean') state.diaryTaskClaimed = false;
            if (typeof state.furnitureTaskClaimed !== 'boolean') state.furnitureTaskClaimed = false;
            if (typeof state.gameTaskClaimed !== 'boolean') state.gameTaskClaimed = false;
            if (typeof state.trustCooldown !== 'boolean') state.trustCooldown = false;
            if (typeof state.memoReminded !== 'boolean') state.memoReminded = false;
            
            // Á°Æ‰øùÊâÄÊúâÈáçË¶ÅÊï∞ÊçÆÈÉΩË¢´‰øùÂ≠ò
            const saveData = {
                version: '4.5',
                day: state.day,
                money: state.money,
                hunger: state.hunger,
                trust: state.trust,
                inventory: state.inventory,
                foodEaten: state.foodEaten,
                unlockedDiaries: state.unlockedDiaries,
                unlockedItems: state.unlockedItems,
                purchasedFurniture: state.purchasedFurniture,
                currentChapter: state.currentChapter,
                customAvatar: state.customAvatar,
                lastLoginDate: state.lastLoginDate,
                lastDailyReset: state.lastDailyReset,
                tasks: state.tasks,
                interactionCount: state.interactionCount,
                dailyLoginClaimed: state.dailyLoginClaimed,
                feedTaskClaimed: state.feedTaskClaimed,
                buyTaskClaimed: state.buyTaskClaimed,
                scheduleTaskClaimed: state.scheduleTaskClaimed,
                diaryTaskClaimed: state.diaryTaskClaimed,
                furnitureTaskClaimed: state.furnitureTaskClaimed,
                gameTaskClaimed: state.gameTaskClaimed,
                weatherHistory: state.weatherHistory,
                lastScheduleTime: state.lastScheduleTime,
                characterPosition: state.characterPosition,
                lastDiaryRead: state.lastDiaryRead,
                chatHistory: state.chatHistory,
                lastActiveChat: state.lastActiveChat,
                furnitureUsage: state.furnitureUsage,
                storyChoices: state.storyChoices,
                currentWeather: state.currentWeather,
                lastWeatherChange: state.lastWeatherChange,
                currentMood: state.currentMood,
                lastMoodChange: state.lastMoodChange,
                moodValue: state.moodValue,
                moodDuration: state.moodDuration || 0,
                moodStartTime: state.moodStartTime || Date.now(),
                moodStability: state.moodStability || 50,
                diaryEntries: state.diaryEntries,
                lastDiaryGeneration: state.lastDiaryGeneration,
                memos: state.memos,
                lastMemoCheck: state.lastMemoCheck,
                memoReminded: state.memoReminded,
                lastTrustGain: state.lastTrustGain,
                trustCooldown: state.trustCooldown,
                moodChangeCooldown: state.moodChangeCooldown,
                consecutivePositiveInteractions: state.consecutivePositiveInteractions,
                consecutiveNegativeInteractions: state.consecutiveNegativeInteractions,
                records: state.records,
                gameHistory: state.gameHistory,
                firstFeedDone: state.firstFeedDone,
                firstGiftDone: state.firstGiftDone,
                firstDiaryRead: state.firstDiaryRead,
                firstFurnitureBought: state.firstFurnitureBought,
                currentBackground: state.currentBackground,
			// ‰øùÂ≠òËá™ÂÆö‰πâËÉåÊôØ
			customBackgrounds: window.customBackgrounds
            };
            
            // Â∞ùËØïÂ∫èÂàóÂåñÔºåÁ°Æ‰øùÊï∞ÊçÆÂèØJSONÂåñ
            const jsonString = JSON.stringify(saveData);
            
            // Â¢ûÈáè‰øùÂ≠òÔºöÂè™ÊúâÂΩìÊï∞ÊçÆÂèëÁîüÂèòÂåñÊó∂Êâç‰øùÂ≠ò
            if (!lastSavedState || !deepCompare(saveData, lastSavedState)) {
                // Ê£ÄÊü•localStorageÂèØÁî®ÊÄß
                if (localStorage && typeof Storage !== 'undefined') {
                    localStorage.setItem('zaizai_game_state', jsonString);
                    localStorage.setItem('zaizai_game_version', '4.5');
                    
                    // Êõ¥Êñ∞ÂÜÖÂ≠òÁºìÂ≠òÔºåÂ§çÁî®Â∑≤Â∫èÂàóÂåñÁöÑÂ≠óÁ¨¶‰∏≤‰ª•ÊèêÈ´òÊÄßËÉΩ
                    lastSavedState = JSON.parse(jsonString);
                }
            }
        } catch (e) {
            console.error('‰øùÂ≠òÁä∂ÊÄÅÂ§±Ë¥•:', e);
        } finally {
            isSaving = false;
        }
    }
    
    function saveState() {
        // Â¶ÇÊûúÊ≠£Âú®‰øùÂ≠òÊàñÂ∑≤Êúâ‰øùÂ≠ò‰ªªÂä°ÔºåÂàôÂèñÊ∂à‰πãÂâçÁöÑ‰øùÂ≠ò‰ªªÂä°
        if (saveTimeout) {
            clearTimeout(saveTimeout);
        }
        
        // ËÆæÁΩÆÈò≤ÊäñÂª∂ËøüÔºå500msÂÜÖÂè™ÊâßË°å‰∏ÄÊ¨°‰øùÂ≠ò
        saveTimeout = setTimeout(() => {
            saveStateImmediately();
        }, 500);
    }

    function loadState() {
        try {
            const saved = localStorage.getItem('zaizai_game_state');
            const version = localStorage.getItem('zaizai_game_version');
            
            if (saved) {
                const parsed = JSON.parse(saved);
                
                // ÁâàÊú¨ËøÅÁßªÈÄªËæë
                if (version !== '4.5') {
                    console.log('Ê£ÄÊµãÂà∞ÊóßÁâàÊú¨Êï∞ÊçÆÔºåËøõË°åËøÅÁßª...');
                    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÁâàÊú¨ËøÅÁßªÈÄªËæë
                }
                
                // ÂêàÂπ∂Áä∂ÊÄÅÔºåÁ°Æ‰øùÊâÄÊúâÂ≠óÊÆµÈÉΩÊúâÈªòËÆ§ÂÄº
                state = {
                    ...state,
                    ...parsed,
                    // Á°Æ‰øùÊï∞ÁªÑÂ≠óÊÆµÂ≠òÂú®
                    inventory: parsed.inventory || [],
                    unlockedItems: parsed.unlockedItems || [],
                    purchasedFurniture: parsed.purchasedFurniture || [],
                    diaryEntries: parsed.diaryEntries || [],
                    memos: parsed.memos || [],
                    records: parsed.records || [],
                    gameHistory: parsed.gameHistory || [],
                    tasks: parsed.tasks || [], // ‰ΩøÁî®‰øùÂ≠òÁöÑ‰ªªÂä°Êï∞ÊçÆ
                    // Á°Æ‰øùÊï∞Â≠óÂ≠óÊÆµÊúâÊïà
                    day: parseInt(parsed.day) || 1,
                    money: parseInt(parsed.money) || 100,
                    hunger: parseInt(parsed.hunger) || 50,
                    trust: parseFloat(parsed.trust) || 0,
                    moodValue: parseInt(parsed.moodValue) || 15,
                    moodDuration: parseInt(parsed.moodDuration) || 0,
                    moodStability: parseInt(parsed.moodStability) || 50,
                    // Á°Æ‰øùÂøÉÊÉÖÂ≠óÊÆµÊúâÊïà
                    currentMood: parsed.currentMood || 'anxious',
                    currentWeather: parsed.currentWeather || 'cloudy',
                    currentBackground: parsed.currentBackground || 'default',
                    // Á°Æ‰øùÊó•ÊúüÂ≠óÊÆµÊúâÊïà
                    lastLoginDate: parsed.lastLoginDate || new Date().toDateString(),
                    moodStartTime: parsed.moodStartTime || Date.now()
                };
				
				// Âä†ËΩΩËá™ÂÆö‰πâËÉåÊôØ - ‰øÆÂ§çÂà∑Êñ∞Âêé‰∏¢Â§±ÈóÆÈ¢ò
				console.log('Âä†ËΩΩËá™ÂÆö‰πâËÉåÊôØÊï∞ÊçÆ:', parsed.customBackgrounds);
				if (parsed.customBackgrounds) {
			        // Á°Æ‰øùcustomBackgroundsÊòØÊï∞ÁªÑ
			        const loadedCustomBackgrounds = Array.isArray(parsed.customBackgrounds) ? parsed.customBackgrounds : [];
			        console.log('Ëß£ÊûêÂêéÁöÑËá™ÂÆö‰πâËÉåÊôØ:', loadedCustomBackgrounds);
			        
			        // Áõ¥Êé•ËµãÂÄºÁªôÂÖ®Â±ÄÂèòÈáècustomBackgrounds
			        customBackgrounds = window.customBackgrounds = loadedCustomBackgrounds;
			        console.log('ËµãÂÄºÂêéÁöÑÂÖ®Â±ÄcustomBackgrounds:', customBackgrounds);
			        
			        // Ê∏ÖÁ©∫backgroundsÊï∞ÁªÑ‰∏≠ÁöÑÊâÄÊúâËá™ÂÆö‰πâËÉåÊôØÔºåÈÅøÂÖçÈáçÂ§ç
			        const defaultBackgrounds = backgrounds.filter(bg => !bg.id.startsWith('custom_'));
			        console.log('ÈªòËÆ§ËÉåÊôØ:', defaultBackgrounds);
			        
			        // ÈáçÊñ∞ÂàùÂßãÂåñbackgroundsÊï∞ÁªÑÔºå‰øùÁïôÈªòËÆ§ËÉåÊôØÔºåÊ∑ªÂä†ÊâÄÊúâËá™ÂÆö‰πâËÉåÊôØ
			        backgrounds.length = 0;
			        backgrounds.push(...defaultBackgrounds);
			        backgrounds.push(...customBackgrounds);
			        console.log('Êõ¥Êñ∞ÂêéÁöÑbackgroundsÊï∞ÁªÑ:', backgrounds);
			    } else {
			        console.log('Ê≤°ÊúâËá™ÂÆö‰πâËÉåÊôØÊï∞ÊçÆ');
			        // Ê≤°ÊúâËá™ÂÆö‰πâËÉåÊôØÊï∞ÊçÆÊó∂ÔºåÊ∏ÖÁ©∫backgroundsÊï∞ÁªÑ‰∏≠ÁöÑËá™ÂÆö‰πâËÉåÊôØ
			        const defaultBackgrounds = backgrounds.filter(bg => !bg.id.startsWith('custom_'));
			        backgrounds.length = 0;
			        backgrounds.push(...defaultBackgrounds);
			        customBackgrounds = window.customBackgrounds = [];
			        console.log('ÈáçÁΩÆÂêéÁöÑcustomBackgrounds:', customBackgrounds);
			    }
                
				// ‰øÆÂ§çÔºöÂ¶ÇÊûúÊ≤°Êúâ‰ªªÂä°Êï∞ÊçÆÔºåÂàùÂßãÂåñÊâÄÊúâ‰ªªÂä°
				        if (!parsed.tasks || parsed.tasks.length === 0) {
				            initializeTasks();
				        } else {
				            // Á°Æ‰øù‰ªªÂä°Êï∞ÊçÆÂÆåÊï¥
				            fixTasksData();
				        }
						
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂêå‰∏ÄÂ§©ÁôªÂΩï
                const today = new Date().toDateString();
                const lastLoginDate = state.lastLoginDate ? new Date(state.lastLoginDate).toDateString() : null;
                
                if (lastLoginDate !== today) {
                    // Êñ∞ÁöÑ‰∏ÄÂ§©
                    if (lastLoginDate) {
                        // ËÆ°ÁÆóÁõ∏Â∑ÆÁöÑÂ§©Êï∞
                        const lastDate = new Date(lastLoginDate);
                        const currentDate = new Date();
                        const timeDiff = currentDate.getTime() - lastDate.getTime();
                        const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
                        
                        if (daysDiff > 0) {
                            state.day += Math.min(daysDiff, 1);
                            state.lastLoginDate = today;
                            
                            // Êó•Â∏∏ÈáçÁΩÆ
                            state.dailyLoginClaimed = false;
							state.feedTaskClaimed = false;
							state.buyTaskClaimed = false;
							state.scheduleTaskClaimed = false;
							state.diaryTaskClaimed = false;
							state.gameTaskClaimed = false;
							                        
                            state.tasks.forEach(task => {
                                if (task.type === 'daily') {
                                    task.progress = 0;
                                    task.claimed = false;
                                }
                            });
                            state.interactionCount = 0;
                            state.feedTaskClaimed = false;
                            state.buyTaskClaimed = false;
                            state.scheduleTaskClaimed = false;
                            state.diaryTaskClaimed = false;
                            state.furnitureTaskClaimed = false;
                            state.gameTaskClaimed = false;
                            state.memoReminded = false;
                            
                            // Â¥ΩÂ¥ΩÊÑüÁü•Êó∂Èó¥ÂèòÂåñ
                            if (daysDiff >= 2) {
                                showDialogueText(`‰Ω†Â∑≤Áªè${daysDiff}Â§©Ê≤°Êù•‰∫Ü...`);
                                updateMood(-10);
                            } else if (daysDiff === 1) {
                                showDialogueText("‰Ω†Êò®Â§©Ê≤°Êù•Âë¢...");
                                updateMood(-5);
                            }
                        }
                    } else {
                        // È¶ñÊ¨°ÁôªÂΩï
                        state.day = 1;
                        state.lastLoginDate = today;
                    }
                    
                    // ÁîüÊàêÊñ∞Êó•ËÆ∞ÁöÑÂá†ÁéáÂ¢ûÂä†
                    if (Math.random() < 0.8) {
                        checkDiaryGeneration();
                    }
                } else {
                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂú®Âêå‰∏ÄÂ§©ÂÜÖÈáçÁΩÆ‰ªªÂä°ÔºàÈõ∂ÁÇπÊ£ÄÊü•Ôºâ
                    const now = new Date();
                    const todayMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const lastReset = state.lastDailyReset ? new Date(state.lastDailyReset) : null;
                    
                    if (!lastReset || todayMidnight > lastReset) {
                        // Èõ∂ÁÇπÂ∑≤ËøáÔºåÈáçÁΩÆÊØèÊó•‰ªªÂä°
                        state.lastDailyReset = todayMidnight.toISOString();
                        
                        // Êó•Â∏∏ÈáçÁΩÆ
                        state.dailyLoginClaimed = false;
                        state.feedTaskClaimed = false;
                        state.buyTaskClaimed = false;
                        state.scheduleTaskClaimed = false;
                        state.diaryTaskClaimed = false;
                        state.gameTaskClaimed = false;
                             
                        // ÈáçÁΩÆÊØèÊó•‰ªªÂä°ËøõÂ∫¶
                        state.tasks.forEach(task => {
                            if (task.type === 'daily') {
                                task.progress = 0;
                                task.claimed = false;
                            }
                        });
                        
                        // ÈáçÁΩÆ‰∫§‰∫íËÆ°Êï∞Ôºà‰ªÖÁî®‰∫éÊØèÊó•‰ªªÂä°Ôºâ
                        state.interactionCount = 0;
                        state.memoReminded = false;
                        
                        showDialogueText("Êñ∞ÁöÑ‰∏ÄÂ§©ÂºÄÂßã‰∫Ü~‰ªäÂ§©‰πüË¶ÅÂ•ΩÂ•ΩÁõ∏Â§ÑÂì¶");
                        updateMood(5);
                        showToast("ÊØèÊó•‰ªªÂä°Â∑≤ÈáçÁΩÆ");
                    }
                    
                    // ÊØèÊó•ÁôªÂΩï‰ªªÂä°ÔºöÂΩìÂ§©Á¨¨‰∏ÄÊ¨°ÊâìÂºÄÊ∏∏ÊàèÊó∂Ëá™Âä®ÂÆåÊàê
                    const dailyLoginTask = state.tasks.find(t => t.id === 'daily_login');
                    if (dailyLoginTask && dailyLoginTask.progress === 0 && !state.dailyLoginClaimed) {
                        dailyLoginTask.progress = 1;
                        renderTaskList();
                    }
                }
                
                // ËÆæÁΩÆÂ¥ΩÂ¥ΩÁöÑÂàùÂßãÂøÉÊÉÖ‰∏∫Ë≠¶ÊÉï
                if (!state.currentMood || state.trust < 15) {
                    state.currentMood = 'anxious';
                    state.moodValue = 150;
                }
                
                // ‰øÆÂ§çÔºöÊõ¥Êñ∞ÊâÄÊúâÂ§¥ÂÉèÊòæÁ§∫
                if (state.customAvatar) {
                    document.getElementById('zaizai-img').src = state.customAvatar;
                    document.getElementById('avatar-preview').src = state.customAvatar;
                    document.getElementById('fullscreen-img').src = state.customAvatar;
                }
                
                // ÂàùÂßãÂåñËÉåÊôØ
                initBackground();
                
                saveState();
                
            } else {
                // ÂÖ®Êñ∞Ê∏∏Êàè
                state.day = 1;
                state.currentMood = 'anxious';
                state.moodValue = 150;
                state.lastLoginDate = new Date().toDateString();
				initializeTasks(); // ÂàùÂßãÂåñÊâÄÊúâ‰ªªÂä°
                saveState();
            }
						
        } catch (e) {
            console.error('Âä†ËΩΩÁä∂ÊÄÅÂ§±Ë¥•:', e);
            // Â¶ÇÊûúÂä†ËΩΩÂ§±Ë¥•ÔºåÈáçÁΩÆ‰∏∫ÈªòËÆ§Áä∂ÊÄÅ
            state = { ...state };
			initializeTasks(); // ÂàùÂßãÂåñÊâÄÊúâ‰ªªÂä°
            saveState();
        }
        
        // Êõ¥Êñ∞ÂÜÖÂ≠òÁºìÂ≠òÔºåÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑÈ¶ñÊ¨°‰øùÂ≠ò
        lastSavedState = JSON.parse(JSON.stringify(state));
        
        // Êõ¥Êñ∞UIÊòæÁ§∫
        updateUI();
        updateMoodIndicator();
    }

    // === ‰øÆÂ§çÂ¥ΩÂ¥ΩÊãñÂä®ÂäüËÉΩ ===
    function initCharacterDragFixed() {
        const character = document.getElementById('character-wrapper');
        const touchArea = document.getElementById('touch-area');
        
        character.outerHTML = character.outerHTML;
        
        const newCharacter = document.getElementById('character-wrapper');
        const newTouchArea = document.getElementById('touch-area');
        
        let isDraggingChar = false;
        let startX = 0, startY = 0, startLeft = 0, startTop = 0;

        newTouchArea.addEventListener('mousedown', handleTouchStartFixed);
        newTouchArea.addEventListener('touchstart', handleTouchStartFixed, { passive: false });

        newCharacter.addEventListener('mousedown', startDragFixed);
        newCharacter.addEventListener('touchstart', startDragTouchFixed, { passive: false });

        function handleTouchStartFixed(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const rect = newTouchArea.getBoundingClientRect();
            let clientY;
            
            if (e.type === 'touchstart') {
                clientY = e.touches[0].clientY;
            } else {
                clientY = e.clientY;
            }
            
            const relativeY = clientY - rect.top;
            const isHead = relativeY < rect.height * 0.4;
            
            handleCharacterInteract(isHead);
            
            document.addEventListener('mousemove', preventDrag);
            document.addEventListener('mouseup', removePreventDrag);
            document.addEventListener('touchmove', preventDrag);
            document.addEventListener('touchend', removePreventDrag);
        }
        
        function preventDrag(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function removePreventDrag(e) {
            document.removeEventListener('mousemove', preventDrag);
            document.removeEventListener('mouseup', removePreventDrag);
            document.removeEventListener('touchmove', preventDrag);
            document.removeEventListener('touchend', removePreventDrag);
        }

        function startDragFixed(e) {
            if (e.target.id === 'touch-area') return;
            
            isDraggingChar = true;
            
            if (e.type === 'mousedown') {
                startX = e.clientX;
                startY = e.clientY;
            }
            
            const computedStyle = window.getComputedStyle(newCharacter);
            startLeft = parseInt(computedStyle.left) || state.characterPosition.x;
            startTop = parseInt(computedStyle.top) || state.characterPosition.y;
            
            newCharacter.style.cursor = 'grabbing';
            newCharacter.style.zIndex = '20';
            
            document.addEventListener('mousemove', dragFixed);
            document.addEventListener('mouseup', stopDragFixed);
            document.addEventListener('touchmove', dragTouchFixed);
            document.addEventListener('touchend', stopDragFixed);
            
            e.preventDefault();
        }

        function startDragTouchFixed(e) {
            if (e.target.id === 'touch-area') return;
            
            if (e.touches.length === 1) {
                isDraggingChar = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                
                const computedStyle = window.getComputedStyle(newCharacter);
                startLeft = parseInt(computedStyle.left) || state.characterPosition.x;
                startTop = parseInt(computedStyle.top) || state.characterPosition.y;
                
                newCharacter.style.zIndex = '20';
                
                document.addEventListener('touchmove', dragTouchFixed);
                document.addEventListener('touchend', stopDragFixed);
                
                e.preventDefault();
            }
        }

        function dragFixed(e) {
            if (!isDraggingChar) return;
            
            const clientX = e.clientX;
            const clientY = e.clientY;
            
            const dx = clientX - startX;
            const dy = clientY - startY;
            
            let newLeft = startLeft + dx;
            let newTop = startTop + dy;
            
            const room = document.getElementById('room-view');
            const roomRect = room.getBoundingClientRect();
            const characterRect = newCharacter.getBoundingClientRect();
            
            newLeft = Math.max(10, Math.min(newLeft, roomRect.width - characterRect.width - 10));
            newTop = Math.max(10, Math.min(newTop, roomRect.height - characterRect.height - 10));
            
            newCharacter.style.left = newLeft + 'px';
            newCharacter.style.top = newTop + 'px';
            
            e.preventDefault();
        }

        function dragTouchFixed(e) {
            if (!isDraggingChar || e.touches.length !== 1) return;
            
            const clientX = e.touches[0].clientX;
            const clientY = e.touches[0].clientY;
            
            const dx = clientX - startX;
            const dy = clientY - startY;
            
            let newLeft = startLeft + dx;
            let newTop = startTop + dy;
            
            const room = document.getElementById('room-view');
            const roomRect = room.getBoundingClientRect();
            const characterRect = newCharacter.getBoundingClientRect();
            
            newLeft = Math.max(10, Math.min(newLeft, roomRect.width - characterRect.width - 10));
            newTop = Math.max(10, Math.min(newTop, roomRect.height - characterRect.height - 10));
            
            newCharacter.style.left = newLeft + 'px';
            newCharacter.style.top = newTop + 'px';
            
            e.preventDefault();
        }

        function stopDragFixed(e) {
            if (isDraggingChar) {
                isDraggingChar = false;
                newCharacter.style.cursor = 'grab';
                newCharacter.style.zIndex = '15';
                
                const computedStyle = window.getComputedStyle(newCharacter);
                state.characterPosition = {
                    x: parseInt(computedStyle.left) || 0,
                    y: parseInt(computedStyle.top) || 0
                };
                
                checkFurnitureProximity();
                
                saveState();
                
                document.removeEventListener('mousemove', dragFixed);
                document.removeEventListener('mouseup', stopDragFixed);
                document.removeEventListener('touchmove', dragTouchFixed);
                document.removeEventListener('touchend', stopDragFixed);
            }
        }
    }

    // ÂàùÂßãÂåñÂ¥ΩÂ¥Ω‰ΩçÁΩÆ
    function initCharacterPosition() {
        const character = document.getElementById('character-wrapper');
        character.style.left = state.characterPosition.x + 'px';
        character.style.top = state.characterPosition.y + 'px';
    }

    // === Ëß¶Êë∏‰∫§‰∫í‰øÆÂ§ç ===
    function initCharacterTouch() {
        // Âú®initCharacterDragFixed‰∏≠Â§ÑÁêÜ
    }

    function handleCharacterInteract(isHead) {
        const img = document.getElementById('zaizai-img');

        img.classList.remove('pat-anim', 'poke-anim');
        void img.offsetWidth;

        if (isHead) {
            img.classList.add('pat-anim');
            showTouchDialogue('pat');
            affectMoodByInteraction('pat');
        } else {
            img.classList.add('poke-anim');
            showTouchDialogue('poke');
            affectMoodByInteraction('poke');
        }
        
        state.interactionCount++;
        updateTaskProgress('play_with_zaizai');
        saveState();
    }

    function showTouchDialogue(type) {
        const phase = getTrustPhase();
        const mood = getCurrentMood();
        
        let dialogues = [];
        
        if (type === 'pat') {
            switch(mood) {
                case 'anxious':
                    dialogues = [
                        "ÔºÅÂà´Á¢∞ÊàëÔºÅ",
                        "‰∏çË¶ÅÊë∏ÊàëÁöÑÂ§¥...",
                        "ËØ∑‰øùÊåÅË∑ùÁ¶ª",
                        "ÊàëÂÆ≥ÊÄï..."
                    ];
                    break;
                case 'calm':
                    dialogues = [
                        "ÂóØ...",
                        "ÂèØ‰ª•Êé•Âèó",
                        "‰∏çËÆ®ÂéåËøôÊ†∑",
                        "ÁªßÁª≠Âêß"
                    ];
                    break;
                case 'happy':
                    dialogues = [
                        "ÂòøÂòøÔºåÂ•ΩÁóí",
                        "ÂñúÊ¨¢ËøôÊ†∑",
                        "ÂÜçÂ§öÊë∏Êë∏",
                        "Â•ΩËàíÊúç"
                    ];
                    break;
                case 'excited':
                    dialogues = [
                        "ÂìáÔºÅÂºÄÂøÉÔºÅ",
                        "ÂÜçÊù•ÂÜçÊù•ÔºÅ",
                        "ÊúÄÂñúÊ¨¢Ë¢´Êë∏Â§¥‰∫ÜÔºÅ",
                        "Â•ΩÂπ∏Á¶èÔºÅ"
                    ];
                    break;
                default:
                    dialogues = ["...", "ÂóØ", "ÊàëÂú®"];
            }
        } else if (type === 'poke') {
            switch(mood) {
                case 'anxious':
                    dialogues = [
                        "ÔºÅ‰∏çË¶ÅÊà≥ÊàëÔºÅ",
                        "ÂæàÁóõÔºÅ",
                        "ËØ∑ÂÅú‰∏ã",
                        "‰∏∫‰ªÄ‰πàË¶Å‰º§ÂÆ≥ÊàëÔºü"
                    ];
                    break;
                case 'calm':
                    dialogues = [
                        "Êà≥Êà≥...",
                        "ÊúâÁÇπÁóí",
                        "ËΩª‰∏ÄÁÇπ",
                        "ÂèØ‰ª•‰∫Ü"
                    ];
                    break;
                case 'happy':
                    dialogues = [
                        "ÂòªÂòªÔºåÂ•ΩÁóí",
                        "Êà≥Êù•Êà≥ÂéªÁöÑ",
                        "ÁúüÂ•ΩÁé©",
                        "ÁªßÁª≠Êà≥"
                    ];
                    break;
                case 'excited':
                    dialogues = [
                        "ÂìàÂìàÂìàÔºÅÂ•ΩÁóíÔºÅ",
                        "Êà≥Êà≥Â§ßËµõÔºÅ",
                        "Â•ΩÂ•ΩÁé©ÔºÅ",
                        "ÂÜçÊù•‰∏ÄÊ¨°ÔºÅ"
                    ];
                    break;
                default:
                    dialogues = ["...", "ÂóØ", "Âì¶"];
            }
        }
        
        if (dialogues.length > 0) {
            const text = dialogues[Math.floor(Math.random() * dialogues.length)];
            showDialogueText(text);
        }
    }

    // Ê£ÄÊü•Â¥ΩÂ¥ΩÊòØÂê¶Âú®ÂÆ∂ÂÖ∑ÈôÑËøë
    function checkFurnitureProximity() {
        const charWrapper = document.getElementById('character-wrapper');
        const charRect = charWrapper.getBoundingClientRect();
        
        const furnitureElements = document.querySelectorAll('#furniture-container .room-item, #window');
        
        furnitureElements.forEach(furniture => {
            const furnitureRect = furniture.getBoundingClientRect();
            const distance = Math.sqrt(
                Math.pow(charRect.left + charRect.width/2 - (furnitureRect.left + furnitureRect.width/2), 2) + 
                Math.pow(charRect.top + charRect.height/2 - (furnitureRect.top + furnitureRect.height/2), 2)
            );
            
            if (distance < 150) {
                const furnitureId = furniture.id;
                const furnitureData = furnitureItems.find(f => f.id === furnitureId) || 
                                     { id: furnitureId, name: furnitureId === 'window' ? 'Á™óÊà∑' : 'ÂÆ∂ÂÖ∑' };
                
                if (Math.random() < 0.3) {
                    setTimeout(() => {
                        // ‰øÆÂ§çÔºöÊ≠£Á°ÆËé∑ÂèñÂÆ∂ÂÖ∑Á±ªÂûãÔºåÂ§ÑÁêÜÊ≤°Êúâ‰∏ãÂàíÁ∫øÁöÑID
                        const furnitureType = furnitureId.includes('_') ? furnitureId.split('_')[1] : furnitureId;
                        const reactions = furnitureReactions[furnitureType] || furnitureReactions.bed;
                        if (reactions && reactions.near) {
                            showDialogueText(reactions.near[Math.floor(Math.random() * reactions.near.length)]);
                        }
                    }, 500);
                }
            }
        });
    }

    // === ËÉåÊôØÁ≥ªÁªü ===
    function initBackground() {
        const roomView = document.getElementById('room-view');
        
        // Á°Æ‰øùcurrentBackgroundÊúâÂÄº
        if (!state.currentBackground) {
            state.currentBackground = 'default';
            saveState();
        }
        
        
        // Â∞ùËØïÊâæÂà∞ÂΩìÂâçËÉåÊôØ
        let currentBg = backgrounds.find(b => b.id === state.currentBackground);
        
        if (!currentBg) {
            console.log('Êú™ÊâæÂà∞ÂΩìÂâçËÉåÊôØÔºåÂ∞ùËØï‰ªécustomBackgroundsÊï∞ÁªÑ‰∏≠Êü•Êâæ...');
            
            // Â∞ùËØï‰ªécustomBackgroundsÊï∞ÁªÑ‰∏≠Êü•ÊâæÂΩìÂâçËÉåÊôØ
            currentBg = customBackgrounds.find(b => b.id === state.currentBackground);
            
            if (currentBg) {
                // Â¶ÇÊûúÊâæÂà∞‰∫ÜÔºåÂ∞ÜÂÖ∂Ê∑ªÂä†Âà∞backgroundsÊï∞ÁªÑ‰∏≠
                backgrounds.push(currentBg);
                console.log('‰ªécustomBackgroundsÊï∞ÁªÑ‰∏≠ÊâæÂà∞ÂΩìÂâçËÉåÊôØÔºåÂ∑≤Ê∑ªÂä†Âà∞backgroundsÊï∞ÁªÑ');
            } else {
                console.log('‰ªécustomBackgroundsÊï∞ÁªÑ‰∏≠‰πüÊú™ÊâæÂà∞ÂΩìÂâçËÉåÊôØÔºåÂõûÈÄÄÂà∞ÈªòËÆ§ËÉåÊôØ...');
                // Â¶ÇÊûúËøòÊòØÊâæ‰∏çÂà∞ÂΩìÂâçËÉåÊôØÔºåÂõûÈÄÄÂà∞ÈªòËÆ§ËÉåÊôØ
                state.currentBackground = 'default';
                currentBg = backgrounds.find(b => b.id === 'default');
                saveState();
            }
        }
        
        // Â∫îÁî®ËÉåÊôØ
        if (currentBg) {
            applyBackground(currentBg);
        } else {
            console.error('Êó†Ê≥ïÊâæÂà∞‰ªª‰ΩïËÉåÊôØÔºå‰ΩøÁî®Á°¨ÁºñÁ†ÅÈªòËÆ§ËÉåÊôØ');
            // Á¥ßÊÄ•ÊÉÖÂÜµÔºöÁ°¨ÁºñÁ†Å‰∏Ä‰∏™ÈªòËÆ§ËÉåÊôØ
            roomView.style.background = 'linear-gradient(180deg, #E3FDFD 0%, #FFFFFF 100%)';
            roomView.style.backgroundSize = 'cover';
            roomView.style.backgroundPosition = 'center';
        }
        
        renderBackgroundSelector();
    }

    function applyBackground(bg) {
        const roomView = document.getElementById('room-view');
        
        if (!bg || !roomView) {
            console.error('Êó†Ê≥ïÂ∫îÁî®ËÉåÊôØ:', bg);
            return;
        }
        
        // Ê∏ÖÈô§ÊâÄÊúâËÉåÊôØÊ†∑Âºè
        roomView.style.background = '';
        roomView.style.backgroundImage = '';
        roomView.style.backgroundColor = '';
        
        if (bg.type === 'gradient') {
            roomView.style.background = bg.value;
            roomView.style.backgroundSize = 'cover';
            roomView.style.backgroundPosition = 'center';
            roomView.style.backgroundRepeat = 'no-repeat';
        } else if (bg.type === 'image') {
            roomView.style.backgroundImage = `url('${bg.value}')`;
            roomView.style.backgroundSize = 'cover';
            roomView.style.backgroundPosition = 'center';
            roomView.style.backgroundRepeat = 'no-repeat';
            roomView.style.backgroundColor = 'transparent';
        } else {
            // Êú™Áü•Á±ªÂûãÔºå‰ΩøÁî®ÈªòËÆ§
            roomView.style.background = 'linear-gradient(180deg, #E3FDFD 0%, #FFFFFF 100%)';
            roomView.style.backgroundSize = 'cover';
            roomView.style.backgroundPosition = 'center';
        }
        
        console.log('ËÉåÊôØÂ∫îÁî®ÊàêÂäü:', bg.name);
    }

    function renderBackgroundSelector() {
        const container = document.getElementById('bg-grid');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Á≥ªÁªüÂÜÖÁΩÆËÉåÊôØ
        const systemBackgrounds = backgrounds.filter(bg => !bg.id.startsWith('custom_'));
        const customBackgroundsList = backgrounds.filter(bg => bg.id.startsWith('custom_'));
        
        
        // Ê∏≤ÊüìÁ≥ªÁªüËÉåÊôØ
        systemBackgrounds.forEach(bg => {
            const bgItem = document.createElement('div');
            bgItem.className = `bg-item ${state.currentBackground === bg.id ? 'active' : ''}`;
            bgItem.onclick = function() {
                changeBackground(bg.id);
            };
            
            const preview = document.createElement('div');
            preview.className = 'bg-preview';
            
            if (bg.type === 'gradient') {
                preview.style.background = bg.value;
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
            } else if (bg.type === 'image') {
                preview.style.background = `url('${bg.value}')`;
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
            }
            
            const name = document.createElement('div');
            name.className = 'bg-name';
            name.textContent = bg.name;
            
            bgItem.appendChild(preview);
            bgItem.appendChild(name);
            container.appendChild(bgItem);
        });
        
        // Ê∏≤ÊüìËá™ÂÆö‰πâËÉåÊôØ
        if (customBackgroundsList.length > 0) {
            // Ê∑ªÂä†ÂàÜÈöîÁ∫øÊ†áÈ¢ò
            const separator = document.createElement('div');
            separator.style.gridColumn = '1 / span 3';
            separator.style.marginTop = '20px';
            separator.style.padding = '10px';
            separator.style.borderTop = '1px solid #eee';
            separator.style.color = '#666';
            separator.style.fontSize = '12px';
            separator.style.fontWeight = 'bold';
            separator.textContent = 'ÊàëÁöÑËÉåÊôØ';
            container.appendChild(separator);
            
            customBackgroundsList.forEach(bg => {
                const bgItem = document.createElement('div');
                bgItem.className = `bg-item ${state.currentBackground === bg.id ? 'active' : ''}`;
                bgItem.onclick = function() {
                    changeBackground(bg.id);
                };
                
                const preview = document.createElement('div');
                preview.className = 'bg-preview';
                
                if (bg.type === 'gradient') {
                    preview.style.background = bg.value;
                    preview.style.backgroundSize = 'cover';
                    preview.style.backgroundPosition = 'center';
                } else if (bg.type === 'image') {
                    preview.style.background = `url('${bg.value}')`;
                    preview.style.backgroundSize = 'cover';
                    preview.style.backgroundPosition = 'center';
                }
                
                const name = document.createElement('div');
                name.className = 'bg-name';
                name.textContent = bg.name;
                
                // Ê∑ªÂä†Âà†Èô§ÊåâÈíÆ
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '√ó';
                deleteBtn.className = 'bg-delete-btn';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '-5px';
                deleteBtn.style.right = '-5px';
                deleteBtn.style.background = '#FF5252';
                deleteBtn.style.color = 'white';
                deleteBtn.style.border = 'none';
                deleteBtn.style.borderRadius = '50%';
                deleteBtn.style.width = '20px';
                deleteBtn.style.height = '20px';
                deleteBtn.style.fontSize = '14px';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.zIndex = '10';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    deleteCustomBackground(bg.id);
                };
                
                bgItem.style.position = 'relative';
                bgItem.appendChild(preview);
                bgItem.appendChild(name);
                bgItem.appendChild(deleteBtn);
                container.appendChild(bgItem);
            });
        }
        

    }
	
	function deleteCustomBackground(bgId) {
	    if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ëá™ÂÆö‰πâËÉåÊôØÂêóÔºü')) {
	        return;
	    }
	    
	    // ‰ªéËá™ÂÆö‰πâËÉåÊôØÂàóË°®‰∏≠Âà†Èô§
	    const bgIndex = customBackgrounds.findIndex(bg => bg.id === bgId);
	    if (bgIndex !== -1) {
	        customBackgrounds.splice(bgIndex, 1);
	    }
	    
	    // ‰ªéËÉåÊôØÂàóË°®‰∏≠Âà†Èô§
	    const allBgIndex = backgrounds.findIndex(bg => bg.id === bgId);
	    if (allBgIndex !== -1) {
	        backgrounds.splice(allBgIndex, 1);
	    }
	    
	    // Â¶ÇÊûúÂΩìÂâç‰ΩøÁî®ÁöÑÊòØË¢´Âà†Èô§ÁöÑËÉåÊôØÔºåÂàáÊç¢Âà∞ÈªòËÆ§ËÉåÊôØ
	    if (state.currentBackground === bgId) {
	        state.currentBackground = 'default';
	        applyBackground(backgrounds.find(b => b.id === 'default'));
	    }
	    
	    // ÈáçÊñ∞Ê∏≤ÊüìËÉåÊôØÈÄâÊã©Âô®
	    renderBackgroundSelector();
	    
	    // ‰øùÂ≠òÁä∂ÊÄÅ
	    saveState();
	    
	    showToast("Ëá™ÂÆö‰πâËÉåÊôØÂ∑≤Âà†Èô§");
	}
	
	function validateBackgrounds() {
	    console.log('È™åËØÅËÉåÊôØÊï∞ÊçÆ...');
	    
	    // Á°Æ‰øùÈªòËÆ§ËÉåÊôØÂ≠òÂú®
	    if (!backgrounds.some(bg => bg.id === 'default')) {
	        console.warn('ÈªòËÆ§ËÉåÊôØ‰∏¢Â§±ÔºåÈáçÊñ∞Ê∑ªÂä†');
	        backgrounds.push({
	            id: 'default',
	            name: 'ÈªòËÆ§',
	            type: 'gradient',
	            value: 'linear-gradient(180deg, #E3FDFD 0%, #FFFFFF 100%)'
	        });
	    }
	    
	    // Á°Æ‰øùÊâÄÊúâÂÜÖÁΩÆËÉåÊôØÈÉΩÂ≠òÂú®
	    const requiredBackgrounds = [
	        { id: 'sunset', name: 'Êó•ËêΩ', type: 'gradient', value: 'linear-gradient(180deg, #FFD3A5 0%, #FD6585 100%)' },
	        { id: 'night', name: 'ÊòüÁ©∫', type: 'gradient', value: 'linear-gradient(180deg, #0C164D 0%, #190B22 100%)' },
	        { id: 'forest', name: 'Ê£ÆÊûó', type: 'gradient', value: 'linear-gradient(180deg, #C1DFC4 0%, #DEECDD 100%)' },
	        { id: 'ocean', name: 'Êµ∑Ê¥ã', type: 'gradient', value: 'linear-gradient(180deg, #A1C4FD 0%, #C2E9FB 100%)' },
	        { id: 'pastel', name: 'È©¨Âç°Èæô', type: 'gradient', value: 'linear-gradient(180deg, #FFD6E7 0%, #FFE6D6 100%)' }
	    ];
	    
	    requiredBackgrounds.forEach(requiredBg => {
	        if (!backgrounds.some(bg => bg.id === requiredBg.id)) {
	            console.warn('ËÉåÊôØ‰∏¢Â§±ÔºåÈáçÊñ∞Ê∑ªÂä†:', requiredBg.name);
	            backgrounds.push(requiredBg);
	        }
	    });
	    
	    console.log('ËÉåÊôØÈ™åËØÅÂÆåÊàêÔºåÂΩìÂâçËÉåÊôØÊï∞Èáè:', backgrounds.length);
	}
	
	// Âú®loadStateÂáΩÊï∞‰∏≠Ë∞ÉÁî®
	// Âú®loadStateÂáΩÊï∞ÁöÑÈÄÇÂΩì‰ΩçÁΩÆÊ∑ªÂä†Ôºö
	validateBackgrounds();

    function changeBackground(bgId) {
        console.log('ÊîπÂèòËÉåÊôØÂà∞:', bgId); // Ë∞ÉËØïÁî®
        
        const bg = backgrounds.find(b => b.id === bgId);
        if (!bg) {
            console.error('ËÉåÊôØÊú™ÊâæÂà∞:', bgId);
            showToast("ËÉåÊôØ‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®ÈªòËÆ§ËÉåÊôØ");
            bgId = 'default';
            return changeBackground('default');
        }
        
        // ‰øùÂ≠òÊóßËÉåÊôØÁî®‰∫éÊØîËæÉ
        const oldBgId = state.currentBackground;
        
        state.currentBackground = bgId;
        applyBackground(bg);
        
        // Êõ¥Êñ∞ËÉåÊôØÈÄâÊã©Âô®
        renderBackgroundSelector();
        
        // ‰øùÂ≠òÁä∂ÊÄÅ
        saveState();
        
        // Â¥ΩÂ¥ΩÁöÑÂèçÂ∫îÔºàÂè™Âú®ÂàáÊç¢‰∏çÂêåËÉåÊôØÊó∂Ôºâ
        if (oldBgId !== bgId) {
            setTimeout(() => {
                const reactions = [
                    "ÊàøÈó¥ÂèòÊºÇ‰∫Æ‰∫ÜÔºÅ",
                    "Êñ∞ÁöÑËÉåÊôØÔºÅÂñúÊ¨¢ÔºÅ",
                    "È¢úËâ≤Â•ΩÁæé",
                    "Ë∞¢Ë∞¢‰Ω†Ë£ÖÈ•∞ÊàøÈó¥"
                ];
                showDialogueText(reactions[Math.floor(Math.random() * reactions.length)]);
                updateMood(5);
            }, 500);
        }
        
        showToast(`ËÉåÊôØÂ∑≤Êõ¥Êç¢‰∏∫: ${bg.name}`);
    }

    function handleBackgroundUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.match('image.*')) {
            showToast("ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂");
            return;
        }
        
        if (file.size > 3 * 1024 * 1024) {
            showToast("ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá3MB");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const timestamp = Date.now();
            const customBg = {
                id: 'custom_' + timestamp,
                name: 'Ëá™ÂÆö‰πâËÉåÊôØ',
                type: 'image',
                value: e.target.result
            };
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Ëá™ÂÆö‰πâËÉåÊôØÔºåÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†
            const existingIndex = customBackgrounds.findIndex(bg => 
                bg.value === e.target.result || bg.id === customBg.id
            );
            
            if (existingIndex === -1) {
                // Ê∑ªÂä†Âà∞Ëá™ÂÆö‰πâËÉåÊôØÂàóË°®
                customBackgrounds.push(customBg);
                
                // Ê∑ªÂä†Âà∞ËÉåÊôØÂàóË°®ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
                if (!backgrounds.some(bg => bg.id === customBg.id)) {
                    backgrounds.push(customBg);
                }
            } else {
                // ‰ΩøÁî®Â∑≤Â≠òÂú®ÁöÑËá™ÂÆö‰πâËÉåÊôØ
                customBg = customBackgrounds[existingIndex];
            }
            
            // ËÆæÁΩÆÂΩìÂâçËÉåÊôØ
            state.currentBackground = customBg.id;
            
            // Â∫îÁî®ËÉåÊôØ
            applyBackground(customBg);
            
            // Êõ¥Êñ∞ËÉåÊôØÈÄâÊã©Âô®
            renderBackgroundSelector();
            
            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            closeModal('bg-modal');
            
            showToast("Ëá™ÂÆö‰πâËÉåÊôØÂ∑≤Â∫îÁî®");
            
            // ‰øùÂ≠òÁä∂ÊÄÅ
            saveState();
            
            // Â¥ΩÂ¥ΩÁöÑÂèçÂ∫î
            setTimeout(() => {
                const reactions = [
                    "ËÉåÊôØÊç¢‰∫ÜÔºÅÂ•ΩÁúãÔºÅ",
                    "Êñ∞ÁöÑËÉåÊôØÂõæÔºåÂñúÊ¨¢ÔºÅ",
                    "ÊàøÈó¥ÂèòÊ†∑‰∫ÜÂë¢",
                    "Ë∞¢Ë∞¢‰Ω†Ë£ÖÈ•∞ÊàøÈó¥"
                ];
                showDialogueText(reactions[Math.floor(Math.random() * reactions.length)]);
                updateMood(5);
            }, 500);
            
            // ËÆ∞ÂΩïÂà∞ËßÇÊµãËÆ∞ÂΩï
            recordSystem.addRecord(
                'Êõ¥Êç¢ËÉåÊôØ',
                `ËßÇÊµãËÄÖÊõ¥Êç¢‰∫ÜÊàøÈó¥ËÉåÊôØ‰∏∫Ëá™ÂÆö‰πâÂõæÁâá„ÄÇ`,
                ['ËÆæÁΩÆ', 'ËÉåÊôØ']
            );
        };
        reader.readAsDataURL(file);
    }
	
	function refreshBackground() {
	    const roomView = document.getElementById('room-view');
	    const bg = backgrounds.find(b => b.id === state.currentBackground);
	    
	    if (bg) {
	        applyBackground(bg);
	    } else {
	        // ÂõûÈÄÄÂà∞ÈªòËÆ§ËÉåÊôØ
	        state.currentBackground = 'default';
	        applyBackground(backgrounds.find(b => b.id === 'default'));
	        saveState();
	    }
	}

    // === Â§©Ê∞îÁ≥ªÁªü ===
    function initWeather() {
        const now = Date.now();
        if (!state.lastWeatherChange || now - state.lastWeatherChange > 3600000) {
            changeWeatherRandomly();
        } else {
            updateWeatherDisplay();
        }
    }

    function changeWeatherRandomly() {
        const weatherKeys = Object.keys(weatherTypes);
        const newWeather = weatherKeys[Math.floor(Math.random() * weatherKeys.length)];
        const oldWeather = state.currentWeather;
        state.currentWeather = newWeather;
        state.lastWeatherChange = Date.now();
        
        // ËÆ∞ÂΩïÂ§©Ê∞îÂèòÂåñÂà∞ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠
        if (!state.weatherHistory) {
            state.weatherHistory = [];
        }
        // Âè™ËÆ∞ÂΩï‰∏çÂêåÁöÑÂ§©Ê∞î
        if (oldWeather !== newWeather) {
            state.weatherHistory.push(newWeather);
            // ÈôêÂà∂ÂéÜÂè≤ËÆ∞ÂΩïÈïøÂ∫¶ÔºåÈÅøÂÖçÂç†Áî®ËøáÂ§öÁ©∫Èó¥
            if (state.weatherHistory.length > 20) {
                state.weatherHistory = state.weatherHistory.slice(-20);
            }
        }
        
        updateWeatherDisplay();
        
        const weatherEffect = weatherTypes[newWeather].moodEffect;
        updateMood(weatherEffect);
        
        if (oldWeather !== newWeather) {
            recordSystem.addRecord(
                `Â§©Ê∞îÂèòÂåñÔºö${weatherTypes[oldWeather]?.name || 'Êú™Áü•'} ‚Üí ${weatherTypes[newWeather].name}`,
                `ËßÇÊµãÁéØÂ¢ÉÂ§©Ê∞îÂèëÁîüÂèòÂåñ„ÄÇÊñ∞ÁöÑÂ§©Ê∞îÁä∂ÂÜµÔºö${weatherTypes[newWeather].name}„ÄÇÂèØËÉΩÂΩ±ÂìçËßÇÊµãÂØπË±°ÊÉÖÁª™„ÄÇ`,
                ['ÁéØÂ¢É', 'Â§©Ê∞î']
            );
        }
        
        saveState();
    }

    function updateWeatherDisplay() {
        const weather = weatherTypes[state.currentWeather];
        const weatherEffect = document.getElementById('weather-effect');
        
        weatherEffect.className = 'weather-effect';
        
        if (weather.effectClass) {
            weatherEffect.classList.add(weather.effectClass);
        }
    }

    function interactWithWindow() {
        const weather = weatherTypes[state.currentWeather];
        const responses = weather.windowResponses;
        const text = responses[Math.floor(Math.random() * responses.length)];
        
        showDialogueText(text);
        
        addTrust(0.5);
        
        if (Math.random() < 0.1) {
            setTimeout(() => {
                changeWeatherRandomly();
                showToast(`Â§©Ê∞îÂèòÊàê‰∫Ü${weatherTypes[state.currentWeather].emoji}${weatherTypes[state.currentWeather].name}`);
            }, 1000);
        }
    }

    // === ÂøÉÊÉÖÁ≥ªÁªü - ‰ºòÂåñÔºöÊñ∞Â¢ûÂøÉÊÉÖË°∞ÂáèÂíåÁ®≥ÂÆöÊÄß ===
    function startMoodDecayTimer() {
        if (moodDecayTimer) clearInterval(moodDecayTimer);
        
        moodDecayTimer = setInterval(() => {
            const now = Date.now();
            const moodDuration = now - state.moodStartTime;
            const currentMood = moodTypes[state.currentMood];
            
            if (currentMood && currentMood.maxDuration) {
                // Â¶ÇÊûúÂøÉÊÉÖÊåÅÁª≠Êó∂Èó¥Ë∂ÖËøáÊúÄÂ§ßÊåÅÁª≠Êó∂Èó¥ÔºåÂºÄÂßãË°∞Âáè
                if (moodDuration > currentMood.maxDuration) {
                    // ÈÄÇÈÖçÊñ∞ÁöÑÂøÉÊÉÖÂÄºÂü∫Êï∞ÔºåË∞ÉÊï¥Ë°∞ÂáèÁéá
                    const decayAmount = currentMood.decayRate * 5 * (moodDuration - currentMood.maxDuration) / 1000;
                    state.moodValue = Math.max(0, state.moodValue - decayAmount);
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂàáÊç¢ÂøÉÊÉÖÔºàÈÄÇÈÖçÊñ∞ÁöÑÂøÉÊÉÖÂÄºÂü∫Êï∞Ôºâ
                    if (state.moodValue <= 100) {
                        if (state.currentMood === 'excited') {
                            updateMoodTo('happy');
                        } else if (state.currentMood === 'happy') {
                            updateMoodTo('calm');
                        } else if (state.currentMood === 'calm') {
                            updateMoodTo('sad');
                        }
                    }
                }
            }
            
            // ÊØè5ÁßíÂ∞èÂπÖÈöèÊú∫Ê≥¢Âä®ÔºàÈÄÇÈÖçÊñ∞ÁöÑÂøÉÊÉÖÂÄºÂü∫Êï∞Ôºâ
            if (Math.random() < 0.2) {
                const randomChange = (Math.random() - 0.5) * 2.5;
                state.moodValue = Math.max(0, Math.min(500, state.moodValue + randomChange));
            }
            
        }, 5000); // ÊØè5ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
    }

    function updateMoodIndicator() {
        const indicator = document.getElementById('mood-indicator');
        const moodEmoji = document.getElementById('mood-emoji');
        const moodText = document.getElementById('mood-text');
        
        const mood = moodTypes[state.currentMood];
        if (mood) {
            indicator.style.display = 'flex';
            moodEmoji.textContent = mood.emoji;
            moodText.textContent = mood.name;
            indicator.style.background = mood.color + '30';
            indicator.style.border = `1px solid ${mood.color}`;
        } else {
            indicator.style.display = 'none';
        }
    }

    function updateMoodTo(newMood) {
        if (state.currentMood === newMood) return;
        
        const oldMood = state.currentMood;
        state.currentMood = newMood;
        state.moodStartTime = Date.now();
        state.moodDuration = 0;
        
        updateMoodIndicator();
        recordSystem.recordMoodChange(oldMood, newMood);
        
        if (Math.random() < 0.3) {
            checkDiaryGeneration();
        }
        
        const mood = moodTypes[newMood];
        showToast(`Â¥ΩÂ¥ΩÁöÑÂøÉÊÉÖÂèòÊàê‰∫Ü${mood.emoji}${mood.name}`);
        
        saveState();
    }

    function updateMood(change) {
        const oldMood = state.currentMood;
        const oldMoodValue = state.moodValue;
        
        const now = Date.now();
        
        // ‰ºòÂåñÈ¢ëÁπÅÊà≥Âä®ÁöÑÂÜ∑Âç¥Êú∫Âà∂ - Âä®ÊÄÅË°∞ÂáèÊïàÊûú
        const timeSinceLastChange = now - state.moodChangeCooldown;
        const cooldownFactor = Math.min(1, Math.max(0.1, timeSinceLastChange / 3000));
        
        // ËøûÁª≠‰∫§‰∫íÊÉ©ÁΩö - Ë∂äÈ¢ëÁπÅÊà≥Âä®ÔºåÊïàÊûúË∂ä‰Ωé
        if (timeSinceLastChange < 2000) {
            // ÈùûÂ∏∏È¢ëÁπÅÁöÑ‰∫§‰∫íÔºåÊïàÊûúÂ§ßÂπÖÈôç‰Ωé
            change *= 0.3 * cooldownFactor;
        } else if (timeSinceLastChange < 5000) {
            // È¢ëÁπÅ‰∫§‰∫íÔºåÊïàÊûúÈôç‰Ωé
            change *= 0.6 * cooldownFactor;
        }
        
        state.moodChangeCooldown = now;
        
        // Â¢ûÂº∫‰ø°‰ªªÂÄºÂØπÂøÉÊÉÖÂÄºÂ¢ûÈïøÁöÑÂΩ±Âìç
        const trustFactor = state.trust / 100;
        let trustModifier = 1;
        if (state.trust < 30) {
            trustModifier = 0.5 + (state.trust / 30) * 0.5; // 0.5 - 1.0
        } else if (state.trust > 70) {
            trustModifier = 1.0 + ((state.trust - 70) / 30) * 0.5; // 1.0 - 1.5
        }
        change *= trustModifier;
        
        // Â¢ûÂä†Â§©Ê∞îÂèòÂåñÂØπÂøÉÊÉÖÂÄºÁöÑÂä®ÊÄÅÂΩ±Âìç
        const weatherEffect = weatherTypes[state.currentWeather].moodEffect;
        const weatherModifier = 1 + (weatherEffect / 100);
        change *= weatherModifier;
        
        // Â∫îÁî®Â§©Ê∞îÁöÑÂü∫Á°ÄÂΩ±ÂìçÔºàÈÄÇÈÖçÊñ∞ÁöÑÂøÉÊÉÖÂÄºÂü∫Êï∞Ôºâ
        state.moodValue += weatherEffect * 0.5;
        
        // Ë∞ÉÊï¥ÂøÉÊÉÖÂÄºÂ¢ûÈïøÊõ≤Á∫øÔºå‰ΩøÂÖ∂Êõ¥Âä†Âπ≥ÊªëËá™ÁÑ∂
        // Êé•ËøëÊª°ÂÄºÊó∂Â¢ûÈïøÊõ¥ÊÖ¢
        const moodValueFactor = 1 - (state.moodValue / 1000);
        change *= Math.max(0.5, moodValueFactor);
        
        // Â∫îÁî®ÂøÉÊÉÖÂèòÂåñÔºàÂøÉÊÉÖÂÄºÂü∫Êï∞Âä†Â§ßÂà∞0-500Ôºâ
        state.moodValue = Math.max(0, Math.min(500, state.moodValue + change));
        
        let newMood = state.currentMood;
        
        // ‰ºòÂåñÂøÉÊÉÖÂà§ÂÆöÈÄªËæëÔºåË∞ÉÊï¥Âπ≥ÈùôÁä∂ÊÄÅ‰∏∫ÊúÄÂ§ßÂå∫Èó¥
        // Êñ∞ÁöÑÁä∂ÊÄÅÂàíÂàÜÔºö
        // - Ë≠¶ÊÉï (anxious): < 100
        // - ÈöæËøá (sad): 100-200
        // - Âπ≥Èùô (calm): 200-400ÔºàÊúÄÂ§ßÂå∫Èó¥Ôºâ
        // - ÂºÄÂøÉ (happy): 400-450
        // - ÂÖ¥Â•ã (excited): > 450
        if (state.moodValue >= 450) {
            newMood = 'excited';
        } else if (state.moodValue >= 400) {
            newMood = 'happy';
        } else if (state.moodValue >= 200) {
            newMood = 'calm'; // ÊúÄÂ§ßÂå∫Èó¥
        } else if (state.moodValue >= 100) {
            newMood = 'sad';
        } else {
            newMood = 'anxious';
        }
        
        if (newMood !== state.currentMood) {
            updateMoodTo(newMood);
        }
        
        if (change > 0) {
            state.consecutivePositiveInteractions++;
            state.consecutiveNegativeInteractions = 0;
            
            // Ë∞ÉÊï¥ËøûÁª≠Ê≠£Èù¢‰∫§‰∫íÁöÑÂ•ñÂä±Êú∫Âà∂ÔºàÈÄÇÈÖçÊñ∞ÁöÑÂøÉÊÉÖÂÄºÂü∫Êï∞Ôºâ
            if (state.consecutivePositiveInteractions >= 5) {
                const bonus = Math.min(15, (state.consecutivePositiveInteractions - 4) * 2.5);
                state.moodValue = Math.min(500, state.moodValue + bonus);
                if (state.consecutivePositiveInteractions === 5) {
                    showToast("ËøûÁª≠ÁöÑÂÖ≥Áà±ËÆ©Â¥ΩÂ¥ΩÂæàÂºÄÂøÉÔºÅ");
                }
            }
        } else if (change < 0) {
            state.consecutiveNegativeInteractions++;
            state.consecutivePositiveInteractions = 0;
            
            // Ë∞ÉÊï¥ËøûÁª≠Ë¥üÈù¢‰∫§‰∫íÁöÑÊÉ©ÁΩöÊú∫Âà∂ÔºàÈÄÇÈÖçÊñ∞ÁöÑÂøÉÊÉÖÂÄºÂü∫Êï∞Ôºâ
            if (state.consecutiveNegativeInteractions >= 5) {
                const penalty = Math.min(15, (state.consecutiveNegativeInteractions - 4) * 2.5);
                state.moodValue = Math.max(0, state.moodValue - penalty);
                if (state.consecutiveNegativeInteractions === 5) {
                    showToast("Â¥ΩÂ¥ΩÊÑüÂà∞ÂæàÂèó‰º§...");
                }
            }
        }
        
        saveState();
    }

    function getCurrentMood() {
        return state.currentMood;
    }

    function affectMoodByInteraction(type) {
        let change = 0;
        let trustBonus = 0;
        
        switch(type) {
            case 'pat':
                change = +8;
                trustBonus = 0.3;
                break;
            case 'poke':
                change = +5;
                trustBonus = 0.2;
                break;
            case 'feed':
                change = +12;
                trustBonus = 0.5;
                break;
            case 'gift':
                change = +15;
                trustBonus = 0.8;
                break;
            case 'ignore':
                change = -5;
                break;
            case 'hurt':
                change = -20;
                trustBonus = -1;
                break;
            case 'chat':
                change = +6;
                trustBonus = 0.4;
                break;
        }
        
        const currentMood = getCurrentMood();
        
        // ‰ºòÂåñ‰∏çÂêåÂøÉÊÉÖÁä∂ÊÄÅ‰∏ãÁöÑ‰∫§‰∫íÊïàÊûú
        if (currentMood === 'sad' || currentMood === 'anxious') {
            // ‰ΩéÂøÉÊÉÖÁä∂ÊÄÅ‰∏ãÔºåÁßØÊûÅ‰∫§‰∫íÊïàÊûúÂ¢ûÂº∫
            change *= 1.3;
        } else if (currentMood === 'happy' || currentMood === 'excited') {
            // È´òÂøÉÊÉÖÁä∂ÊÄÅ‰∏ãÔºåÁßØÊûÅ‰∫§‰∫íÊïàÊûúÂáèÂº±
            change *= 0.7;
        }
        
        updateMood(change);
        
        // ‰ø°‰ªªÂÄºÂ•ñÂä±‰πü‰∏é‰∫§‰∫íÈ¢ëÁéáÁõ∏ÂÖ≥
        const now = Date.now();
        const timeSinceLastChange = now - state.moodChangeCooldown;
        if (timeSinceLastChange < 2000) {
            trustBonus *= 0.5;
        }
        
        if (trustBonus !== 0) {
            addTrust(trustBonus);
        }
    }

    // === ÂøÉÁêÜÊ¥ªÂä®Á≥ªÁªü ===
    function getTrustPhase() {
        if (state.trust >= 85) return 'p5';
        else if (state.trust >= 70) return 'p4';
        else if (state.trust >= 50) return 'p3';
        else if (state.trust >= 30) return 'p2';
        else if (state.trust >= 15) return 'p1';
        else return 'p0';
    }

    function showDialogue(type) {
        const phase = getTrustPhase();
        const mood = getCurrentMood();
        const moodResponses = mentalActivities[phase] ? mentalActivities[phase][type] : null;
        
        if (moodResponses && moodResponses[mood] && moodResponses[mood].length > 0) {
            const list = moodResponses[mood];
            const text = list[Math.floor(Math.random() * list.length)];
            showDialogueText(text);
        } else {
            const defaultResponses = ["...", "ÂóØ...", "ÊàëÂú®Âê¨", "ÊÄé‰πà‰∫ÜÔºü", "Âì¶..."];
            const text = defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
            showDialogueText(text);
        }
    }

    function showSpecialDialogue(text) {
        showDialogueText(text);
    }

    function showDialogueText(text) {
        const bubble = document.getElementById('bubble');
        bubble.innerText = text;
        bubble.style.opacity = 1;
        bubble.style.top = "-110px";
        
        setTimeout(() => {
            bubble.style.opacity = 0;
            bubble.style.top = "-100px";
        }, 3500);
    }

    // === ÂØπËØùÁ≥ªÁªü ===
    function renderChat() {
        const container = document.getElementById('chat-container');
        container.innerHTML = '';
        
        state.chatHistory.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${msg.sender}-message`;
            
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${msg.sender}-bubble`;
            bubble.innerText = msg.text;
            
            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
        });
        
        container.scrollTop = container.scrollHeight;
    }

    function sendChat() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        
        if (text === '') return;
        
        state.chatHistory.push({
            sender: 'user',
            text: text,
            time: new Date().toLocaleTimeString()
        });
        
        input.value = '';
        
        setTimeout(() => {
            const response = getChatResponse(text);
            state.chatHistory.push({
                sender: 'zaizai',
                text: response,
                time: new Date().toLocaleTimeString()
            });
            
            renderChat();
            affectMoodByInteraction('chat');
            saveState();
        }, 1000 + Math.random() * 1000);
        
        renderChat();
        saveState();
    }

    function getChatResponse(userMessage) {
        const phase = getTrustPhase();
        const mood = getCurrentMood();
        const responses = chatResponses[phase];
        const lowerMsg = userMessage.toLowerCase();
        
        if (!responses) {
            const defaultResponses = ["...", "ÂóØ", "ÊàëÂú®Âê¨", "ËøôÊ†∑Âïä"];
            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        }
        
        if (responses.special) {
            for (const [keyword, moodResponses] of Object.entries(responses.special)) {
                if (lowerMsg.includes(keyword.toLowerCase()) && moodResponses[mood]) {
                    return moodResponses[mood][Math.floor(Math.random() * moodResponses[mood].length)];
                }
            }
        }
        
        if (lowerMsg.includes('Ôºü') || lowerMsg.includes('?') || 
            lowerMsg.includes('‰∏∫‰ªÄ‰πà') || lowerMsg.includes('ÊÄé‰πà') || 
            lowerMsg.includes('‰ªÄ‰πà') || lowerMsg.includes('Â¶Ç‰Ωï') ||
            lowerMsg.includes('Âêó') || lowerMsg.includes('Âë¢')) {
            if (responses.questions && responses.questions[mood]) {
                return responses.questions[mood][Math.floor(Math.random() * responses.questions[mood].length)];
            }
        }
        
        if (lowerMsg.includes('‰Ω†Â•Ω') || lowerMsg.includes('Âó®') || lowerMsg.includes('hello') || 
            lowerMsg.includes('hi') || lowerMsg.includes('Êó©') || lowerMsg.includes('Êôö') ||
            lowerMsg.includes('ÂìàÂñΩ') || lowerMsg.includes('ÂñÇ')) {
            if (responses.greetings && responses.greetings[mood]) {
                return responses.greetings[mood][Math.floor(Math.random() * responses.greetings[mood].length)];
            }
        }
        
        if (lowerMsg.includes('Êàë') || lowerMsg.includes('‰Ω†') || lowerMsg.includes('‰ªñ') ||
            lowerMsg.includes('Â•π') || lowerMsg.includes('ÂÆÉ')) {
            if (responses.statements && responses.statements[mood]) {
                return responses.statements[mood][Math.floor(Math.random() * responses.statements[mood].length)];
            }
        }
        
        if (responses.statements && responses.statements[mood]) {
            return responses.statements[mood][Math.floor(Math.random() * responses.statements[mood].length)];
        }
        
        const fallbackResponses = ["...", "ÂóØ", "ÊàëÂú®Âê¨", "ËøôÊ†∑Âïä", "Âì¶", "ÊòéÁôΩ‰∫Ü"];
        return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
    }

    // Â¥ΩÂ¥Ω‰∏ªÂä®ÂØπËØù
    function startAutoChat() {
        if (autoChatTimer) clearInterval(autoChatTimer);
        
        autoChatTimer = setInterval(() => {
            const now = Date.now();
            
            if (now - state.lastMemoCheck > 30000) {
                checkMemoReminder();
                state.lastMemoCheck = now;
            }
            
            if (now - state.lastActiveChat > 45000 && Math.random() < 0.25) {
                const phase = getTrustPhase();
                const activeChatList = activeChats[phase];
                
                if (activeChatList && activeChatList.length > 0) {
                    const chat = activeChatList[0];
                    if (Math.random() < chat.chance) {
                        let message;
                        
                        const hasUncompletedMemos = state.memos.some(memo => !memo.completed);
                        if (hasUncompletedMemos && state.trust >= 30 && chat.memoMessages && !state.memoReminded) {
                            message = chat.memoMessages[Math.floor(Math.random() * chat.memoMessages.length)];
                            state.memoReminded = true;
                        } else {
                            message = chat.messages[Math.floor(Math.random() * chat.messages.length)];
                        }
                        
                        state.chatHistory.push({
                            sender: 'zaizai',
                            text: message,
                            time: new Date().toLocaleTimeString()
                        });
                        
                        if (document.getElementById('chat-modal').style.display === 'flex') {
                            renderChat();
                        }
                        
                        state.lastActiveChat = now;
                        saveState();
                    }
                }
            }
            
            autoUseFurniture();
            
            if (Math.random() < 0.08) {
                const moodChange = Math.random() < 0.5 ? -1 : +1;
                updateMood(moodChange);
            }
            
            if (Math.random() < 0.02) {
                changeWeatherRandomly();
            }
            
        }, 15000);
    }

    // === Â§áÂøòÂΩïÁ≥ªÁªü ===
    function addMemo() {
        const input = document.getElementById('memo-input');
        const text = input.value.trim();
        
        if (text === '') {
            showToast("ËØ∑ËæìÂÖ•ÂÜÖÂÆπ");
            return;
        }
        
        if (state.memos.length >= 10) {
            showToast("Â§áÂøòÂΩïÊúÄÂ§öÂè™ËÉΩÊ∑ªÂä†10Êù°");
            return;
        }
        
        const newMemo = {
            id: Date.now().toString(),
            text: text,
            completed: false,
            createdAt: new Date().toLocaleString()
        };
        
        state.memos.push(newMemo);
        input.value = '';
        
        renderMemos();
        saveState();
        showToast("Â§áÂøòÂΩïÂ∑≤Ê∑ªÂä†");
        
        state.memoReminded = false;
        
        if (state.trust >= 20 && Math.random() < 0.3) {
            setTimeout(() => {
                const responses = [
                    "‰Ω†ÂÜô‰∫ÜÊñ∞ÁöÑÂ§áÂøòÂΩïÂë¢",
                    "Êàë‰ºöÂ∏Æ‰Ω†ËÆ∞‰ΩèÁöÑ",
                    "Ë¶ÅËÆ∞ÂæóÂÆåÊàêÂì¶",
                    "ÊàëÁúãÂà∞‰∫Ü‰Ω†ÂÜôÁöÑ‰∏úË•ø"
                ];
                showDialogueText(responses[Math.floor(Math.random() * responses.length)]);
            }, 1000);
        }
    }

    function renderMemos() {
        const container = document.getElementById('memo-list');
        
        if (!state.memos || state.memos.length === 0) {
            container.innerHTML = '<div class="empty-memo">ËøòÊ≤°ÊúâÂ§áÂøòÂΩïÔºåÊ∑ªÂä†Á¨¨‰∏ÄÊù°ÂêßÔºÅ</div>';
            return;
        }
        
        container.innerHTML = state.memos.map(memo => `
            <div class="memo-item ${memo.completed ? 'completed' : ''}" data-id="${memo.id}">
                <div class="memo-content">${memo.text}</div>
                <div class="memo-actions">
                    ${memo.completed ? 
                        '<span class="memo-completed">Â∑≤ÂÆåÊàê</span>' : 
                        `<button class="memo-action-btn complete" onclick="toggleMemo('${memo.id}')">ÂÆåÊàê</button>`
                    }
                    <button class="memo-action-btn delete" onclick="deleteMemo('${memo.id}')">Âà†Èô§</button>
                </div>
            </div>
        `).join('');
    }

    function toggleMemo(memoId) {
        const memo = state.memos.find(m => m.id.toString() === memoId);
        
        if (memo) {
            memo.completed = !memo.completed;
            renderMemos();
            saveState();
            
            if (memo.completed) {
                showToast("‰ªªÂä°ÂÆåÊàêÔºÅ");
                affectMoodByInteraction('pat');
                addTrust(0.5);
            } else {
                showToast("Â∑≤Ê†áËÆ∞‰∏∫Êú™ÂÆåÊàê");
            }
        }
    }

    function deleteMemo(memoId) {
        const memoIndex = state.memos.findIndex(m => m.id.toString() === memoId);
        
        if (memoIndex !== -1) {
            state.memos.splice(memoIndex, 1);
            renderMemos();
            saveState();
            showToast("Â§áÂøòÂΩïÂ∑≤Âà†Èô§");
        }
    }

    function checkMemoReminder() {
        const hasUncompletedMemos = state.memos.some(memo => !memo.completed);
        
        if (hasUncompletedMemos && !state.memoReminded && Math.random() < 0.3) {
            state.memoReminded = false;
        }
    }

    // === ‰ø°‰ªªÂÄºÁ≥ªÁªü ===
    function addTrust(val) {
        const oldTrust = state.trust;
        const now = Date.now();
        
        if (val > 0) {
            if (state.trustCooldown && now - state.lastTrustGain < 10000) {
                val *= 0.3;
            }
            
            const trustFactor = Math.max(0.1, 1 - (state.trust / 100) * 0.8);
            val *= trustFactor;
            
            const mood = getCurrentMood();
            if (mood === 'happy' || mood === 'excited') {
                val *= 1.5;
            } else if (mood === 'sad' || mood === 'anxious') {
                val *= 0.5;
            }
            
            val = Math.round(val * 10) / 10;
            
            if (val < 0.1 && val > 0) {
                val = 0.1;
            }
        }
        
        state.trust = Math.min(100, state.trust + val);
        
        if (val > 0) {
            state.lastTrustGain = now;
            state.trustCooldown = true;
            
            setTimeout(() => {
                state.trustCooldown = false;
            }, 10000);
        }
        
        recordSystem.recordTrustChange(oldTrust, state.trust);
        
        updateUI();
        checkStoryProgress();
        
        const trustTask = state.tasks.find(t => t.id === 'increase_trust');
        if (trustTask) {
            trustTask.progress = Math.min(trustTask.maxProgress, Math.floor(state.trust / 10) * 10);
            renderTaskList();
        }
        
        checkItemUnlocks();
        saveState();
    }

    // === Êó•Á®ãË°åÂä®Á≥ªÁªü ===
    function doSchedule(actionId, baseReward, timeCost) {
        const action = scheduleActions.find(a => a.id === actionId);
        if (!action) return;
        
        if (state.hunger <= action.hungerCost) {
            showToast("Â¥ΩÂ¥ΩÂ§™È•ø‰∫ÜÔºåÊó†Ê≥ïË°åÂä®ÔºÅ");
            return;
        }
        
        const now = Date.now();
        if (state.lastScheduleTime && now - state.lastScheduleTime < 30000) {
            showToast("Â¥ΩÂ¥ΩÈúÄË¶Å‰ºëÊÅØ‰∏Ä‰∏ã...");
            return;
        }
        
        state.lastScheduleTime = now;
        
        state.money += action.reward;
        state.hunger = Math.max(0, state.hunger - action.hungerCost);
        addTrust(action.trustGain);
        
        let eventMessage = "";
        if (action.risk > 0 && Math.random() < action.risk) {
            const events = [
                { message: "Â¥ΩÂ¥ΩÂú®Êé¢Á¥¢‰∏≠Âèó‰∫ÜÁÇπËΩª‰º§", effect: { hunger: -5, mood: -10 } },
                { message: "Â¥ΩÂ¥ΩÂèëÁé∞‰∫Ü‰∏Ä‰∫õÊúâÁî®ÁöÑ‰∏úË•ø", effect: { money: 30, mood: +5 } },
                { message: "Â¥ΩÂ¥ΩÈÅáÂà∞‰∫ÜÂ•áÊÄ™ÁöÑÁé∞Ë±°Ôºå‰ΩÜÂÆâÂÖ®ËøîÂõû", effect: { trust: 2, mood: -5 } },
                { message: "Â¥ΩÂ¥ΩÂèëÁé∞‰∫ÜÊñ∞ÁöÑÊó•ËÆ∞Á¥†Êùê", effect: { mood: +8 } }
            ];
            const event = events[Math.floor(Math.random() * events.length)];
            eventMessage = `Ôºà${event.message}Ôºâ`;
            
            if (event.effect.money) state.money += event.effect.money;
            if (event.effect.hunger) state.hunger = Math.max(0, state.hunger + event.effect.hunger);
            if (event.effect.trust) addTrust(event.effect.trust);
            if (event.effect.mood) updateMood(event.effect.mood);
        }
        
        let rewardText = action.reward > 0 ? `Ëé∑Âæó ${action.reward}üí∞` : '';
        let trustText = action.trustGain > 0 ? `‰ø°‰ªªÂÄº+${action.trustGain.toFixed(1)}` : '';
        let message = `Ë°åÂä®ÁªìÊùüÔºå${rewardText} ${trustText} ${eventMessage}`.trim();
        showToast(message);
        
        // ÂÆûÈôÖÂÆåÊàêÊó•Á®ãÂêéÊõ¥Êñ∞‰ªªÂä°ËøõÂ∫¶
        const scheduleTask = state.tasks.find(t => t.id === 'complete_schedule');
        if (scheduleTask) {
            scheduleTask.progress = 1;
            renderTaskList();
        }
        
        if (Math.random() > 0.6) checkDiaryGeneration();
        
        checkItemUnlocks();
        
        showDialogue('idle');
        
        if (actionId === 'explore' && Math.random() < action.risk) {
            affectMoodByInteraction('hurt');
        } else if (actionId === 'talk') {
            affectMoodByInteraction('chat');
        } else {
            affectMoodByInteraction('pat');
        }
        
        updateUI();
        checkStoryProgress();
        saveState();
        
        recordSystem.addRecord(
            `Êó•Á®ãË°åÂä®Ôºö${action.name}`,
            `ËßÇÊµãÂØπË±°ÊâßË°å‰∫Ü${action.name}Ë°åÂä®„ÄÇËÄóÊó∂Ôºö${action.time}Â∞èÊó∂„ÄÇÁªìÊûúÔºö${message}`,
            ['Êó•Á®ã', 'Ë°åÂä®']
        );
    }

    // === ÊàøÈó¥ÊîπÈÄ†ÂäüËÉΩ - ‰øÆÂ§çÔºöÁªøÊ§çÊîπ‰∏∫ÂèØË¥≠‰π∞ ===
    function renderRoomShop() {
        const list = document.getElementById('room-shop-list');
        const availableItems = furnitureItems.filter(item => 
            !state.purchasedFurniture.includes(item.id)
        );
        
        if (availableItems.length === 0) {
            list.innerHTML = "<div style='text-align:center;color:#ccc;margin-top:20px'>ÊâÄÊúâÂÆ∂ÂÖ∑ÈÉΩÂ∑≤Ë¥≠‰π∞ÔºÅ</div>";
            return;
        }
        
        list.innerHTML = availableItems.map(item => `
            <div class="furniture-item">
                <div class="furniture-header">
                    <span class="furniture-title">${item.emoji} ${item.name}</span>
                    <span class="furniture-price">${item.price}üí∞</span>
                </div>
                <div class="furniture-desc">${item.desc}</div>
                <div class="furniture-effect">ÊïàÊûúÔºö${item.effect}</div>
                <button class="btn-action" style="width:100%; margin-top:10px;" onclick="buyFurniture('${item.id}')">Ë¥≠‰π∞</button>
            </div>
        `).join('');
    }

    function buyFurniture(furnitureId) {
        const furniture = furnitureItems.find(f => f.id === furnitureId);
        if (!furniture) return;
        
        if (state.money >= furniture.price) {
            state.money -= furniture.price;
            state.purchasedFurniture.push(furnitureId);
            
            if (!state.firstFurnitureBought) {
                state.firstFurnitureBought = true;
                recordSystem.recordKeyInteraction('first_furniture', furniture.name);
            }
            
            // ÂÆûÈôÖË¥≠‰π∞ÂÆ∂ÂÖ∑ÂêéÊõ¥Êñ∞‰ªªÂä°ËøõÂ∫¶
            const buyFurnitureTask = state.tasks.find(t => t.id === 'buy_furniture');
            if (buyFurnitureTask) {
                buyFurnitureTask.progress = 1;
                renderTaskList();
            }
            renderFurniture();
            
            showToast(`Ë¥≠‰π∞ÊàêÂäüÔºÅ${furniture.name}Â∑≤Ê∑ªÂä†Âà∞ÊàøÈó¥`);
            updateUI();
            
            setTimeout(() => {
                const phase = getTrustPhase();
                const mood = getCurrentMood();
                const messages = mentalActivities[phase] ? mentalActivities[phase].furniture : null;
                const furnitureType = furniture.id.includes('bed') ? 'bed' : 
                                   furniture.id.includes('desk') ? 'desk' :
                                   furniture.id.includes('bookshelf') ? 'bookshelf' :
                                   furniture.id.includes('plant') ? 'plant' : 'lamp';
                
                if (messages && messages[furnitureType]) {
                    showDialogueText(messages[furnitureType]);
                } else {
                    const defaultResponses = [
                        "Êñ∞ÁöÑÂÆ∂ÂÖ∑ÔºÅ",
                        "Ë∞¢Ë∞¢ÔºåÊàëÂæàÂñúÊ¨¢",
                        "ÊàøÈó¥ÂèòÂæóÊõ¥Â•Ω‰∫Ü",
                        "ÊÑüËßâÊõ¥ËàíÈÄÇ‰∫Ü"
                    ];
                    showDialogueText(defaultResponses[Math.floor(Math.random() * defaultResponses.length)]);
                }
                
                affectMoodByInteraction('gift');
            }, 1000);
            
            saveState();
            
            recordSystem.addRecord(
                `ÂÆ∂ÂÖ∑Ê∑ªÁΩÆÔºö${furniture.name}`,
                `ËßÇÊµãËÄÖ‰∏∫ÊàøÈó¥Ê∑ªÁΩÆ‰∫Ü${furniture.name}„ÄÇÊàøÈó¥ËàíÈÄÇÂ∫¶ÊèêÂçá„ÄÇËä±Ë¥πÔºö${furniture.price}ÈáëÂ∏Å„ÄÇ`,
                ['ÂÆ∂ÂÖ∑', 'Ë¥≠‰π∞']
            );
        } else {
            showToast("ÈáëÂ∏Å‰∏çË∂≥ÔºÅ");
        }
    }

    function renderFurniture() {
        const container = document.getElementById('furniture-container');
        container.innerHTML = '';
        
        state.purchasedFurniture.forEach(furnitureId => {
            const furniture = furnitureItems.find(f => f.id === furnitureId);
            if (furniture) {
                const item = document.createElement('div');
                item.className = 'room-item';
                item.id = furniture.id;
                item.title = furniture.name;
                item.innerHTML = furniture.emoji;
                item.style.left = furniture.position.x + 'px';
                item.style.top = furniture.position.y + 'px';
                item.style.fontSize = furniture.size;
                item.onclick = () => interactWithFurniture(furniture.id);
                container.appendChild(item);
            }
        });
    }

    function interactWithFurniture(furnitureId) {
        const charWrapper = document.getElementById('character-wrapper');
        const charRect = charWrapper.getBoundingClientRect();
        const furnitureEl = document.getElementById(furnitureId);
        
        if (!furnitureEl) return;
        
        const furnitureRect = furnitureEl.getBoundingClientRect();
        const distance = Math.sqrt(
            Math.pow(charRect.left - furnitureRect.left, 2) + 
            Math.pow(charRect.top - furnitureRect.top, 2)
        );
        
        if (distance < 200) {
            const furniture = furnitureItems.find(f => f.id === furnitureId) || 
                             { id: furnitureId, name: furnitureId.includes('bed') ? 'Â∫ä' : 'Áâ©ÂìÅ' };
            
            useFurniture(furniture);
        } else {
            showToast("Â¥ΩÂ¥Ω‰∏çÂú®ÈôÑËøë...");
        }
    }

    function useFurniture(furniture) {
        const phase = getTrustPhase();
        const mood = getCurrentMood();
        const messages = mentalActivities[phase] ? mentalActivities[phase].furniture : null;
        
        let furnitureType = 'bed';
        if (furniture.id.includes('desk')) furnitureType = 'desk';
        else if (furniture.id.includes('bookshelf')) furnitureType = 'bookshelf';
        else if (furniture.id.includes('plant')) furnitureType = 'plant';
        else if (furniture.id.includes('lamp')) furnitureType = 'lamp';
        
        if (messages && messages[furnitureType]) {
            showDialogueText(messages[furnitureType]);
        } else {
            // ‰øÆÂ§çÔºöÊ≠£Á°ÆËé∑ÂèñÂÆ∂ÂÖ∑Á±ªÂûãÔºåÂ§ÑÁêÜÊ≤°Êúâ‰∏ãÂàíÁ∫øÁöÑID
            const furnitureType = furniture.id.includes('_') ? furniture.id.split('_')[1] : furniture.id;
            const reactions = furnitureReactions[furnitureType] || furnitureReactions.bed;
            if (reactions && reactions.use) {
                showDialogueText(reactions.use[Math.floor(Math.random() * reactions.use.length)]);
            } else {
                const defaultResponses = [
                    "‰ΩøÁî®‰∏≠...",
                    "Ëøô‰∏™ÂÆ∂ÂÖ∑ÂæàÂ•ΩÁî®",
                    "ÊÑüËßâ‰∏çÈîô",
                    "Ë∞¢Ë∞¢‰Ω†ÁöÑÁ§ºÁâ©"
                ];
                showDialogueText(defaultResponses[Math.floor(Math.random() * defaultResponses.length)]);
            }
        }
        
        if (!state.furnitureUsage[furniture.id]) {
            state.furnitureUsage[furniture.id] = 0;
        }
        state.furnitureUsage[furniture.id]++;
        
        const furnitureEl = document.getElementById(furniture.id);
        if (furnitureEl) {
            furnitureEl.classList.add('using-furniture');
            setTimeout(() => {
                furnitureEl.classList.remove('using-furniture');
            }, 2000);
        }
        
        if (furniture.id.includes('bed')) {
            state.hunger = Math.min(100, state.hunger + 15);
            affectMoodByInteraction('pat');
        } else if (furniture.id.includes('desk')) {
            addTrust(1);
            affectMoodByInteraction('pat');
        } else if (furniture.id.includes('plant')) {
            affectMoodByInteraction('pat');
            updateMood(5);
        } else if (furniture.id.includes('lamp')) {
            affectMoodByInteraction('pat');
            updateMood(3);
        }
        
        updateUI();
        saveState();
    }

    function autoUseFurniture() {
        if (state.purchasedFurniture.length === 0) return;
        
        const phase = getTrustPhase();
        const mood = getCurrentMood();
        const furnitureList = state.purchasedFurniture.map(id => furnitureItems.find(f => f.id === id)).filter(f => f);
        
        furnitureList.forEach(furniture => {
            const useChance = furniture.useChance || 0.2;
            if (Math.random() < useChance) {
                setTimeout(() => {
                    const messages = mentalActivities[phase] ? mentalActivities[phase].furniture : null;
                    let furnitureType = 'bed';
                    if (furniture.id.includes('desk')) furnitureType = 'desk';
                    else if (furniture.id.includes('bookshelf')) furnitureType = 'bookshelf';
                    else if (furniture.id.includes('plant')) furnitureType = 'plant';
                    else if (furniture.id.includes('lamp')) furnitureType = 'lamp';
                    
                    if (messages && messages[furnitureType]) {
                        showDialogueText(messages[furnitureType]);
                    }
                    
                    updateMood(3);
                }, Math.random() * 5000 + 2000);
            }
        });
    }

    // === Êó•ËÆ∞Á≥ªÁªü ===
    function checkDiaryGeneration() {
        const now = Date.now();
        const lastGen = state.lastDiaryGeneration || 0;
        
        if (now - lastGen < 86400000) {
            return;
        }
        
        const mood = getCurrentMood();
        const moodEntries = diaryContentLibrary[mood];
        
        if (!moodEntries || moodEntries.length === 0) {
            return;
        }
        
        const availableEntries = moodEntries.filter(entry => 
            entry.requireTrust <= state.trust && 
            !state.diaryEntries.some(de => de.title === entry.title)
        );
        
        if (availableEntries.length === 0) {
            if (Math.random() < 0.3) {
                generateRandomDiary(mood);
            }
            return;
        }
        
        let selectedEntry;
        if (state.trust < 15) {
            selectedEntry = availableEntries[0];
        } else if (state.trust < 30) {
            selectedEntry = availableEntries[Math.min(1, availableEntries.length - 1)];
        } else {
            const weights = availableEntries.map((_, index) => 
                Math.pow(0.8, index)
            );
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;
            
            for (let i = 0; i < availableEntries.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    selectedEntry = availableEntries[i];
                    break;
                }
            }
        }
        
        if (selectedEntry) {
            createNewDiaryEntry(selectedEntry, mood);
        }
    }

    function generateRandomDiary(mood) {
        const diaryTemplates = {
            happy: [
                { title: "Âø´‰πêÁöÑÂ∞è‰∫ã", content: "‰ªäÂ§©ÂèëÁîü‰∫Ü‰∏Ä‰ª∂Â∞è‰∫ãÔºå‰ΩÜËÆ©ÊàëÂæàÂºÄÂøÉ„ÄÇËôΩÁÑ∂‰∏çÁü•ÈÅìÂéüÂõ†Ôºå‰ΩÜËøôÁßçÊ∏©ÊöñÁöÑÊÑüËßâËÆ©ÊàëÊÉ≥ËÆ∞ÂΩï‰∏ãÊù•„ÄÇ" },
                { title: "ÂæÆÁ¨ëÁöÑÁêÜÁî±", content: "‰∏çÁü•‰∏çËßâÈó¥ÔºåÊàëÂºÄÂßãÊúüÂæÖÊØè‰∏ÄÂ§©‰∫Ü„ÄÇËøô‰∏™ÊàøÈó¥Â•ΩÂÉè‰πüÊ≤°ÈÇ£‰πàÁ≥üÁ≥ï„ÄÇ" }
            ],
            calm: [
                { title: "Âπ≥Âá°ÁöÑ‰∏ÄÂ§©", content: "‰ªäÂ§©ÂæàÂπ≥Èùô„ÄÇÊàëÊï¥ÁêÜ‰∫Ü‰∏Ä‰∏ãÊàøÈó¥ÔºåÁúã‰∫ÜÁúãÁ™óÂ§ñ„ÄÇÊó∂Èó¥ÊÖ¢ÊÖ¢ÊµÅÈÄùÔºå‰ΩÜÊàëÂπ∂‰∏çÁùÄÊÄ•„ÄÇ" },
                { title: "ÂÜÖÂøÉÁöÑÂπ≥Èùô", content: "ÊàëÂèëÁé∞ÔºåÂΩìÊàë‰∏çÂÜçÊÅêÊÉßÁöÑÊó∂ÂÄôÔºåËøô‰∏™ÊàøÈó¥ÂÖ∂ÂÆûÊå∫ËàíÈÄÇÁöÑ„ÄÇ" }
            ]
        };
        
        const templates = diaryTemplates[mood] || [
            { title: "‰ªäÂ§©ÁöÑËÆ∞ÂΩï", content: `‰ªäÂ§©ÊòØÁ¨¨${state.day}Â§©„ÄÇÂøÉÊÉÖÔºö${moodTypes[mood].name}„ÄÇ` }
        ];
        
        const template = templates[Math.floor(Math.random() * templates.length)];
        const newDiary = {
            id: Date.now().toString(),
            title: template.title,
            date: `Á¨¨${state.day}Â§©`,
            mood: moodTypes[mood].emoji + " " + moodTypes[mood].name,
            content: template.content,
            createdAt: Date.now()
        };
        
        state.diaryEntries.push(newDiary);
        state.lastDiaryGeneration = Date.now();
        
        const diaryBook = document.getElementById('diary-book');
        diaryBook.innerText = 'üìî‚ú®';
        diaryBook.style.display = 'block';
        
        setTimeout(() => {
            diaryBook.innerText = 'üìî';
        }, 2000);
        
        saveState();
    }

    function createNewDiaryEntry(entry, mood) {
        const newDiary = {
            id: Date.now().toString(),
            title: entry.title,
            date: `Á¨¨${state.day}Â§©`,
            mood: moodTypes[mood].emoji + " " + moodTypes[mood].name,
            content: entry.content,
            createdAt: Date.now()
        };
        
        state.diaryEntries.push(newDiary);
        state.lastDiaryGeneration = Date.now();
        
        const diaryBook = document.getElementById('diary-book');
        diaryBook.innerText = 'üìî‚ú®';
        diaryBook.style.animation = 'float 1s infinite ease-in-out';
        diaryBook.style.display = 'block';
        
        setTimeout(() => {
            diaryBook.innerText = 'üìî';
            diaryBook.style.animation = 'float 3s infinite ease-in-out';
        }, 2000);
        
        showToast("ÂèëÁé∞‰∫Ü‰∏ÄÁØáÊñ∞ÁöÑÊó•ËÆ∞ÔºÅ");
        
        recordSystem.addRecord(
            'Êó•ËÆ∞ÁîüÊàê',
            `ËßÇÊµãÂØπË±°ÂÜô‰∏ã‰∫ÜÊñ∞ÁöÑÊó•ËÆ∞Ôºö${entry.title}„ÄÇ`,
            ['Êó•ËÆ∞', 'ÂøÉÁêÜ']
        );
        
        saveState();
    }

    function openDiary() {
        const container = document.getElementById('diary-container');
        
        if (state.diaryEntries.length === 0) {
            container.innerHTML = `
                <div style='text-align:center;color:#999; margin-top:20px;'>
                    <p>Êó•ËÆ∞Êú¨ÊòØÁ©∫ÁöÑ„ÄÇ</p>
                    <p style='font-size:11px; margin-top:10px;'>Â¥ΩÂ¥ΩËøòÊ≤°ÊúâÂÜôÊó•ËÆ∞...ÊèêÂçá‰ø°‰ªªÂÄºÊàñÁ≠âÂæÖ‰ªñÂøÉÊÉÖÂèòÂåñÊó∂ÂèØËÉΩ‰ºöÂÜôÊó•ËÆ∞</p>
                </div>
            `;
        } else {
            const sortedEntries = [...state.diaryEntries].sort((a, b) => b.createdAt - a.createdAt);
            
            container.innerHTML = sortedEntries.map(d => `
                <div class="diary-paper">
                    <div class="diary-date">
                        <span>${d.title} - ${d.date}</span>
                        <span class="diary-mood">${d.mood}</span>
                    </div>
                    ${d.content}
                </div>
            `).join('');
            
            if (!state.firstDiaryRead && state.diaryEntries.length > 0) {
                state.firstDiaryRead = true;
                recordSystem.recordKeyInteraction('first_diary', '');
            }
            
            // ÂÆûÈôÖÈòÖËØªÊó•ËÆ∞ÂêéÊõ¥Êñ∞‰ªªÂä°ËøõÂ∫¶
            const readDiaryTask = state.tasks.find(t => t.id === 'read_diary');
            if (readDiaryTask) {
                readDiaryTask.progress = 1;
                renderTaskList();
            }
            addTrust(0.3);
        }
        
        openModal('diary-modal');
    }

    // === ÂïÜÂ∫óÁ≥ªÁªü ===
    function renderShop() {
        const list = document.getElementById('shop-list');
        const allItems = [...baseItems, ...unlockableItems];
        
        const availableItems = allItems.filter(item => 
            item.unlockCondition === null || 
            state.unlockedItems.includes(item.id) || 
            item.unlockCondition(state)
        );
        
        if (availableItems.length === 0) {
            list.innerHTML = "<div style='text-align:center;color:#ccc;margin-top:20px'>ÂïÜÂ∫óÊöÇÊó∂Ê≤°ÊúâÂèØË¥≠‰π∞ÁöÑÁâ©ÂìÅ</div>";
            return;
        }
        
        list.innerHTML = availableItems.map(item => {
            const isNewlyUnlocked = !state.unlockedItems.includes(item.id) && 
                                   (item.unlockCondition === null || item.unlockCondition(state));
            
            if (isNewlyUnlocked && !state.unlockedItems.includes(item.id)) {
                state.unlockedItems.push(item.id);
                saveState();
            }
            
            const itemClass = isNewlyUnlocked ? 'item-row item-unlocked' : 'item-row';
            
            return `
                <div class="${itemClass}">
                    <div>
                        <strong>${item.name}</strong><br>
                        <span style="color:#aaa;font-size:10px">${item.desc}</span>
                        ${isNewlyUnlocked ? '<div class="unlock-condition">‚ú® Êñ∞Ëß£ÈîÅÔºÅ</div>' : ''}
                    </div>
                    <button class="btn-action" onclick="buyItem('${item.id}')">${item.price}üí∞</button>
                </div>
            `;
        }).join('');
        
        const lockedItems = unlockableItems.filter(item => 
            !state.unlockedItems.includes(item.id) && 
            item.unlockCondition && 
            !item.unlockCondition(state)
        );
        
        if (lockedItems.length > 0) {
            list.innerHTML += `
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #eee;">
                    <h4 style="color: #888; font-size: 12px; margin-bottom: 10px;">ÂæÖËß£ÈîÅÁâ©ÂìÅ</h4>
                    ${lockedItems.map(item => `
                        <div class="item-row locked-item">
                            <div>
                                <strong style="color:#aaa">${item.name}</strong><br>
                                <span style="color:#ccc;font-size:10px">${item.desc}</span>
                                <div class="unlock-condition">üîí ${getUnlockConditionText(item)}</div>
                            </div>
                            <span style="color:#ccc">${item.price}üí∞</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    }

    function getUnlockConditionText(item) {
        if (item.unlockCondition) {
            if (item.id === 'book') return "‰ø°‰ªªÂÄºËææÂà∞25Ëß£ÈîÅ";
            if (item.id === 'radio') return "‰ø°‰ªªÂÄºËææÂà∞45Ëß£ÈîÅ";
            if (item.id === 'teddy') return "‰ø°‰ªªÂÄºËææÂà∞65Ëß£ÈîÅ";
            if (item.id === 'lamp') return "‰ø°‰ªªÂÄºËææÂà∞35Ëß£ÈîÅ";
            if (item.id === 'cake') return "ÂñÇÈ£ü8Ê¨°ÂêéËß£ÈîÅ";
            if (item.id === 'puzzle') return "Ê∏∏ÊàèÂ§©Êï∞ËææÂà∞15Â§©Ëß£ÈîÅ";
            if (item.id === 'blanket') return "Á¥ØËÆ°Ëé∑Âæó800ÈáëÂ∏ÅËß£ÈîÅ";
            if (item.id === 'camera') return "‰ø°‰ªªÂÄºËææÂà∞80Ëß£ÈîÅ";
        }
        return "Êú™Áü•Êù°‰ª∂";
    }

    function checkItemUnlocks() {
        unlockableItems.forEach(item => {
            if (item.unlockCondition && item.unlockCondition(state) && !state.unlockedItems.includes(item.id)) {
                state.unlockedItems.push(item.id);
                showToast(`‚ú® Êñ∞ÂïÜÂìÅËß£ÈîÅÔºö${item.name}ÔºÅ`);
                
                recordSystem.addRecord(
                    `ÂïÜÂìÅËß£ÈîÅÔºö${item.name}`,
                    `ÂïÜÂ∫óËß£ÈîÅÊñ∞ÂïÜÂìÅÔºö${item.name}„ÄÇËß£ÈîÅÊù°‰ª∂Â∑≤Êª°Ë∂≥Ôºö${getUnlockConditionText(item)}„ÄÇ`,
                    ['ÂïÜÂ∫ó', 'Ëß£ÈîÅ']
                );
                
                saveState();
            }
        });
    }

    function buyItem(id) {
        const allItems = [...baseItems, ...unlockableItems];
        const item = allItems.find(i => i.id === id);
        
        if (!item) {
            showToast("ÂïÜÂìÅ‰∏çÂ≠òÂú®");
            return;
        }
        
        if (item.unlockCondition && !state.unlockedItems.includes(item.id) && !item.unlockCondition(state)) {
            showToast("ËØ•ÂïÜÂìÅÂ∞öÊú™Ëß£ÈîÅ");
            return;
        }
        
        if (state.money >= item.price) {
            state.money -= item.price;
            state.inventory.push(item);
            showToast("Ë¥≠‰π∞ÊàêÂäüÔºåÂ∑≤Â≠òÂÖ•ËÉåÂåÖ");
            
            // ÂÆûÈôÖË¥≠‰π∞Áâ©ÂìÅÂêéÊõ¥Êñ∞‰ªªÂä°ËøõÂ∫¶
            const buyTask = state.tasks.find(t => t.id === 'buy_item');
            if (buyTask) {
                buyTask.progress = 1;
                renderTaskList();
            }
            
            updateUI();
            saveState();
            
            recordSystem.addRecord(
                `Ë¥≠‰π∞Áâ©ÂìÅÔºö${item.name}`,
                `ËßÇÊµãËÄÖË¥≠‰π∞‰∫Ü${item.name}„ÄÇËä±Ë¥πÔºö${item.price}ÈáëÂ∏Å„ÄÇÁâ©ÂìÅÂ∑≤Â≠òÂÖ•ËÉåÂåÖ„ÄÇ`,
                ['ÂïÜÂ∫ó', 'Ë¥≠‰π∞']
            );
        } else {
            showToast("‰ΩôÈ¢ù‰∏çË∂≥");
        }
    }

    function renderBag() {
        const list = document.getElementById('bag-list');
        if (state.inventory.length === 0) {
            list.innerHTML = "<div style='text-align:center;color:#ccc;margin-top:20px'>ËÉåÂåÖÊòØÁ©∫ÁöÑ</div>";
            return;
        }
        list.innerHTML = state.inventory.map((item, idx) => `
            <div class="item-row">
                <div>
                    <strong>${item.name}</strong><br>
                    <span style="color:#aaa;font-size:10px">${item.desc}</span>
                </div>
                <button class="btn-action" onclick="useItem(${idx})">Áªô‰∫à</button>
            </div>
        `).join('');
    }

    function useItem(idx) {
        const item = state.inventory[idx];
        state.inventory.splice(idx, 1);
        
        const mood = getCurrentMood();
        const reactions = itemReactions[item.id];
        
        let dialogue = "";
        if (reactions && reactions[mood]) {
            const moodReactions = reactions[mood];
            dialogue = moodReactions[Math.floor(Math.random() * moodReactions.length)];
        } else {
            if (item.type === 'food') {
                switch(mood) {
                    case 'anxious': dialogue = "È£üÁâ©...Ë∞¢Ë∞¢"; break;
                    case 'calm': dialogue = "ÊàëÊî∂‰∏ã‰∫Ü"; break;
                    case 'happy': dialogue = "Ë∞¢Ë∞¢ÔºÅÁúãËµ∑Êù•ÂæàÂ•ΩÂêÉ"; break;
                    case 'excited': dialogue = "ÂìáÔºÅÈ£üÁâ©ÔºÅË∞¢Ë∞¢‰Ω†ÔºÅ"; break;
                    default: dialogue = "Ë∞¢Ë∞¢";
                }
            } else {
                switch(mood) {
                    case 'anxious': dialogue = "Á§ºÁâ©Ôºü‰∏∫‰ªÄ‰πàÁªôÊàëËøô‰∏™Ôºü"; break;
                    case 'calm': dialogue = "Ë∞¢Ë∞¢‰Ω†ÁöÑÁ§ºÁâ©"; break;
                    case 'happy': dialogue = "Á§ºÁâ©ÔºÅÂ•ΩÂºÄÂøÉÔºÅ"; break;
                    case 'excited': dialogue = "Â§™Ê£í‰∫ÜÔºÅË∞¢Ë∞¢‰Ω†ÔºÅ"; break;
                    default: dialogue = "Ë∞¢Ë∞¢";
                }
            }
        }
        
        showDialogueText(dialogue);
        
        if (item.type === 'food') {
            state.hunger = Math.min(100, state.hunger + 30);
            state.foodEaten++;
            
            if (!state.firstFeedDone) {
                state.firstFeedDone = true;
                recordSystem.recordKeyInteraction('first_feed', '');
            }
            
            affectMoodByInteraction('feed');
            
            // ÂÆûÈôÖÂñÇÈ£üÂêéÊõ¥Êñ∞‰ªªÂä°ËøõÂ∫¶
            const feedTask = state.tasks.find(t => t.id === 'feed_zaizai');
            if (feedTask) {
                feedTask.progress = 1;
                renderTaskList();
            }
            saveState();
        } else {
            if (!state.firstGiftDone) {
                state.firstGiftDone = true;
                recordSystem.recordKeyInteraction('first_gift', item.name);
            }
            
            affectMoodByInteraction('gift');
        }
        
        renderBag();
        updateUI();
        closeModal('bag-modal');
        
        setTimeout(checkDiaryGeneration, 1000);
        checkItemUnlocks();
        saveState();
        
        recordSystem.addRecord(
            `‰ΩøÁî®Áâ©ÂìÅÔºö${item.name}`,
            `ËßÇÊµãËÄÖÂêëËßÇÊµãÂØπË±°Êèê‰æõ‰∫Ü${item.name}„ÄÇËßÇÊµãÂØπË±°ÂèçÂ∫îÔºö${dialogue}`,
            ['‰∫íÂä®', item.type === 'food' ? 'ÂñÇÈ£ü' : 'Á§ºÁâ©']
        );
    }

    // === ÂâßÊÉÖÁ≥ªÁªü ===
    function checkStoryProgress() {
        if (state.currentChapter < storyChapters.length) {
            const nextStory = storyChapters[state.currentChapter];
            if (state.trust >= nextStory.t) {
                showStoryChapter(nextStory);
                state.currentChapter++;
                
                recordSystem.recordStoryProgress(nextStory.title);
                
                saveState();
            }
        }
    }

    function showStoryChapter(chapter) {
        document.getElementById('story-chapter-title').innerText = chapter.title;
        document.getElementById('story-title').innerText = '';
        document.getElementById('story-content').innerHTML = chapter.content;
        
        const choiceContainer = document.getElementById('story-choice');
        choiceContainer.innerHTML = '';
        
        if (chapter.choices && chapter.choices.length > 0) {
            chapter.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'story-btn';
                button.innerText = choice.text;
                button.onclick = () => {
                    choice.effect();
                    document.getElementById('continue-story-btn').style.display = 'block';
                    choiceContainer.innerHTML = '';
                    state.storyChoices.push({ chapter: chapter.title, choice: choice.text });
                };
                choiceContainer.appendChild(button);
            });
            document.getElementById('continue-story-btn').style.display = 'none';
        } else {
            document.getElementById('continue-story-btn').style.display = 'block';
        }
        
        openModal('story-modal');
        
        if (state.trust >= 30) {
            document.getElementById('diary-book').style.display = 'block';
        }
    }

    // === ‰ªªÂä°Á≥ªÁªü ===
function renderTaskList() {
    const container = document.getElementById('task-list');
    
    if (!state.tasks || state.tasks.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#ccc;margin-top:20px">ÊöÇÊó†‰ªªÂä°</div>';
        return;
    }
    
    // ÊåâÁ±ªÂûãÂàÜÁªÑÔºöÊØèÊó•‰ªªÂä°„ÄÅËøõÂ∫¶‰ªªÂä°„ÄÅÊàêÂ∞±‰ªªÂä°
    const dailyTasks = state.tasks.filter(t => t.type === 'daily');
    const progressTasks = state.tasks.filter(t => t.type === 'progress');
    const achievementTasks = state.tasks.filter(t => t.type === 'achievement');
    
    let html = '';
    
    // ÊØèÊó•‰ªªÂä°
    if (dailyTasks.length > 0) {
        html += '<h4 style="color: #888; font-size: 12px; margin-bottom: 10px; margin-top: 0;">ÊØèÊó•‰ªªÂä°</h4>';
        html += dailyTasks.map(task => renderTaskItem(task)).join('');
    }
    
    // ËøõÂ∫¶‰ªªÂä°
    if (progressTasks.length > 0) {
        html += '<h4 style="color: #888; font-size: 12px; margin-bottom: 10px; margin-top: 20px;">ËøõÂ∫¶‰ªªÂä°</h4>';
        html += progressTasks.map(task => renderTaskItem(task)).join('');
    }
    
    // ÊàêÂ∞±‰ªªÂä°
    if (achievementTasks.length > 0) {
        html += '<h4 style="color: #888; font-size: 12px; margin-bottom: 10px; margin-top: 20px;">ÊàêÂ∞±‰ªªÂä°</h4>';
        html += achievementTasks.map(task => renderTaskItem(task)).join('');
    }
    
    container.innerHTML = html;
}

function renderTaskItem(task) {
    const progressPercent = task.maxProgress > 0 ? (task.progress / task.maxProgress) * 100 : 0;
    const isCompleted = task.progress >= task.maxProgress;
    const isClaimable = isCompleted && !task.claimed;
    
    // Ê†πÊçÆ‰ªªÂä°Á±ªÂûãÊòæÁ§∫‰∏çÂêåÁöÑÊ†∑Âºè
    let typeBadge = '';
    switch(task.type) {
        case 'daily':
            typeBadge = '<span style="font-size:9px; color:#4CAF50; background:#E8F5E9; padding:1px 5px; border-radius:8px;">ÊØèÊó•</span>';
            break;
        case 'progress':
            typeBadge = '<span style="font-size:9px; color:#2196F3; background:#E3F2FD; padding:1px 5px; border-radius:8px;">ËøõÂ∫¶</span>';
            break;
        case 'achievement':
            typeBadge = '<span style="font-size:9px; color:#FF9800; background:#FFF3E0; padding:1px 5px; border-radius:8px;">ÊàêÂ∞±</span>';
            break;
    }
    
    return `
        <div class="task-item">
            <div class="task-info">
                <div class="task-title">
                    ${task.title} ${typeBadge}
                </div>
                <div class="task-desc">${task.desc}</div>
                <div class="task-progress">
                    <div class="task-progress-fill" style="width: ${progressPercent}%"></div>
                </div>
                <div style="font-size:10px; color:#888; margin-top:3px;">
                    ËøõÂ∫¶: ${task.progress}/${task.maxProgress}
                </div>
            </div>
            <div>
                <span class="task-reward">+${task.reward}üí∞</span>
                <button class="task-btn" 
                        onclick="claimTaskReward('${task.id}')" 
                        ${isClaimable ? '' : 'disabled'}
                        style="${isClaimable ? 'background: var(--primary-pink);' : ''}">
                    ${isCompleted ? (task.claimed ? 'Â∑≤È¢ÜÂèñ' : 'È¢ÜÂèñ') : 'ËøõË°å‰∏≠'}
                </button>
            </div>
        </div>
    `;
}

    function updateAchievementProgress() {
        // ÈÅçÂéÜÊâÄÊúâÊàêÂ∞±‰ªªÂä°ÔºåÊ†πÊçÆÂÆûÈôÖÊÉÖÂÜµÊõ¥Êñ∞ËøõÂ∫¶
        state.tasks.forEach(task => {
            if (task.type === 'achievement' && task.progress < task.maxProgress) {
                switch(task.id) {
                    case 'first_feed':
                        // ÂàùÊ¨°ÂñÇÈ£üÊàêÂ∞±
                        if (state.firstFeedDone) {
                            task.progress = 1;
                        }
                        break;
                    case 'first_gift':
                        // ÂàùÊ¨°ÈÄÅÁ§ºÊàêÂ∞±
                        if (state.firstGiftDone) {
                            task.progress = 1;
                        }
                        break;
                    case 'first_diary':
                        // ÂàùÊ¨°ËØªÊó•ËÆ∞ÊàêÂ∞±
                        if (state.firstDiaryRead) {
                            task.progress = 1;
                        }
                        break;
                    case 'trust_30':
                        // ‰ø°‰ªªÂÄºËææÂà∞30ÁÇπÊàêÂ∞±
                        if (state.trust >= 30) {
                            task.progress = 1;
                        }
                        break;
                    case 'trust_60':
                        // ‰ø°‰ªªÂÄºËææÂà∞60ÁÇπÊàêÂ∞±
                        if (state.trust >= 60) {
                            task.progress = 1;
                        }
                        break;
                    case 'trust_100':
                        // ‰ø°‰ªªÂÄºËææÂà∞100ÁÇπÊàêÂ∞±
                        if (state.trust >= 100) {
                            task.progress = 1;
                        }
                        break;
                    case 'feed_10':
                        // Á¥ØÁßØÂñÇÈ£ü10Ê¨°ÊàêÂ∞±
                        task.progress = Math.min(task.maxProgress, state.foodEaten);
                        break;
                    case 'interact_50':
                        // Á¥ØÁßØ‰∏éÂ¥ΩÂ¥Ω‰∫íÂä®50Ê¨°ÊàêÂ∞±
                        task.progress = Math.min(task.maxProgress, state.interactionCount);
                        break;
                    case 'collect_all_furniture':
                        // Ë¥≠‰π∞ÊâÄÊúâÂÆ∂ÂÖ∑ÊàêÂ∞±
                        // Âä®ÊÄÅËÆ°ÁÆóÈúÄË¶ÅË¥≠‰π∞ÁöÑÂÆ∂ÂÖ∑Êï∞Èáè
                        const totalFurniture = furnitureItems.length;
                        task.maxProgress = totalFurniture;
                        task.progress = state.purchasedFurniture.length;
                        if (state.purchasedFurniture.length >= totalFurniture) {
                            task.progress = task.maxProgress;
                        }
                        break;
                }
            }
        });
    }

    function updateTaskProgress(taskId) {
        const task = state.tasks.find(t => t.id === taskId);
        if (!task) return;
        
        // Ê†πÊçÆÂÆûÈôÖÂÆåÊàêÊÉÖÂÜµÊõ¥Êñ∞‰ªªÂä°ËøõÂ∫¶
        switch(taskId) {
            case 'daily_login':
                // ÁôªÂΩï‰ªªÂä°ÔºöÂè™ÊúâÂú®ÂΩìÂ§©Á¨¨‰∏ÄÊ¨°ÁôªÂΩïÊó∂Ëá™Âä®ÂÆåÊàê
                if (!state.dailyLoginClaimed) {
                    task.progress = 1;
                }
                break;
            case 'feed_zaizai':
                // ÂñÇÈ£ü‰ªªÂä°ÔºöÈÄöËøáfeedÂáΩÊï∞Ë∞ÉÁî®Êó∂Êõ¥Êñ∞ÔºåËøôÈáå‰∏çËá™Âä®ÂÆåÊàê
                // ‰øùÊåÅÂΩìÂâçËøõÂ∫¶ÔºåÁî±ÂÆûÈôÖÂñÇÈ£üÊìç‰ΩúÊõ¥Êñ∞
                break;
            case 'play_with_zaizai':
                // ‰∫íÂä®‰ªªÂä°ÔºöÂü∫‰∫éÂÆûÈôÖ‰∫íÂä®Ê¨°Êï∞
                task.progress = Math.min(task.maxProgress, state.interactionCount);
                break;
            case 'complete_schedule':
                // Êó•Á®ã‰ªªÂä°ÔºöÈÄöËøácompleteScheduleÂáΩÊï∞Ë∞ÉÁî®Êó∂Êõ¥Êñ∞
                // ‰øùÊåÅÂΩìÂâçËøõÂ∫¶ÔºåÁî±ÂÆûÈôÖÂÆåÊàêÊó•Á®ãÊìç‰ΩúÊõ¥Êñ∞
                break;
            case 'increase_trust':
                // ‰ø°‰ªª‰ªªÂä°ÔºöÂü∫‰∫éÂÆûÈôÖ‰ø°‰ªªÂÄºÂ¢ûÈïø
                // ËÆ°ÁÆóÂΩìÂâç‰ø°‰ªªÂÄºÁöÑÊï¥Êï∞ÈÉ®ÂàÜÔºàÊØè10ÁÇπ‰∏∫‰∏Ä‰∏™Èò∂ÊÆµÔºâ
                const currentTrustStage = Math.floor(state.trust / 10) * 10;
                task.progress = Math.min(task.maxProgress, currentTrustStage);
                break;
            case 'buy_item':
                // Ë¥≠‰π∞Áâ©ÂìÅ‰ªªÂä°ÔºöÈÄöËøábuyItemÂáΩÊï∞Ë∞ÉÁî®Êó∂Êõ¥Êñ∞
                // ‰øùÊåÅÂΩìÂâçËøõÂ∫¶ÔºåÁî±ÂÆûÈôÖË¥≠‰π∞Êìç‰ΩúÊõ¥Êñ∞
                break;
            case 'read_diary':
                // ÈòÖËØªÊó•ËÆ∞‰ªªÂä°ÔºöÈÄöËøáreadDiaryÂáΩÊï∞Ë∞ÉÁî®Êó∂Êõ¥Êñ∞
                // ‰øùÊåÅÂΩìÂâçËøõÂ∫¶ÔºåÁî±ÂÆûÈôÖÈòÖËØªÊìç‰ΩúÊõ¥Êñ∞
                break;
            case 'buy_furniture':
                // Ë¥≠‰π∞ÂÆ∂ÂÖ∑‰ªªÂä°ÔºöÈÄöËøábuyFurnitureÂáΩÊï∞Ë∞ÉÁî®Êó∂Êõ¥Êñ∞
                // ‰øùÊåÅÂΩìÂâçËøõÂ∫¶ÔºåÁî±ÂÆûÈôÖË¥≠‰π∞Êìç‰ΩúÊõ¥Êñ∞
                break;
            case 'play_game':
                // Áé©Ê∏∏Êàè‰ªªÂä°ÔºöÈÄöËøáÊ∏∏ÊàèÂÆåÊàêÊó∂Êõ¥Êñ∞
                // ‰øùÊåÅÂΩìÂâçËøõÂ∫¶ÔºåÁî±ÂÆûÈôÖÊ∏∏ÊàèÂÆåÊàêÊìç‰ΩúÊõ¥Êñ∞
                break;
            // Êñ∞Â¢ûÈïøÁ∫øËøõÂ∫¶‰ªªÂä°
            case 'collect_diary_entries':
                task.progress = Math.min(task.maxProgress, state.diaryEntries.length);
                break;
            case 'accumulate_money':
                task.progress = Math.min(task.maxProgress, Math.floor(state.money / 100));
                break;
            case 'interact_multiple_times':
                task.progress = Math.min(task.maxProgress, state.interactionCount);
                break;
            case 'try_different_weather':
                const uniqueWeathers = new Set(state.weatherHistory || []).size;
                task.progress = Math.min(task.maxProgress, uniqueWeathers);
                break;
        }
        
        // Êõ¥Êñ∞ÊàêÂ∞±‰ªªÂä°ËøõÂ∫¶
        updateAchievementProgress();
        
        // ËøõÂ∫¶‰ªªÂä°Âè†Âä†ÂºèÈÄªËæëÔºöÂÆåÊàêÂΩìÂâçÈò∂ÊÆµÂêéËá™Âä®Êõ¥Êñ∞Ëá≥‰∏ã‰∏ÄÈò∂ÊÆµ
        if (task.type === 'progress' && task.progress >= task.maxProgress) {
            // Á°ÆÂÆöÂΩìÂâç‰ªªÂä°ÁöÑÈò∂ÊÆµÂíå‰∏ã‰∏ÄÈò∂ÊÆµÁõÆÊ†á
            let nextStage = 0;
            let nextMaxProgress = 0;
            let nextReward = 0;
            
            switch(taskId) {
                case 'increase_trust':
                    // ‰ø°‰ªªÂÄº‰ªªÂä°ÔºöÊØè10ÁÇπ‰∏∫‰∏Ä‰∏™Èò∂ÊÆµÔºåÂ•ñÂä±ÈÄíÂ¢û
                    nextStage = Math.floor(task.maxProgress / 10) + 1;
                    nextMaxProgress = nextStage * 10;
                    nextReward = 50 + (nextStage - 1) * 20;
                    task.title = `ÊèêÂçá‰ø°‰ªª${nextStage}`;
                    task.desc = `ÊèêÂçá‰ø°‰ªªÂÄº${nextMaxProgress}ÁÇπ`;
                    break;
                case 'collect_diary_entries':
                    // Êî∂ÈõÜÊó•ËÆ∞‰ªªÂä°ÔºöÊØè10ÁØá‰∏∫‰∏Ä‰∏™Èò∂ÊÆµ
                    nextStage = Math.floor(task.maxProgress / 10) + 1;
                    nextMaxProgress = nextStage * 10;
                    nextReward = 200 + (nextStage - 1) * 100;
                    task.title = `Êî∂ÈõÜÊó•ËÆ∞${nextStage}`;
                    task.desc = `Êî∂ÈõÜ${nextMaxProgress}ÁØáÊó•ËÆ∞`;
                    break;
                case 'accumulate_money':
                    // ÁßØÁ¥ØË¥¢ÂØå‰ªªÂä°ÔºöÊØè1000ÈáëÂ∏Å‰∏∫‰∏Ä‰∏™Èò∂ÊÆµ
                    nextStage = Math.floor(task.maxProgress / 10) + 1;
                    nextMaxProgress = nextStage * 10;
                    nextReward = 300 + (nextStage - 1) * 150;
                    task.title = `ÁßØÁ¥ØË¥¢ÂØå${nextStage}`;
                    task.desc = `ÁßØÁ¥Ø${nextMaxProgress * 100}ÈáëÂ∏Å`;
                    break;
                case 'interact_multiple_times':
                    // È¢ëÁπÅ‰∫íÂä®‰ªªÂä°ÔºöÊØè50Ê¨°‰∏∫‰∏Ä‰∏™Èò∂ÊÆµ
                    nextStage = Math.floor(task.maxProgress / 50) + 1;
                    nextMaxProgress = nextStage * 50;
                    nextReward = 150 + (nextStage - 1) * 50;
                    task.title = `È¢ëÁπÅ‰∫íÂä®${nextStage}`;
                    task.desc = `‰∏éÂ¥ΩÂ¥Ω‰∫íÂä®${nextMaxProgress}Ê¨°`;
                    break;
                case 'try_different_weather':
                    // ‰ΩìÈ™åÂ§©Ê∞î‰ªªÂä°ÔºöÊúÄÂ§ö5ÁßçÂ§©Ê∞îÔºåÂÆåÊàêÂêé‰∏çÂÜçËøõÈò∂
                    if (task.maxProgress < 5) {
                        nextMaxProgress = Math.min(task.maxProgress + 1, 5);
                        nextReward = 100 + (nextMaxProgress - 1) * 20;
                        task.title = `‰ΩìÈ™åÂ§©Ê∞î`;
                        task.desc = `‰ΩìÈ™å${nextMaxProgress}Áßç‰∏çÂêåÂ§©Ê∞î`;
                    } else {
                        // Â∑≤ÂÆåÊàêÊâÄÊúâÂ§©Ê∞î‰ΩìÈ™åÔºå‰∏çÂÜçËøõÈò∂
                        return;
                    }
                    break;
                default:
                    return;
            }
            
            // Êõ¥Êñ∞‰ªªÂä°Âà∞‰∏ã‰∏ÄÈò∂ÊÆµ
            task.maxProgress = nextMaxProgress;
            task.reward = nextReward;
            task.claimed = false;
            
            // ÊòæÁ§∫‰ªªÂä°ËøõÈò∂ÊèêÁ§∫
            showToast(`‰ªªÂä°ËøõÈò∂Ôºö${task.title}`);
        }
        
        renderTaskList();
        saveState();
    }

function claimTaskReward(taskId) {
    const task = state.tasks.find(t => t.id === taskId);
    if (!task) {
        console.error('Êâæ‰∏çÂà∞‰ªªÂä°:', taskId);
        return;
    }
    
    if (task.claimed) {
        showToast("‰ªªÂä°Â•ñÂä±Â∑≤È¢ÜÂèñ");
        return;
    }
    
    if (task.progress >= task.maxProgress) {
        state.money += task.reward;
        task.claimed = true;
        
        // Êõ¥Êñ∞ÂØπÂ∫îÁöÑ‰ªªÂä°ÂÆåÊàêÁä∂ÊÄÅ
        switch(taskId) {
            case 'daily_login':
                state.dailyLoginClaimed = true;
                break;
            case 'feed_zaizai':
                state.feedTaskClaimed = true;
                break;
            case 'complete_schedule':
                state.scheduleTaskClaimed = true;
                break;
            case 'buy_item':
                state.buyTaskClaimed = true;
                break;
            case 'read_diary':
                state.diaryTaskClaimed = true;
                break;
            case 'buy_furniture':
                state.furnitureTaskClaimed = true;
                break;
            case 'play_game':
                state.gameTaskClaimed = true;
                break;
        }
        
        showToast(`‰ªªÂä°ÂÆåÊàêÔºÅËé∑Âæó ${task.reward}üí∞`);
        updateUI();
        renderTaskList();
        
        // Â¥ΩÂ¥ΩÁöÑÂèçÂ∫î
        setTimeout(() => {
            const reactions = [
                "ÂÆåÊàê‰ªªÂä°‰∫ÜÔºÅÂ•ΩÂéâÂÆ≥ÔºÅ",
                "ÈáëÂ∏ÅÂ¢ûÂä†‰∫ÜÂë¢ÔºÅ",
                "ÁªßÁª≠Âä†Ê≤πÔºÅ",
                "ÂÅöÂæóÂ•ΩÔºÅ"
            ];
            showDialogueText(reactions[Math.floor(Math.random() * reactions.length)]);
            updateMood(5);
            addTrust(1);
        }, 500);
        
        saveState();
        
        // ËÆ∞ÂΩïÂà∞ËßÇÊµãËÆ∞ÂΩï
        recordSystem.addRecord(
            `ÂÆåÊàê‰ªªÂä°Ôºö${task.title}`,
            `ÂÆåÊàêÊØèÊó•‰ªªÂä°Ôºö${task.title}„ÄÇËé∑ÂæóÂ•ñÂä±Ôºö${task.reward}ÈáëÂ∏Å„ÄÇ`,
            ['‰ªªÂä°', 'ÂÆåÊàê']
        );
    } else {
        showToast("‰ªªÂä°Â∞öÊú™ÂÆåÊàê");
    }
}

    // === ËßÇÊµãËÆ∞ÂΩïÁ≥ªÁªü ===
    function renderRecords() {
        const container = document.getElementById('record-list');
        
        if (!state.records || state.records.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; color:#999; padding:40px 20px;">
                    <p>ËøòÊ≤°ÊúâËßÇÊµãËÆ∞ÂΩï„ÄÇ</p>
                    <p style="font-size:12px; margin-top:10px;">Á≥ªÁªü‰ºöËá™Âä®ËÆ∞ÂΩïÈáçË¶Å‰∫ã‰ª∂ÂíåÂ¥ΩÂ¥ΩÁöÑÂøÉÁêÜÂèòÂåñ</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = state.records.map(record => `
            <div class="record-item">
                <div class="record-header">
                    <span class="record-title">${record.title}</span>
                    <span class="record-time">Day ${record.gameDay} | ${record.time}</span>
                </div>
                <div class="record-content">${record.content}</div>
                <div>
                    ${record.tags.map(tag => `
                        <span class="record-tag tag-${tag}">${tag}</span>
                    `).join('')}
                </div>
                <div style="font-size:10px; color:#aaa; margin-top:5px;">
                    ‰ø°‰ªªÁ≠âÁ∫ß: ${recordSystem.getTrustLevel(record.trustLevel)} (${record.trustLevel}ÁÇπ)
                </div>
            </div>
        `).join('');
    }

    function exportRecords() {
        if (!state.records || state.records.length === 0) {
            showToast("Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑËÆ∞ÂΩï");
            return;
        }
        
        let exportText = "=== ÂºÇÁïåËßÇÊµãÁ™óÂè£ - ËßÇÊµãËÆ∞ÂΩï ===\n";
        exportText += `ÂØºÂá∫Êó∂Èó¥: ${new Date().toLocaleString()}\n`;
        exportText += `Ê∏∏ÊàèÂ§©Êï∞: ${state.day}\n`;
        exportText += `ÂΩìÂâç‰ø°‰ªªÂÄº: ${state.trust.toFixed(1)}\n`;
        exportText += `ÂΩìÂâçÂøÉÊÉÖ: ${moodTypes[state.currentMood]?.name || 'Êú™Áü•'}\n`;
        exportText += "=".repeat(40) + "\n\n";
        
        state.records.forEach((record, index) => {
            exportText += `[ËÆ∞ÂΩï ${index + 1}] ${record.title}\n`;
            exportText += `Êó∂Èó¥: Day ${record.gameDay} | ${record.time}\n`;
            exportText += `‰ø°‰ªªÁ≠âÁ∫ß: ${recordSystem.getTrustLevel(record.trustLevel)} (${record.trustLevel}ÁÇπ)\n`;
            exportText += `Ê†áÁ≠æ: ${record.tags.join(', ')}\n`;
            exportText += `ÂÜÖÂÆπ: ${record.content}\n`;
            exportText += "-".repeat(40) + "\n";
        });
        
        const blob = new Blob([exportText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ËßÇÊµãËÆ∞ÂΩï_Day${state.day}_${new Date().getTime()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast("ËßÇÊµãËÆ∞ÂΩïÂ∑≤ÂØºÂá∫");
    }

    // === Áï™ËåÑÈíüÁ≥ªÁªü ===
    function openPomodoro() {
        openModal('pomodoro-modal');
        renderPomodoroTasks();
        updatePomodoroDisplay();
        
        // ‰øÆÂ§çÔºöÊõ¥Êñ∞Áï™ËåÑÈíüÂ§¥ÂÉèÊòæÁ§∫
        const fullscreenImg = document.getElementById('fullscreen-img');
        if (state.customAvatar) {
            fullscreenImg.src = state.customAvatar;
        }
    }

    function renderPomodoroTasks() {
        const container = document.getElementById('pomodoro-tasks');
        if (pomodoro.tasks.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ËøòÊ≤°Êúâ‰ªªÂä°ËÆ∞ÂΩï</div>';
            return;
        }
        
        container.innerHTML = pomodoro.tasks.map((task, index) => `
            <div class="task-item" style="margin-bottom: 8px; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:13px;">${task.name}</span>
                    <span style="font-size:12px;color:#666;">${formatTime(task.duration)}</span>
                </div>
                <div style="font-size:11px;color:#888;margin-top:4px;">
                    ${new Date(task.timestamp).toLocaleString()}
                </div>
            </div>
        `).join('');
    }

    function startPomodoro() {
        const taskInput = document.getElementById('pomodoro-task');
        const durationSelect = document.getElementById('pomodoro-duration');
        
        pomodoro.currentTask = taskInput.value.trim() || '‰∏ìÊ≥®Êó∂Èó¥';
        pomodoro.totalTime = parseInt(durationSelect.value);
        pomodoro.timeLeft = pomodoro.totalTime;
        
        if (pomodoro.timer) {
            clearInterval(pomodoro.timer);
        }
        
        pomodoro.isRunning = true;
        pomodoro.isPaused = false;
        
        document.getElementById('pomodoro-start').style.display = 'none';
        document.getElementById('pomodoro-pause').style.display = 'inline-block';
        
        enterFullscreenMode();
        
        pomodoro.timer = setInterval(updatePomodoroTimer, 1000);
        
        const startMsgs = pomodoroDialogue.start;
        showFullscreenDialogue(startMsgs[Math.floor(Math.random() * startMsgs.length)]);
        
        setInterval(() => {
            if (pomodoro.isRunning && !pomodoro.isPaused && pomodoro.inFullscreen) {
                const tickMsgs = pomodoroDialogue.tick;
                if (Math.random() < 0.1) {
                    showFullscreenDialogue(tickMsgs[Math.floor(Math.random() * tickMsgs.length)]);
                }
                
                if (pomodoro.timeLeft <= 300 && Math.random() < 0.3) {
                    const almostMsgs = pomodoroDialogue.almost;
                    showFullscreenDialogue(almostMsgs[Math.floor(Math.random() * almostMsgs.length)]);
                }
            }
        }, 30000);
    }

    function enterFullscreenMode() {
        closeModal('pomodoro-modal');
        pomodoro.inFullscreen = true;
        
        // ‰øÆÂ§çÔºöÊõ¥Êñ∞Áï™ËåÑÈíüÂÖ®Â±èÊ®°ÂºèÁöÑÂ§¥ÂÉèÊòæÁ§∫
        const fullscreenImg = document.getElementById('fullscreen-img');
        if (state.customAvatar) {
            fullscreenImg.src = state.customAvatar;
        } else {
            fullscreenImg.src = 'https://api.dicebear.com/9.x/avataaars/svg?seed=Felix&backgroundColor=ffdfbf';
        }
        
        document.getElementById('fullscreen-task').textContent = pomodoro.currentTask;
        document.getElementById('pomodoro-fullscreen').style.display = 'flex';
        
        fullscreenImg.onclick = handleFullscreenPoke;
        
        updateFullscreenDisplay();
    }

    function handleFullscreenPoke() {
        if (!pomodoro.isRunning || pomodoro.isPaused) return;
        
        const pokeMsgs = pomodoroDialogue.poke;
        const msg = pokeMsgs[Math.floor(Math.random() * pokeMsgs.length)];
        showFullscreenDialogue(msg);
        
        const img = document.getElementById('fullscreen-img');
        img.style.transform = 'scale(1.1)';
        setTimeout(() => {
            img.style.transform = 'scale(1)';
        }, 200);
    }

    function showFullscreenDialogue(text) {
        const bubble = document.getElementById('fullscreen-bubble');
        bubble.textContent = text;
        bubble.style.opacity = '1';
        
        setTimeout(() => {
            bubble.style.opacity = '0';
        }, 2000);
    }

    function updatePomodoroTimer() {
        if (!pomodoro.isRunning || pomodoro.isPaused) return;
        
        pomodoro.timeLeft--;
        
        if (pomodoro.inFullscreen) {
            updateFullscreenDisplay();
        } else {
            updatePomodoroDisplay();
        }
        
        if (pomodoro.timeLeft <= 0) {
            finishPomodoro(true);
        }
    }

    function updateFullscreenDisplay() {
        const minutes = Math.floor(pomodoro.timeLeft / 60);
        const seconds = pomodoro.timeLeft % 60;
        document.getElementById('fullscreen-timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (pomodoro.timeLeft <= 60) {
            document.getElementById('fullscreen-status').textContent = 'ÊúÄÂêé1ÂàÜÈíüÔºÅ';
        } else if (pomodoro.timeLeft <= 300) {
            document.getElementById('fullscreen-status').textContent = 'Âø´ÂÆåÊàê‰∫ÜÔºÅ';
        } else {
            const progress = ((pomodoro.totalTime - pomodoro.timeLeft) / pomodoro.totalTime * 100).toFixed(0);
            document.getElementById('fullscreen-status').textContent = `Â∑≤ÂÆåÊàê ${progress}%`;
        }
    }

    function updatePomodoroDisplay() {
        const minutes = Math.floor(pomodoro.timeLeft / 60);
        const seconds = pomodoro.timeLeft % 60;
        document.getElementById('pomodoro-timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById('pomodoro-status').textContent = 
            pomodoro.isRunning ? (pomodoro.isPaused ? 'Â∑≤ÊöÇÂÅú' : 'ËøõË°å‰∏≠') : 'ÂáÜÂ§áÂºÄÂßã';
    }

    function pausePomodoro() {
        if (!pomodoro.isRunning) return;
        
        pomodoro.isPaused = !pomodoro.isPaused;
        document.getElementById('pomodoro-pause').textContent = 
            pomodoro.isPaused ? 'ÁªßÁª≠' : 'ÊöÇÂÅú';
        
        showFullscreenDialogue(pomodoro.isPaused ? '‰ºëÊÅØ‰∏Ä‰∏ã‰πüÂ•Ω' : 'ÁªßÁª≠‰∏ìÊ≥®ÂêßÔºÅ');
    }

    function resetPomodoro() {
        if (pomodoro.timer) {
            clearInterval(pomodoro.timer);
            pomodoro.timer = null;
        }
        
        pomodoro.isRunning = false;
        pomodoro.isPaused = false;
        pomodoro.timeLeft = pomodoro.totalTime;
        
        document.getElementById('pomodoro-start').style.display = 'inline-block';
        document.getElementById('pomodoro-pause').style.display = 'none';
        
        updatePomodoroDisplay();
    }

    // ÊòæÁ§∫Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂºπÁ™ó
    function showCustomConfirm(message, onYes, onNo) {
        const modal = document.getElementById('custom-confirm-modal');
        const yesBtn = document.getElementById('confirm-yes');
        const noBtn = document.getElementById('confirm-no');
        
        // Êõ¥Êñ∞ÂºπÁ™óÂÜÖÂÆπ
        modal.querySelector('p').textContent = message;
        
        // ÊòæÁ§∫ÂºπÁ™ó
        modal.style.display = 'flex';
        
        // ÂÆö‰πâ‰∫ã‰ª∂Â§ÑÁêÜÂáΩÊï∞
        function handleConfirmYes() {
            modal.style.display = 'none';
            // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
            yesBtn.removeEventListener('click', handleConfirmYes);
            noBtn.removeEventListener('click', handleConfirmNo);
            if (onYes) onYes();
        }
        
        function handleConfirmNo() {
            modal.style.display = 'none';
            // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
            yesBtn.removeEventListener('click', handleConfirmYes);
            noBtn.removeEventListener('click', handleConfirmNo);
            if (onNo) onNo();
        }
        
        // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
        yesBtn.addEventListener('click', handleConfirmYes);
        noBtn.addEventListener('click', handleConfirmNo);
    }
    
    function finishPomodoro(success = true) {
        // Â¶ÇÊûúÊòØÁî®Êà∑‰∏ªÂä®ÁÇπÂáªÂÆåÊàêÔºå‰∏îÊó∂Èó¥Êú™Âà∞ÔºåÊòæÁ§∫Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂºπÁ™ó
        if (success && pomodoro.timeLeft > 0) {
            // ÊòæÁ§∫Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂºπÁ™ó
            showCustomConfirm('‰Ω†Á°ÆÂÆöÂ∑≤ÁªèÊàêÂäüÂÆåÊàê‰ªªÂä°‰∫ÜÂêóÔºü', 
                // Á°ÆÂÆöÊåâÈíÆÂõûË∞É
                function() {
                    // Áî®Êà∑Á°ÆËÆ§ÂÆåÊàê‰ªªÂä°ÔºåÁªßÁª≠ÊâßË°åÂÆåÊàêÈÄªËæë
                    completePomodoro(true);
                }, 
                // ÂèñÊ∂àÊåâÈíÆÂõûË∞É
                function() {
                    // Áî®Êà∑ÂèñÊ∂àÔºå‰∏çÂÅö‰ªª‰ΩïÊìç‰ΩúÔºåÁªßÁª≠ÂÄíËÆ°Êó∂
                    return;
                }
            );
            return;
        }
        
        // Ê≠£Â∏∏ÂÆåÊàêÊàñÊîæÂºÉ‰ªªÂä°
        completePomodoro(success);
    }
    
    // ÂÆûÈôÖÂÆåÊàêÁï™ËåÑÈíüÁöÑÈÄªËæë
    function completePomodoro(success) {
        if (pomodoro.timer) {
            clearInterval(pomodoro.timer);
            pomodoro.timer = null;
        }
        
        pomodoro.isRunning = false;
        pomodoro.inFullscreen = false;
        
        if (success && pomodoro.currentTask) {
            const actualDuration = pomodoro.totalTime - pomodoro.timeLeft;
            pomodoro.tasks.unshift({
                name: pomodoro.currentTask,
                duration: actualDuration,
                timestamp: Date.now(),
                completed: true
            });
            
            if (pomodoro.tasks.length > 20) {
                pomodoro.tasks = pomodoro.tasks.slice(0, 20);
            }
            
            // ËÆ°ÁÆóÈáëÂ∏ÅÂ•ñÂä±ÔºöÊó∂Èó¥Ë∂äÈïøÔºåÂ•ñÂä±Ë∂äÂ§öÔºåÊèêÂâçÂÆåÊàêÂàôÂáèÂ∞ë
            const baseReward = Math.floor(pomodoro.totalTime / 60) * 2; // Âü∫Á°ÄÂ•ñÂä±ÔºöÊØèÂàÜÈíü2ÈáëÂ∏Å
            const completionRate = actualDuration / pomodoro.totalTime;
            const finalReward = Math.max(1, Math.floor(baseReward * completionRate));
            
            // ÂèëÊîæÈáëÂ∏ÅÂ•ñÂä±
            state.money += finalReward;
            
            // ÊòæÁ§∫Â•ñÂä±‰ø°ÊÅØ
            const finishMsgs = pomodoroDialogue.finish;
            showToast(`${finishMsgs[Math.floor(Math.random() * finishMsgs.length)]} Ëé∑Âæó ${finalReward}üí∞`);
            
            addTrust(2);
            updateMood(8);
            updateUI();
            
            recordSystem.addRecord(
                'Áï™ËåÑÈíü‰∏ìÊ≥®ÂÆåÊàê',
                `ÂÆåÊàêÁï™ËåÑÈíü‰∏ìÊ≥®Ôºö${pomodoro.currentTask}ÔºåÊó∂ÈïøÔºö${formatTime(actualDuration)}„ÄÇËé∑Âæó ${finalReward} ÈáëÂ∏Å„ÄÇ`,
                ['Áï™ËåÑÈíü', '‰∏ìÊ≥®']
            );
        } else {
            // Áî®Êà∑ÊîæÂºÉ‰ªªÂä°ÁöÑÊÉÖÂÜµ
            const cancelMsgs = pomodoroDialogue.cancel;
            showToast(cancelMsgs[Math.floor(Math.random() * cancelMsgs.length)]);
            
            updateMood(-3);
        }
        
        document.getElementById('pomodoro-fullscreen').style.display = 'none';
        resetPomodoro();
    }

    function cancelPomodoro() {
        // ÊîæÂºÉ‰ªªÂä°ÔºåË∞ÉÁî®finishPomodoro(false)Â§ÑÁêÜÂ§±Ë¥•ÈÄªËæë
        finishPomodoro(false);
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}ÂàÜ${secs}Áßí`;
    }

    // === Â∞èÊ∏∏ÊàèÁ≥ªÁªü - ‰øÆÂ§çÁâà ===
    
    // 2048Ê∏∏Êàè - ‰øÆÂ§çÊï∞Â≠óÂùóÂÆö‰ΩçÈóÆÈ¢ò
    function startGame2048() {
        closeModal('game-select-modal');
        
        if (!game2048.initialized) {
            initGame2048();
        } else {
            restartGame2048();
        }
        
        openModal('game2048-modal');
        
        // Ê∑ªÂä†ÈîÆÁõòÊéßÂà∂
        document.addEventListener('keydown', handleGame2048Key);
        
        // Ê∑ªÂä†Ëß¶Êë∏ÊªëÂä®ÊéßÂà∂
        const gameGrid = document.getElementById('game2048-grid');
        gameGrid.addEventListener('touchstart', handleGame2048SwipeStart, { passive: true });
        gameGrid.addEventListener('touchmove', handleGame2048SwipeMove, { passive: true });
        gameGrid.addEventListener('touchend', handleGame2048SwipeEnd, { passive: true });
        
        if (!state.gameHistory) state.gameHistory = [];
        state.gameHistory.push({
            game: '2048',
            startTime: new Date().toLocaleString(),
            score: 0
        });
    }
    
    function initGame2048() {
        game2048.grid = [];
        game2048.score = 0;
        game2048.gameOver = false;
        game2048.tiles = [];
        game2048.initialized = true;
        game2048.touchDirection = null;
        game2048.touchInterval = null;
        
        for (let i = 0; i < 4; i++) {
            game2048.grid[i] = [0, 0, 0, 0];
        }
        
        addRandomTile();
        addRandomTile();
        
        renderGame2048();
    }
    
    function restartGame2048() {
        initGame2048();
        document.getElementById('game2048-score').textContent = '0';
    }
    
    function closeGame2048() {
        closeModal('game2048-modal');
        document.removeEventListener('keydown', handleGame2048Key);
        
        // ÁßªÈô§Ëß¶Êë∏ÊªëÂä®ÊéßÂà∂
        const gameGrid = document.getElementById('game2048-grid');
        gameGrid.removeEventListener('touchstart', handleGame2048SwipeStart);
        gameGrid.removeEventListener('touchmove', handleGame2048SwipeMove);
        gameGrid.removeEventListener('touchend', handleGame2048SwipeEnd);
        
        // Ê∏ÖÈô§Ëß¶Êë∏Èó¥Èöî
        if (game2048.touchInterval) {
            clearInterval(game2048.touchInterval);
            game2048.touchInterval = null;
        }
        
        if (game2048.score > 0) {
            const coins = Math.floor(game2048.score / 100);
            if (coins > 0) {
                state.money += coins;
                showToast(`Ê∏∏ÊàèÁªìÊùüÔºÅËé∑Âæó ${coins} ÈáëÂ∏Å`);
                updateUI();
                
                // ÂÆûÈôÖÂÆåÊàêÊ∏∏ÊàèÂêéÊõ¥Êñ∞‰ªªÂä°ËøõÂ∫¶
                const playGameTask = state.tasks.find(t => t.id === 'play_game');
                if (playGameTask) {
                    playGameTask.progress = 1;
                    renderTaskList();
                }
                
                saveState();
                
                if (state.gameHistory && state.gameHistory.length > 0) {
                    const lastGame = state.gameHistory[state.gameHistory.length - 1];
                    lastGame.endTime = new Date().toLocaleString();
                    lastGame.finalScore = game2048.score;
                    lastGame.coinsEarned = coins;
                    
                    recordSystem.addRecord(
                        'Â∞èÊ∏∏ÊàèÔºö2048',
                        `ÂÆåÊàê2048Ê∏∏Êàè„ÄÇÊúÄÁªàÂàÜÊï∞Ôºö${game2048.score}ÔºåËé∑ÂæóÈáëÂ∏ÅÔºö${coins}„ÄÇ`,
                        ['Ê∏∏Êàè', '2048']
                    );
                }
            }
        }
    }
    
    function handleGame2048Key(e) {
        if (game2048.gameOver) return;
        
        let moved = false;
        
        switch(e.key) {
            case 'ArrowUp':
            case 'w':
            case 'W':
                moved = moveUp();
                break;
            case 'ArrowDown':
            case 's':
            case 'S':
                moved = moveDown();
                break;
            case 'ArrowLeft':
            case 'a':
            case 'A':
                moved = moveLeft();
                break;
            case 'ArrowRight':
            case 'd':
            case 'D':
                moved = moveRight();
                break;
        }
        
        if (moved) {
            addRandomTile();
            renderGame2048();
            
            if (isGameOver()) {
                game2048.gameOver = true;
                setTimeout(() => {
                    showToast("Ê∏∏ÊàèÁªìÊùüÔºÅ");
                }, 500);
            }
        }
    }
    
    // ÊªëÂ±èÊìç‰ΩúÂ§ÑÁêÜ
    function handleGame2048SwipeStart(e) {
        if (game2048.gameOver) return;
        
        const touch = e.touches[0];
        game2048.startX = touch.clientX;
        game2048.startY = touch.clientY;
    }
    
    function handleGame2048SwipeMove(e) {
        if (game2048.gameOver) return;
        // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†‰∏Ä‰∫õÈÄªËæëÔºåÊØîÂ¶ÇÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
        e.preventDefault();
    }
    
    function handleGame2048SwipeEnd(e) {
        if (game2048.gameOver) return;
        
        const touch = e.changedTouches[0];
        const endX = touch.clientX;
        const endY = touch.clientY;
        
        const deltaX = endX - game2048.startX;
        const deltaY = endY - game2048.startY;
        
        // ËÆ°ÁÆóÊªëÂä®Ë∑ùÁ¶ªÔºåËÆæÁΩÆÈòàÂÄº‰ª•Âå∫ÂàÜÁÇπÂáªÂíåÊªëÂä®
        const minSwipeDistance = 20;
        
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
            // Ê∞¥Âπ≥ÊªëÂä®
            if (deltaX > 0) {
                executeGame2048Move('right');
            } else {
                executeGame2048Move('left');
            }
        } else if (Math.abs(deltaY) > minSwipeDistance) {
            // ÂûÇÁõ¥ÊªëÂä®
            if (deltaY > 0) {
                executeGame2048Move('down');
            } else {
                executeGame2048Move('up');
            }
        }
    }
    
    function executeGame2048Move(direction) {
        let moved = false;
        
        switch(direction) {
            case 'up':
                moved = moveUp();
                break;
            case 'down':
                moved = moveDown();
                break;
            case 'left':
                moved = moveLeft();
                break;
            case 'right':
                moved = moveRight();
                break;
        }
        
        if (moved) {
            addRandomTile();
            renderGame2048();
            
            if (isGameOver()) {
                game2048.gameOver = true;
                if (game2048.touchInterval) {
                    clearInterval(game2048.touchInterval);
                    game2048.touchInterval = null;
                }
                setTimeout(() => {
                    showToast("Ê∏∏ÊàèÁªìÊùüÔºÅ");
                }, 500);
            }
        }
    }
    
    function moveUp() {
        let moved = false;
        
        for (let col = 0; col < 4; col++) {
            let column = [];
            for (let row = 0; row < 4; row++) {
                if (game2048.grid[row][col] !== 0) {
                    column.push(game2048.grid[row][col]);
                }
            }
            
            for (let i = 0; i < column.length - 1; i++) {
                if (column[i] === column[i + 1]) {
                    column[i] *= 2;
                    game2048.score += column[i];
                    column.splice(i + 1, 1);
                }
            }
            
            while (column.length < 4) {
                column.push(0);
            }
            
            for (let row = 0; row < 4; row++) {
                if (game2048.grid[row][col] !== column[row]) {
                    moved = true;
                }
                game2048.grid[row][col] = column[row];
            }
        }
        
        if (moved) {
            document.getElementById('game2048-score').textContent = game2048.score;
        }
        
        return moved;
    }
    
    function moveDown() {
        let moved = false;
        
        for (let col = 0; col < 4; col++) {
            let column = [];
            for (let row = 3; row >= 0; row--) {
                if (game2048.grid[row][col] !== 0) {
                    column.push(game2048.grid[row][col]);
                }
            }
            
            for (let i = 0; i < column.length - 1; i++) {
                if (column[i] === column[i + 1]) {
                    column[i] *= 2;
                    game2048.score += column[i];
                    column.splice(i + 1, 1);
                }
            }
            
            while (column.length < 4) {
                column.push(0);
            }
            
            for (let row = 3; row >= 0; row--) {
                if (game2048.grid[row][col] !== column[3 - row]) {
                    moved = true;
                }
                game2048.grid[row][col] = column[3 - row];
            }
        }
        
        if (moved) {
            document.getElementById('game2048-score').textContent = game2048.score;
        }
        
        return moved;
    }
    
    function moveLeft() {
        let moved = false;
        
        for (let row = 0; row < 4; row++) {
            let line = [];
            for (let col = 0; col < 4; col++) {
                if (game2048.grid[row][col] !== 0) {
                    line.push(game2048.grid[row][col]);
                }
            }
            
            for (let i = 0; i < line.length - 1; i++) {
                if (line[i] === line[i + 1]) {
                    line[i] *= 2;
                    game2048.score += line[i];
                    line.splice(i + 1, 1);
                }
            }
            
            while (line.length < 4) {
                line.push(0);
            }
            
            for (let col = 0; col < 4; col++) {
                if (game2048.grid[row][col] !== line[col]) {
                    moved = true;
                }
                game2048.grid[row][col] = line[col];
            }
        }
        
        if (moved) {
            document.getElementById('game2048-score').textContent = game2048.score;
        }
        
        return moved;
    }
    
    function moveRight() {
        let moved = false;
        
        for (let row = 0; row < 4; row++) {
            let line = [];
            for (let col = 3; col >= 0; col--) {
                if (game2048.grid[row][col] !== 0) {
                    line.push(game2048.grid[row][col]);
                }
            }
            
            for (let i = 0; i < line.length - 1; i++) {
                if (line[i] === line[i + 1]) {
                    line[i] *= 2;
                    game2048.score += line[i];
                    line.splice(i + 1, 1);
                }
            }
            
            while (line.length < 4) {
                line.push(0);
            }
            
            for (let col = 3; col >= 0; col--) {
                if (game2048.grid[row][col] !== line[3 - col]) {
                    moved = true;
                }
                game2048.grid[row][col] = line[3 - col];
            }
        }
        
        if (moved) {
            document.getElementById('game2048-score').textContent = game2048.score;
        }
        
        return moved;
    }
    
    function addRandomTile() {
        let emptyCells = [];
        
        for (let row = 0; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                if (game2048.grid[row][col] === 0) {
                    emptyCells.push({row, col});
                }
            }
        }
        
        if (emptyCells.length > 0) {
            const cell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
            game2048.grid[cell.row][cell.col] = Math.random() < 0.9 ? 2 : 4;
        }
    }
    
    function isGameOver() {
        for (let row = 0; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                if (game2048.grid[row][col] === 0) {
                    return false;
                }
            }
        }
        
        for (let row = 0; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                const value = game2048.grid[row][col];
                
                if (col < 3 && game2048.grid[row][col + 1] === value) {
                    return false;
                }
                
                if (row < 3 && game2048.grid[row + 1][col] === value) {
                    return false;
                }
            }
        }
        
        return true;
    }
    
    // ‰øÆÂ§çrenderGame2048ÂáΩÊï∞ÔºåÁ°Æ‰øùÊï∞Â≠óÂùóÂáÜÁ°ÆÂØπÈΩê
    function renderGame2048() {
        const gridContainer = document.getElementById('game2048-grid');
        
        // Á°Æ‰øù‰ΩøÁî®ÂùóÁ∫ßÊòæÁ§∫
        gridContainer.style.display = 'block';
        gridContainer.innerHTML = '';
        
        // Ëé∑ÂèñÁΩëÊ†ºÂÆπÂô®ÁöÑÊ†∑Âºè
        const computedStyle = window.getComputedStyle(gridContainer);
        const padding = parseInt(computedStyle.padding);
        const gridWidth = parseInt(computedStyle.width);
        const gridHeight = parseInt(computedStyle.height);
        const gridSize = Math.min(gridWidth, gridHeight);
        
        // ËÆæÁΩÆÁΩëÊ†ºÂÆπÂô®ÁöÑÂõ∫ÂÆöÂ∞∫ÂØ∏
        gridContainer.style.width = `${gridSize}px`;
        gridContainer.style.height = `${gridSize}px`;
        
        // Èó¥ÈöôÂ§ßÂ∞èÔºàÁõ∏ÂØπÁΩëÊ†ºÂ§ßÂ∞èÁöÑÁôæÂàÜÊØîÔºâ
        const gap = 8;
        
        // ËÆ°ÁÆóÊØè‰∏™Ê†ºÂ≠êÁöÑÂ§ßÂ∞èÔºà4x4ÁΩëÊ†ºÔºå3‰∏™Èó¥ÈöôÔºâ
        const innerSize = gridSize - 2 * padding;
        const cellSize = (innerSize - 3 * gap) / 4; // 4‰∏™Ê†ºÂ≠êÔºå3‰∏™Èó¥Èöô
        
        // ËÆ°ÁÆóËµ∑Âßã‰ΩçÁΩÆÔºåÁ°Æ‰øùÊï¥‰∏™ÁΩëÊ†ºÂ±Ö‰∏≠
        const startX = padding + (innerSize - 4 * cellSize - 3 * gap) / 2;
        const startY = padding + (innerSize - 4 * cellSize - 3 * gap) / 2;
        
        // ÁªòÂà∂ËÉåÊôØÊ†ºÂ≠ê
        for (let row = 0; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                const cell = document.createElement('div');
                cell.className = 'game2048-cell';
                cell.style.position = 'absolute';
                cell.style.width = `${cellSize}px`;
                cell.style.height = `${cellSize}px`;
                cell.style.left = `${startX + col * (cellSize + gap)}px`;
                cell.style.top = `${startY + row * (cellSize + gap)}px`;
                gridContainer.appendChild(cell);
            }
        }
        
        // ÁªòÂà∂Êï∞Â≠óÂùó
        for (let row = 0; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                const value = game2048.grid[row][col];
                if (value !== 0) {
                    const tile = document.createElement('div');
                    tile.className = `game2048-tile tile-${value}`;
                    tile.textContent = value;
                    tile.style.position = 'absolute';
                    tile.style.width = `${cellSize}px`;
                    tile.style.height = `${cellSize}px`;
                    tile.style.left = `${startX + col * (cellSize + gap)}px`;
                    tile.style.top = `${startY + row * (cellSize + gap)}px`;
                    
                    // Ê†πÊçÆÊï∞Â≠óÂ§ßÂ∞èË∞ÉÊï¥Â≠ó‰Ωì
                    if (value >= 1000) {
                        tile.style.fontSize = `${cellSize * 0.3}px`;
                    } else if (value >= 100) {
                        tile.style.fontSize = `${cellSize * 0.35}px`;
                    } else if (value >= 10) {
                        tile.style.fontSize = `${cellSize * 0.4}px`;
                    } else {
                        tile.style.fontSize = `${cellSize * 0.45}px`;
                    }
                    
                    gridContainer.appendChild(tile);
                }
            }
        }
    }
    
    // ÊâìÁ†ñÂùóÊ∏∏Êàè - ‰øÆÂ§çÁâà
    function startBrickBreaker() {
        closeModal('game-select-modal');
        
        brickBreaker.canvas = document.getElementById('brickbreaker-canvas');
        brickBreaker.ctx = brickBreaker.canvas.getContext('2d');
        
        initBrickBreaker();
        openModal('game-brickbreaker-modal');
        
        // Ê∑ªÂä†ÈîÆÁõòÊéßÂà∂
        document.addEventListener('keydown', handleBrickBreakerKey);
        
        if (!state.gameHistory) state.gameHistory = [];
        state.gameHistory.push({
            game: 'ÊâìÁ†ñÂùó',
            startTime: new Date().toLocaleString(),
            score: 0
        });
        
        brickBreaker.gameRunning = true;
        requestAnimationFrame(gameLoopBrickBreaker);
    }
    
    function initBrickBreaker() {
        // ÂàùÂßãÂåñÁîªÂ∏É
        const canvas = document.getElementById('brickbreaker-canvas');
        brickBreaker.canvas = canvas;
        brickBreaker.ctx = canvas.getContext('2d');
        
        // ÂàùÂßãÂåñÊå°Êùø
        brickBreaker.paddle = { 
            x: 150, 
            y: 380, 
            width: 80, 
            height: 10 
        };
        
        // ÂàùÂßãÂåñÁêÉ
        brickBreaker.ball = { 
            x: 150, 
            y: 370, 
            radius: 8, 
            dx: 3, 
            dy: -3 
        };
        
            // ÂàùÂßãÂåñÁ†ñÂùó - ‰øÆÂ§çÂè≥‰æßÁ†ñÂùóÊ∫¢Âá∫ÈóÆÈ¢ò
            brickBreaker.bricks = [];
            const brickRowCount = 5;
            const brickColumnCount = 8;
            const brickWidth = 35;
            const brickHeight = 15;
            const brickPadding = 5;
            const brickOffsetTop = 50;
            
            // ËÆ°ÁÆóÊÄªÂÆΩÂ∫¶Âπ∂Â±Ö‰∏≠Á†ñÂùó
            const totalBricksWidth = brickColumnCount * brickWidth + (brickColumnCount - 1) * brickPadding;
            const brickOffsetLeft = (brickBreaker.canvas.width - totalBricksWidth) / 2;
            
            for (let c = 0; c < brickColumnCount; c++) {
                brickBreaker.bricks[c] = [];
                for (let r = 0; r < brickRowCount; r++) {
                    const brickX = c * (brickWidth + brickPadding) + brickOffsetLeft;
                    const brickY = r * (brickHeight + brickPadding) + brickOffsetTop;
                    brickBreaker.bricks[c][r] = { 
                        x: brickX, 
                        y: brickY, 
                        width: brickWidth, 
                        height: brickHeight, 
                        visible: true 
                    };
                }
            }
        
        brickBreaker.score = 0;
        brickBreaker.paddleDirection = 0;
        brickBreaker.touchInterval = null;
        
        document.getElementById('brickbreaker-score').textContent = '0';
    }
    
    function gameLoopBrickBreaker(timestamp) {
        if (!brickBreaker.gameRunning) return;
        
        brickBreaker.ctx.clearRect(0, 0, brickBreaker.canvas.width, brickBreaker.canvas.height);
        
        drawBricks();
        drawPaddle();
        drawBall();
        
        // Êõ¥Êñ∞Êå°Êùø‰ΩçÁΩÆ
        if (brickBreaker.paddleDirection !== 0) {
            brickBreaker.paddle.x += brickBreaker.paddleSpeed * brickBreaker.paddleDirection;
            brickBreaker.paddle.x = Math.max(0, Math.min(brickBreaker.paddle.x, brickBreaker.canvas.width - brickBreaker.paddle.width));
        }
        
        brickBreaker.ball.x += brickBreaker.ball.dx;
        brickBreaker.ball.y += brickBreaker.ball.dy;
        
        // ËæπÁïåÁ¢∞ÊíûÊ£ÄÊµã
        if (brickBreaker.ball.x + brickBreaker.ball.radius > brickBreaker.canvas.width || brickBreaker.ball.x - brickBreaker.ball.radius < 0) {
            brickBreaker.ball.dx = -brickBreaker.ball.dx;
        }
        
        if (brickBreaker.ball.y - brickBreaker.ball.radius < 0) {
            brickBreaker.ball.dy = -brickBreaker.ball.dy;
        }
        
        // Ê∏∏ÊàèÁªìÊùüÊù°‰ª∂
        if (brickBreaker.ball.y + brickBreaker.ball.radius > brickBreaker.canvas.height) {
            brickBreaker.gameRunning = false;
            showToast("Ê∏∏ÊàèÁªìÊùüÔºÅÁêÉÊéâ‰∏ãÂéª‰∫Ü");
            return;
        }
        
        // Êå°ÊùøÁ¢∞ÊíûÊ£ÄÊµã
        if (
            brickBreaker.ball.x + brickBreaker.ball.radius > brickBreaker.paddle.x &&
            brickBreaker.ball.x - brickBreaker.ball.radius < brickBreaker.paddle.x + brickBreaker.paddle.width &&
            brickBreaker.ball.y + brickBreaker.ball.radius > brickBreaker.paddle.y &&
            brickBreaker.ball.y - brickBreaker.ball.radius < brickBreaker.paddle.y + brickBreaker.paddle.height
        ) {
            brickBreaker.ball.dy = -Math.abs(brickBreaker.ball.dy);
            
            // Ê†πÊçÆÂáª‰∏≠Êå°ÊùøÁöÑ‰ΩçÁΩÆË∞ÉÊï¥ÂèçÂºπËßíÂ∫¶
            const hitPos = (brickBreaker.ball.x - brickBreaker.paddle.x) / brickBreaker.paddle.width;
            brickBreaker.ball.dx = 5 * (hitPos - 0.5);
        }
        
        // Á†ñÂùóÁ¢∞ÊíûÊ£ÄÊµã
        for (let c = 0; c < brickBreaker.bricks.length; c++) {
            for (let r = 0; r < brickBreaker.bricks[c].length; r++) {
                const brick = brickBreaker.bricks[c][r];
                if (brick.visible) {
                    if (
                        brickBreaker.ball.x + brickBreaker.ball.radius > brick.x &&
                        brickBreaker.ball.x - brickBreaker.ball.radius < brick.x + brick.width &&
                        brickBreaker.ball.y + brickBreaker.ball.radius > brick.y &&
                        brickBreaker.ball.y - brickBreaker.ball.radius < brick.y + brick.height
                    ) {
                        brickBreaker.ball.dy = -brickBreaker.ball.dy;
                        brick.visible = false;
                        brickBreaker.score += 10;
                        document.getElementById('brickbreaker-score').textContent = brickBreaker.score;
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÁ†ñÂùóÈÉΩË¢´ÂáªÁ¢é
                        let allBricksGone = true;
                        for (let c2 = 0; c2 < brickBreaker.bricks.length; c2++) {
                            for (let r2 = 0; r2 < brickBreaker.bricks[c2].length; r2++) {
                                if (brickBreaker.bricks[c2][r2].visible) {
                                    allBricksGone = false;
                                    break;
                                }
                            }
                            if (!allBricksGone) break;
                        }
                        
                        if (allBricksGone) {
                            brickBreaker.gameRunning = false;
                            showToast("ÊÅ≠ÂñúÔºÅ‰Ω†ÂáªÁ¢é‰∫ÜÊâÄÊúâÁ†ñÂùóÔºÅ");
                            return;
                        }
                    }
                }
            }
        }
        
        brickBreaker.animationId = requestAnimationFrame(gameLoopBrickBreaker);
    }
    
    function drawBricks() {
        for (let c = 0; c < brickBreaker.bricks.length; c++) {
            for (let r = 0; r < brickBreaker.bricks[c].length; r++) {
                const brick = brickBreaker.bricks[c][r];
                if (brick.visible) {
                    brickBreaker.ctx.fillStyle = `hsl(${r * 60}, 70%, 50%)`;
                    brickBreaker.ctx.fillRect(brick.x, brick.y, brick.width, brick.height);
                    brickBreaker.ctx.strokeStyle = '#000';
                    brickBreaker.ctx.strokeRect(brick.x, brick.y, brick.width, brick.height);
                }
            }
        }
    }
    
    function drawPaddle() {
        brickBreaker.ctx.fillStyle = '#FF6B6B';
        brickBreaker.ctx.fillRect(brickBreaker.paddle.x, brickBreaker.paddle.y, brickBreaker.paddle.width, brickBreaker.paddle.height);
        brickBreaker.ctx.strokeStyle = '#000';
        brickBreaker.ctx.strokeRect(brickBreaker.paddle.x, brickBreaker.paddle.y, brickBreaker.paddle.width, brickBreaker.paddle.height);
    }
    
    function drawBall() {
        brickBreaker.ctx.beginPath();
        brickBreaker.ctx.arc(brickBreaker.ball.x, brickBreaker.ball.y, brickBreaker.ball.radius, 0, Math.PI * 2);
        brickBreaker.ctx.fillStyle = '#4ECDC4';
        brickBreaker.ctx.fill();
        brickBreaker.ctx.strokeStyle = '#000';
        brickBreaker.ctx.stroke();
        brickBreaker.ctx.closePath();
    }
    
    function handleBrickBreakerKey(e) {
        switch(e.key) {
            case 'ArrowLeft':
            case 'a':
            case 'A':
                brickBreaker.paddleDirection = -1;
                break;
            case 'ArrowRight':
            case 'd':
            case 'D':
                brickBreaker.paddleDirection = 1;
                break;
        }
    }
    
    // Ëß¶Â±èÊéßÂà∂ÂáΩÊï∞
    function startMovePaddleLeft() {
        brickBreaker.paddleDirection = -1;
        
        if (brickBreaker.touchInterval) {
            clearInterval(brickBreaker.touchInterval);
        }
        
        brickBreaker.touchInterval = setInterval(() => {
            brickBreaker.paddleDirection = -1;
        }, 50);
    }
    
    function startMovePaddleRight() {
        brickBreaker.paddleDirection = 1;
        
        if (brickBreaker.touchInterval) {
            clearInterval(brickBreaker.touchInterval);
        }
        
        brickBreaker.touchInterval = setInterval(() => {
            brickBreaker.paddleDirection = 1;
        }, 50);
    }
    
    function stopPaddle() {
        brickBreaker.paddleDirection = 0;
        
        if (brickBreaker.touchInterval) {
            clearInterval(brickBreaker.touchInterval);
            brickBreaker.touchInterval = null;
        }
    }
    
    function closeBrickBreaker() {
        closeModal('game-brickbreaker-modal');
        document.removeEventListener('keydown', handleBrickBreakerKey);
        
        if (brickBreaker.animationId) {
            cancelAnimationFrame(brickBreaker.animationId);
        }
        
        if (brickBreaker.touchInterval) {
            clearInterval(brickBreaker.touchInterval);
            brickBreaker.touchInterval = null;
        }
        
        brickBreaker.gameRunning = false;
        brickBreaker.paddleDirection = 0;
        
        if (brickBreaker.score > 0) {
            const coins = Math.floor(brickBreaker.score / 10);
            if (coins > 0) {
                state.money += coins;
                showToast(`Ê∏∏ÊàèÁªìÊùüÔºÅËé∑Âæó ${coins} ÈáëÂ∏Å`);
                updateUI();
                
                // ÂÆûÈôÖÂÆåÊàêÊ∏∏ÊàèÂêéÊõ¥Êñ∞‰ªªÂä°ËøõÂ∫¶
                const playGameTask = state.tasks.find(t => t.id === 'play_game');
                if (playGameTask) {
                    playGameTask.progress = 1;
                    renderTaskList();
                }
                
                saveState();
                
                if (state.gameHistory && state.gameHistory.length > 0) {
                    const lastGame = state.gameHistory[state.gameHistory.length - 1];
                    lastGame.endTime = new Date().toLocaleString();
                    lastGame.finalScore = brickBreaker.score;
                    lastGame.coinsEarned = coins;
                    
                    recordSystem.addRecord(
                        'Â∞èÊ∏∏ÊàèÔºöÊâìÁ†ñÂùó',
                        `ÂÆåÊàêÊâìÁ†ñÂùóÊ∏∏Êàè„ÄÇÊúÄÁªàÂàÜÊï∞Ôºö${brickBreaker.score}ÔºåËé∑ÂæóÈáëÂ∏ÅÔºö${coins}„ÄÇ`,
                        ['Ê∏∏Êàè', 'ÊâìÁ†ñÂùó']
                    );
                }
            }
        }
    }
    
    function restartBrickBreaker() {
        if (brickBreaker.animationId) {
            cancelAnimationFrame(brickBreaker.animationId);
        }
        if (brickBreaker.touchInterval) {
            clearInterval(brickBreaker.touchInterval);
            brickBreaker.touchInterval = null;
        }
        initBrickBreaker();
        brickBreaker.gameRunning = true;
        brickBreaker.paddleDirection = 0;
        requestAnimationFrame(gameLoopBrickBreaker);
    }
    
    // ‰øÑÁΩóÊñØÊñπÂùóÊ∏∏Êàè - ‰øÆÂ§çÁâà
    function startTetris() {
        closeModal('game-select-modal');
        
        tetris.canvas = document.getElementById('tetris-canvas');
        tetris.ctx = tetris.canvas.getContext('2d');
        
        initTetris();
        openModal('game-tetris-modal');
        
        // Ê∑ªÂä†ÈîÆÁõòÊéßÂà∂
        document.addEventListener('keydown', handleTetrisKey);
        
        if (!state.gameHistory) state.gameHistory = [];
        state.gameHistory.push({
            game: '‰øÑÁΩóÊñØÊñπÂùó',
            startTime: new Date().toLocaleString(),
            score: 0
        });
        
        tetris.lastTime = 0;
        tetris.touchAction = null;
        tetris.touchInterval = null;
        requestAnimationFrame(gameLoopTetris);
    }
    
    function initTetris() {
        // ÂàùÂßãÂåñÁΩëÊ†º - ‰øÆÂ§çÔºöÁ°Æ‰øùÊ≠£Á°ÆÂàùÂßãÂåñ
        const rows = 20;
        const cols = 10;
        
        tetris.grid = [];
        for (let r = 0; r < rows; r++) {
            tetris.grid[r] = [];
            for (let c = 0; c < cols; c++) {
                tetris.grid[r][c] = 0;
            }
        }
        
        // ÊñπÂùóÂΩ¢Áä∂ÂÆö‰πâ - ‰øÆÂ§çÔºö‰ΩøÁî®Êõ¥Ê∏ÖÊô∞ÁöÑÂΩ¢Áä∂Êï∞ÁªÑ
        tetris.shapes = [
            // I
            [
                [1,1,1,1]
            ],
            // O
            [
                [1,1],
                [1,1]
            ],
            // T
            [
                [0,1,0],
                [1,1,1]
            ],
            // Z
            [
                [1,1,0],
                [0,1,1]
            ],
            // S
            [
                [0,1,1],
                [1,1,0]
            ],
            // J
            [
                [1,0,0],
                [1,1,1]
            ],
            // L
            [
                [0,0,1],
                [1,1,1]
            ]
        ];
        
        // ÊñπÂùóÈ¢úËâ≤
        tetris.colors = [
            '#FF6B6B', // Á∫¢Ëâ≤
            '#4ECDC4', // ÈùíËâ≤
            '#FFD166', // ÈªÑËâ≤
            '#06D6A0', // ÁªøËâ≤
            '#118AB2', // ËìùËâ≤
            '#EF476F', // Á≤âËâ≤
            '#7B68EE'  // Á¥´Ëâ≤
        ];
        
        // ÂàõÂª∫Êñ∞ÊñπÂùó
        createNewPiece();
        
        tetris.score = 0;
        tetris.gameOver = false;
        tetris.dropCounter = 0;
        tetris.dropInterval = 1000;
        tetris.blockSize = 20;
        
        document.getElementById('tetris-score').textContent = '0';
    }
    
    function createNewPiece() {
        const shapeIndex = Math.floor(Math.random() * tetris.shapes.length);
        tetris.currentPiece = {
            shape: JSON.parse(JSON.stringify(tetris.shapes[shapeIndex])), // Ê∑±Êã∑Ë¥ù
            color: tetris.colors[shapeIndex],
            shapeIndex: shapeIndex, // ‰øùÂ≠òÂΩ¢Áä∂Á¥¢Âºï
            x: Math.floor((10 - tetris.shapes[shapeIndex][0].length) / 2), // Â±Ö‰∏≠ÊòæÁ§∫
            y: 0
        };
    }
    
    function gameLoopTetris(time) {
        if (tetris.gameOver) return;
        
        const deltaTime = time - tetris.lastTime;
        tetris.lastTime = time;
        
        tetris.dropCounter += deltaTime;
        if (tetris.dropCounter > tetris.dropInterval) {
            dropPiece();
            tetris.dropCounter = 0;
        }
        
        // ÁªòÂà∂Ê∏∏Êàè
        drawTetrisGrid();
        drawCurrentPiece();
        
        tetris.animationId = requestAnimationFrame(gameLoopTetris);
    }
    
    function drawTetrisGrid() {
        const blockSize = tetris.blockSize;
        
        // Ê∏ÖÈô§ÁîªÂ∏É
        tetris.ctx.fillStyle = '#000';
        tetris.ctx.fillRect(0, 0, tetris.canvas.width, tetris.canvas.height);
        
        // ÁªòÂà∂ÁΩëÊ†ºÁ∫ø
        tetris.ctx.strokeStyle = '#333';
        tetris.ctx.lineWidth = 0.5;
        
        // ÁªòÂà∂Â∑≤ÈîÅÂÆöÁöÑÊñπÂùó
        for (let r = 0; r < 20; r++) {
            for (let c = 0; c < 10; c++) {
                // ÁªòÂà∂ÁΩëÊ†ºÁ∫ø
                tetris.ctx.strokeRect(c * blockSize, r * blockSize, blockSize, blockSize);
                
                // ÁªòÂà∂ÊñπÂùó
                if (tetris.grid[r][c] > 0) {
                    const colorIndex = tetris.grid[r][c] - 1;
                    if (colorIndex >= 0 && colorIndex < tetris.colors.length) {
                        // ÁªòÂà∂ÊñπÂùó‰∏ª‰Ωì
                        tetris.ctx.fillStyle = tetris.colors[colorIndex];
                        tetris.ctx.fillRect(c * blockSize + 1, r * blockSize + 1, blockSize - 2, blockSize - 2);
                        
                        // ÁªòÂà∂ÊñπÂùóËæπÊ°Ü
                        tetris.ctx.strokeStyle = '#FFF';
                        tetris.ctx.lineWidth = 1;
                        tetris.ctx.strokeRect(c * blockSize + 0.5, r * blockSize + 0.5, blockSize - 1, blockSize - 1);
                        tetris.ctx.strokeStyle = '#333';
                        tetris.ctx.lineWidth = 0.5;
                    }
                }
            }
        }
    }
    
    function drawCurrentPiece() {
        if (!tetris.currentPiece || tetris.gameOver) return;
        
        const piece = tetris.currentPiece;
        const blockSize = tetris.blockSize;
        
        tetris.ctx.fillStyle = piece.color;
        
        for (let r = 0; r < piece.shape.length; r++) {
            for (let c = 0; c < piece.shape[r].length; c++) {
                if (piece.shape[r][c]) {
                    const x = (piece.x + c) * blockSize;
                    const y = (piece.y + r) * blockSize;
                    
                    // ÁªòÂà∂ÊñπÂùó‰∏ª‰Ωì
                    tetris.ctx.fillRect(x + 1, y + 1, blockSize - 2, blockSize - 2);
                    
                    // ÁªòÂà∂ÊñπÂùóËæπÊ°Ü
                    tetris.ctx.strokeStyle = '#FFF';
                    tetris.ctx.lineWidth = 1;
                    tetris.ctx.strokeRect(x + 0.5, y + 0.5, blockSize - 1, blockSize - 1);
                    tetris.ctx.strokeStyle = '#333';
                    tetris.ctx.lineWidth = 0.5;
                }
            }
        }
    }
    
    function dropPiece() {
        if (!tetris.currentPiece || tetris.gameOver) return;
        
        // Â∞ùËØïÂêë‰∏ãÁßªÂä®
        tetris.currentPiece.y++;
        
        // Â¶ÇÊûúÂèëÁîüÁ¢∞ÊíûÔºåÂõûÈÄÄÂπ∂ÈîÅÂÆöÊñπÂùó
        if (checkTetrisCollision()) {
            tetris.currentPiece.y--;
            lockPiece();
            clearLines();
            
            // ÂàõÂª∫Êñ∞ÊñπÂùó
            createNewPiece();
            
            // Ê£ÄÊü•Ê∏∏ÊàèÊòØÂê¶ÁªìÊùüÔºàÊñ∞ÊñπÂùóÁîüÊàêÊó∂Â∞±ÂèëÁîüÁ¢∞ÊíûÔºâ
            if (checkTetrisCollision()) {
                tetris.gameOver = true;
                showToast("Ê∏∏ÊàèÁªìÊùüÔºÅÊñπÂùóÂ†ÜÂà∞È°∂ÈÉ®‰∫Ü");
                if (tetris.animationId) {
                    cancelAnimationFrame(tetris.animationId);
                    tetris.animationId = null;
                }
            }
        }
    }
    
    function checkTetrisCollision() {
        const piece = tetris.currentPiece;
        if (!piece) return true;
        
        // Ê£ÄÊü•ÂΩìÂâçÊñπÂùóÁöÑÊØè‰∏™Â∞èÊñπÂùó
        for (let r = 0; r < piece.shape.length; r++) {
            for (let c = 0; c < piece.shape[r].length; c++) {
                if (piece.shape[r][c]) {
                    const newX = piece.x + c;
                    const newY = piece.y + r;
                    
                    // Ê£ÄÊü•ËæπÁïå
                    if (newX < 0 || newX >= 10) {
                        return true; // Ë∂ÖÂá∫Â∑¶Âè≥ËæπÁïå
                    }
                    
                    if (newY >= 20) {
                        return true; // Ë∂ÖÂá∫Â∫ïÈÉ®
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶‰∏éÂ∑≤ÊúâÊñπÂùóÈáçÂè†ÔºàÂè™Ê£ÄÊü•Âú®ÁΩëÊ†ºÂÜÖÁöÑ‰ΩçÁΩÆÔºâ
                    if (newY >= 0 && tetris.grid[newY] && tetris.grid[newY][newX] > 0) {
                        return true; // ‰∏éÂ∑≤ÊúâÊñπÂùóÁ¢∞Êíû
                    }
                }
            }
        }
        
        return false;
    }
    
    function lockPiece() {
        const piece = tetris.currentPiece;
        if (!piece) return;
        
        for (let r = 0; r < piece.shape.length; r++) {
            for (let c = 0; c < piece.shape[r].length; c++) {
                if (piece.shape[r][c]) {
                    const gridY = piece.y + r;
                    const gridX = piece.x + c;
                    
                    // Á°Æ‰øù‰ΩçÁΩÆÂú®ÁΩëÊ†ºÂÜÖ
                    if (gridY >= 0 && gridY < 20 && gridX >= 0 && gridX < 10) {
                        // ‰ΩøÁî®ÂΩ¢Áä∂Á¥¢Âºï + 1 Êù•‰øùÂ≠òÊñπÂùóÁ±ªÂûãÔºà0Ë°®Á§∫Á©∫Ôºâ
                        tetris.grid[gridY][gridX] = piece.shapeIndex + 1;
                    }
                }
            }
        }
    }
    
    function clearLines() {
        let linesCleared = 0;
        
        // ‰ªéÂ∫ïÈÉ®Âêë‰∏äÊ£ÄÊü•
        for (let r = 19; r >= 0; r--) {
            let isFull = true;
            
            // Ê£ÄÊü•ËØ•Ë°åÊòØÂê¶Â°´Êª°
            for (let c = 0; c < 10; c++) {
                if (tetris.grid[r][c] === 0) {
                    isFull = false;
                    break;
                }
            }
            
            // Â¶ÇÊûúÂ°´Êª°ÔºåÊ∏ÖÈô§ËØ•Ë°å
            if (isFull) {
                // Â∞Ü‰∏äÈù¢ÁöÑÊâÄÊúâË°åÂêë‰∏ãÁßªÂä®‰∏ÄË°å
                for (let y = r; y > 0; y--) {
                    for (let c = 0; c < 10; c++) {
                        tetris.grid[y][c] = tetris.grid[y - 1][c];
                    }
                }
                
                // Ê∏ÖÁ©∫ÊúÄÈ°∂ÈÉ®‰∏ÄË°å
                for (let c = 0; c < 10; c++) {
                    tetris.grid[0][c] = 0;
                }
                
                linesCleared++;
                
                // Áî±‰∫éÁßªÂä®‰∫ÜË°åÔºåÈúÄË¶ÅÂÜçÊ¨°Ê£ÄÊü•ÂΩìÂâçË°å
                r++;
            }
        }
        
        // ËÆ°ÁÆóÂàÜÊï∞
        if (linesCleared > 0) {
            const points = [0, 40, 100, 300, 1200];
            tetris.score += points[linesCleared];
            document.getElementById('tetris-score').textContent = tetris.score;
            
            // ÈöèÁùÄÂàÜÊï∞Â¢ûÂä†ÔºåÂä†Âø´‰∏ãËêΩÈÄüÂ∫¶
            tetris.dropInterval = Math.max(100, 1000 - Math.floor(tetris.score / 100) * 50);
        }
    }
    
    function handleTetrisKey(e) {
        if (tetris.gameOver) return;
        
        switch(e.key) {
            case 'ArrowLeft':
                movePiece(-1, 0);
                break;
            case 'ArrowRight':
                movePiece(1, 0);
                break;
            case 'ArrowDown':
                softDrop();
                break;
            case 'ArrowUp':
                rotatePiece();
                break;
            case ' ':
                hardDrop();
                break;
        }
    }
    
    function handleTetrisTouch(action) {
        if (tetris.gameOver) return;
        
        const now = Date.now();
        if (tetris.lastTouchTime && now - tetris.lastTouchTime < 100) {
            return;
        }
        tetris.lastTouchTime = now;
        
        switch(action) {
            case 'left':
                movePiece(-1, 0);
                break;
            case 'right':
                movePiece(1, 0);
                break;
            case 'down':
                softDrop();
                break;
            case 'up':
                rotatePiece();
                break;
            case 'fastdrop':
                hardDrop();
                break;
        }
        
        return false;
    }
    
    function clearTetrisTouch() {
        tetris.lastTouchTime = null;
    }
    
    function movePiece(dx, dy) {
        if (!tetris.currentPiece || tetris.gameOver) return false;
        
        // ‰øùÂ≠òÂéüÊù•ÁöÑ‰ΩçÁΩÆ
        const originalX = tetris.currentPiece.x;
        const originalY = tetris.currentPiece.y;
        
        // Â∞ùËØïÁßªÂä®
        tetris.currentPiece.x += dx;
        tetris.currentPiece.y += dy;
        
        // Ê£ÄÊü•Á¢∞Êíû
        if (checkTetrisCollision()) {
            // Â¶ÇÊûúÁ¢∞ÊíûÔºåÊÅ¢Â§çÂà∞ÂéüÊù•ÁöÑ‰ΩçÁΩÆ
            tetris.currentPiece.x = originalX;
            tetris.currentPiece.y = originalY;
            return false;
        }
        
        return true;
    }
    
    function softDrop() {
        if (!tetris.currentPiece || tetris.gameOver) return;
        
        // Â∞ùËØïÂêë‰∏ãÁßªÂä®
        if (!movePiece(0, 1)) {
            // Â¶ÇÊûúÊó†Ê≥ïÁßªÂä®ÔºåÈîÅÂÆöÊñπÂùó
            lockPiece();
            clearLines();
            createNewPiece();
        }
    }
    
    function hardDrop() {
        if (!tetris.currentPiece || tetris.gameOver) return;
        
        // ‰∏ÄÁõ¥Âêë‰∏ãÁßªÂä®Áõ¥Âà∞Á¢∞Êíû
        while (movePiece(0, 1)) {
            // ÁªßÁª≠‰∏ãËêΩ
        }
        
        // ÈîÅÂÆöÊñπÂùó
        lockPiece();
        clearLines();
        createNewPiece();
    }
    
    function rotatePiece() {
        if (!tetris.currentPiece || tetris.gameOver) return;
        
        // ‰øùÂ≠òÂéüÂßãÂΩ¢Áä∂
        const originalShape = JSON.parse(JSON.stringify(tetris.currentPiece.shape));
        const originalX = tetris.currentPiece.x;
        
        // ËÆ°ÁÆóÊóãËΩ¨ÂêéÁöÑÂΩ¢Áä∂
        const rows = originalShape.length;
        const cols = originalShape[0].length;
        
        const rotated = [];
        for (let c = 0; c < cols; c++) {
            rotated[c] = [];
            for (let r = rows - 1; r >= 0; r--) {
                rotated[c][rows - 1 - r] = originalShape[r][c];
            }
        }
        
        // Â∞ùËØïÂ∫îÁî®ÊóãËΩ¨
        tetris.currentPiece.shape = rotated;
        
        // Ê£ÄÊü•ÊóãËΩ¨ÂêéÊòØÂê¶‰ºöÂèëÁîüÁ¢∞Êíû
        if (checkTetrisCollision()) {
            // Â¶ÇÊûúÁ¢∞ÊíûÔºåÂ∞ùËØïÂ¢ôË∏¢Ôºàwall kickÔºâ
            let kickOffset = 1;
            const maxKickAttempts = 2;
            
            for (let attempt = 0; attempt < maxKickAttempts; attempt++) {
                // Â∞ùËØïÂêëÂ∑¶ÁßªÂä®
                tetris.currentPiece.x = originalX - kickOffset;
                if (!checkTetrisCollision()) {
                    return; // Â¢ôË∏¢ÊàêÂäü
                }
                
                // Â∞ùËØïÂêëÂè≥ÁßªÂä®
                tetris.currentPiece.x = originalX + kickOffset;
                if (!checkTetrisCollision()) {
                    return; // Â¢ôË∏¢ÊàêÂäü
                }
                
                // ÈáçÁΩÆ‰ΩçÁΩÆ
                tetris.currentPiece.x = originalX;
                kickOffset++;
            }
            
            // ÊâÄÊúâÂ¢ôË∏¢Â∞ùËØïÈÉΩÂ§±Ë¥•ÔºåÊÅ¢Â§çÂéüÂßãÂΩ¢Áä∂
            tetris.currentPiece.shape = originalShape;
        }
    }
    
    function closeTetris() {
        closeModal('game-tetris-modal');
        document.removeEventListener('keydown', handleTetrisKey);
        
        if (tetris.animationId) {
            cancelAnimationFrame(tetris.animationId);
        }
        
        if (tetris.touchInterval) {
            clearInterval(tetris.touchInterval);
            tetris.touchInterval = null;
        }
        
        // ËÆ°ÁÆóÈáëÂ∏ÅÂ•ñÂä±
        if (tetris.score > 0) {
            const coins = Math.floor(tetris.score / 50);
            if (coins > 0) {
                state.money += coins;
                showToast(`Ê∏∏ÊàèÁªìÊùüÔºÅËé∑Âæó ${coins} ÈáëÂ∏Å`);
                updateUI();
                
                // ÂÆûÈôÖÂÆåÊàêÊ∏∏ÊàèÂêéÊõ¥Êñ∞‰ªªÂä°ËøõÂ∫¶
                const playGameTask = state.tasks.find(t => t.id === 'play_game');
                if (playGameTask) {
                    playGameTask.progress = 1;
                    renderTaskList();
                }
                
                saveState();
                
                if (state.gameHistory && state.gameHistory.length > 0) {
                    const lastGame = state.gameHistory[state.gameHistory.length - 1];
                    lastGame.endTime = new Date().toLocaleString();
                    lastGame.finalScore = tetris.score;
                    lastGame.coinsEarned = coins;
                    
                    recordSystem.addRecord(
                        'Â∞èÊ∏∏ÊàèÔºö‰øÑÁΩóÊñØÊñπÂùó',
                        `ÂÆåÊàê‰øÑÁΩóÊñØÊñπÂùóÊ∏∏Êàè„ÄÇÊúÄÁªàÂàÜÊï∞Ôºö${tetris.score}ÔºåËé∑ÂæóÈáëÂ∏ÅÔºö${coins}„ÄÇ`,
                        ['Ê∏∏Êàè', '‰øÑÁΩóÊñØÊñπÂùó']
                    );
                }
            }
        }
    }
    
    function restartTetris() {
        if (tetris.animationId) {
            cancelAnimationFrame(tetris.animationId);
        }
        if (tetris.touchInterval) {
            clearInterval(tetris.touchInterval);
            tetris.touchInterval = null;
        }
        initTetris();
        tetris.lastTime = 0;
        tetris.touchAction = null;
        tetris.gameOver = false;
        requestAnimationFrame(gameLoopTetris);
    }

    // === Ëá™ÂÆö‰πâÂ§¥ÂÉèÁ≥ªÁªü ===
    function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.match('image.*')) {
            showToast("ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂");
            return;
        }
        
        if (file.size > 2 * 1024 * 1024) {
            showToast("ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá2MB");
            return;
        }
        
        selectedAvatarFile = file;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatar-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        showToast("ÂõæÁâáÂ∑≤ÈÄâÊã©ÔºåÁÇπÂáªÂ∫îÁî®ÊåâÈíÆËÆæÁΩÆÂ§¥ÂÉè");
    }

    function applyCustomAvatar() {
        if (!selectedAvatarFile) {
            showToast("ËØ∑ÂÖàÈÄâÊã©ÂõæÁâá");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const imgData = e.target.result;
            
            // ÂàõÂª∫‰∏¥Êó∂ÂõæÁâáÊ£ÄÊü•ÈÄèÊòéÂ∫¶
            const tempImg = new Image();
            tempImg.onload = function() {
                // Êõ¥Êñ∞ÊâÄÊúâÂ§¥ÂÉèÊòæÁ§∫
                document.getElementById('zaizai-img').src = imgData;
                document.getElementById('avatar-preview').src = imgData;
                document.getElementById('fullscreen-img').src = imgData;
                
                // Â¶ÇÊûúÊòØPNGÂõæÁâáÔºåÊ∑ªÂä†Ê∞îÊ≥°ÊïàÊûúÁ±ª
                if (selectedAvatarFile.type === 'image/png') {
                    document.getElementById('zaizai-img').classList.add('transparent-avatar-effect');
                    document.getElementById('avatar-preview').classList.add('transparent-avatar-effect');
                    document.getElementById('fullscreen-img').classList.add('transparent-avatar-effect');
                }
                
                state.customAvatar = imgData;
                
                showToast("Â§¥ÂÉèÊõ¥Êç¢ÊàêÂäüÔºÅÈÄèÊòéÊïàÊûúÂ∑≤Â∫îÁî®");
                closeModal('avatar-modal');
                
                recordSystem.addRecord(
                    'Êõ¥Êç¢Â§¥ÂÉè',
                    'ËßÇÊµãËÄÖÊõ¥Êç¢‰∫ÜËßÇÊµãÂØπË±°ÁöÑÂ§¥ÂÉèÔºåÂ∫îÁî®‰∫ÜÈÄèÊòéÊ∞îÊ≥°ÊïàÊûú„ÄÇ',
                    ['ËÆæÁΩÆ', 'Â§¥ÂÉè']
                );
                
                saveState();
            };
            tempImg.src = imgData;
        };
        reader.readAsDataURL(selectedAvatarFile);
    }

// === ‰ªªÂä°Á≥ªÁªüËæÖÂä©ÂáΩÊï∞ ===

// ÂàùÂßãÂåñ‰ªªÂä°
function initializeTasks() {
    state.tasks = JSON.parse(JSON.stringify(taskList));
    
    // ËÆæÁΩÆÊØèÊó•ÁôªÂΩï‰ªªÂä°ÁöÑÂàùÂßãÁä∂ÊÄÅ
    const dailyLoginTask = state.tasks.find(t => t.id === 'daily_login');
    if (dailyLoginTask) {
        dailyLoginTask.progress = state.dailyLoginClaimed ? 1 : 0;
    }
    
    // ËÆæÁΩÆ‰∫íÂä®‰ªªÂä°ËøõÂ∫¶
    const playTask = state.tasks.find(t => t.id === 'play_with_zaizai');
    if (playTask) {
        playTask.progress = Math.min(playTask.maxProgress, state.interactionCount);
    }
    
    // ËÆæÁΩÆ‰ø°‰ªª‰ªªÂä°ËøõÂ∫¶
    const trustTask = state.tasks.find(t => t.id === 'increase_trust');
    if (trustTask) {
        trustTask.progress = Math.min(trustTask.maxProgress, Math.floor(state.trust));
    }
    
    console.log('‰ªªÂä°ÂàùÂßãÂåñÂÆåÊàêÔºåÂÖ±', state.tasks.length, '‰∏™‰ªªÂä°');
}

// ‰øÆÂ§ç‰ªªÂä°Êï∞ÊçÆ
function fixTasksData() {
    const currentTaskIds = state.tasks.map(t => t.id);
    const allTaskIds = taskList.map(t => t.id);
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÁº∫Â§±ÁöÑ‰ªªÂä°
    const missingTaskIds = allTaskIds.filter(id => !currentTaskIds.includes(id));
    
    if (missingTaskIds.length > 0) {
        console.log('ÂèëÁé∞Áº∫Â§±ÁöÑ‰ªªÂä°:', missingTaskIds);
        
        // Ê∑ªÂä†Áº∫Â§±ÁöÑ‰ªªÂä°
        missingTaskIds.forEach(missingId => {
            const template = taskList.find(t => t.id === missingId);
            if (template) {
                const newTask = JSON.parse(JSON.stringify(template));
                
                // ËÆæÁΩÆÂàùÂßãËøõÂ∫¶
                switch(missingId) {
                    case 'daily_login':
                        newTask.progress = state.dailyLoginClaimed ? 1 : 0;
                        break;
                    case 'play_with_zaizai':
                        newTask.progress = Math.min(newTask.maxProgress, state.interactionCount);
                        break;
                    case 'increase_trust':
                        newTask.progress = Math.min(newTask.maxProgress, Math.floor(state.trust));
                        break;
                    case 'complete_schedule':
                        newTask.progress = state.scheduleTaskClaimed ? 1 : 0;
                        break;
                    case 'buy_item':
                        newTask.progress = state.buyTaskClaimed ? 1 : 0;
                        break;
                    case 'read_diary':
                        newTask.progress = state.diaryTaskClaimed ? 1 : 0;
                        break;
                    case 'buy_furniture':
                        newTask.progress = state.furnitureTaskClaimed ? 1 : 0;
                        break;
                    case 'play_game':
                        newTask.progress = state.gameTaskClaimed ? 1 : 0;
                        break;
                }
                
                state.tasks.push(newTask);
                console.log('Ê∑ªÂä†‰ªªÂä°:', newTask.title);
            }
        });
        
        saveState();
    }
}

    // === ÈÄöÁî®UIÊõ¥Êñ∞ ===
    function updateUI() {
        document.getElementById('money-display').innerText = `üí∞ ${Math.floor(state.money)}`;
        document.getElementById('hunger-bar').style.width = `${state.hunger}%`;
        document.getElementById('trust-bar').style.width = `${state.trust}%`;
        document.getElementById('day-display').innerText = `Day ${state.day}`;
        
        if (state.trust >= 30) {
            document.getElementById('diary-book').style.display = 'block';
        }
    }

    function openModal(id) { 
        document.getElementById(id).style.display = 'flex'; 
        
        if (id === 'task-list-modal') {
            renderTaskList();
        }
        else if (id === 'shop-modal') {
            renderShop();
        }
        else if (id === 'room-shop-modal') {
            renderRoomShop();
        }
        else if (id === 'chat-modal') {
            renderChat();
            document.getElementById('chat-input').focus();
        }
        else if (id === 'memo-modal') {
            renderMemos();
            document.getElementById('memo-input').focus();
        }
        else if (id === 'record-modal') {
            renderRecords();
        }
        else if (id === 'bg-modal') {
            renderBackgroundSelector();
        }
        else if (id === 'pomodoro-modal') {
            const fullscreenImg = document.getElementById('fullscreen-img');
            if (state.customAvatar) {
                fullscreenImg.src = state.customAvatar;
            }
        }
    }
    
    function closeModal(id) { 
        document.getElementById(id).style.display = 'none'; 
        
        if (id === 'chat-modal') {
            document.getElementById('chat-input').blur();
        }
        else if (id === 'memo-modal') {
            document.getElementById('memo-input').blur();
        }
        else if (id === 'game2048-modal') {
            // 2048Ê∏∏ÊàèÂÖ≥Èó≠Êó∂‰∏çÈúÄË¶ÅÊ∏ÖÁêÜËß¶Êë∏‰∫ã‰ª∂
        }
        else if (id === 'game-brickbreaker-modal') {
            stopPaddle();
        }
        else if (id === 'game-tetris-modal') {
            clearTetrisTouch();
        }
    }
    
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    }

    // Á¶ÅÊ≠¢ÈïøÊåâÂàÜ‰∫´Á≠âÁΩëÈ°µÂäüËÉΩ
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });
    
    document.addEventListener('selectstart', function(e) {
        e.preventDefault();
    });
    
    let longPressTimer;
    document.addEventListener('touchstart', function(e) {
        longPressTimer = setTimeout(function() {
            e.preventDefault();
        }, 200);
    }, { passive: false });
    
    document.addEventListener('touchend', function() {
        clearTimeout(longPressTimer);
    });
    
    document.addEventListener('touchmove', function() {
        clearTimeout(longPressTimer);
    });

</script>
</body>
</html>