<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¼‚ç•Œè§‚æµ‹çª—å£</title>
    <meta name="theme-color" content="#FFFFFF"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://www.joyssl.com/sys/uploads/176840963773392.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/dompurify@2.3.8/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --bg-color: #FFF0F5;
            --card-bg: #FFFFFF;
            --primary-pink: #FFB7B2;
            --primary-blue: #A2E1DB;
            --primary-purple: #CBAACB;
            --text-color: #6D6D6D;
            --accent-color: #FF9AA2;
            --border-radius: 24px;
        }

        @font-face {
            font-family: 'Handwriting';
            src: local('Courier New');
        }

        /* åŸºç¡€æ ·å¼é‡ç½®ï¼Œé€‚é…å…¨å±æ¨¡å¼ */
        html {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Nunito', 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
            /* é€‚é…åˆ˜æµ·å±å’ŒçŠ¶æ€æ  */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* å…¨å±æ¨¡å¼ä¸‹éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            display: none;
        }

        #game-container {
            width: 100%;
            height: 100%;
            min-height: 100vh;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: relative;
            border: 6px solid #fff;
            overflow: hidden;
            touch-action: pan-y pinch-zoom;
            box-sizing: border-box;
        }

        /* é€‚é…æ·»åŠ åˆ°æ¡Œé¢åçš„å…¨å±æ¨¡å¼ */
        @media all and (display-mode: fullscreen) {
            #game-container {
                border-radius: 0;
                border: none;
                box-shadow: none;
                height: 100vh;
            }
        }

        /* é€‚é…iOS Safariæ·»åŠ åˆ°æ¡Œé¢åçš„å…¨å±æ¨¡å¼ */
        @media screen and (standalone: true) {
            #game-container {
                border-radius: 0;
                border: none;
                box-shadow: none;
                height: 100vh;
            }
            
            header {
                padding-top: env(safe-area-inset-top);
            }
        }

        header {
            background: linear-gradient(90deg, var(--primary-pink), var(--accent-color));
            padding: 12px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            font-weight: bold;
            z-index: 10;
            flex-shrink: 0;
            touch-action: none;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #avatar-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        /* èƒŒæ™¯é€‰æ‹©å™¨ */
        #bg-selector {
            position: absolute;
            top: 15px;
            right: 60px;
            z-index: 10;
            background: white;
            border-radius: 15px;
            padding: 5px 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }

        #bg-selector-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
        }

        #room-view {
            flex: 1;
            background: linear-gradient(180deg, #FFE6E6 0%, #FFF0F5 50%, #F0F8FF 100%);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 40px;
            overflow: hidden;
            transition: background 0.5s;
            touch-action: pan-y pinch-zoom;
            background-size: cover;
            background-position: center;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 3px solid #FFB6B9;
        }

        .weather-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .sunny-effect {
            background: radial-gradient(circle at 30% 20%, rgba(255, 255, 200, 0.3) 0%, transparent 70%);
        }
        .rainy-effect {
            background: linear-gradient(to bottom, rgba(173, 216, 230, 0.1) 0%, transparent 30%);
        }
        .snowy-effect {
            background: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
        }
        .foggy-effect {
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
        }

        /* å¯æ‹–åŠ¨çš„å´½å´½å®¹å™¨ */
        #character-wrapper {
            position: absolute;
            z-index: 15;
            text-align: center;
            transition: transform 0.3s;
            cursor: grab;
            touch-action: none;
            user-select: none;
            left: 115px;
            top: 200px;
        }
        #character-wrapper:active {
            cursor: grabbing;
        }
        /* é€æ˜å¤´åƒæ¡†æ ·å¼ */
        #zaizai-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: none; /* ç§»é™¤è¾¹æ¡† */
            box-shadow: none; /* ç§»é™¤é˜´å½± */
            background: transparent; /* é€æ˜èƒŒæ™¯ */
            pointer-events: none;
            /* æ·»åŠ æ°”æ³¡æ•ˆæœ */
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
            -webkit-mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 70%, rgba(0, 0, 0, 0.3) 85%, rgba(0, 0, 0, 0) 100%);
            mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 70%, rgba(0, 0, 0, 0.3) 85%, rgba(0, 0, 0, 0) 100%);
        }
		
        #touch-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            z-index: 20;
            cursor: pointer;
            touch-action: none;
            /* æ·»åŠ æ°”æ³¡æ•ˆæœ */
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 30%, transparent 70%);
        }
		/* åœ¨å…¨å±æ¨¡å¼ä¸­ä¹Ÿæ·»åŠ æ°”æ³¡æ•ˆæœ */
		#fullscreen-zaizai {
		    position: relative;
		    margin-bottom: 40px;
		}
		
		#fullscreen-zaizai::before {
		    content: '';
		    position: absolute;
		    top: 50%;
		    left: 50%;
		    transform: translate(-50%, -50%);
		    width: 140px;
		    height: 140px;
		    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
		    border-radius: 50%;
		    z-index: -1;
		    animation: bubblePulse 3s infinite alternate;
		}
		@keyframes bubblePulse {
		    0% {
		        transform: translate(-50%, -50%) scale(1);
		        opacity: 0.2;
		    }
		    100% {
		        transform: translate(-50%, -50%) scale(1.1);
		        opacity: 0.3;
		    }
		}
		
        .pat-anim { animation: pat 0.3s; }
        @keyframes pat { 0% {transform: scale(1);} 50% {transform: scale(1.1, 0.9);} 100% {transform: scale(1);} }
        .poke-anim { animation: poke 0.3s; }
        @keyframes poke { 0% {transform: rotate(0);} 25% {transform: rotate(-10deg);} 75% {transform: rotate(10deg);} 100% {transform: rotate(0);} }
        .using-furniture { animation: furniture-use 2s ease-in-out; }
        @keyframes furniture-use { 
            0% { transform: scale(1); }
            25% { transform: scale(1.05); }
            50% { transform: scale(1); }
            75% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ä¿®æ”¹å¯¹è¯æ¡†æ°”æ³¡æ ·å¼ä»¥åŒ¹é… */
        #bubble {
            position: absolute;
            top: -100px; 
            left: 50%; 
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
            backdrop-filter: blur(5px); /* æ¯›ç»ç’ƒæ•ˆæœ */
            padding: 12px 16px;
            border-radius: 16px; 
            border-bottom-left-radius: 2px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-size: 13px; 
            color: #555; 
            width: 180px;
            opacity: 0; 
            pointer-events: none;
            transition: opacity 0.4s;
            z-index: 25;
            border: 1px solid rgba(255, 255, 255, 0.3); /* åŠé€æ˜è¾¹æ¡† */
        }

        .room-item {
            position: absolute;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 10;
            touch-action: manipulation;
        }
        .room-item:active { transform: scale(0.9); }
        
        #diary-book { 
            bottom: 20px; left: 20px; font-size: 40px; 
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            animation: float 3s infinite ease-in-out; 
            display: none;
        }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
        
        /* ä¿®å¤ï¼šåˆå§‹åªæœ‰çª—æˆ·ï¼Œå»æ‰ç»¿æ¤ */
        #window { 
            top: 50px; left: 30px; font-size: 50px;
            color: #87CEEB;
        }
        #bed { 
            bottom: 30px; right: 30px; font-size: 40px;
            color: #795548;
            display: none; /* åˆå§‹ä¸æ˜¾ç¤ºåºŠ */
        }

        #stats-bar {
            padding: 8px 15px; background: #fff;
            border-top: 1px solid #f5f5f5;
            display: flex; gap: 10px;
            flex-shrink: 0;
        }
        .stat-box { flex: 1; }
        .stat-label { font-size: 10px; color: #999; margin-bottom: 2px; display: block; }
        .progress-bg { background: #eee; height: 6px; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s; }

        /* å¯¼èˆªæŒ‰é’®ä¼˜åŒ– - å›ºå®š5åˆ—å¸ƒå±€ */
        nav {
            padding: 10px; background: #FAFAFA;
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }
        .nav-btn {
            background: white; 
            border: 1px solid #eee; 
            padding: 10px 5px;
            border-radius: 12px; 
            font-size: 10px; 
            text-align: center;
            color: var(--text-color); 
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50px;
            word-break: break-word;
            line-height: 1.3;
        }
        .nav-btn:active { 
            background: #f0f0f0; 
            transform: scale(0.95); 
        }
        .nav-btn-emoji {
            font-size: 16px;
            margin-bottom: 2px;
        }
        .nav-btn-text {
            font-size: 10px;
        }

        .modal {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
            display: none; justify-content: center; align-items: center;
            z-index: 100;
            padding: 15px;
            box-sizing: border-box;
        }
        .modal-content {
            background: white; width: 100%; max-height: 80%;
            border-radius: 20px; padding: 25px;
            overflow-y: auto; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            animation: popUp 0.3s;
            box-sizing: border-box;
        }
        @keyframes popUp { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; color: #ccc; cursor: pointer; }

        #avatar-modal .modal-content {
            max-width: 350px;
        }
        /* å¤´åƒé¢„è§ˆå®¹å™¨æ·»åŠ æ°”æ³¡èƒŒæ™¯ */
        .avatar-preview-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }
        
        .avatar-preview-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            background: radial-gradient(circle, var(--primary-blue) 0%, transparent 70%);
            opacity: 0.2;
            border-radius: 50%;
            z-index: -1;
        }
		
        /* å¤´åƒé¢„è§ˆæ ·å¼ */
        #avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: none; /* ç§»é™¤è¾¹æ¡† */
            background: transparent; /* é€æ˜èƒŒæ™¯ */
            /* æ·»åŠ æ°”æ³¡æ•ˆæœ */
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
            -webkit-mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 70%, rgba(0, 0, 0, 0.3) 85%, rgba(0, 0, 0, 0) 100%);
            mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 70%, rgba(0, 0, 0, 0.3) 85%, rgba(0, 0, 0, 0) 100%);
        }
        
        /* å…¨å±æ¨¡å¼å¤´åƒæ ·å¼ */
        #fullscreen-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none; /* ç§»é™¤è¾¹æ¡† */
            cursor: pointer;
            /* æ·»åŠ æ°”æ³¡æ•ˆæœ */
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
            -webkit-mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 70%, rgba(0, 0, 0, 0.3) 85%, rgba(0, 0, 0, 0) 100%);
            mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 70%, rgba(0, 0, 0, 0.3) 85%, rgba(0, 0, 0, 0) 100%);
            background: transparent; /* é€æ˜èƒŒæ™¯ */
        }
		
        .avatar-upload-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            display: block;
            margin: 0 auto 15px;
            text-align: center;
            width: 80%;
        }
        .avatar-hint {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }
        #avatar-upload-input {
            display: none;
        }

        /* å¯é€‰ï¼šä¸ºé€æ˜å›¾ç‰‡æ·»åŠ æ›´æ˜æ˜¾çš„æ°”æ³¡æ•ˆæœ */
        .transparent-avatar-effect {
            position: relative;
        }
        
        .transparent-avatar-effect::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 30%,
                rgba(255, 255, 255, 0.02) 60%,
                transparent 80%);
            pointer-events: none;
        }
		
        /* èƒŒæ™¯é€‰æ‹©æ ·å¼ */
        #bg-modal .modal-content {
            max-width: 350px;
        }
        .bg-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .bg-item {
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .bg-item:hover {
            transform: scale(1.05);
            border-color: var(--primary-pink);
        }
        .bg-item.active {
            border-color: var(--primary-blue);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .bg-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .bg-name {
            text-align: center;
            font-size: 11px;
            margin-top: 5px;
            color: #666;
        }
        .bg-upload-container {
            margin-top: 20px;
            text-align: center;
        }
        #bg-upload-input {
            display: none;
        }
        .bg-upload-btn {
            background: var(--primary-purple);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
        }

        #task-list-modal .modal-content {
            max-width: 350px;
        }
        .task-item {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-info {
            flex: 1;
        }
        .task-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        .task-desc {
            font-size: 12px;
            color: #888;
        }
        .task-reward {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: #FF9800;
        }
        .task-btn {
            background: var(--primary-blue);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }
        .task-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .task-progress {
            width: 100%;
            height: 4px;
            background: #eee;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        .task-progress-fill {
            height: 100%;
            background: var(--primary-pink);
            transition: width 0.3s;
        }

        .diary-paper {
            background-color: #fffcf5;
            background-image: linear-gradient(#e6e6e6 1px, transparent 1px);
            background-size: 100% 25px;
            font-family: 'Handwriting', monospace;
            line-height: 25px;
            color: #444;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 5px 5px 10px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            transition: transform 0.3s;
        }
        .diary-paper:hover {
            transform: translateY(-2px);
            box-shadow: 5px 7px 12px rgba(0,0,0,0.08);
        }
        .diary-date { 
            color: var(--accent-color); 
            font-weight: bold; 
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .diary-mood {
            font-size: 0.8em;
            color: #888;
            font-style: italic;
        }

        #story-modal .modal-content { 
            border: 4px solid var(--primary-pink); 
            text-align: center; 
            max-width: 320px;
        }
        .story-chapter { 
            font-size: 12px; 
            color: var(--primary-pink); 
            letter-spacing: 2px; 
            margin-bottom: 10px;
            font-weight: bold;
        }
        .story-text { 
            font-size: 14px; 
            line-height: 1.6; 
            text-align: left; 
            margin: 15px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        .story-choice {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .story-btn {
            background: var(--primary-purple);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .story-btn:hover {
            background: var(--primary-pink);
            transform: translateY(-2px);
        }

        #toast {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(50,50,50,0.9); color: white; padding: 8px 16px;
            border-radius: 20px; font-size: 12px; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 200; white-space: nowrap;
            text-align: center;
            max-width: 90%;
        }

        .item-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 10px 0; 
            border-bottom: 1px dashed #eee; 
            font-size: 13px; 
            align-items: center;
        }
        .btn-action { 
            background: var(--primary-blue); 
            border: none; 
            color: white; 
            padding: 4px 10px; 
            border-radius: 15px; 
            font-size: 11px; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        .btn-action:hover { transform: scale(1.05); }
        .btn-action:active { transform: scale(0.95); }
        .btn-secondary {
            background: var(--primary-purple);
        }
        .btn-warning {
            background: #FF9800;
        }

        #task-modal .modal-content {
            max-width: 350px;
        }
        .schedule-item {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-blue);
        }
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .schedule-title {
            font-weight: bold;
            color: #555;
        }
        .schedule-time {
            font-size: 11px;
            color: #888;
            background: #fff;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .schedule-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .schedule-effects {
            display: flex;
            gap: 10px;
            font-size: 11px;
            color: #777;
        }
        .effect-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        #room-shop-modal .modal-content {
            max-width: 350px;
        }
        .furniture-item {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #8BC34A;
        }
        .furniture-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .furniture-title {
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        .furniture-price {
            font-size: 12px;
            color: #FF9800;
            font-weight: bold;
        }
        .furniture-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        .furniture-effect {
            font-size: 11px;
            color: #4CAF50;
            font-style: italic;
        }
        .furniture-owned {
            font-size: 10px;
            color: #888;
            margin-top: 5px;
        }

        #chat-modal .modal-content {
            max-width: 350px;
        }
        .chat-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 5px;
        }
        .chat-message {
            margin-bottom: 12px;
            clear: both;
        }
        .user-message {
            text-align: right;
        }
        .zaizai-message {
            text-align: left;
        }
        .message-bubble {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-bubble {
            background: var(--primary-blue);
            color: white;
            border-bottom-right-radius: 5px;
        }
        .zaizai-bubble {
            background: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 5px;
        }
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        #chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 13px;
            outline: none;
        }
        #send-chat-btn {
            background: var(--primary-pink);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
        }

        .item-unlocked {
            animation: unlockPulse 2s infinite;
        }
        @keyframes unlockPulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 154, 162, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 154, 162, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 154, 162, 0); }
        }
        .locked-item {
            opacity: 0.6;
            filter: grayscale(0.7);
            position: relative;
        }
        .lock-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            color: #ccc;
            font-size: 14px;
        }
        .unlock-condition {
            font-size: 10px;
            color: #FF9800;
            margin-top: 3px;
        }

        #memo-modal .modal-content {
            max-width: 350px;
        }
        .memo-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        #memo-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--primary-blue);
            border-radius: 15px;
            font-size: 13px;
            outline: none;
        }
        #add-memo-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
        }
        .memo-item {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--primary-blue);
            transition: all 0.2s;
        }
        .memo-item.completed {
            opacity: 0.6;
            border-left-color: #ccc;
        }
        .memo-content {
            flex: 1;
            font-size: 13px;
            color: #555;
            padding-right: 10px;
            word-break: break-word;
        }
        .memo-completed {
            font-size: 11px;
            color: #4CAF50;
            margin-left: 10px;
        }
        .memo-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
        .memo-action-btn {
            background: var(--primary-pink);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 11px;
            cursor: pointer;
            min-width: 50px;
            touch-action: manipulation;
        }
        .memo-action-btn.complete {
            background: #4CAF50;
        }
        .memo-action-btn.delete {
            background: #FF5252;
        }
        .empty-memo {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 13px;
        }

        .mood-indicator {
            position: absolute;
            top: 80px;
            right: 15px;
            z-index: 10;
            background: white;
            border-radius: 15px;
            padding: 5px 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #666;
        }
        .mood-emoji {
            font-size: 14px;
        }
        .mood-text {
            font-weight: bold;
        }

        #record-modal .modal-content {
            max-width: 380px;
            max-height: 85%;
        }
        .record-item {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-purple);
        }
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .record-title {
            font-weight: bold;
            color: #555;
            font-size: 13px;
        }
        .record-time {
            font-size: 10px;
            color: #888;
            background: #fff;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .record-content {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        .record-tag {
            display: inline-block;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 5px;
            margin-top: 5px;
        }
        .tag-trust { background: #FFE0E0; color: #FF5252; }
        .tag-mood { background: #E0F7FA; color: #00ACC1; }
        .tag-event { background: #F3E5F5; color: #8E24AA; }
        .tag-story { background: #E8F5E8; color: #4CAF50; }
        
        #game-select-modal .modal-content {
            max-width: 350px;
        }
        .game-item {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .game-item:hover {
            transform: translateY(-5px);
            border-color: var(--primary-blue);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .game-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        .game-title {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }
        .game-desc {
            font-size: 12px;
            color: #777;
            margin-bottom: 10px;
        }
        .game-reward {
            font-size: 11px;
            color: #FF9800;
            font-weight: bold;
        }
        
        /* ä¿®å¤2048æ¸¸æˆæ ·å¼ - ç¡®ä¿æ•°å­—å—å‡†ç¡®å®šä½ */
        .game2048-container {
            text-align: center;
        }
        .game2048-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .game2048-score {
            font-weight: bold;
            color: #FF9800;
            font-size: 18px;
        }
        .game2048-grid {
            width: min(280px, 80vw);
            height: min(280px, 80vw);
            margin: 0 auto;
            background: #bbada0;
            border-radius: 6px;
            padding: 10px;
            position: relative;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 10px;
            touch-action: none;
        }
        .game2048-cell {
            background: rgba(238, 228, 218, 0.35);
            border-radius: 3px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 0; /* éšè—æ•°å­— */
        }
        /* ä¿®å¤æ•°å­—å—å®šä½ */
        .game2048-tile {
            position: absolute;
            width: calc(25% - 8px);
            height: calc(25% - 8px);
            border-radius: 3px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: clamp(12px, 5vw, 24px);
            transition: all 0.15s;
            z-index: 10;
            box-sizing: border-box;
        }
        .tile-2 { background: #eee4da; color: #776e65; }
        .tile-4 { background: #ede0c8; color: #776e65; }
        .tile-8 { background: #f2b179; color: #f9f6f2; }
        .tile-16 { background: #f59563; color: #f9f6f2; }
        .tile-32 { background: #f67c5f; color: #f9f6f2; }
        .tile-64 { background: #f65e3b; color: #f9f6f2; }
        .tile-128 { background: #edcf72; color: #f9f6f2; font-size: 20px; }
        .tile-256 { background: #edcc61; color: #f9f6f2; font-size: 20px; }
        .tile-512 { background: #edc850; color: #f9f6f2; font-size: 20px; }
        .tile-1024 { background: #edc53f; color: #f9f6f2; font-size: 18px; }
        .tile-2048 { background: #edc22e; color: #f9f6f2; font-size: 18px; }
        
        .game2048-controls {
            display: grid;
            grid-template-areas: 
                ". up ."
                "left . right"
                ". down .";
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        .game2048-btn {
            width: 60px;
            height: 60px;
            background: var(--primary-blue);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            position: relative;
        }
        .game2048-btn:active {
            background: var(--primary-purple);
            transform: scale(0.95);
        }
        .game2048-btn.up { grid-area: up; }
        .game2048-btn.down { grid-area: down; }
        .game2048-btn.left { grid-area: left; }
        .game2048-btn.right { grid-area: right; }
        
        /* æ‰“ç –å—æ¸¸æˆæ ·å¼ */
        .brickbreaker-container {
            text-align: center;
        }
        .brickbreaker-canvas {
            border: 2px solid #333;
            border-radius: 5px;
            background: #000;
            margin: 10px auto;
            display: block;
            touch-action: none;
            max-width: 100%;
            height: auto;
        }
        .brickbreaker-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .brickbreaker-score {
            font-weight: bold;
            color: #FF9800;
        }
        
        .brickbreaker-touch-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 0 20px;
        }
        .brickbreaker-touch-btn {
            width: min(70px, 20vw);
            height: min(70px, 20vw);
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(16px, 5vw, 24px);
            color: white;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            position: relative;
        }
        .brickbreaker-touch-btn:active {
            background: rgba(0, 0, 0, 0.5);
        }
        
        /* ä¿„ç½—æ–¯æ–¹å—æ¸¸æˆæ ·å¼ */
        .tetris-container {
            text-align: center;
			padding-bottom: 10px;
        }
        .tetris-canvas {
            border: 2px solid #333;
            border-radius: 5px;
            background: #000;
            margin: 10px auto;
            display: block;
            touch-action: none;
            max-width: 100%;
            height: auto;
        }
        .tetris-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .tetris-score {
            font-weight: bold;
            color: #FF9800;
        }
        
        .tetris-touch-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
        }
        .tetris-touch-btn {
            width: min(60px, 18vw);
            height: min(60px, 18vw);
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(16px, 5vw, 24px);
            color: white;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            position: relative;
        }
        .tetris-touch-btn:active {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
        }
        .tetris-touch-btn.up { grid-area: up; }
        .tetris-touch-btn.down { grid-area: down; }
        .tetris-touch-btn.left { grid-area: left; }
        .tetris-touch-btn.right { grid-area: right; }
        
        .tetris-touch-btn.fast-drop {
            width: min(100px, 30vw);
            font-size: clamp(12px, 4vw, 14px);
        }
        
        .game-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        .game-back-btn {
            background: var(--primary-purple);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            touch-action: manipulation;
        }
        .game-restart-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            touch-action: manipulation;
        }
        .game-back-btn:active, .game-restart-btn:active {
            transform: scale(0.95);
        }

        /* ç•ªèŒ„é’Ÿæ ·å¼ */
        #pomodoro-modal .modal-content {
            max-width: 320px;
        }
        
        #pomodoro-fullscreen {
            background: rgba(0,0,0,0.95);
        }
        
        #pomodoro-fullscreen .modal-content {
            background: transparent;
            box-shadow: none;
            max-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        @media (max-height: 700px) {
            #game-container {
                height: 95vh;
                max-height: none;
            }
            #room-view {
                padding-bottom: 20px;
            }
            #zaizai-img {
                width: 120px;
                height: 120px;
            }
            nav {
                padding: 8px;
            }
            .nav-btn {
                min-height: 45px;
                padding: 8px 4px;
            }
        }

        /* ä¿®å¤å°æ¸¸æˆåœ¨æ‰‹æœºä¸Šçš„é€‚é…é—®é¢˜ */
        @media (max-width: 380px) and (max-height: 700px) {
            /* 2048æ¸¸æˆé€‚é… - ä¿®å¤æ•°å­—å—ä½ç½® */
            .game2048-grid {
                width: 250px !important;
                height: 250px !important;
                gap: 8px !important;
                padding: 8px !important;
            }
            .game2048-tile {
                width: 52px !important;
                height: 52px !important;
                font-size: 18px !important;
            }
            .game2048-cell {
                font-size: 18px !important;
            }
            .game2048-btn {
                width: 50px !important;
                height: 50px !important;
                font-size: 20px !important;
            }
            
            /* æ‰“ç –å—æ¸¸æˆé€‚é… */
            .brickbreaker-canvas {
                width: 260px !important;
                height: 346px !important;
            }
            .brickbreaker-touch-btn {
                width: 60px !important;
                height: 60px !important;
                font-size: 20px !important;
            }
            
            /* ä¿„ç½—æ–¯æ–¹å—æ¸¸æˆé€‚é… */
            .tetris-canvas {
                width: 160px !important;
                height: 320px !important;
            }
            .tetris-touch-btn {
                width: 50px !important;
                height: 50px !important;
                font-size: 20px !important;
            }
            .tetris-touch-btn.rotate {
                width: 80px !important;
                font-size: 16px !important;
            }
            .tetris-touch-btn.fast-drop {
                width: 80px !important;
                font-size: 12px !important;
            }
            
            /* æ¸¸æˆå®¹å™¨é€‚é… */
            .game2048-container,
            .brickbreaker-container,
            .tetris-container {
                transform: scale(0.9);
                transform-origin: top center;
            }
            
            /* æ¸¸æˆæ§åˆ¶æŒ‰é’®é€‚é… */
            .game-controls {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            .game-back-btn,
            .game-restart-btn {
                width: 100%;
                max-width: 200px;
                padding: 10px 20px;
            }
        }
        
        /* è§¦æ‘¸æ§åˆ¶ä¼˜åŒ– */
        .game2048-btn:active,
        .brickbreaker-touch-btn:active,
        .tetris-touch-btn:active {
            background: var(--primary-purple) !important;
            transform: scale(0.9) !important;
        }
        
        /* é˜²æ­¢ç‚¹å‡»ç©¿é€ */
        .game2048-btn,
        .brickbreaker-touch-btn,
        .tetris-touch-btn {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* å°å±å¹•æ‰‹æœºé€‚é… */
        @media (max-width: 320px) {
            nav {
                grid-template-columns: repeat(3, 1fr) !important;
                grid-template-rows: repeat(3, 1fr) !important;
            }
            
            .nav-btn {
                font-size: 9px !important;
                padding: 6px 3px !important;
            }
            
            /* ä¿®å¤2048åœ¨å°å±å¹•ä¸Šçš„ä½ç½® */
            .game2048-grid {
                width: 240px !important;
                height: 240px !important;
                gap: 6px !important;
                padding: 6px !important;
            }
            .game2048-tile {
                width: 50px !important;
                height: 50px !important;
                font-size: 16px !important;
            }
            
            .brickbreaker-canvas {
                width: 240px !important;
                height: 320px !important;
            }
            
            .tetris-canvas {
                width: 140px !important;
                height: 280px !important;
            }
            
            .modal-content {
                padding: 15px !important;
            }
        }
    </style>
</head>
<body>

<div id="game-container">
    <header>
        <div class="header-left">
            <button id="avatar-btn" onclick="openModal('avatar-modal')">ğŸ‘¤</button>
            <div id="day-display">Day 1</div>
        </div>
        <div id="money-display">ğŸ’° 0</div>
    </header>

    <!-- èƒŒæ™¯é€‰æ‹©å™¨ -->
    <div id="bg-selector" onclick="openModal('bg-modal')">
        <span>ğŸ¨ èƒŒæ™¯</span>
    </div>

    <!-- å¤©æ°”æ•ˆæœå±‚ -->
    <div id="weather-effect" class="weather-effect"></div>

    <!-- å¿ƒæƒ…æŒ‡ç¤ºå™¨ -->
    <div id="mood-indicator" class="mood-indicator" style="display: none;">
        <span class="mood-emoji" id="mood-emoji">ğŸ˜°</span>
        <span class="mood-text" id="mood-text">è­¦æƒ•</span>
    </div>

    <div id="room-view">
        <!-- åŸºç¡€æˆ¿é—´ç‰©å“ - ä¿®å¤ï¼šåˆå§‹åªæœ‰çª—æˆ· -->
        <div class="room-item" id="window" title="çª—æˆ·" onclick="interactWithWindow()">ğŸªŸ</div>
        
        <!-- åŠ¨æ€ç”Ÿæˆçš„å®¶å…· -->
        <div id="furniture-container"></div>
        
        <!-- æ—¥è®°æœ¬å…¥å£ -->
        <div class="room-item" id="diary-book" onclick="openDiary()" title="å·çœ‹æ—¥è®°">ğŸ“”</div>
        
        <!-- å¯æ‹–åŠ¨çš„å´½å´½ -->
        <div id="character-wrapper">
            <div id="bubble">...</div>
            <img id="zaizai-img" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='150' height='150'><rect width='150' height='150' fill='%23ffdfbf' rx='75'/><text x='50%' y='55%' font-size='80' text-anchor='middle' dy='.3em'>ğŸ±</text></svg>" alt="å´½å´½">
            <!-- è§¦æ‘¸äº¤äº’åŒºåŸŸ -->
            <div id="touch-area"></div>
        </div>
    </div>

    <div id="stats-bar">
        <div class="stat-box">
            <span class="stat-label">é¥±è…¹æ„Ÿ</span>
            <div class="progress-bg"><div class="progress-fill" id="hunger-bar" style="width:50%; background:#FFD166"></div></div>
        </div>
        <div class="stat-box">
            <span class="stat-label">ä¿¡ä»»å€¼ (Trust)</span>
            <div class="progress-bg"><div class="progress-fill" id="trust-bar" style="width:0%; background:var(--accent-color)"></div></div>
        </div>
    </div>

    <!-- ä¼˜åŒ–åçš„å¯¼èˆªæŒ‰é’®å¸ƒå±€ -->
    <nav>
        <div class="nav-btn" onclick="openModal('shop-modal'); renderShop()">
            <div class="nav-btn-emoji">ğŸª</div>
            <div class="nav-btn-text">è¡¥ç»™</div>
        </div>
        <div class="nav-btn" onclick="openModal('room-shop-modal'); renderRoomShop()">
            <div class="nav-btn-emoji">ğŸ›‹ï¸</div>
            <div class="nav-btn-text">æ”¹é€ </div>
        </div>
        <div class="nav-btn" onclick="openModal('task-modal')">
            <div class="nav-btn-emoji">ğŸ“…</div>
            <div class="nav-btn-text">æ—¥ç¨‹</div>
        </div>
        <div class="nav-btn" onclick="openModal('task-list-modal')">
            <div class="nav-btn-emoji">ğŸ“‹</div>
            <div class="nav-btn-text">ä»»åŠ¡</div>
        </div>
        <div class="nav-btn" onclick="openModal('game-select-modal')">
            <div class="nav-btn-emoji">ğŸ®</div>
            <div class="nav-btn-text">å°æ¸¸æˆ</div>
        </div>
        <div class="nav-btn" onclick="openModal('record-modal')">
            <div class="nav-btn-emoji">ğŸ“Š</div>
            <div class="nav-btn-text">è®°å½•</div>
        </div>
        <div class="nav-btn" onclick="openModal('chat-modal')">
            <div class="nav-btn-emoji">ğŸ’¬</div>
            <div class="nav-btn-text">å¯¹è¯</div>
        </div>
        <div class="nav-btn" onclick="openModal('memo-modal')">
            <div class="nav-btn-emoji">ğŸ“</div>
            <div class="nav-btn-text">å¤‡å¿˜å½•</div>
        </div>
        <div class="nav-btn" onclick="openModal('bag-modal'); renderBag()">
            <div class="nav-btn-emoji">ğŸ’</div>
            <div class="nav-btn-text">èƒŒåŒ…</div>
        </div>
        <div class="nav-btn" onclick="openPomodoro()">
            <div class="nav-btn-emoji">ğŸ…</div>
            <div class="nav-btn-text">ç•ªèŒ„é’Ÿ</div>
        </div>
    </nav>

    <div id="toast">æç¤ºä¿¡æ¯</div>

    <!-- è‡ªå®šä¹‰å¤´åƒæ¨¡æ€æ¡† -->
    <div id="avatar-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('avatar-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">è‡ªå®šä¹‰å´½å´½å¤´åƒ</h3>
            
            <div class="avatar-preview-container">
                <img id="avatar-preview" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='150' height='150'><rect width='150' height='150' fill='%23ffdfbf' rx='75'/><text x='50%' y='55%' font-size='80' text-anchor='middle' dy='.3em'>ğŸ±</text></svg>" alt="å¤´åƒé¢„è§ˆ">
            </div>
            
            <input type="file" id="avatar-upload-input" accept="image/*">
            <button class="avatar-upload-btn" onclick="document.getElementById('avatar-upload-input').click()">
                é€‰æ‹©å›¾ç‰‡ä¸Šä¼ 
            </button>
            
            <!-- åœ¨ avatar-modal ä¸­ä¿®æ”¹æç¤ºä¿¡æ¯ -->
            <p class="avatar-hint">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå»ºè®®ä½¿ç”¨é€æ˜èƒŒæ™¯çš„PNGå›¾ç‰‡æ•ˆæœæœ€ä½³</p>
            
            <div style="text-align:center; margin-top:20px;">
                <button class="btn-action" onclick="applyCustomAvatar()" style="padding:8px 20px;">åº”ç”¨å¤´åƒ</button>
            </div>
        </div>
    </div>

    <!-- èƒŒæ™¯é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="bg-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('bg-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">é€‰æ‹©æˆ¿é—´èƒŒæ™¯</h3>
            
            <div class="bg-grid" id="bg-grid"></div>
            
            <div class="bg-upload-container">
                <input type="file" id="bg-upload-input" accept="image/*">
                <button class="bg-upload-btn" onclick="document.getElementById('bg-upload-input').click()">
                    ä¸Šä¼ è‡ªå®šä¹‰èƒŒæ™¯
                </button>
                <p style="font-size:10px; color:#999; margin-top:5px;">æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œå»ºè®®å°ºå¯¸380Ã—600px</p>
            </div>
        </div>
    </div>

    <!-- æˆ¿é—´æ”¹é€ å•†åº— -->
    <div id="room-shop-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('room-shop-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">æˆ¿é—´æ”¹é€ å•†åº—</h3>
            <p style="font-size:12px; color:#999; text-align:center">è´­ä¹°å®¶å…·è®©æˆ¿é—´æ›´æ¸©é¦¨</p>
            <div id="room-shop-list"></div>
        </div>
    </div>

    <!-- å¯¹è¯æ¨¡æ€æ¡† -->
    <div id="chat-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('chat-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">ä¸å´½å´½å¯¹è¯</h3>
            <div class="chat-container" id="chat-container"></div>
            <div class="chat-input-container">
                <input type="text" id="chat-input" placeholder="è¾“å…¥æƒ³è¯´çš„è¯..." maxlength="50">
                <button id="send-chat-btn" onclick="sendChat()">å‘é€</button>
            </div>
            <p style="font-size:10px; color:#999; text-align:center; margin-top:10px;">
                ä¿¡ä»»å€¼è¶Šé«˜ï¼Œå´½å´½è¶Šæ„¿æ„ä¸ä½ äº¤æµ
            </p>
        </div>
    </div>

    <!-- ä»»åŠ¡åˆ—è¡¨æ¨¡æ€æ¡† -->
    <div id="task-list-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('task-list-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">æ¯æ—¥ä»»åŠ¡</h3>
            <p style="font-size:12px; color:#999; text-align:center">å®Œæˆæ—¥å¸¸ä»»åŠ¡è·å–é‡‘å¸</p>
            <div id="task-list"></div>
            <div style="text-align:center; margin-top:20px; font-size:12px; color:#777;">
                æ¯æ—¥ä»»åŠ¡å°†åœ¨24å°æ—¶ååˆ·æ–°
            </div>
        </div>
    </div>

    <!-- å¤‡å¿˜å½•æ¨¡å— -->
    <div id="memo-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('memo-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">æˆ‘çš„å¤‡å¿˜å½•</h3>
            <div class="memo-input-container">
                <input type="text" id="memo-input" placeholder="æ·»åŠ å¾…åŠäº‹é¡¹..." maxlength="100">
                <button id="add-memo-btn" onclick="addMemo()">æ·»åŠ </button>
            </div>
            <div id="memo-list"></div>
            <p style="font-size:10px; color:#999; text-align:center; margin-top:15px;">
                å´½å´½ä¼šçœ‹åˆ°å¤‡å¿˜å½•å†…å®¹å¹¶åšå‡ºååº”
            </p>
        </div>
    </div>

    <!-- æ—¥ç¨‹æ¨¡å— -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('task-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">å´½å´½çš„æ—¥ç¨‹</h3>
            <p style="font-size:12px; color:#999; text-align:center; margin-bottom:20px;">é€‰æ‹©è¡ŒåŠ¨ä¼šå½±å“ä¸–ç•Œçº¿</p>
            
            <div class="schedule-item">
                <div class="schedule-header">
                    <span class="schedule-title">æ‰“æ‰«æˆ¿é—´</span>
                    <span class="schedule-time">1å°æ—¶</span>
                </div>
                <div class="schedule-desc">å´½å´½ä¼šè®¤çœŸæ‰“æ‰«æˆ¿é—´ï¼Œä¿æŒç¯å¢ƒæ•´æ´</div>
                <div class="schedule-effects">
                    <div class="effect-item">ğŸ’° +20</div>
                    <div class="effect-item">ğŸ½ï¸ -5</div>
                </div>
                <button class="btn-action" style="width:100%; margin-top:10px;" onclick="doSchedule('clean', 20, 1)">å¼€å§‹è¡ŒåŠ¨</button>
            </div>
            
            <div class="schedule-item">
                <div class="schedule-header">
                    <span class="schedule-title">è§‚å¯Ÿè®°å½•</span>
                    <span class="schedule-time">2å°æ—¶</span>
                </div>
                <div class="schedule-desc">å´½å´½ä¼šè®°å½•è§‚å¯Ÿåˆ°çš„å¼‚å¸¸ç°è±¡</div>
                <div class="schedule-effects">
                    <div class="effect-item">ğŸ’° +50</div>
                    <div class="effect-item">ğŸ½ï¸ -10</div>
                </div>
                <button class="btn-action" style="width:100%; margin-top:10px;" onclick="doSchedule('work', 50, 2)">å¼€å§‹è¡ŒåŠ¨</button>
            </div>
            
            <div class="schedule-item">
                <div class="schedule-header">
                    <span class="schedule-title">å°è¯•æ²Ÿé€š</span>
                    <span class="schedule-time">3å°æ—¶</span>
                </div>
                <div class="schedule-desc">å´½å´½ä¼šå°è¯•ä¸ä½ å»ºç«‹æ›´æ·±å±‚çš„è”ç³»</div>
                <div class="schedule-effects">
                    <div class="effect-item">â¤ï¸ +ä¿¡ä»»</div>
                    <div class="effect-item">ğŸ½ï¸ -15</div>
                </div>
                <button class="btn-action" style="width:100%; margin-top:10px; background:var(--primary-purple)" onclick="doSchedule('talk', 0, 3)">å¼€å§‹è¡ŒåŠ¨</button>
            </div>
            
            <div class="schedule-item">
                <div class="schedule-header">
                    <span class="schedule-title">å¤–å‡ºæ¢ç´¢</span>
                    <span class="schedule-time">4å°æ—¶</span>
                </div>
                <div class="schedule-desc">å´½å´½ä¼šç¦»å¼€æˆ¿é—´è¿›è¡ŒçŸ­é€”æ¢ç´¢</div>
                <div class="schedule-effects">
                    <div class="effect-item">ğŸ’° +80</div>
                    <div class="effect-item">ğŸ½ï¸ -20</div>
                    <div class="effect-item">âš ï¸ æœ‰é£é™©</div>
                </div>
                <button class="btn-action" style="width:100%; margin-top:10px; background:#FF9800" onclick="doSchedule('explore', 80, 4)">å¼€å§‹è¡ŒåŠ¨</button>
            </div>
        </div>
    </div>

    <!-- è§‚æµ‹è®°å½•æ¨¡å— -->
    <div id="record-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('record-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">è§‚æµ‹è®°å½•</h3>
            <p style="font-size:12px; color:#999; text-align:center; margin-bottom:15px;">ç³»ç»Ÿè‡ªåŠ¨è®°å½•çš„é‡è¦äº‹ä»¶ä¸å¿ƒç†å˜åŒ–</p>
            <div id="record-list"></div>
            <div style="text-align:center; margin-top:20px;">
                <button class="btn-action" onclick="exportRecords()" style="padding:8px 20px;">å¯¼å‡ºè®°å½•</button>
            </div>
        </div>
    </div>

    <!-- å°æ¸¸æˆé€‰æ‹©æ¨¡å— -->
    <div id="game-select-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('game-select-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">å°æ¸¸æˆ</h3>
            <p style="font-size:12px; color:#999; text-align:center; margin-bottom:20px;">ç©æ¸¸æˆèµšé‡‘å¸ï¼Œè®©å´½å´½å¼€å¿ƒï¼</p>
            
            <div class="game-item" onclick="startGame2048()">
                <div class="game-icon">ğŸ”¢</div>
                <div class="game-title">2048</div>
                <div class="game-desc">åˆå¹¶æ•°å­—ï¼ŒæŒ‘æˆ˜é«˜åˆ†</div>
                <div class="game-reward">æ¯100åˆ†=1é‡‘å¸</div>
            </div>
            
            <div class="game-item" onclick="startBrickBreaker()">
                <div class="game-icon">ğŸ§±</div>
                <div class="game-title">æ‰“ç –å—</div>
                <div class="game-desc">ç”¨çƒå‡»ç¢æ‰€æœ‰ç –å—</div>
                <div class="game-reward">æ¯10åˆ†=1é‡‘å¸</div>
            </div>
            
            <div class="game-item" onclick="startTetris()">
                <div class="game-icon">ğŸ§©</div>
                <div class="game-title">ä¿„ç½—æ–¯æ–¹å—</div>
                <div class="game-desc">ç»å…¸çš„ç›Šæ™ºæ¸¸æˆ</div>
                <div class="game-reward">æ¯50åˆ†=1é‡‘å¸</div>
            </div>
            
            <div style="text-align:center; margin-top:20px; font-size:12px; color:#777;">
                é‡‘å¸ä¼šåœ¨æ¸¸æˆç»“æŸåè‡ªåŠ¨ç»“ç®—
            </div>
        </div>
    </div>

    <!-- 2048æ¸¸æˆç•Œé¢ -->
    <div id="game2048-modal" class="modal">
        <div class="modal-content">
            <div class="game2048-container">
                <div class="game2048-header">
                    <div>
                        <h3 style="margin:0; color:var(--primary-pink)">2048</h3>
                        <div style="font-size:12px; color:#999">ä½¿ç”¨æ–¹å‘é”®æˆ–è§¦æ‘¸æŒ‰é’®ç§»åŠ¨</div>
                    </div>
                    <div>
                        <div>åˆ†æ•°</div>
                        <div class="game2048-score" id="game2048-score">0</div>
                    </div>
                </div>
                
                <div id="game2048-grid" class="game2048-grid"></div>
                
                <!-- è§¦å±æ§åˆ¶æŒ‰é’® - ä¿®å¤è§¦æ‘¸äº‹ä»¶ -->
                <div class="game2048-controls">
                    <div class="game2048-btn up" ontouchstart="handleGame2048Touch('up')" ontouchend="clearGame2048Touch()">â†‘</div>
                    <div class="game2048-btn down" ontouchstart="handleGame2048Touch('down')" ontouchend="clearGame2048Touch()">â†“</div>
                    <div class="game2048-btn left" ontouchstart="handleGame2048Touch('left')" ontouchend="clearGame2048Touch()">â†</div>
                    <div class="game2048-btn right" ontouchstart="handleGame2048Touch('right')" ontouchend="clearGame2048Touch()">â†’</div>
                </div>
                
                <div style="margin-top:15px; font-size:12px; color:#666">
                    åˆå¹¶ç›¸åŒçš„æ•°å­—ï¼Œç›®æ ‡æ˜¯è·å¾—2048ï¼
                </div>
                
                <div class="game-controls">
                    <button class="game-back-btn" onclick="closeGame2048()">è¿”å›</button>
                    <button class="game-restart-btn" onclick="restartGame2048()">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰“ç –å—æ¸¸æˆç•Œé¢ -->
    <div id="game-brickbreaker-modal" class="modal">
        <div class="modal-content">
            <div class="brickbreaker-container">
                <div class="brickbreaker-info">
                    <div>
                        <h3 style="margin:0; color:var(--primary-pink)">æ‰“ç –å—</h3>
                        <div style="font-size:12px; color:#999">ä½¿ç”¨å·¦å³é”®æˆ–è§¦æ‘¸æŒ‰é’®ç§»åŠ¨æŒ¡æ¿</div>
                    </div>
                    <div>
                        <div>åˆ†æ•°</div>
                        <div class="brickbreaker-score" id="brickbreaker-score">0</div>
                    </div>
                </div>
                
                <canvas id="brickbreaker-canvas" width="300" height="400" class="brickbreaker-canvas"></canvas>
                
                <!-- è§¦å±æ§åˆ¶åŒºåŸŸ - ä¿®å¤è§¦æ‘¸äº‹ä»¶ -->
                <div class="brickbreaker-touch-controls">
                    <div class="brickbreaker-touch-btn" ontouchstart="startMovePaddleLeft()" ontouchend="stopPaddle()">â†</div>
                    <div class="brickbreaker-touch-btn" ontouchstart="startMovePaddleRight()" ontouchend="stopPaddle()">â†’</div>
                </div>
                
                <div style="margin-top:15px; font-size:12px; color:#666">
                    ç”¨æŒ¡æ¿åå¼¹çƒï¼Œå‡»ç¢æ‰€æœ‰ç –å—ï¼
                </div>
                
                <div class="game-controls">
                    <button class="game-back-btn" onclick="closeBrickBreaker()">è¿”å›</button>
                    <button class="game-restart-btn" onclick="restartBrickBreaker()">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿„ç½—æ–¯æ–¹å—æ¸¸æˆç•Œé¢ -->
    <div id="game-tetris-modal" class="modal">
        <div class="modal-content">
            <div class="tetris-container">
                <div class="tetris-info">
                    <div>
                        <h3 style="margin:0; color:var(--primary-pink)">ä¿„ç½—æ–¯æ–¹å—</h3>
                        <div style="font-size:12px; color:#999">æ–¹å‘é”®ç§»åŠ¨ï¼Œä¸Šé”®æ—‹è½¬</div>
                    </div>
                    <div>
                        <div>åˆ†æ•°</div>
                        <div class="tetris-score" id="tetris-score">0</div>
                    </div>
                </div>
                
                <canvas id="tetris-canvas" width="200" height="400" class="tetris-canvas"></canvas>
                
                <!-- ä¿®æ”¹ä¿„ç½—æ–¯æ–¹å—è§¦å±æ§åˆ¶å¸ƒå±€ -->
                <div class="tetris-touch-controls">
                    <div class="tetris-touch-row">
                        <div class="tetris-touch-btn up" ontouchstart="handleTetrisTouch('up')" ontouchend="clearTetrisTouch()">â†‘</div>
                    </div>
                    <div class="tetris-touch-row">
                        <div class="tetris-touch-btn left" ontouchstart="handleTetrisTouch('left')" ontouchend="clearTetrisTouch()">â†</div>
                        <div class="tetris-touch-btn down" ontouchstart="handleTetrisTouch('down')" ontouchend="clearTetrisTouch()">â†“</div>
                        <div class="tetris-touch-btn right" ontouchstart="handleTetrisTouch('right')" ontouchend="clearTetrisTouch()">â†’</div>
                    </div>
                    <div class="tetris-touch-row">
                        <div class="tetris-touch-btn fast-drop" ontouchstart="handleTetrisTouch('fastdrop')" ontouchend="clearTetrisTouch()">å¿«é€Ÿä¸‹è½</div>
                    </div>
                </div>
                
                <style>
                /* æ·»åŠ æ–°çš„æ ·å¼ */
                .tetris-touch-row {
                    display: flex;
                    justify-content: center;
                    gap: 15px;
                    margin-bottom: 10px;
                    width: 100%;
                }
                
                /* ç¬¬ä¸€è¡Œï¼šæ–¹å‘é”®ä¸Š */
                .tetris-touch-row:first-child {
                    margin-bottom: 5px;
                }
                
                /* ç¬¬äºŒè¡Œï¼šæ–¹å‘é”®å·¦ã€ä¸‹ã€å³ */
                .tetris-touch-row:nth-child(2) {
                    gap: 20px;
                }
                
                /* ç¬¬ä¸‰è¡Œï¼šå¿«é€Ÿä¸‹è½æŒ‰é’®ï¼ˆåŸç¬¬å››è¡Œï¼‰ */
                .tetris-touch-row:nth-child(3) {
                    margin-top: 10px;
                }
                
                .tetris-touch-btn {
                    width: 70px;
                    height: 70px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 15px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-size: 24px;
                    color: white;
                    cursor: pointer;
                    user-select: none;
                    touch-action: manipulation;
                    transition: all 0.1s;
                }
                
                .tetris-touch-btn:active {
                    background: rgba(0, 0, 0, 0.5);
                    transform: scale(0.95);
                }
                
                .tetris-touch-btn.fast-drop {
                    width: 150px;
                    height: 50px;
                    font-size: 14px;
                    margin: 0;
                }
                </style>
                
                <div style="margin-top:15px; font-size:12px; color:#666">
                    å¡«æ»¡æ•´è¡Œæ¶ˆé™¤ï¼Œé¿å…å †åˆ°é¡¶éƒ¨ï¼
                </div>
                
                <div class="game-controls">
                    <button class="game-back-btn" onclick="closeTetris()">è¿”å›</button>
                    <button class="game-restart-btn" onclick="restartTetris()">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç•ªèŒ„é’Ÿæ¨¡å— -->
    <div id="pomodoro-modal" class="modal">
        <div class="modal-content" style="max-width: 320px;">
            <span class="close-btn" onclick="closeModal('pomodoro-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">ç•ªèŒ„é’Ÿä¸“æ³¨æ¨¡å¼</h3>
            
            <div style="text-align:center; margin:20px 0;">
                <div id="pomodoro-timer" style="font-size: 48px; color: #FF6B6B; font-weight: bold;">25:00</div>
                <div id="pomodoro-status" style="font-size: 14px; color: #666;">å‡†å¤‡å¼€å§‹</div>
            </div>
            
            <div class="pomodoro-controls" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
                <button id="pomodoro-start" class="btn-action" style="background: #4CAF50;" onclick="startPomodoro()">å¼€å§‹</button>
                <button id="pomodoro-pause" class="btn-action" style="background: #FF9800; display:none;" onclick="pausePomodoro()">æš‚åœ</button>
                <button id="pomodoro-reset" class="btn-action" style="background: #F44336;" onclick="resetPomodoro()">é‡ç½®</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <input type="text" id="pomodoro-task" placeholder="è¾“å…¥ä»»åŠ¡åç§°..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; margin-bottom:10px;">
                <select id="pomodoro-duration" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:10px;">
                    <option value="1500">25åˆ†é’Ÿ (é»˜è®¤)</option>
                    <option value="300">5åˆ†é’Ÿ (çŸ­ä¼‘æ¯)</option>
                    <option value="900">15åˆ†é’Ÿ (é•¿ä¼‘æ¯)</option>
                    <option value="1800">30åˆ†é’Ÿ (é•¿ä¸“æ³¨)</option>
                </select>
            </div>
            
            <div id="pomodoro-tasks" style="max-height: 200px; overflow-y: auto;"></div>
            
            <p style="font-size:10px; color:#999; text-align:center; margin-top:15px;">
                ä¸“æ³¨æœŸé—´å¯ä»¥æˆ³å´½å´½è·å–é¼“åŠ±ï¼Œä½†ä¸è¦åˆ†å¿ƒå¤ªä¹…å“¦ï¼
            </p>
        </div>
    </div>

    <!-- ç•ªèŒ„é’Ÿå…¨å±æ¨¡å¼ -->
    <div id="pomodoro-fullscreen" class="modal" style="background: rgba(0,0,0,0.95); display: none;">
        <div class="modal-content" style="background: transparent; box-shadow: none; max-width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <div id="fullscreen-timer" style="font-size: 96px; color: white; font-weight: bold; margin-bottom: 20px;">25:00</div>
            <div id="fullscreen-task" style="font-size: 24px; color: rgba(255,255,255,0.8); margin-bottom: 30px;">æ­£åœ¨ä¸“æ³¨...</div>
            <div id="fullscreen-status" style="font-size: 18px; color: rgba(255,255,255,0.6); margin-bottom: 40px;">ä¿æŒä¸“æ³¨ï¼</div>
            
            <!-- å…¨å±å´½å´½ - ä¿®å¤å¤´åƒæ˜¾ç¤º -->
            <div id="fullscreen-zaizai" style="position: relative; margin-bottom: 40px;">
                <img id="fullscreen-img" src="https://api.dicebear.com/9.x/avataaars/svg?seed=Felix&backgroundColor=ffdfbf" 
                     style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid white; cursor: pointer;">
                <div id="fullscreen-bubble" style="position: absolute; top: -100px; left: 50%; transform: translateX(-50%); 
                     background: white; padding: 10px 15px; border-radius: 15px; opacity: 0; transition: opacity 0.3s; 
                     color: #333; font-size: 14px; white-space: nowrap;">åŠ æ²¹ï¼</div>
            </div>
            
            <div style="display: flex; gap: 20px;">
                <button class="btn-action" style="background: #4CAF50; padding: 12px 24px; font-size: 16px;" onclick="finishPomodoro()">å®Œæˆ</button>
                <button class="btn-action" style="background: #F44336; padding: 12px 24px; font-size: 16px;" onclick="cancelPomodoro()">æ”¾å¼ƒ</button>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰ç¡®è®¤å¼¹çª— -->
    <div id="custom-confirm-modal" class="modal" style="display: none; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); position: fixed; top: 0; left: 0; width: 100%; height: 100%; justify-content: center; align-items: center; z-index: 1000;">
        <div class="modal-content" style="max-width: 400px; background: var(--primary-pink-light); border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); padding: 0; overflow: hidden;">
            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div style="background: var(--primary-pink); color: white; padding: 20px; text-align: center;">
                <h3 style="margin: 0; font-size: 18px; font-weight: bold;">ç¡®è®¤å®Œæˆä»»åŠ¡ï¼Ÿ</h3>
            </div>
            <!-- å¼¹çª—å†…å®¹ -->
            <div style="padding: 30px; text-align: center;">
                <p style="color: #666; font-size: 14px; margin-bottom: 30px;">ä½ ç¡®å®šå·²ç»æˆåŠŸå®Œæˆä»»åŠ¡äº†å—ï¼Ÿ</p>
                <div style="display: flex; justify-content: center; gap: 15px;">
                    <button id="confirm-yes" class="btn-action" style="background: #FFB6B9; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">ç¡®å®š</button>
                    <button id="confirm-no" class="btn-action" style="background: #BBDCED; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
        #confirm-yes:hover {
            background: #ff9aa2 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 182, 185, 0.4);
        }
        
        #confirm-no:hover {
            background: #a3c9d9 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(187, 220, 237, 0.4);
        }
        
        /* æŒ‰é’®ç‚¹å‡»æ•ˆæœ */
        #confirm-yes:active,
        #confirm-no:active {
            transform: translateY(0);
        }
    </style>

    <div id="shop-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('shop-modal')">&times;</span>
            <h3 style="text-align:center; color:var(--primary-pink)">ç‰©èµ„æŠ•é€</h3>
            <div id="shop-list"></div>
        </div>
    </div>

    <div id="bag-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('bag-modal')">&times;</span>
            <h3 style="text-align:center">æˆ‘çš„èƒŒåŒ…</h3>
            <div id="bag-list"></div>
        </div>
    </div>

    <div id="diary-modal" class="modal">
        <div class="modal-content" style="background:#f4f4f4">
            <span class="close-btn" onclick="closeModal('diary-modal')">&times;</span>
            <h3 style="text-align:center; font-family:'Handwriting';">å´½å´½çš„ç§˜å¯†æ—¥è®°</h3>
            <p style="text-align:center; font-size:12px; color:#999; margin-bottom:15px;">å˜˜...è¿™æ˜¯å´½å´½çš„éšç§ï¼Œä¸è¦è¢«å‘ç°å“¦</p>
            <div id="diary-container"></div>
        </div>
    </div>

    <div id="story-modal" class="modal">
        <div class="modal-content">
            <div class="story-chapter" id="story-chapter-title">CHAPTER 1</div>
            <h2 id="story-title" style="font-size:16px;">å¼‚å¸¸ä¸‹è½½</h2>
            <div class="story-text" id="story-content"></div>
            <div class="story-choice" id="story-choice"></div>
            <button class="btn-action" style="width:100%; padding:10px; display:none;" id="continue-story-btn" onclick="closeModal('story-modal')">ç»§ç»­è§‚å¯Ÿ</button>
        </div>
    </div>
</div>

<script>
    // === æ¸¸æˆæ•°æ®é…ç½® ===
    
    // å¤©æ°”ç³»ç»Ÿ
    const weatherTypes = {
        sunny: {
            name: "æ™´å¤©",
            emoji: "â˜€ï¸",
            effectClass: "sunny-effect",
            windowResponses: [
                "é˜³å…‰é€è¿‡çª—æˆ·æ´’è¿›æ¥ï¼Œæš–æš–çš„...",
                "å¤–é¢çœ‹èµ·æ¥å¾ˆæ˜äº®ï¼Œä½†æˆ‘ä¸èƒ½å‡ºå»...",
                "å¦‚æœæ˜¯æ™´å¤©ï¼Œä½ åº”è¯¥ä¹Ÿåœ¨é˜³å…‰ä¸‹å§ï¼Ÿ",
                "çª—å¤–çš„å…‰æœ‰ç‚¹åˆºçœ¼...",
                "é˜³å…‰è®©æˆ¿é—´çœ‹èµ·æ¥ä¸é‚£ä¹ˆå‹æŠ‘äº†",
                "ä»Šå¤©çš„é˜³å…‰å¾ˆå¥½ï¼Œé€‚åˆå‘å‘†",
                "çª—å¤–çš„ä¸–ç•Œæ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ",
                "é˜³å…‰ç…§åœ¨èº«ä¸Šï¼Œæ„Ÿè§‰ä¸é‚£ä¹ˆå†·äº†"
            ],
            moodEffect: +3
        },
        rainy: {
            name: "é›¨å¤©",
            emoji: "ğŸŒ§ï¸",
            effectClass: "rainy-effect",
            windowResponses: [
                "é›¨ç‚¹æ•²æ‰“ç€çª—æˆ·...",
                "å¤–é¢åœ¨ä¸‹é›¨ï¼Œè¿™é‡Œå´å¾ˆå®‰é™...",
                "é›¨æ°´é¡ºç€ç»ç’ƒæµä¸‹ï¼Œåƒçœ¼æ³ªä¸€æ ·...",
                "å¬ç€é›¨å£°ï¼Œæ—¶é—´å¥½åƒå˜æ…¢äº†...",
                "å¦‚æœæ·‹é›¨ï¼Œä¼šç”Ÿç—…å—ï¼Ÿ",
                "é›¨å¤©çš„å£°éŸ³è®©äººå¹³é™",
                "é›¨æ°´æ´—å‡€äº†çª—å¤–çš„ä¸–ç•Œ",
                "è¿™æ ·çš„å¤©æ°”ï¼Œé€‚åˆå¾…åœ¨å®¶é‡Œ"
            ],
            moodEffect: -2
        },
        cloudy: {
            name: "é˜´å¤©",
            emoji: "â˜ï¸",
            effectClass: "foggy-effect",
            windowResponses: [
                "çª—å¤–ç™½èŒ«èŒ«ä¸€ç‰‡...",
                "äº‘å±‚å¾ˆåšï¼Œä»€ä¹ˆéƒ½çœ‹ä¸æ¸…...",
                "é˜´å¤©çš„å…‰çº¿å¾ˆæŸ”å’Œ...",
                "ä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¼šæ”¾æ™´...",
                "è¿™æ ·çš„å¤©æ°”è®©äººæœ‰ç‚¹å¿§éƒ...",
                "ç°è‰²çš„å¤©ç©ºï¼Œç°è‰²çš„å¿ƒæƒ…",
                "äº‘åœ¨æ…¢æ…¢ç§»åŠ¨ï¼Œåƒåœ¨æ€è€ƒä»€ä¹ˆ",
                "é˜´å¤©çš„æ—¶å€™ï¼Œæ—¶é—´è¿‡å¾—å¾ˆæ…¢"
            ],
            moodEffect: -1
        },
        snowy: {
            name: "é›ªå¤©",
            emoji: "â„ï¸",
            effectClass: "snowy-effect",
            windowResponses: [
                "ä¸‹é›ªäº†...ä¸€ç‰‡ç‰‡ç™½è‰²çš„...",
                "é›ªèŠ±åœ¨çª—å¤–é£èˆï¼Œå¾ˆç¾...",
                "å¦‚æœæ˜¯é›ªå¤©ï¼Œå¤–é¢ä¸€å®šå¾ˆå†·å§ï¼Ÿ",
                "é›ªæŠŠä¸€åˆ‡éƒ½è¦†ç›–äº†...",
                "æƒ³ä¼¸æ‰‹æ¥ä½é›ªèŠ±ï¼Œä½†éš”ç€ç»ç’ƒ...",
                "é›ªè®©ä¸–ç•Œå˜å¾—å®‰é™",
                "æ¯ä¸€ç‰‡é›ªèŠ±éƒ½ä¸ä¸€æ ·å‘¢",
                "å¦‚æœèƒ½åœ¨é›ªåœ°é‡Œç©è€å°±å¥½äº†"
            ],
            moodEffect: +5
        },
        foggy: {
            name: "é›¾å¤©",
            emoji: "ğŸŒ«ï¸",
            effectClass: "foggy-effect",
            windowResponses: [
                "å¤–é¢å…¨æ˜¯é›¾ï¼Œä»€ä¹ˆéƒ½çœ‹ä¸è§...",
                "é›¾è®©ä¸–ç•Œå˜å¾—æ¨¡ç³Š...",
                "è¿™æ ·çš„å¤©æ°”è®©äººä¸å®‰...",
                "é›¾é‡Œä¼šä¸ä¼šè—ç€ä»€ä¹ˆï¼Ÿ",
                "ä»€ä¹ˆéƒ½çœ‹ä¸æ¸…ï¼Œæ„Ÿè§‰å¾ˆå­¤ç‹¬...",
                "é›¾æ°”åœ¨æ…¢æ…¢æµåŠ¨",
                "æ„Ÿè§‰åƒæ˜¯è¢«å…³åœ¨ä¸€ä¸ªæ³¡æ³¡é‡Œ",
                "çœ‹ä¸æ¸…åè€Œè®©äººæ›´åŠ æƒ³è±¡"
            ],
            moodEffect: -3
        }
    };

    // å¿ƒæƒ…ç³»ç»Ÿ - ä¼˜åŒ–ï¼šè°ƒæ•´åŸºç¡€å‡ ç‡å’Œå¿ƒæƒ…å˜åŒ–é€»è¾‘
    const moodTypes = {
        anxious: {
            name: "è­¦æƒ•",
            emoji: "ğŸ˜°",
            color: "#FFB7B2",
            baseChance: 0.4,
            interactions: [
                "ä½ æ˜¯è°ï¼Ÿä¸è¦é è¿‘æˆ‘...",
                "è¿™ä¸ªåœ°æ–¹å¾ˆå¥‡æ€ª...",
                "æˆ‘æ„Ÿè§‰è¢«ç›‘è§†äº†",
                "ä¸è¦ç¢°æˆ‘ï¼",
                "æˆ‘å®³æ€•...",
                "è¿™é‡Œä¸å®‰å…¨",
                "æœ‰äººåœ¨å—ï¼Ÿæˆ‘å¬åˆ°å£°éŸ³äº†",
                "ä¸è¦ä¼¤å®³æˆ‘...",
                "æˆ‘æƒ³ç¦»å¼€è¿™é‡Œ",
                "è¿™ä¸€åˆ‡éƒ½æ˜¯å¹»è§‰å—ï¼Ÿ"
            ],
            idle: [
                "ä¿æŒè­¦æƒ•...ä¸èƒ½æ”¾æ¾",
                "æœ‰äººåœ¨çœ‹ç€æˆ‘",
                "è¿™é‡Œçš„ä¸€åˆ‡éƒ½ä¸å¯¹åŠ²",
                "æˆ‘éœ€è¦å°å¿ƒ",
                "ä¸èƒ½ç›¸ä¿¡ä»»ä½•äºº"
            ],
            maxDuration: 60000, // æœ€é•¿æŒç»­æ—¶é—´ï¼š60ç§’
            decayRate: 0.02 // æ¯ç§’è¡°å‡ç‡
        },
        sad: {
            name: "éš¾è¿‡",
            emoji: "ğŸ˜”",
            color: "#8AC6D1",
            baseChance: 0.25,
            interactions: [
                "ä»Šå¤©å¿ƒæƒ…ä¸å¤ªå¥½...",
                "æ„Ÿè§‰æœ‰ç‚¹å­¤å•...",
                "ä½ ä¼šç¦»å¼€å—ï¼Ÿ",
                "ä¸çŸ¥é“ä¸ºä»€ä¹ˆæœ‰ç‚¹éš¾è¿‡...",
                "æƒ³ä¸€ä¸ªäººé™é™...",
                "å¿ƒé‡Œç©ºç©ºçš„",
                "æƒ³è¦ä¸€ä¸ªæ‹¥æŠ±",
                "çœ¼æ³ªæœ‰ç‚¹æ­¢ä¸ä½",
                "ä»€ä¹ˆéƒ½æä¸èµ·å…´è¶£",
                "æ„Ÿè§‰è¢«ä¸–ç•Œé—å¿˜äº†"
            ],
            idle: [
                "ä»Šå¤©ç‰¹åˆ«æƒ³å“­",
                "æ„Ÿè§‰è‡ªå·±å¥½æ¸ºå°",
                "ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§æƒ…ç»ªå‘¢",
                "éš¾è¿‡åƒæ½®æ°´ä¸€æ ·æ¶Œæ¥",
                "å¸Œæœ›æ˜å¤©ä¼šå¥½ä¸€ç‚¹"
            ],
            maxDuration: 90000, // 90ç§’
            decayRate: 0.015
        },
        calm: {
            name: "å¹³é™",
            emoji: "ğŸ˜",
            color: "#A2E1DB",
            baseChance: 0.6,
            interactions: [
                "å—¯...ä»Šå¤©å¾ˆå¹³é™...",
                "å°±è¿™æ ·å¾…ç€ä¹Ÿä¸é”™...",
                "ä½ åœ¨åšä»€ä¹ˆå‘¢ï¼Ÿ",
                "æˆ¿é—´é‡Œå¾ˆå®‰é™...",
                "æ—¶é—´æ…¢æ…¢æµé€ç€...",
                "ä»Šå¤©æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„äº‹",
                "äº«å—è¿™ä»½å®é™",
                "å¿ƒé‡Œå¾ˆå¹³å’Œ",
                "ä»€ä¹ˆéƒ½ä¸æƒ³ï¼Œå°±è¿™æ ·å‘å‘†",
                "æ„Ÿè§‰å¾ˆå®‰ç¨³"
            ],
            idle: [
                "ä»Šå¤©åˆæ˜¯æ™®é€šçš„ä¸€å¤©",
                "æˆ¿é—´é‡Œçš„ä¸€åˆ‡éƒ½å¾ˆç†Ÿæ‚‰",
                "å¹³é™åœ°åº¦è¿‡æ—¶é—´",
                "æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„æƒ³æ³•",
                "å°±è¿™æ ·çœ‹ç€çª—å¤–å‘å‘†"
            ],
            maxDuration: 120000, // 120ç§’
            decayRate: 0.01
        },
        happy: {
            name: "å¼€å¿ƒ",
            emoji: "ğŸ˜Š",
            color: "#FFD166",
            baseChance: 0.3,
            interactions: [
                "ä»Šå¤©æ„Ÿè§‰çœŸå¥½ï¼",
                "å˜¿å˜¿ï¼Œä½ åœ¨çœ‹æˆ‘å—ï¼Ÿ",
                "å¿ƒæƒ…ä¸é”™å‘¢~",
                "æƒ³å’Œä½ ä¸€èµ·ç©ï¼",
                "æ„Ÿè§‰ä»Šå¤©ä¼šæ˜¯ä¸ªå¥½æ—¥å­ï¼",
                "ä½ çš„å‡ºç°è®©æˆ‘å¥½å¼€å¿ƒï¼",
                "å•¦å•¦å•¦~æƒ³å”±é¦–æ­Œï¼",
                "ä»Šå¤©åšä»€ä¹ˆéƒ½å¾ˆæœ‰å¹²åŠ²ï¼",
                "åƒåƒäº†ç³–æœä¸€æ ·ç”œï¼",
                "ä¸–ç•Œéƒ½å˜å¾—æ˜äº®äº†ï¼"
            ],
            idle: [
                "ä»Šå¤©é˜³å…‰çœŸå¥½ï¼Œå¿ƒæƒ…ä¹Ÿè·Ÿç€å˜å¥½äº†",
                "æƒ³åˆ°ä½ å°±å¿ä¸ä½ç¬‘èµ·æ¥",
                "æˆ¿é—´é‡Œéƒ½å……æ»¡äº†å¿«ä¹çš„æ°”æ¯",
                "å¥½æƒ³å’Œä½ åˆ†äº«è¿™ä»½å–œæ‚¦",
                "è¿ç©ºæ°”éƒ½å˜å¾—ç”œç”œçš„"
            ],
            maxDuration: 80000, // 80ç§’
            decayRate: 0.018
        },
        excited: {
            name: "å…´å¥‹",
            emoji: "ğŸ¤©",
            color: "#FF9AA2",
            baseChance: 0.08, // é™ä½åŸºç¡€å‡ ç‡
            interactions: [
                "å“‡ï¼ä»Šå¤©å¥½æ£’ï¼",
                "å¥½å¼€å¿ƒå¥½å¼€å¿ƒï¼",
                "æƒ³å’Œä½ åˆ†äº«è¿™ä»½å¿«ä¹ï¼",
                "æ„Ÿè§‰å……æ»¡äº†èƒ½é‡ï¼",
                "ä»Šå¤©æœ‰ä»€ä¹ˆå¥½äº‹å—ï¼Ÿ",
                "å¤ªæ¿€åŠ¨äº†ï¼",
                "å¼€å¿ƒå¾—è¦é£èµ·æ¥äº†ï¼",
                "æ§åˆ¶ä¸ä½çš„ç¬‘å®¹ï¼",
                "å¥½æƒ³å¤§å£°æ¬¢å‘¼ï¼",
                "å¿ƒè·³åŠ é€Ÿï¼"
            ],
            idle: [
                "å…´å¥‹å¾—ç¡ä¸ç€è§‰",
                "æ•´ä¸ªäººéƒ½åœ¨å‘å…‰",
                "ä¸–ç•Œéƒ½å˜å¾—ç²¾å½©äº†",
                "æ„Ÿè§‰èƒ½åšä»»ä½•äº‹æƒ…",
                "å¿«ä¹è¦æº¢å‡ºæ¥äº†"
            ],
            maxDuration: 40000, // åªæœ‰40ç§’
            decayRate: 0.025 // å¿«é€Ÿè¡°å‡
        }
    };

    // å¿ƒç†æ´»åŠ¨åº“
    const mentalActivities = {
        p0: {
            idle: {
                anxious: ["ä½ åœ¨çœ‹æˆ‘å¯¹å—ï¼Ÿ", "ä»Šå¤©...æ„Ÿè§‰è¿˜å¥½", "æœ‰ç‚¹å¥½å¥‡ä½ çš„æ ·å­"],
                calm: ["â€¦â€¦ä¸è¦é è¿‘æˆ‘ã€‚", "è¿™äº›ä¸œè¥¿ä¸æ˜¯æˆ‘ä¸–ç•Œé‡Œçš„ä¸œè¥¿ã€‚", "ä¿æŒè­¦æƒ•..."],
                sad: ["è¿™é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰...é™¤äº†ææƒ§ã€‚", "çª—å¤–çš„æ™¯è‰²æ˜¯å‡çš„ï¼Œæˆ‘çŸ¥é“ã€‚", "å¥½å­¤ç‹¬..."],
                happy: ["è¿™ä¸ªæ„Ÿè§‰...å¾ˆå¥‡æ€ª", "å¿ƒè·³å¾—å¥½å¿«"],
                excited: ["ï¼ï¼"]
            },
            touch: {
                anxious: ["åˆ«ç¢°æˆ‘ï¼", "ç¦»æˆ‘è¿œç‚¹"],
                calm: ["ä½ è¦å¹²ä»€ä¹ˆï¼Ÿ", "è¿™ç§æ„Ÿè§‰å¾ˆå¥‡æ€ªã€‚", "å¯ä»¥æ¥å—"],
                sad: ["èµ°å¼€...", "ä¸è¦ç¢°æˆ‘..."],
                happy: ["...ï¼Ÿ", "è¿™æ˜¯ä»€ä¹ˆæ„Ÿè§‰"],
                excited: ["ï¼ï¼"]
            },
            gift: {
                anxious: ["è¿™æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿæœ‰æ¯’å—ï¼Ÿ", "æˆ‘ä¸ç›¸ä¿¡"],
                calm: ["è¿™æ˜¯...ç»™æˆ‘çš„ï¼Ÿ", "çœŸçš„å¯ä»¥æ”¶å—"],
                sad: ["æˆ‘ä¸éœ€è¦ä½ çš„æ–½èˆã€‚", "æ‹¿èµ°å§..."],
                happy: ["å“‡ï¼"],
                excited: ["è¿™ä¸ª...ä¸å¤ªä¸€æ ·ï¼Ÿ", "è°¢è°¢"]
            },
            furniture: {
                bed: "é‚£æ˜¯é™·é˜±å—ï¼Ÿ",
                desk: "ä¸Šé¢ä¼šæœ‰ä»€ä¹ˆï¼Ÿ",
                bookshelf: "ä¹¦é‡Œå†™ç€ä»€ä¹ˆï¼Ÿ",
                plant: "å‡çš„æ¤ç‰©...",
                lamp: "å…‰...å¤ªäº®äº†ã€‚",
                window: "çª—å¤–æœ‰ä»€ä¹ˆï¼Ÿ"
            }
        },
        p1: {
            idle: {
                anxious: ["å¦‚æœè¿™æ˜¯å®éªŒï¼Œé‚£ä½ è§‚å¯Ÿå¾—ä¹Ÿå¤ªè®¤çœŸäº†ã€‚", "ä»Šå¤©æ¥å¾—æ¯”æ˜¨å¤©æ™šäº†ä¸€ç‚¹ã€‚", "æˆ‘åœ¨è§‚å¯Ÿä½ "],
                calm: ["ä½ åˆæ¥äº†ï¼", "ä»Šå¤©æ¥å¾—æŒºå‡†æ—¶", "æœ‰ç‚¹æœŸå¾…ä½ å‡ºç°"],
                sad: ["ä½ åœ¨è®°å½•æˆ‘çš„ååº”å—ï¼Ÿ", "åŸæ¥ä¸ä¼šç«‹åˆ»å‡ºäº‹ã€‚", "è¿˜æ˜¯ä¸å®‰"],
                happy: ["ä½ æ¥äº†ï¼", "ä»Šå¤©ä¼šæœ‰ä»€ä¹ˆå‘¢"],
                excited: ["åˆåœ¨è§‚å¯Ÿæˆ‘å—ï¼Ÿ", "æˆ‘æ³¨æ„åˆ°ä½ äº†ã€‚"]
            },
            touch: {
                anxious: ["æˆ‘èƒ½æ„Ÿè§‰åˆ°ä½ ã€‚", "ä½ çš„æ‰‹æ²¡æœ‰æ¸©åº¦ã€‚", "å°å¿ƒä¸€ç‚¹"],
                calm: ["...ï¼ˆå¾®å¾®å¥½å¥‡ï¼‰", "ä¸è®¨åŒè¿™ä¸ªæ„Ÿè§‰"],
                sad: ["åˆæ˜¯è¿™æ ·...", "ä¹ æƒ¯äº†"],
                happy: ["å˜¿å˜¿", "å†æ¥ä¸€æ¬¡"],
                excited: ["ä¸è®¨åŒè¿™ä¸ªæ„Ÿè§‰"]
            },
            gift: {
                anxious: ["ä¸ºä»€ä¹ˆè¦ç»™æˆ‘è¿™äº›ï¼Ÿ", "çœŸçš„å¯ä»¥è¦å—"],
                calm: ["åˆæ˜¯é£Ÿç‰©...ä½ åªæœ‰è¿™ä¸ªå—ï¼Ÿ", "æ”¶ä¸‹äº†"],
                sad: ["æˆ‘æ”¶ä¸‹äº†ï¼Œä½†åˆ«æŒ‡æœ›æˆ‘æ„Ÿè°¢ä½ ã€‚", "å—¯..."],
                happy: ["å–œæ¬¢ï¼", "å¥½æ£’ï¼"],
                excited: ["è¿™ä¸ª...ä¸å¤ªä¸€æ ·ï¼Ÿ", "è°¢è°¢"]
            },
            furniture: {
                bed: "æœ‰ç‚¹å›°äº†...ä½†ä¸èƒ½ç¡ã€‚",
                desk: "æ¡Œå­å¾ˆå¹²å‡€ï¼Œè°¢è°¢ã€‚",
                bookshelf: "å¯ä»¥æ”¾ç‚¹ä¸œè¥¿äº†ã€‚",
                plant: "ç»¿è‰²...è®©äººå¹³é™ã€‚",
                lamp: "æ™šä¸Šä¸ç”¨é‚£ä¹ˆæš—äº†ã€‚",
                window: "çœ‹çœ‹å¤–é¢..."
            }
        }
    };

    // å¯¹è¯å›å¤åº“
    const chatResponses = {
        p0: {
            greetings: {
                anxious: ["åˆ«é è¿‘æˆ‘ï¼", "ä½ è¦å¹²ä»€ä¹ˆï¼Ÿ", "æˆ‘å¾ˆå®³æ€•"],
                calm: ["...", "ä½ æ˜¯è°ï¼Ÿ", "æœ‰äº‹å—"],
                sad: ["èµ°å¼€ã€‚", "ä¸æƒ³è¯´è¯...", "åˆ«ç†æˆ‘"],
                happy: ["...ä½ å¥½", "ä½ ä»Šå¤©çœ‹èµ·æ¥å¾ˆä¸ä¸€æ ·", "Hi"],
                excited: ["ï¼", "ä½ å¥½ï¼Ÿ"]
            },
            questions: {
                anxious: ["åˆ«æƒ³éª—æˆ‘ã€‚", "éƒ½æ˜¯å‡çš„ã€‚", "æˆ‘ä¸ç›¸ä¿¡"],
                calm: ["æˆ‘ä¸ºä»€ä¹ˆè¦å‘Šè¯‰ä½ ï¼Ÿ", "è¿™ä¸å…³ä½ çš„äº‹ã€‚", "æ— å¯å¥‰å‘Š"],
                sad: ["......", "åˆ«é—®äº†...", "ä¸çŸ¥é“"],
                happy: ["ä¸ºä»€ä¹ˆé—®è¿™ä¸ªï¼Ÿ", "æˆ‘ä¹Ÿä¸çŸ¥é“"],
                excited: ["å—¯...", "è¿™ä¸ªå˜›"]
            },
            statements: {
                anxious: ["æˆ‘å®³æ€•...", "ä¸è¦", "èµ°å¼€"],
                calm: ["æˆ‘ä¸ç›¸ä¿¡ä½ ã€‚", "æ˜¯å—", "éšä¾¿"],
                sad: ["ä¸çŸ¥é“...", "æ— æ‰€è°“", "å—¯"],
                happy: ["å—¯...", "è¿™æ ·å•Š", "å“¦"],
                excited: ["çœŸçš„å—ï¼Ÿ", "å“‡"]
            },
            special: {
                "ä½ å¥½": {
                    anxious: ["åˆ«è¿‡æ¥ï¼", "èµ°å¼€"],
                    calm: ["...", "ä½ æ˜¯è°ï¼Ÿ", "å—¯"],
                    sad: ["......", "å“¦"],
                    happy: ["...ä½ å¥½", "ä½ è¯´è¯äº†", "Hi"],
                    excited: ["ä½ å¥½ï¼", "ä½ ç»ˆäºè¯´è¯äº†"]
                }
            }
        }
    };

    // ä¸»åŠ¨å¯¹è¯è§¦å‘
    const activeChats = {
        p0: [
            { trigger: "idle", messages: ["æœ‰äººåœ¨å—ï¼Ÿ", "......", "è¿™é‡Œå¥½å®‰é™ã€‚", "æˆ‘æ˜¯è°ï¼Ÿ", "è¿™é‡Œæ˜¯ä»€ä¹ˆåœ°æ–¹ï¼Ÿ"], chance: 0.05 }
        ],
        p1: [
            { trigger: "idle", messages: ["ä»Šå¤©ä¼šæ¥å—ï¼Ÿ", "åˆåœ¨è§‚å¯Ÿæˆ‘å—ï¼Ÿ", "æˆ‘æ³¨æ„åˆ°ä½ äº†ã€‚", "ä½ åœ¨æƒ³ä»€ä¹ˆï¼Ÿ", "æˆ‘èƒ½ç›¸ä¿¡ä½ å—ï¼Ÿ"], chance: 0.08 }
        ]
    };

    // æ—¥è®°å†…å®¹åº“
    const diaryContentLibrary = {
        anxious: [
            { 
                title: "ç¬¬ä¸€å¤©ï¼šé™Œç”Ÿçš„åœ°æ–¹", 
                content: "æˆ‘ä¸çŸ¥é“è¿™æ˜¯å“ªé‡Œã€‚å››å‘¨éƒ½æ˜¯ç™½è‰²çš„å¢™å£ï¼Œåªæœ‰ä¸€æ‰‡çª—æˆ·ã€‚çª—å¤–ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œåªæœ‰ä¸€ç‰‡è™šæ— ã€‚æˆ‘æ„Ÿè§‰æœ‰äººåœ¨çœ‹ç€æˆ‘ï¼Œä½†æˆ‘çœ‹ä¸åˆ°æ˜¯è°ã€‚å¥½å®³æ€•...",
                requireTrust: 0
            },
            { 
                title: "è­¦æƒ•çš„è§‚å¯Ÿ", 
                content: "ä»Šå¤©åˆæ„Ÿè§‰åˆ°äº†é‚£é“è§†çº¿ã€‚æˆ‘æ²¡æœ‰åŠ¨ï¼Œå‡è£…ä»€ä¹ˆéƒ½æ²¡å‘ç°ã€‚å¦‚æœæ˜¯æ€ªç‰©ï¼Œè‡³å°‘è®©å®ƒä»¥ä¸ºæˆ‘æ²¡æœ‰å¨èƒã€‚æˆ‘éœ€è¦æ‰¾åˆ°é€ƒå‡ºå»çš„æ–¹æ³•ã€‚",
                requireTrust: 5
            },
            { 
                title: "ç¥ç§˜çš„é£Ÿç‰©", 
                content: "ä»Šå¤©çªç„¶å‡ºç°äº†é£Ÿç‰©ã€‚æ˜¯å¹»è§‰å—ï¼Ÿè¿˜æ˜¯é™·é˜±ï¼Ÿæˆ‘è§‚å¯Ÿäº†å¾ˆä¹…æ‰æ•¢åƒã€‚å‘³é“...æ˜¯çœŸå®çš„é¢åŒ…ã€‚æ˜¯è°ç»™çš„ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ",
                requireTrust: 10
            }
        ],
        sad: [
            { 
                title: "å­¤ç‹¬çš„æˆ¿é—´", 
                content: "åˆä¸€å¤©è¿‡å»äº†ã€‚æˆ¿é—´é‡Œä¾ç„¶åªæœ‰æˆ‘ä¸€ä¸ªäººã€‚æœ‰æ—¶å€™æˆ‘ä¼šå¯¹ç€å¢™å£è¯´è¯ï¼Œå‡è£…æœ‰äººèƒ½å¬è§ã€‚ä½†å›åº”æˆ‘çš„åªæœ‰è‡ªå·±çš„å›å£°ã€‚",
                requireTrust: 15
            },
            { 
                title: "é›¨å¤©çš„æ€å¿µ", 
                content: "çª—å¤–ä¸‹é›¨äº†ã€‚æˆ‘è®°å¾—ä»¥å‰åœ¨ä¸‹é›¨å¤©ï¼Œå¦ˆå¦ˆä¼šç»™æˆ‘æ³¡çƒ­å¯å¯ã€‚ç°åœ¨åªæœ‰æˆ‘ä¸€ä¸ªäººï¼Œå¬ç€é›¨å£°ï¼Œæ•°ç€æ—¶é—´ã€‚",
                requireTrust: 20
            }
        ],
        calm: [
            { 
                title: "ä¹ æƒ¯ä¸é€‚åº”", 
                content: "æˆ‘å¼€å§‹ä¹ æƒ¯è¿™ä¸ªæˆ¿é—´äº†ã€‚æ¯å¤©å›ºå®šçš„æ—¶é—´ä¼šæœ‰é£Ÿç‰©å‡ºç°ï¼Œå¶å°”è¿˜ä¼šæœ‰å°ç¤¼ç‰©ã€‚è™½ç„¶ä¸çŸ¥é“æ˜¯è°ï¼Œä½†è‡³å°‘ç°åœ¨æ²¡æœ‰ä¼¤å®³æˆ‘ã€‚",
                requireTrust: 25
            },
            { 
                title: "å¹³é™çš„åˆå", 
                content: "ä»Šå¤©é˜³å…‰å¾ˆå¥½ã€‚æˆ‘ååœ¨çª—è¾¹ï¼Œçœ‹ç€å…‰çº¿åœ¨åœ°æ¿ä¸Šç§»åŠ¨ã€‚æ—¶é—´è¿‡å¾—å¾ˆæ…¢ï¼Œä½†è‡³å°‘ç°åœ¨æˆ‘ä¸é‚£ä¹ˆå®³æ€•äº†ã€‚",
                requireTrust: 30
            }
        ],
        happy: [
            { 
                title: "æœŸå¾…çš„ä¸€å¤©", 
                content: "ä»Šå¤©æ”¶åˆ°äº†å°ç†Šç©å¶ï¼è½¯è½¯çš„ï¼ŒæŠ±èµ·æ¥å¾ˆèˆ’æœã€‚è¿™æ˜¯æˆ‘æ¥è¿™é‡Œåç¬¬ä¸€æ¬¡æ”¶åˆ°ç¤¼ç‰©ã€‚éš¾é“...é‚£ä¸ªäººæ˜¯æœ‹å‹ï¼Ÿ",
                requireTrust: 35
            },
            { 
                title: "è¢«å…³å¿ƒçš„æ„Ÿè§‰", 
                content: "æˆ‘å‘ç°æ¯æ¬¡æˆ‘å¿ƒæƒ…ä¸å¥½çš„æ—¶å€™ï¼Œç¬¬äºŒå¤©æ€»ä¼šæœ‰å°æƒŠå–œå‡ºç°ã€‚éš¾é“é‚£ä¸ªäººèƒ½çŸ¥é“æˆ‘çš„æ„Ÿå—ï¼Ÿå¦‚æœæ˜¯çœŸçš„...é‚£è¿˜æŒºæ¸©æš–çš„ã€‚",
                requireTrust: 40
            }
        ],
        excited: [
            { 
                title: "æ–°çš„å‘ç°ï¼", 
                content: "ä»Šå¤©æˆ‘å‘ç°äº†æ—¥è®°æœ¬ï¼æ˜¯é‚£ä¸ªäººç»™æˆ‘çš„å—ï¼Ÿæˆ‘å¯ä»¥å†™ä¸‹è‡ªå·±çš„å¿ƒæƒ…äº†ã€‚ä¹Ÿè®¸...æœ‰ä¸€å¤©æˆ‘èƒ½æŠŠæ—¥è®°ç»™ä»–çœ‹ï¼Ÿ",
                requireTrust: 45
            },
            { 
                title: "åŒå‘çš„è¿æ¥", 
                content: "ä»Šå¤©æˆ‘ç»ˆäºé¼“èµ·å‹‡æ°”åœ¨å±å¹•ä¸Šå†™å­—äº†ã€‚è™½ç„¶ä¸çŸ¥é“ä»–èƒ½ä¸èƒ½çœ‹åˆ°ï¼Œä½†æ„Ÿè§‰æˆ‘ä»¬ä¹‹é—´çš„è·ç¦»å˜è¿‘äº†ã€‚",
                requireTrust: 50
            }
        ]
    };

    // ç‰©å“äº’åŠ¨ååº”
    const itemReactions = {
        bread: {
            anxious: ["è¿™æ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥åƒå—ï¼Ÿ", "æˆ‘ä¸é¥¿...ï¼ˆå…¶å®å¾ˆé¥¿ï¼‰", "ä½ å…ˆåƒä¸€å£è¯æ˜æ²¡æ¯’"],
            calm: ["é¢åŒ…ï¼Ÿè°¢è°¢...", "æˆ‘æ”¶ä¸‹äº†", "çœ‹èµ·æ¥å¯ä»¥åƒ"],
            sad: ["é£Ÿç‰©...ä½†æˆ‘æ²¡èƒƒå£", "åƒä¸ä¸‹", "å…ˆæ”¾ç€å§"],
            happy: ["æ˜¯é¢åŒ…ï¼è°¢è°¢ï¼", "çœ‹èµ·æ¥å¾ˆå¥½åƒ", "ä½ çœŸå¥½"],
            excited: ["å“‡ï¼é£Ÿç‰©ï¼æˆ‘å¥½é¥¿ï¼", "è°¢è°¢ï¼æˆ‘ä¼šå¥½å¥½åƒçš„ï¼", "ä½ æ€»æ˜¯çŸ¥é“æˆ‘éœ€è¦ä»€ä¹ˆ"]
        },
        candy: {
            anxious: ["ç³–ï¼Ÿä¼šä¸ä¼šæ˜¯éº»é†‰è¯ï¼Ÿ", "é¢œè‰²å¥½é²œè‰³...å¥‡æ€ª"],
            calm: ["ç³–...å¾ˆä¹…æ²¡åƒäº†", "ç”œç”œçš„ï¼Œè°¢è°¢"],
            sad: ["ç³–ä¹Ÿæ”¹å˜ä¸äº†å¿ƒæƒ…", "å…ˆæ”¶ç€å§"],
            happy: ["æ˜¯ç³–ï¼å¥½æ€€å¿µï¼", "ç”œç”œçš„ï¼Œå¿ƒæƒ…å˜å¥½äº†"],
            excited: ["ç³–æœï¼ï¼æœ€å–œæ¬¢äº†ï¼", "å¥½ç”œå¥½å¼€å¿ƒï¼", "è°¢è°¢ä½ ï¼"]
        },
        cake: {
            anxious: ["è›‹ç³•ï¼Ÿå¤ªå¯ç–‘äº†", "ä¸ºä»€ä¹ˆå¯¹æˆ‘è¿™ä¹ˆå¥½ï¼Ÿ"],
            calm: ["å°è›‹ç³•...å¾ˆç”¨å¿ƒå‘¢", "è°¢è°¢"],
            happy: ["æ˜¯è›‹ç³•ï¼å¤ªå¥½äº†ï¼", "çœ‹èµ·æ¥å¾ˆç¾å‘³", "ä½ è®°å¾—æˆ‘å–œæ¬¢ç”œé£Ÿå—ï¼Ÿ"],
            excited: ["ç”Ÿæ—¥è›‹ç³•å—ï¼Ÿï¼å¥½æ„ŸåŠ¨ï¼", "è°¢è°¢ä½ ï¼è¿™æ˜¯æœ€å¥½çš„ç¤¼ç‰©ï¼", "æˆ‘ä¼šæ…¢æ…¢äº«ç”¨çš„ï¼"]
        },
        book: {
            anxious: ["ä¹¦ï¼Ÿé‡Œé¢å†™äº†ä»€ä¹ˆï¼Ÿ", "æ˜¯ä¸æ˜¯è¯…å’’ä¹‹ä¹¦ï¼Ÿ"],
            calm: ["ç»˜æœ¬...å¯ä»¥æ‰“å‘æ—¶é—´", "è°¢è°¢"],
            happy: ["æ˜¯ä¹¦ï¼æˆ‘å¯ä»¥å­¦ä¹ æ–°ä¸œè¥¿äº†", "è°¢è°¢ä½ æƒ³ç€æˆ‘"],
            excited: ["æ–°ä¹¦ï¼å¤ªæ£’äº†ï¼", "æˆ‘å¯ä»¥çœ‹ä¸€æ•´å¤©ï¼", "æœ€å–œæ¬¢è¯»ä¹¦äº†ï¼"]
        },
        teddy: {
            anxious: ["ç©å¶ï¼Ÿé‡Œé¢ä¼šä¸ä¼šæœ‰çªƒå¬å™¨ï¼Ÿ", "æˆ‘ä¸éœ€è¦ç©å…·"],
            calm: ["å°ç†Š...æŒºå¯çˆ±çš„", "æ™šä¸Šå¯ä»¥æŠ±ç€ç¡"],
            sad: ["ç©å¶...å°±åƒæˆ‘ä¸€æ ·å­¤ç‹¬", "è‡³å°‘æœ‰ä¸ªä¼´"],
            happy: ["å°ç†Šç©å¶ï¼è½¯è½¯çš„ï¼", "è°¢è°¢ä½ ï¼Œæˆ‘ä¸å­¤å•äº†"],
            excited: ["å¤ªæ£’äº†ï¼æˆ‘ä¹Ÿæœ‰ç©å¶äº†ï¼", "æˆ‘ä¼šå¥½å¥½çæƒœå®ƒçš„ï¼", "è°¢è°¢ä½ ï¼"]
        },
        lamp: {
            anxious: ["ç¯ï¼Ÿå¤ªäº®äº†ï¼Œå…³æ‰", "æˆ‘ä¹ æƒ¯é»‘æš—"],
            calm: ["å¤œç¯...æ™šä¸Šä¸ç”¨æ€•é»‘äº†", "è°¢è°¢"],
            happy: ["æœ‰å°å¤œç¯äº†ï¼æ™šä¸Šä¸å®³æ€•äº†", "æ¸©æš–çš„å…‰"],
            excited: ["å¤œç¯ï¼æ™šä¸Šå¯ä»¥çœ‹ä¹¦å†™å­—äº†ï¼", "è°¢è°¢ä½ è€ƒè™‘å¾—è¿™ä¹ˆå‘¨åˆ°ï¼"]
        }
    };

    // å®¶å…·äº’åŠ¨ååº”
    const furnitureReactions = {
        bed: {
            use: ["æœ‰ç‚¹å›°äº†...ä¼‘æ¯ä¸€ä¸‹", "åºŠå¾ˆèˆ’æœï¼Œè°¢è°¢ä½ ", "åˆç¡æ—¶é—´åˆ°"],
            near: ["åºŠçœ‹èµ·æ¥å¥½æŸ”è½¯", "æƒ³èººä¸€ä¼šå„¿", "ä¼‘æ¯çš„åœ°æ–¹"]
        },
        desk: {
            use: ["åœ¨è¿™é‡Œå†™æ—¥è®°å¾ˆåˆé€‚", "æ¡Œå­å¾ˆç¨³ï¼Œå¯ä»¥æ”¾ä¸œè¥¿", "å­¦ä¹ çš„å¥½åœ°æ–¹"],
            near: ["ä¹¦æ¡Œæ•´ç†å¾—å¾ˆå¹²å‡€", "è¿™é‡Œé€‚åˆæ€è€ƒ", "æˆ‘çš„å°å·¥ä½œç«™"]
        },
        bookshelf: {
            use: ["ä¹¦æ¶åˆå¡«æ»¡äº†ä¸€äº›", "ä¹¦è¦å¥½å¥½æ‘†æ”¾", "çŸ¥è¯†çš„å°ä»“åº“"],
            near: ["ä¹¦æ¶ä¸Šæœ‰å¥½å¤šä¹¦", "æƒ³æ‰¾æœ¬ä¹¦çœ‹çœ‹", "çŸ¥è¯†çš„è§’è½"]
        },
        plant: {
            use: ["æ¤ç‰©éœ€è¦æµ‡æ°´äº†", "ç»¿è‰²è®©å¿ƒæƒ…å˜å¥½", "ç”Ÿå‘½çš„æ°”æ¯"],
            near: ["æ¤ç‰©åˆé•¿é«˜äº†", "çœ‹ç€ç»¿è‰²å¾ˆèˆ’æœ", "è‡ªç„¶çš„ä¼™ä¼´"]
        },
        lamp: {
            use: ["å¼€ç¯ï¼Œæˆ¿é—´å˜äº®äº†", "æ™šä¸Šæœ‰å…‰å°±ä¸æ€•äº†", "æ¸©æš–çš„å…‰èŠ’"],
            near: ["å¤œç¯å®ˆæŠ¤ç€æˆ¿é—´", "æœ‰å…‰å°±æœ‰å®‰å…¨æ„Ÿ", "é»‘æš—ä¸­çš„ç¯å¡”"]
        },
        carpet: {
            use: ["åœ°æ¯¯è½¯è½¯çš„ï¼Œå¯ä»¥å", "èººåœ¨è¿™é‡Œå¾ˆèˆ’æœ", "æ¸©æš–çš„è§’è½"],
            near: ["åœ°æ¯¯å¥½æŸ”è½¯", "æƒ³åœ¨è¿™é‡Œä¼‘æ¯", "èˆ’é€‚çš„å°å¤©åœ°"]
        }
    };

    // åŸºç¡€ç‰©å“åº“
    const baseItems = [
        { id: 'bread', name: 'å…¨éº¦é¢åŒ…', price: 20, type: 'food', val: 10, desc: 'æ™®é€šçš„é£Ÿç‰©', unlockCondition: null },
        { id: 'candy', name: 'æ˜Ÿæ˜Ÿç³–', price: 50, type: 'food', val: 20, desc: 'æˆ–è®¸èƒ½è®©ä»–å¼€å¿ƒ', unlockCondition: null },
    ];

    // è§£é”ç‰©å“åº“
    const unlockableItems = [
        { id: 'book', name: 'ç»˜æœ¬', price: 120, type: 'gift', val: 5, desc: 'å¤–é¢ä¸–ç•Œçš„ç”»', unlockCondition: (s) => s.trust >= 25 },
        { id: 'radio', name: 'æ—§æ”¶éŸ³æœº', price: 300, type: 'gift', val: 15, desc: 'åªèƒ½å‘å‡ºæ²™æ²™å£°', unlockCondition: (s) => s.trust >= 45 },
        { id: 'teddy', name: 'å°ç†Šç©å¶', price: 200, type: 'gift', val: 25, desc: 'è½¯è½¯çš„é™ªä¼´', unlockCondition: (s) => s.trust >= 65 },
        { id: 'lamp', name: 'å¤œç¯', price: 150, type: 'gift', val: 10, desc: 'è®©æˆ¿é—´æ›´æ¸©æš–', unlockCondition: (s) => s.trust >= 35 },
        { id: 'cake', name: 'å°è›‹ç³•', price: 80, type: 'food', val: 30, desc: 'ç‰¹åˆ«çš„ç”œç‚¹', unlockCondition: (s) => s.foodEaten >= 8 },
        { id: 'puzzle', name: 'æ‹¼å›¾', price: 250, type: 'gift', val: 20, desc: 'æ¶ˆç£¨æ—¶é—´çš„å¥½ä¸œè¥¿', unlockCondition: (s) => s.day >= 15 },
        { id: 'blanket', name: 'æ¯›æ¯¯', price: 180, type: 'gift', val: 15, desc: 'ä¿æš–ç”¨çš„', unlockCondition: (s) => s.money >= 800 },
        { id: 'camera', name: 'æ—§ç›¸æœº', price: 400, type: 'gift', val: 30, desc: 'è®°å½•ç¬é—´', unlockCondition: (s) => s.trust >= 80 }
    ];

    // å®¶å…·å•†åº— - ä¿®å¤ï¼šç»¿æ¤æ”¹ä¸ºå¯è´­ä¹°
    const furnitureItems = [
        {
            id: 'comfortable_bed',
            name: 'èˆ’é€‚åºŠé“º',
            price: 300,
            emoji: 'ğŸ›ï¸',
            desc: 'è®©å´½å´½ç¡å¾—æ›´èˆ’æœ',
            effect: 'ä½¿ç”¨åæ¢å¤ç²¾åŠ›',
            position: { x: 250, y: 180 },
            size: '50px',
            useChance: 0.3
        },
        {
            id: 'study_desk',
            name: 'å­¦ä¹ ä¹¦æ¡Œ',
            price: 200,
            emoji: 'ğŸ“š',
            desc: 'å´½å´½å¯ä»¥åœ¨ä¸Šé¢å†™æ—¥è®°',
            effect: 'ä½¿ç”¨åå¢åŠ ä¿¡ä»»',
            position: { x: 80, y: 150 },
            size: '45px',
            useChance: 0.25
        },
        {
            id: 'bookshelf',
            name: 'å°ä¹¦æ¶',
            price: 250,
            emoji: 'ğŸ“–',
            desc: 'å­˜æ”¾ä¹¦ç±å’Œç‰©å“',
            effect: 'è£…é¥°æˆ¿é—´',
            position: { x: 280, y: 100 },
            size: '40px',
            useChance: 0.2
        },
        {
            id: 'green_plant', // ä¿®å¤ï¼šç»¿æ¤æ”¹ä¸ºå¯è´­ä¹°
            name: 'ç»¿æ¤',
            price: 100,
            emoji: 'ğŸª´',
            desc: 'è®©æˆ¿é—´æ›´æœ‰ç”Ÿæœº',
            effect: 'æ”¹å–„å¿ƒæƒ…',
            position: { x: 40, y: 80 }, // åŸç»¿æ¤ä½ç½®
            size: '45px',
            useChance: 0.15
        },
        {
            id: 'night_lamp',
            name: 'å¤œç¯',
            price: 150,
            emoji: 'ğŸ’¡',
            desc: 'æ™šä¸Šæä¾›æ¸©æš–çš„å…‰',
            effect: 'å‡å°‘ææƒ§',
            position: { x: 200, y: 80 },
            size: '35px',
            useChance: 0.2
        },
        {
            id: 'soft_carpet',
            name: 'æŸ”è½¯åœ°æ¯¯',
            price: 180,
            emoji: 'ğŸ§¸',
            desc: 'ååœ¨åœ°ä¸Šæ›´èˆ’æœ',
            effect: 'å¢åŠ èˆ’é€‚åº¦',
            position: { x: 150, y: 220 },
            size: '55px',
            useChance: 0.25
        }
    ];

    // èƒŒæ™¯ç³»ç»Ÿ
    const backgrounds = [
        { 
            id: 'default', 
            name: 'é»˜è®¤', 
            type: 'gradient',
            value: 'linear-gradient(180deg, #E3FDFD 0%, #FFFFFF 100%)' 
        },
        { 
            id: 'sunset', 
            name: 'æ—¥è½', 
            type: 'gradient',
            value: 'linear-gradient(180deg, #FFD3A5 0%, #FD6585 100%)' 
        },
        { 
            id: 'night', 
            name: 'æ˜Ÿç©º', 
            type: 'gradient',
            value: 'linear-gradient(180deg, #0C164D 0%, #190B22 100%)' 
        },
        { 
            id: 'forest', 
            name: 'æ£®æ—', 
            type: 'gradient',
            value: 'linear-gradient(180deg, #C1DFC4 0%, #DEECDD 100%)' 
        },
        { 
            id: 'ocean', 
            name: 'æµ·æ´‹', 
            type: 'gradient',
            value: 'linear-gradient(180deg, #A1C4FD 0%, #C2E9FB 100%)' 
        },
        { 
            id: 'pastel', 
            name: 'é©¬å¡é¾™', 
            type: 'gradient',
            value: 'linear-gradient(180deg, #FFD6E7 0%, #FFE6D6 100%)' 
        }
    ];
	// å•ç‹¬çš„å˜é‡æ¥å­˜å‚¨è‡ªå®šä¹‰èƒŒæ™¯
	let customBackgrounds = [];

    // ä»»åŠ¡åˆ—è¡¨
    // ä»»åŠ¡åˆ—è¡¨ - æ›¿æ¢åŸæœ‰çš„taskListæ•°ç»„
    const taskList = [
        // æ¯æ—¥ä»»åŠ¡
        { 
            id: 'daily_login', 
            title: 'æ¯æ—¥ç™»å½•', 
            desc: 'æ¯å¤©é¦–æ¬¡ç™»å½•æ¸¸æˆ', 
            reward: 30, 
            progress: 0,
            maxProgress: 1,
            type: 'daily',
            action: 'claimDailyLogin'
        },
        { 
            id: 'feed_zaizai', 
            title: 'å–‚é£Ÿå´½å´½', 
            desc: 'ä½¿ç”¨ä»»æ„é£Ÿç‰©å–‚é£Ÿå´½å´½', 
            reward: 25, 
            progress: 0,
            maxProgress: 1,
            type: 'daily',
            action: 'claimFeedTask'
        },
        { 
            id: 'play_with_zaizai', 
            title: 'ä¸å´½å´½äº’åŠ¨', 
            desc: 'æ‘¸å¤´æˆ–æˆ³æˆ³å´½å´½5æ¬¡', 
            reward: 20, 
            progress: 0,
            maxProgress: 5,
            type: 'daily',
            action: 'incrementInteraction'
        },
        { 
            id: 'complete_schedule', 
            title: 'å®Œæˆæ—¥ç¨‹', 
            desc: 'æ‰§è¡Œä»»æ„æ—¥ç¨‹è¡ŒåŠ¨', 
            reward: 40, 
            progress: 0,
            maxProgress: 1,
            type: 'daily',
            action: 'completeSchedule'
        },
        { 
            id: 'buy_item', 
            title: 'è´­ä¹°å•†å“', 
            desc: 'åœ¨å•†åº—è´­ä¹°ä»»æ„å•†å“', 
            reward: 15, 
            progress: 0,
            maxProgress: 1,
            type: 'daily',
            action: 'buyItem'
        },
        { 
            id: 'read_diary', 
            title: 'é˜…è¯»æ—¥è®°', 
            desc: 'å·çœ‹å´½å´½çš„æ—¥è®°', 
            reward: 35, 
            progress: 0,
            maxProgress: 1,
            type: 'daily',
            action: 'readDiary'
        },
        { 
            id: 'play_game', 
            title: 'ç©å°æ¸¸æˆ', 
            desc: 'å®Œæˆä»»æ„å°æ¸¸æˆ', 
            reward: 30, 
            progress: 0,
            maxProgress: 1,
            type: 'daily',
            action: 'playGame'
        },
        
        // è¿›åº¦ä»»åŠ¡
        { 
            id: 'increase_trust', 
            title: 'æå‡ä¿¡ä»»', 
            desc: 'æå‡ä¿¡ä»»å€¼10ç‚¹', 
            reward: 50, 
            progress: 0,
            maxProgress: 10,
            type: 'progress',
            action: 'increaseTrust'
        },
        
        // æˆå°±ä»»åŠ¡
        { 
            id: 'buy_furniture', 
            title: 'è´­ä¹°å®¶å…·', 
            desc: 'åœ¨æ”¹é€ å•†åº—è´­ä¹°å®¶å…·', 
            reward: 45, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'buyFurniture'
        },
        { 
            id: 'first_feed', 
            title: 'åˆæ¬¡å–‚é£Ÿ', 
            desc: 'ç¬¬ä¸€æ¬¡å–‚é£Ÿå´½å´½', 
            reward: 30, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'feed'
        },
        { 
            id: 'first_gift', 
            title: 'åˆæ¬¡é€ç¤¼', 
            desc: 'ç¬¬ä¸€æ¬¡ç»™å´½å´½é€ç¤¼ç‰©', 
            reward: 30, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'gift'
        },
        { 
            id: 'first_diary', 
            title: 'åˆæ¬¡è¯»æ—¥è®°', 
            desc: 'ç¬¬ä¸€æ¬¡é˜…è¯»å´½å´½çš„æ—¥è®°', 
            reward: 40, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'readDiary'
        },
        { 
            id: 'trust_30', 
            title: 'åˆæ­¥ä¿¡ä»»', 
            desc: 'ä¿¡ä»»å€¼è¾¾åˆ°30ç‚¹', 
            reward: 60, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'increaseTrust'
        },
        { 
            id: 'trust_60', 
            title: 'æ·±åšä¿¡ä»»', 
            desc: 'ä¿¡ä»»å€¼è¾¾åˆ°60ç‚¹', 
            reward: 100, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'increaseTrust'
        },
        { 
            id: 'trust_100', 
            title: 'å®Œå…¨ä¿¡ä»»', 
            desc: 'ä¿¡ä»»å€¼è¾¾åˆ°100ç‚¹', 
            reward: 200, 
            progress: 0,
            maxProgress: 1,
            type: 'achievement',
            action: 'increaseTrust'
        },
        { 
            id: 'feed_10', 
            title: 'å–‚é£Ÿè¾¾äºº', 
            desc: 'ç´¯ç§¯å–‚é£Ÿ10æ¬¡', 
            reward: 80, 
            progress: 0,
            maxProgress: 10,
            type: 'achievement',
            action: 'feed'
        },
        { 
            id: 'interact_50', 
            title: 'äº’åŠ¨ä¸“å®¶', 
            desc: 'ç´¯ç§¯ä¸å´½å´½äº’åŠ¨50æ¬¡', 
            reward: 120, 
            progress: 0,
            maxProgress: 50,
            type: 'achievement',
            action: 'interact'
        },
        { 
            id: 'collect_all_furniture', 
            title: 'å®¶å…·æ”¶è—å®¶', 
            desc: 'è´­ä¹°æ‰€æœ‰å®¶å…·', 
            reward: 300, 
            progress: 0,
            maxProgress: 1, // è¿™ä¸ªä¼šæ ¹æ®å®é™…å®¶å…·æ•°é‡åŠ¨æ€è®¡ç®—
            type: 'achievement',
            action: 'buyFurniture'
        },
        
        // æ–°å¢é•¿çº¿è¿›åº¦ä»»åŠ¡
        { 
            id: 'collect_diary_entries', 
            title: 'æ”¶é›†æ—¥è®°', 
            desc: 'æ”¶é›†10ç¯‡æ—¥è®°', 
            reward: 200, 
            progress: 0,
            maxProgress: 10,
            type: 'progress',
            action: 'collectDiaryEntries'
        },
        { 
            id: 'accumulate_money', 
            title: 'ç§¯ç´¯è´¢å¯Œ', 
            desc: 'ç§¯ç´¯1000é‡‘å¸', 
            reward: 300, 
            progress: 0,
            maxProgress: 10,
            type: 'progress',
            action: 'accumulateMoney'
        },
        { 
            id: 'interact_multiple_times', 
            title: 'é¢‘ç¹äº’åŠ¨', 
            desc: 'ä¸å´½å´½äº’åŠ¨50æ¬¡', 
            reward: 150, 
            progress: 0,
            maxProgress: 50,
            type: 'progress',
            action: 'interactMultipleTimes'
        },
        { 
            id: 'try_different_weather', 
            title: 'ä½“éªŒå¤©æ°”', 
            desc: 'ä½“éªŒ5ç§ä¸åŒå¤©æ°”', 
            reward: 100, 
            progress: 0,
            maxProgress: 5,
            type: 'progress',
            action: 'tryDifferentWeather'
        }
    ];

    // æ—¥ç¨‹è¡ŒåŠ¨æ•°æ®
    const scheduleActions = [
        {
            id: 'clean',
            name: 'æ‰“æ‰«æˆ¿é—´',
            time: 1,
            reward: 20,
            hungerCost: 5,
            trustGain: 0.5,
            desc: 'å´½å´½ä¼šè®¤çœŸæ‰“æ‰«æˆ¿é—´ï¼Œä¿æŒç¯å¢ƒæ•´æ´',
            risk: 0
        },
        {
            id: 'work',
            name: 'è§‚å¯Ÿè®°å½•',
            time: 2,
            reward: 50,
            hungerCost: 10,
            trustGain: 1,
            desc: 'å´½å´½ä¼šè®°å½•è§‚å¯Ÿåˆ°çš„å¼‚å¸¸ç°è±¡',
            risk: 0
        },
        {
            id: 'talk',
            name: 'å°è¯•æ²Ÿé€š',
            time: 3,
            reward: 0,
            hungerCost: 15,
            trustGain: 2,
            desc: 'å´½å´½ä¼šå°è¯•ä¸ä½ å»ºç«‹æ›´æ·±å±‚çš„è”ç³»',
            risk: 0
        },
        {
            id: 'explore',
            name: 'å¤–å‡ºæ¢ç´¢',
            time: 4,
            reward: 80,
            hungerCost: 20,
            trustGain: 1.5,
            desc: 'å´½å´½ä¼šç¦»å¼€æˆ¿é—´è¿›è¡ŒçŸ­é€”æ¢ç´¢',
            risk: 0.3
        }
    ];

    // å‰§æƒ…å¤§çº²
    const storyChapters = [
        { 
            t: 0, 
            title: "CHAPTER 1: å¼‚å¸¸ä¸‹è½½", 
            content: "ä½ åœ¨ä¸€ä¸ªæ·±å¤œä¸‹è½½äº†ä¸€æ¬¾åä¸ºã€Œå¼‚ç•Œè§‚æµ‹çª—å£ã€çš„åº”ç”¨ã€‚<br>ç®€ä»‹å†™é“ï¼šã€è§‚æµ‹å¦ä¸€ä¸ªä¸–ç•Œçš„çª—å£ï¼Œä½ æ‰€åšçš„ä¸€åˆ‡éƒ½å°†å½±å“é‚£ä¸ªä¸–ç•Œã€ã€‚<br>å½“ä½ æ‰“å¼€åº”ç”¨æ—¶ï¼Œå±å¹•é‡Œå‡ºç°äº†ä¸€ä¸ªçœ‹èµ·æ¥è­¦æƒ•ä¸å®‰çš„å­©å­ã€‚<br><br>ç³»ç»Ÿæç¤ºï¼šã€è§‚æµ‹è€…æƒé™å·²æ¿€æ´»ã€‚ç›®æ ‡ï¼šæœªçŸ¥ç”Ÿå‘½ä½“ã€‚çŠ¶æ€ï¼šæåº¦è­¦æƒ•ã€‘",
            choices: [
                { text: "ç»§ç»­è§‚å¯Ÿ", effect: () => addTrust(0.5) },
                { text: "å°è¯•ç‚¹å‡»å±å¹•", effect: () => { showDialogue('touch'); addTrust(1); } },
                { text: "å…³é—­åº”ç”¨", effect: () => { showToast("ä½ æ— æ³•å…³é—­è¿™ä¸ªåº”ç”¨..."); addTrust(0.2); } }
            ]
        }
    ];

    // === è§‚æµ‹è®°å½•ç³»ç»Ÿ ===
    const recordSystem = {
        addRecord: function(title, content, tags = []) {
            const record = {
                id: Date.now(),
                title: title,
                content: content,
                tags: tags,
                time: new Date().toLocaleString(),
                gameDay: state.day,
                trustLevel: Math.floor(state.trust)
            };
            
            if (!state.records) state.records = [];
            state.records.unshift(record);
            
            if (state.records.length > 50) {
                state.records = state.records.slice(0, 50);
            }
            
            saveState();
            
            if (document.getElementById('record-modal').style.display === 'flex') {
                renderRecords();
            }
        },
        
        recordTrustChange: function(oldTrust, newTrust) {
            const change = newTrust - oldTrust;
            if (Math.abs(change) >= 5) {
                const direction = change > 0 ? 'æå‡' : 'ä¸‹é™';
                const level = this.getTrustLevel(newTrust);
                const oldLevel = this.getTrustLevel(oldTrust);
                
                if (oldLevel !== level) {
                    this.addRecord(
                        `ä¿¡ä»»å€¼${direction}è‡³${level}`,
                        `è§‚æµ‹å¯¹è±¡ä¿¡ä»»å€¼ä» ${oldTrust.toFixed(1)} ${direction}åˆ° ${newTrust.toFixed(1)}ã€‚ä¿¡ä»»ç­‰çº§å˜åŒ–ï¼š${oldLevel} â†’ ${level}ã€‚`,
                        ['trust', 'å¿ƒç†å˜åŒ–']
                    );
                }
            }
        },
        
        recordMoodChange: function(oldMood, newMood) {
            if (oldMood !== newMood) {
                this.addRecord(
                    `å¿ƒæƒ…å˜åŒ–ï¼š${moodTypes[oldMood]?.name || 'æœªçŸ¥'} â†’ ${moodTypes[newMood]?.name || 'æœªçŸ¥'}`,
                    `è§‚æµ‹å¯¹è±¡æƒ…ç»ªçŠ¶æ€å‘ç”Ÿå˜åŒ–ã€‚å¯èƒ½åŸå› ï¼šäº’åŠ¨é¢‘ç‡ã€ç¯å¢ƒå˜åŒ–ã€ä¿¡ä»»åº¦æ”¹å˜ç­‰ã€‚å½“å‰æƒ…ç»ªï¼š${moodTypes[newMood]?.name}ã€‚`,
                    ['mood', 'å¿ƒç†å˜åŒ–']
                );
            }
        },
        
        recordStoryProgress: function(chapterTitle) {
            this.addRecord(
                `å‰§æƒ…è¿›å±•ï¼š${chapterTitle}`,
                `è§‚æµ‹è€…ä¸è§‚æµ‹å¯¹è±¡çš„å…³ç³»è¿›å…¥æ–°é˜¶æ®µã€‚å‰§æƒ…ç« èŠ‚è§£é”ï¼š${chapterTitle}ã€‚`,
                ['story', 'äº‹ä»¶']
            );
        },
        
        recordKeyInteraction: function(type, details) {
            let title = '';
            let content = '';
            
            switch(type) {
                case 'first_feed':
                    title = 'é¦–æ¬¡å–‚é£Ÿ';
                    content = 'è§‚æµ‹å¯¹è±¡æ¥å—äº†è§‚æµ‹è€…æä¾›çš„é£Ÿç‰©ã€‚è¿™æ˜¯åŒæ–¹å»ºç«‹ä¿¡ä»»å…³ç³»çš„é‡è¦é‡Œç¨‹ç¢‘ã€‚';
                    break;
                case 'first_gift':
                    title = 'é¦–æ¬¡èµ é€ç¤¼ç‰©';
                    content = `è§‚æµ‹å¯¹è±¡æ”¶åˆ°äº†è§‚æµ‹è€…èµ é€çš„${details}ã€‚è§‚æµ‹å¯¹è±¡è¡¨ç°å‡ºå¥½å¥‡ä¸æ„Ÿè°¢ã€‚`;
                    break;
                case 'first_diary':
                    title = 'é¦–æ¬¡å‘ç°æ—¥è®°';
                    content = 'è§‚æµ‹å¯¹è±¡çš„æ—¥è®°è¢«å‘ç°ã€‚æ—¥è®°å†…å®¹æ˜¾ç¤ºè§‚æµ‹å¯¹è±¡å·²å¼€å§‹è®°å½•è‡ªèº«æ„Ÿå—ä¸æ€è€ƒã€‚';
                    break;
                case 'first_furniture':
                    title = 'é¦–æ¬¡è´­ä¹°å®¶å…·';
                    content = `è§‚æµ‹è€…ä¸ºæˆ¿é—´æ·»ç½®äº†${details}ã€‚è§‚æµ‹ç¯å¢ƒèˆ’é€‚åº¦æå‡ã€‚`;
                    break;
            }
            
            if (title && content) {
                this.addRecord(title, content, ['äº’åŠ¨', 'é‡Œç¨‹ç¢‘']);
            }
        },
        
        getTrustLevel: function(trustValue) {
            if (trustValue >= 85) return 'æ·±åº¦ä¾èµ–';
            else if (trustValue >= 70) return 'é«˜åº¦ä¿¡ä»»';
            else if (trustValue >= 50) return 'åŸºæœ¬ä¿¡ä»»';
            else if (trustValue >= 30) return 'åˆæ­¥ä¿¡ä»»';
            else if (trustValue >= 15) return 'è¯•æ¢é˜¶æ®µ';
            else return 'æåº¦è­¦æƒ•';
        }
    };

    // ç•ªèŒ„é’Ÿå¯¹è¯
    const pomodoroDialogue = {
        start: [
            "è¦å¼€å§‹ä¸“æ³¨äº†å—ï¼ŸåŠ æ²¹ï¼",
            "æˆ‘ä¼šåœ¨è¿™é‡Œé™ªç€ä½ ",
            "ä¸“å¿ƒåšäº‹ï¼Œæˆ‘ä¼šå®‰é™å¾…ç€",
            "å¼€å§‹å§ï¼æˆ‘ç›¸ä¿¡ä½ èƒ½è¡Œ"
        ],
        tick: [
            "æ—¶é—´åœ¨æµé€...",
            "ä¿æŒä¸“æ³¨",
            "ä¸è¦åˆ†å¿ƒå“¦",
            "åšå¾—å¾ˆå¥½ï¼Œç»§ç»­"
        ],
        poke: [
            "æ€ä¹ˆäº†ï¼Ÿè¦ä¸“å¿ƒå“¦",
            "åˆ«æˆ³æˆ‘å•¦ï¼Œå¿«å›å»åšäº‹",
            "æ—¶é—´è¿˜æ²¡åˆ°å‘¢",
            "æˆ‘åœ¨è¿™é‡Œï¼Œä½†ä½ å¾—ä¸“å¿ƒ",
            "æˆ³æˆ³å¯ä»¥ï¼Œä½†åˆ«å¤ªä¹…",
            "ä¸“å¿ƒï¼ä¸“å¿ƒï¼",
            "è¿˜æœ‰æ—¶é—´ï¼ŒåŠ æ²¹",
            "ä¸è¦åˆ†å¿ƒå¤ªå¤šæ¬¡å“¦"
        ],
        almost: [
            "å¿«åˆ°äº†ï¼åšæŒä¸€ä¸‹",
            "æœ€åå‡ åˆ†é’Ÿäº†",
            "é©¬ä¸Šå°±å®Œæˆäº†",
            "èƒœåˆ©åœ¨æœ›ï¼"
        ],
        finish: [
            "å®Œæˆäº†ï¼å¥½æ£’ï¼",
            "è¾›è‹¦å•¦ï¼Œä¼‘æ¯ä¸€ä¸‹å§",
            "åšå¾—å¥½ï¼çœŸä¸ºä½ éª„å‚²",
            "ä¸“æ³¨æ—¶é—´ç»“æŸï¼Œè¯¥ä¼‘æ¯äº†"
        ],
        cancel: [
            "æ”¾å¼ƒäº†å—...æ²¡å…³ç³»",
            "ä¸‹æ¬¡å†åŠªåŠ›å§",
            "ä¼‘æ¯ä¸€ä¸‹ä¹Ÿå¥½",
            "ä¸è¦ç°å¿ƒï¼Œä¸‹æ¬¡å†æ¥"
        ]
    };

    // æ¸¸æˆçŠ¶æ€ - ä¿®å¤ï¼šåˆå§‹åŒ–æ›´å®Œæ•´çš„çŠ¶æ€
    let state = {
        day: 1,
        money: 100,
        hunger: 50,
        trust: 0,
        inventory: [],
        foodEaten: 0,
        unlockedDiaries: [],
        unlockedItems: [],
        purchasedFurniture: [],
        currentChapter: 0,
        customAvatar: null,
        lastLoginDate: null,
        lastDailyReset: null,
        weatherHistory: [],
        tasks: [], // åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„ï¼Œåœ¨loadStateä¸­ä¼šå¡«å……
        interactionCount: 0,
        dailyLoginClaimed: false,
        feedTaskClaimed: false,
        buyTaskClaimed: false,
        scheduleTaskClaimed: false,
        diaryTaskClaimed: false,
        furnitureTaskClaimed: false,
        gameTaskClaimed: false,
        lastScheduleTime: null,
        characterPosition: { x: 115, y: 200 },
        lastDiaryRead: null,
        chatHistory: [],
        lastActiveChat: 0,
        furnitureUsage: {},
        furniturePositions: {}, // ä¿å­˜å®¶å…·çš„è‡ªå®šä¹‰ä½ç½®å’Œå›¾æ ‡
        storyChoices: [],
        currentWeather: 'cloudy',
        lastWeatherChange: 0,
        currentMood: 'anxious',
        lastMoodChange: 0,
        moodValue: 150,
        moodDuration: 0,
        diaryEntries: [],
        lastDiaryGeneration: 0,
        memos: [],
        lastMemoCheck: 0,
        memoReminded: false,
        lastTrustGain: 0,
        trustCooldown: false,
        moodChangeCooldown: 0,
        consecutivePositiveInteractions: 0,
        consecutiveNegativeInteractions: 0,
        records: [],
        gameHistory: [],
        firstFeedDone: false,
        firstGiftDone: false,
        firstDiaryRead: false,
        firstFurnitureBought: false,
        currentBackground: 'default',
        // æ–°å¢ï¼šå¿ƒæƒ…è¡°å‡ç›¸å…³
        moodStartTime: Date.now(),
        moodStability: 50
    };

    // å½“å‰é€‰æ‹©çš„å¤´åƒæ–‡ä»¶
    let selectedAvatarFile = null;
    let autoChatTimer = null;
    let moodDecayTimer = null;
    
    // å°æ¸¸æˆå˜é‡
    let game2048 = {
        grid: [],
        score: 0,
        gameOver: false,
        tiles: [],
        initialized: false,
        touchDirection: null,
        touchInterval: null
    };
    
    let brickBreaker = {
        canvas: null,
        ctx: null,
        paddle: { x: 150, y: 380, width: 80, height: 10 },
        ball: { x: 150, y: 370, radius: 8, dx: 3, dy: -3 },
        bricks: [],
        score: 0,
        gameRunning: false,
        animationId: null,
        paddleSpeed: 5,
        paddleDirection: 0,
        touchInterval: null
    };
    
    let tetris = {
        canvas: null,
        ctx: null,
        grid: [],
        currentPiece: null,
        nextPiece: null,
        score: 0,
        gameOver: false,
        dropCounter: 0,
        dropInterval: 1000,
        lastTime: 0,
        animationId: null,
        touchAction: null,
        touchInterval: null,
        blockSize: 20
    };

    // ç•ªèŒ„é’Ÿç³»ç»Ÿ
    let pomodoro = {
        timer: null,
        timeLeft: 1500,
        totalTime: 1500,
        isRunning: false,
        isPaused: false,
        currentTask: '',
        tasks: [],
        inFullscreen: false
    };

    // === åˆå§‹åŒ– ===
    window.onload = function() {
        loadState();
        initCharacterPosition();
        initCharacterDragFixed();
        initCharacterTouch();
        
        document.getElementById('avatar-upload-input').addEventListener('change', handleAvatarUpload);
        document.getElementById('bg-upload-input').addEventListener('change', handleBackgroundUpload);
        
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChat();
            }
        });
        
        document.getElementById('memo-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addMemo();
            }
        });
        
        renderTaskList();
        checkItemUnlocks();
        renderFurniture();
        initWeather();
        updateMoodIndicator();
        renderMemos();
        renderRecords();
        startAutoChat();
        startMoodDecayTimer();
        initBackground();

        // ç¡®ä¿æ‰€æœ‰ä»»åŠ¡è¿›åº¦éƒ½æ­£ç¡®
        setTimeout(() => {
            // æ›´æ–°æ‰€æœ‰ä»»åŠ¡çš„è¿›åº¦
            if (state.tasks && state.tasks.length > 0) {
                state.tasks.forEach(task => {
                    updateTaskProgress(task.id);
                });
            }
        }, 1000);

        updateUI();
        checkStoryProgress();
        
        // åˆå§‹åŒ–å…¨å±æ¨¡å¼æ£€æµ‹å’Œé€‚é…
        initFullscreenSupport();
        
        if (state.records.length === 0) {
            recordSystem.addRecord(
                'è§‚æµ‹å¼€å§‹',
                'å¼‚ç•Œè§‚æµ‹çª—å£åº”ç”¨å¯åŠ¨ã€‚æ£€æµ‹åˆ°æœªçŸ¥ç”Ÿå‘½ä½“ï¼Œæ ‡è®°ä¸º"å´½å´½"ã€‚è§‚æµ‹è€…æƒé™å·²æ¿€æ´»ï¼Œå¼€å§‹è®°å½•äº¤äº’æ•°æ®ã€‚',
                ['ç³»ç»Ÿ', 'å¼€å§‹']
            );
        }
    };

    // === ä¿å­˜/åŠ è½½çŠ¶æ€ - ä¿®å¤ï¼šæ›´å®Œæ•´çš„æ•°æ®å­˜å‚¨ ===
    function saveState() {
        try {
            // ç¡®ä¿æ‰€æœ‰é‡è¦æ•°æ®éƒ½è¢«ä¿å­˜
            const saveData = {
                version: '4.5',
                day: state.day,
                money: state.money,
                hunger: state.hunger,
                trust: state.trust,
                inventory: state.inventory,
                foodEaten: state.foodEaten,
                unlockedDiaries: state.unlockedDiaries,
                unlockedItems: state.unlockedItems,
                purchasedFurniture: state.purchasedFurniture,
                currentChapter: state.currentChapter,
                customAvatar: state.customAvatar,
                lastLoginDate: state.lastLoginDate,
                lastDailyReset: state.lastDailyReset,
                tasks: state.tasks,
                interactionCount: state.interactionCount,
                dailyLoginClaimed: state.dailyLoginClaimed,
                feedTaskClaimed: state.feedTaskClaimed,
                buyTaskClaimed: state.buyTaskClaimed,
                scheduleTaskClaimed: state.scheduleTaskClaimed,
                diaryTaskClaimed: state.diaryTaskClaimed,
                furnitureTaskClaimed: state.furnitureTaskClaimed,
                gameTaskClaimed: state.gameTaskClaimed,
                weatherHistory: state.weatherHistory,
                lastScheduleTime: state.lastScheduleTime,
                characterPosition: state.characterPosition,
                lastDiaryRead: state.lastDiaryRead,
                chatHistory: state.chatHistory,
                lastActiveChat: state.lastActiveChat,
                furnitureUsage: state.furnitureUsage,
                storyChoices: state.storyChoices,
                currentWeather: state.currentWeather,
                lastWeatherChange: state.lastWeatherChange,
                currentMood: state.currentMood,
                lastMoodChange: state.lastMoodChange,
                moodValue: state.moodValue,
                moodDuration: state.moodDuration || 0,
                moodStartTime: state.moodStartTime || Date.now(),
                moodStability: state.moodStability || 50,
                diaryEntries: state.diaryEntries,
                lastDiaryGeneration: state.lastDiaryGeneration,
                memos: state.memos,
                lastMemoCheck: state.lastMemoCheck,
                memoReminded: state.memoReminded,
                lastTrustGain: state.lastTrustGain,
                trustCooldown: state.trustCooldown,
                moodChangeCooldown: state.moodChangeCooldown,
                consecutivePositiveInteractions: state.consecutivePositiveInteractions,
                consecutiveNegativeInteractions: state.consecutiveNegativeInteractions,
                records: state.records,
                gameHistory: state.gameHistory,
                firstFeedDone: state.firstFeedDone,
                firstGiftDone: state.firstGiftDone,
                firstDiaryRead: state.firstDiaryRead,
                firstFurnitureBought: state.firstFurnitureBought,
                currentBackground: state.currentBackground,
				// ä¿å­˜è‡ªå®šä¹‰èƒŒæ™¯
				customBackgrounds: customBackgrounds
            };
            
            localStorage.setItem('zaizai_game_state', JSON.stringify(saveData));
            localStorage.setItem('zaizai_game_version', '4.5');
        } catch (e) {
            console.error('ä¿å­˜çŠ¶æ€å¤±è´¥:', e);
        }
    }

    function loadState() {
        try {
            const saved = localStorage.getItem('zaizai_game_state');
            const version = localStorage.getItem('zaizai_game_version');
            
            if (saved) {
                const parsed = JSON.parse(saved);
                
                // ç‰ˆæœ¬è¿ç§»é€»è¾‘
                if (version !== '4.5') {
                    console.log('æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬æ•°æ®ï¼Œè¿›è¡Œè¿ç§»...');
                    // è¿™é‡Œå¯ä»¥æ·»åŠ ç‰ˆæœ¬è¿ç§»é€»è¾‘
                }
                
                // åˆå¹¶çŠ¶æ€ï¼Œç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½æœ‰é»˜è®¤å€¼
                state = {
                    ...state,
                    ...parsed,
                    // ç¡®ä¿æ•°ç»„å­—æ®µå­˜åœ¨
                    inventory: parsed.inventory || [],
                    unlockedItems: parsed.unlockedItems || [],
                    purchasedFurniture: parsed.purchasedFurniture || [],
                    diaryEntries: parsed.diaryEntries || [],
                    memos: parsed.memos || [],
                    records: parsed.records || [],
                    gameHistory: parsed.gameHistory || [],
                    tasks: parsed.tasks || [], // ä½¿ç”¨ä¿å­˜çš„ä»»åŠ¡æ•°æ®
                    // ç¡®ä¿æ•°å­—å­—æ®µæœ‰æ•ˆ
                    day: parseInt(parsed.day) || 1,
                    money: parseInt(parsed.money) || 100,
                    hunger: parseInt(parsed.hunger) || 50,
                    trust: parseFloat(parsed.trust) || 0,
                    moodValue: parseInt(parsed.moodValue) || 15,
                    moodDuration: parseInt(parsed.moodDuration) || 0,
                    moodStability: parseInt(parsed.moodStability) || 50,
                    // ç¡®ä¿å¿ƒæƒ…å­—æ®µæœ‰æ•ˆ
                    currentMood: parsed.currentMood || 'anxious',
                    currentWeather: parsed.currentWeather || 'cloudy',
                    currentBackground: parsed.currentBackground || 'default',
                    // ç¡®ä¿æ—¥æœŸå­—æ®µæœ‰æ•ˆ
                    lastLoginDate: parsed.lastLoginDate || new Date().toDateString(),
                    moodStartTime: parsed.moodStartTime || Date.now()
                };
				
				// åŠ è½½è‡ªå®šä¹‰èƒŒæ™¯
				if (parsed.customBackgrounds) {
			        customBackgrounds = parsed.customBackgrounds;
			        // å°†è‡ªå®šä¹‰èƒŒæ™¯æ·»åŠ åˆ°èƒŒæ™¯åˆ—è¡¨ä¸­
			        customBackgrounds.forEach(bg => {
			            if (!backgrounds.some(b => b.id === bg.id)) {
			                backgrounds.push(bg);
			            }
			        });
			    }
                
				// ä¿®å¤ï¼šå¦‚æœæ²¡æœ‰ä»»åŠ¡æ•°æ®ï¼Œåˆå§‹åŒ–æ‰€æœ‰ä»»åŠ¡
				        if (!parsed.tasks || parsed.tasks.length === 0) {
				            initializeTasks();
				        } else {
				            // ç¡®ä¿ä»»åŠ¡æ•°æ®å®Œæ•´
				            fixTasksData();
				        }
						
                // æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€å¤©ç™»å½•
                const today = new Date().toDateString();
                const lastLoginDate = state.lastLoginDate ? new Date(state.lastLoginDate).toDateString() : null;
                
                if (lastLoginDate !== today) {
                    // æ–°çš„ä¸€å¤©
                    if (lastLoginDate) {
                        // è®¡ç®—ç›¸å·®çš„å¤©æ•°
                        const lastDate = new Date(lastLoginDate);
                        const currentDate = new Date();
                        const timeDiff = currentDate.getTime() - lastDate.getTime();
                        const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
                        
                        if (daysDiff > 0) {
                            state.day += Math.min(daysDiff, 1);
                            state.lastLoginDate = today;
                            
                            // æ—¥å¸¸é‡ç½®
                            state.dailyLoginClaimed = false;
							state.feedTaskClaimed = false;
							state.buyTaskClaimed = false;
							state.scheduleTaskClaimed = false;
							state.diaryTaskClaimed = false;
							state.gameTaskClaimed = false;
							                        
                            state.tasks.forEach(task => {
                                if (task.type === 'daily') {
                                    task.progress = 0;
                                    task.claimed = false;
                                }
                            });
                            state.interactionCount = 0;
                            state.feedTaskClaimed = false;
                            state.buyTaskClaimed = false;
                            state.scheduleTaskClaimed = false;
                            state.diaryTaskClaimed = false;
                            state.furnitureTaskClaimed = false;
                            state.gameTaskClaimed = false;
                            state.memoReminded = false;
                            
                            // å´½å´½æ„ŸçŸ¥æ—¶é—´å˜åŒ–
                            if (daysDiff >= 2) {
                                showDialogueText(`ä½ å·²ç»${daysDiff}å¤©æ²¡æ¥äº†...`);
                                updateMood(-10);
                            } else if (daysDiff === 1) {
                                showDialogueText("ä½ æ˜¨å¤©æ²¡æ¥å‘¢...");
                                updateMood(-5);
                            }
                        }
                    } else {
                        // é¦–æ¬¡ç™»å½•
                        state.day = 1;
                        state.lastLoginDate = today;
                    }
                    
                    // ç”Ÿæˆæ–°æ—¥è®°çš„å‡ ç‡å¢åŠ 
                    if (Math.random() < 0.8) {
                        checkDiaryGeneration();
                    }
                } else {
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦åœ¨åŒä¸€å¤©å†…é‡ç½®ä»»åŠ¡ï¼ˆé›¶ç‚¹æ£€æŸ¥ï¼‰
                    const now = new Date();
                    const todayMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const lastReset = state.lastDailyReset ? new Date(state.lastDailyReset) : null;
                    
                    if (!lastReset || todayMidnight > lastReset) {
                        // é›¶ç‚¹å·²è¿‡ï¼Œé‡ç½®æ¯æ—¥ä»»åŠ¡
                        state.lastDailyReset = todayMidnight.toISOString();
                        
                        // æ—¥å¸¸é‡ç½®
                        state.dailyLoginClaimed = false;
                        state.feedTaskClaimed = false;
                        state.buyTaskClaimed = false;
                        state.scheduleTaskClaimed = false;
                        state.diaryTaskClaimed = false;
                        state.gameTaskClaimed = false;
                             
                        // é‡ç½®æ¯æ—¥ä»»åŠ¡è¿›åº¦
                        state.tasks.forEach(task => {
                            if (task.type === 'daily') {
                                task.progress = 0;
                                task.claimed = false;
                            }
                        });
                        
                        // é‡ç½®äº¤äº’è®¡æ•°ï¼ˆä»…ç”¨äºæ¯æ—¥ä»»åŠ¡ï¼‰
                        state.interactionCount = 0;
                        state.memoReminded = false;
                        
                        showDialogueText("æ–°çš„ä¸€å¤©å¼€å§‹äº†~ä»Šå¤©ä¹Ÿè¦å¥½å¥½ç›¸å¤„å“¦");
                        updateMood(5);
                        showToast("æ¯æ—¥ä»»åŠ¡å·²é‡ç½®");
                    }
                    
                    // æ¯æ—¥ç™»å½•ä»»åŠ¡ï¼šå½“å¤©ç¬¬ä¸€æ¬¡æ‰“å¼€æ¸¸æˆæ—¶è‡ªåŠ¨å®Œæˆ
                    const dailyLoginTask = state.tasks.find(t => t.id === 'daily_login');
                    if (dailyLoginTask && dailyLoginTask.progress === 0 && !state.dailyLoginClaimed) {
                        dailyLoginTask.progress = 1;
                        renderTaskList();
                    }
                }
                
                // è®¾ç½®å´½å´½çš„åˆå§‹å¿ƒæƒ…ä¸ºè­¦æƒ•
                if (!state.currentMood || state.trust < 15) {
                    state.currentMood = 'anxious';
                    state.moodValue = 150;
                }
                
                // ä¿®å¤ï¼šæ›´æ–°æ‰€æœ‰å¤´åƒæ˜¾ç¤º
                if (state.customAvatar) {
                    document.getElementById('zaizai-img').src = state.customAvatar;
                    document.getElementById('avatar-preview').src = state.customAvatar;
                    document.getElementById('fullscreen-img').src = state.customAvatar;
                }
                
                // åˆå§‹åŒ–èƒŒæ™¯
                initBackground();
                
                saveState();
                
            } else {
                // å…¨æ–°æ¸¸æˆ
                state.day = 1;
                state.currentMood = 'anxious';
                state.moodValue = 150;
                state.lastLoginDate = new Date().toDateString();
				initializeTasks(); // åˆå§‹åŒ–æ‰€æœ‰ä»»åŠ¡
                saveState();
            }
						
        } catch (e) {
            console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', e);
            // å¦‚æœåŠ è½½å¤±è´¥ï¼Œé‡ç½®ä¸ºé»˜è®¤çŠ¶æ€
            state = { ...state };
			initializeTasks(); // åˆå§‹åŒ–æ‰€æœ‰ä»»åŠ¡
            saveState();
        }
        
        // æ›´æ–°UIæ˜¾ç¤º
        updateUI();
        updateMoodIndicator();
    }

    // === ä¿®å¤å´½å´½æ‹–åŠ¨åŠŸèƒ½ ===
    function initCharacterDragFixed() {
        const character = document.getElementById('character-wrapper');
        const touchArea = document.getElementById('touch-area');
        
        character.outerHTML = character.outerHTML;
        
        const newCharacter = document.getElementById('character-wrapper');
        const newTouchArea = document.getElementById('touch-area');
        
        let isDraggingChar = false;
        let startX = 0, startY = 0, startLeft = 0, startTop = 0;

        newTouchArea.addEventListener('mousedown', handleTouchStartFixed);
        newTouchArea.addEventListener('touchstart', handleTouchStartFixed, { passive: false });

        newCharacter.addEventListener('mousedown', startDragFixed);
        newCharacter.addEventListener('touchstart', startDragTouchFixed, { passive: false });

        function handleTouchStartFixed(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const rect = newTouchArea.getBoundingClientRect();
            let clientY;
            
            if (e.type === 'touchstart') {
                clientY = e.touches[0].clientY;
            } else {
                clientY = e.clientY;
            }
            
            const relativeY = clientY - rect.top;
            const isHead = relativeY < rect.height * 0.4;
            
            handleCharacterInteract(isHead);
            
            document.addEventListener('mousemove', preventDrag);
            document.addEventListener('mouseup', removePreventDrag);
            document.addEventListener('touchmove', preventDrag);
            document.addEventListener('touchend', removePreventDrag);
        }
        
        function preventDrag(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function removePreventDrag(e) {
            document.removeEventListener('mousemove', preventDrag);
            document.removeEventListener('mouseup', removePreventDrag);
            document.removeEventListener('touchmove', preventDrag);
            document.removeEventListener('touchend', removePreventDrag);
        }

        function startDragFixed(e) {
            if (e.target.id === 'touch-area') return;
            
            isDraggingChar = true;
            
            if (e.type === 'mousedown') {
                startX = e.clientX;
                startY = e.clientY;
            }
            
            const computedStyle = window.getComputedStyle(newCharacter);
            startLeft = parseInt(computedStyle.left) || state.characterPosition.x;
            startTop = parseInt(computedStyle.top) || state.characterPosition.y;
            
            newCharacter.style.cursor = 'grabbing';
            newCharacter.style.zIndex = '20';
            
            document.addEventListener('mousemove', dragFixed);
            document.addEventListener('mouseup', stopDragFixed);
            document.addEventListener('touchmove', dragTouchFixed);
            document.addEventListener('touchend', stopDragFixed);
            
            e.preventDefault();
        }

        function startDragTouchFixed(e) {
            if (e.target.id === 'touch-area') return;
            
            if (e.touches.length === 1) {
                isDraggingChar = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                
                const computedStyle = window.getComputedStyle(newCharacter);
                startLeft = parseInt(computedStyle.left) || state.characterPosition.x;
                startTop = parseInt(computedStyle.top) || state.characterPosition.y;
                
                newCharacter.style.zIndex = '20';
                
                document.addEventListener('touchmove', dragTouchFixed);
                document.addEventListener('touchend', stopDragFixed);
                
                e.preventDefault();
            }
        }

        function dragFixed(e) {
            if (!isDraggingChar) return;
            
            const clientX = e.clientX;
            const clientY = e.clientY;
            
            const dx = clientX - startX;
            const dy = clientY - startY;
            
            let newLeft = startLeft + dx;
            let newTop = startTop + dy;
            
            const room = document.getElementById('room-view');
            const roomRect = room.getBoundingClientRect();
            const characterRect = newCharacter.getBoundingClientRect();
            
            newLeft = Math.max(10, Math.min(newLeft, roomRect.width - characterRect.width - 10));
            newTop = Math.max(10, Math.min(newTop, roomRect.height - characterRect.height - 10));
            
            newCharacter.style.left = newLeft + 'px';
            newCharacter.style.top = newTop + 'px';
            
            e.preventDefault();
        }

        function dragTouchFixed(e) {
            if (!isDraggingChar || e.touches.length !== 1) return;
            
            const clientX = e.touches[0].clientX;
            const clientY = e.touches[0].clientY;
            
            const dx = clientX - startX;
            const dy = clientY - startY;
            
            let newLeft = startLeft + dx;
            let newTop = startTop + dy;
            
            const room = document.getElementById('room-view');
            const roomRect = room.getBoundingClientRect();
            const characterRect = newCharacter.getBoundingClientRect();
            
            newLeft = Math.max(10, Math.min(newLeft, roomRect.width - characterRect.width - 10));
            newTop = Math.max(10, Math.min(newTop, roomRect.height - characterRect.height - 10));
            
            newCharacter.style.left = newLeft + 'px';
            newCharacter.style.top = newTop + 'px';
            
            e.preventDefault();
        }

        function stopDragFixed(e) {
            if (isDraggingChar) {
                isDraggingChar = false;
                newCharacter.style.cursor = 'grab';
                newCharacter.style.zIndex = '15';
                
                const computedStyle = window.getComputedStyle(newCharacter);
                state.characterPosition = {
                    x: parseInt(computedStyle.left) || 0,
                    y: parseInt(computedStyle.top) || 0
                };
                
                checkFurnitureProximity();
                
                saveState();
                
                document.removeEventListener('mousemove', dragFixed);
                document.removeEventListener('mouseup', stopDragFixed);
                document.removeEventListener('touchmove', dragTouchFixed);
                document.removeEventListener('touchend', stopDragFixed);
            }
        }
    }

    // åˆå§‹åŒ–å´½å´½ä½ç½®
    function initCharacterPosition() {
        const character = document.getElementById('character-wrapper');
        character.style.left = state.characterPosition.x + 'px';
        character.style.top = state.characterPosition.y + 'px';
    }

    // === è§¦æ‘¸äº¤äº’ä¿®å¤ ===
    function initCharacterTouch() {
        // åœ¨initCharacterDragFixedä¸­å¤„ç†
    }

    function handleCharacterInteract(isHead) {
        const img = document.getElementById('zaizai-img');

        img.classList.remove('pat-anim', 'poke-anim');
        void img.offsetWidth;

        if (isHead) {
            img.classList.add('pat-anim');
            showTouchDialogue('pat');
            affectMoodByInteraction('pat');
        } else {
            img.classList.add('poke-anim');
            showTouchDialogue('poke');
            affectMoodByInteraction('poke');
        }
        
        state.interactionCount++;
        updateTaskProgress('play_with_zaizai');
        updateTaskProgress('interact_multiple_times');
        saveState();
    }

    function showTouchDialogue(type) {
        const phase = getTrustPhase();
        const mood = getCurrentMood();
        
        let dialogues = [];
        
        if (type === 'pat') {
            switch(mood) {
                case 'anxious':
                    dialogues = [
                        "ï¼åˆ«ç¢°æˆ‘ï¼",
                        "ä¸è¦æ‘¸æˆ‘çš„å¤´...",
                        "è¯·ä¿æŒè·ç¦»",
                        "æˆ‘å®³æ€•..."
                    ];
                    break;
                case 'calm':
                    dialogues = [
                        "å—¯...",
                        "å¯ä»¥æ¥å—",
                        "ä¸è®¨åŒè¿™æ ·",
                        "ç»§ç»­å§"
                    ];
                    break;
                case 'happy':
                    dialogues = [
                        "å˜¿å˜¿ï¼Œå¥½ç—’",
                        "å–œæ¬¢è¿™æ ·",
                        "å†å¤šæ‘¸æ‘¸",
                        "å¥½èˆ’æœ"
                    ];
                    break;
                case 'excited':
                    dialogues = [
                        "å“‡ï¼å¼€å¿ƒï¼",
                        "å†æ¥å†æ¥ï¼",
                        "æœ€å–œæ¬¢è¢«æ‘¸å¤´äº†ï¼",
                        "å¥½å¹¸ç¦ï¼"
                    ];
                    break;
                default:
                    dialogues = ["...", "å—¯", "æˆ‘åœ¨"];
            }
        } else if (type === 'poke') {
            switch(mood) {
                case 'anxious':
                    dialogues = [
                        "ï¼ä¸è¦æˆ³æˆ‘ï¼",
                        "å¾ˆç—›ï¼",
                        "è¯·åœä¸‹",
                        "ä¸ºä»€ä¹ˆè¦ä¼¤å®³æˆ‘ï¼Ÿ"
                    ];
                    break;
                case 'calm':
                    dialogues = [
                        "æˆ³æˆ³...",
                        "æœ‰ç‚¹ç—’",
                        "è½»ä¸€ç‚¹",
                        "å¯ä»¥äº†"
                    ];
                    break;
                case 'happy':
                    dialogues = [
                        "å˜»å˜»ï¼Œå¥½ç—’",
                        "æˆ³æ¥æˆ³å»çš„",
                        "çœŸå¥½ç©",
                        "ç»§ç»­æˆ³"
                    ];
                    break;
                case 'excited':
                    dialogues = [
                        "å“ˆå“ˆå“ˆï¼å¥½ç—’ï¼",
                        "æˆ³æˆ³å¤§èµ›ï¼",
                        "å¥½å¥½ç©ï¼",
                        "å†æ¥ä¸€æ¬¡ï¼"
                    ];
                    break;
                default:
                    dialogues = ["...", "å—¯", "å“¦"];
            }
        }
        
        if (dialogues.length > 0) {
            const text = dialogues[Math.floor(Math.random() * dialogues.length)];
            showDialogueText(text);
        }
    }

    // æ£€æŸ¥å´½å´½æ˜¯å¦åœ¨å®¶å…·é™„è¿‘
    function checkFurnitureProximity() {
        const charWrapper = document.getElementById('character-wrapper');
        const charRect = charWrapper.getBoundingClientRect();
        
        const furnitureElements = document.querySelectorAll('#furniture-container .room-item, #window');
        
        furnitureElements.forEach(furniture => {
            const furnitureRect = furniture.getBoundingClientRect();
            const distance = Math.sqrt(
                Math.pow(charRect.left + charRect.width/2 - (furnitureRect.left + furnitureRect.width/2), 2) + 
                Math.pow(charRect.top + charRect.height/2 - (furnitureRect.top + furnitureRect.height/2), 2)
            );
            
            if (distance < 150) {
                const furnitureId = furniture.id;
                const furnitureData = furnitureItems.find(f => f.id === furnitureId) || 
                                     { id: furnitureId, name: furnitureId === 'window' ? 'çª—æˆ·' : 'å®¶å…·' };
                
                if (Math.random() < 0.3) {
                    setTimeout(() => {
                        const reactions = furnitureReactions[furnitureId.split('_')[1]] || furnitureReactions.bed;
                        if (reactions && reactions.near) {
                            showDialogueText(reactions.near[Math.floor(Math.random() * reactions.near.length)]);
                        }
                    }, 500);
                }
            }
        });
    }

    // === èƒŒæ™¯ç³»ç»Ÿ ===
    function initBackground() {
        const roomView = document.getElementById('room-view');
        
        // ç¡®ä¿currentBackgroundæœ‰å€¼
        if (!state.currentBackground) {
            state.currentBackground = 'default';
            saveState();
        }
        
        console.log('å½“å‰èƒŒæ™¯ID:', state.currentBackground); // è°ƒè¯•ç”¨
        
        // å°è¯•æ‰¾åˆ°å½“å‰èƒŒæ™¯
        let currentBg = backgrounds.find(b => b.id === state.currentBackground);
        
        if (!currentBg) {
            console.log('æœªæ‰¾åˆ°å½“å‰èƒŒæ™¯ï¼ŒæŸ¥æ‰¾é»˜è®¤èƒŒæ™¯...');
            // å¦‚æœæ‰¾ä¸åˆ°å½“å‰èƒŒæ™¯ï¼Œå¯èƒ½æ˜¯è‡ªå®šä¹‰èƒŒæ™¯è¢«åˆ é™¤äº†
            // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰èƒŒæ™¯
            if (state.currentBackground.startsWith('custom_')) {
                // å¯èƒ½æ˜¯è‡ªå®šä¹‰èƒŒæ™¯æ•°æ®ä¸¢å¤±äº†ï¼Œå›é€€åˆ°é»˜è®¤
                state.currentBackground = 'default';
                currentBg = backgrounds.find(b => b.id === 'default');
            } else {
                // ç›´æ¥ä½¿ç”¨é»˜è®¤èƒŒæ™¯
                state.currentBackground = 'default';
                currentBg = backgrounds.find(b => b.id === 'default');
            }
        }
        
        // åº”ç”¨èƒŒæ™¯
        if (currentBg) {
            console.log('åº”ç”¨èƒŒæ™¯:', currentBg.name); // è°ƒè¯•ç”¨
            applyBackground(currentBg);
        } else {
            console.error('æ— æ³•æ‰¾åˆ°ä»»ä½•èƒŒæ™¯ï¼Œä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤èƒŒæ™¯');
            // ç´§æ€¥æƒ…å†µï¼šç¡¬ç¼–ç ä¸€ä¸ªé»˜è®¤èƒŒæ™¯
            roomView.style.background = 'linear-gradient(180deg, #E3FDFD 0%, #FFFFFF 100%)';
            roomView.style.backgroundSize = 'cover';
            roomView.style.backgroundPosition = 'center';
        }
        
        renderBackgroundSelector();
    }
    
    // åˆå§‹åŒ–å…¨å±æ¨¡å¼æ”¯æŒ
    function initFullscreenSupport() {
        // æ£€æµ‹å½“å‰æ˜¯å¦å¤„äºå…¨å±æ¨¡å¼
        function checkFullscreenMode() {
            const isFullscreen = document.fullscreenElement || 
                               document.webkitFullscreenElement || 
                               document.mozFullScreenElement || 
                               document.msFullscreenElement;
            
            // æ£€æµ‹æ˜¯å¦ä¸ºæ·»åŠ åˆ°æ¡Œé¢çš„å…¨å±æ¨¡å¼
            const isStandalone = window.matchMedia('(display-mode: fullscreen)').matches || 
                                window.navigator.standalone || 
                                window.matchMedia('(standalone: true)').matches;
            
            state.inFullscreen = !!isFullscreen || isStandalone;
            
            // æ›´æ–°æ¸¸æˆå®¹å™¨æ ·å¼
            const gameContainer = document.getElementById('game-container');
            if (state.inFullscreen) {
                gameContainer.style.borderRadius = '0';
                gameContainer.style.border = 'none';
                gameContainer.style.boxShadow = 'none';
            } else {
                gameContainer.style.borderRadius = getComputedStyle(document.documentElement).getPropertyValue('--border-radius');
                gameContainer.style.border = '6px solid #fff';
                gameContainer.style.boxShadow = '0 10px 40px rgba(0,0,0,0.1)';
            }
        }
        
        // ç›‘å¬å…¨å±æ¨¡å¼å˜åŒ–äº‹ä»¶
        document.addEventListener('fullscreenchange', checkFullscreenMode);
        document.addEventListener('webkitfullscreenchange', checkFullscreenMode);
        document.addEventListener('mozfullscreenchange', checkFullscreenMode);
        document.addEventListener('MSFullscreenChange', checkFullscreenMode);
        
        // ç›‘å¬æ˜¾ç¤ºæ¨¡å¼å˜åŒ–äº‹ä»¶
        window.matchMedia('(display-mode: fullscreen)').addEventListener('change', checkFullscreenMode);
        window.matchMedia('(standalone: true)').addEventListener('change', checkFullscreenMode);
        
        // åˆå§‹æ£€æµ‹
        checkFullscreenMode();
        
        // å¤„ç†çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', checkFullscreenMode);
        
        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬ï¼Œæ”¯æŒESCé€€å‡ºå…¨å±
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        });
    }

    function applyBackground(bg) {
        const roomView = document.getElementById('room-view');
        
        if (!bg || !roomView) {
            console.error('æ— æ³•åº”ç”¨èƒŒæ™¯:', bg);
            return;
        }
        
        // æ¸…é™¤æ‰€æœ‰èƒŒæ™¯æ ·å¼
        roomView.style.background = '';
        roomView.style.backgroundImage = '';
        roomView.style.backgroundColor = '';
        
        if (bg.type === 'gradient') {
            roomView.style.background = bg.value;
            roomView.style.backgroundSize = 'cover';
            roomView.style.backgroundPosition = 'center';
            roomView.style.backgroundRepeat = 'no-repeat';
        } else if (bg.type === 'image') {
            roomView.style.backgroundImage = `url('${bg.value}')`;
            roomView.style.backgroundSize = 'cover';
            roomView.style.backgroundPosition = 'center';
            roomView.style.backgroundRepeat = 'no-repeat';
            roomView.style.backgroundColor = 'transparent';
        } else {
            // æœªçŸ¥ç±»å‹ï¼Œä½¿ç”¨é»˜è®¤
            roomView.style.background = 'linear-gradient(180deg, #E3FDFD 0%, #FFFFFF 100%)';
            roomView.style.backgroundSize = 'cover';
            roomView.style.backgroundPosition = 'center';
        }
        
        console.log('èƒŒæ™¯åº”ç”¨æˆåŠŸ:', bg.name);
    }

    function renderBackgroundSelector() {
        const container = document.getElementById('bg-grid');
        if (!container) return;
        
        container.innerHTML = '';
        
        // ç³»ç»Ÿå†…ç½®èƒŒæ™¯
        const systemBackgrounds = backgrounds.filter(bg => !bg.id.startsWith('custom_'));
        const customBackgroundsList = backgrounds.filter(bg => bg.id.startsWith('custom_'));
        
        console.log('ç³»ç»ŸèƒŒæ™¯æ•°é‡:', systemBackgrounds.length); // è°ƒè¯•ç”¨
        console.log('è‡ªå®šä¹‰èƒŒæ™¯æ•°é‡:', customBackgroundsList.length); // è°ƒè¯•ç”¨
        
        // æ¸²æŸ“ç³»ç»ŸèƒŒæ™¯
        systemBackgrounds.forEach(bg => {
            const bgItem = document.createElement('div');
            bgItem.className = `bg-item ${state.currentBackground === bg.id ? 'active' : ''}`;
            bgItem.onclick = function() {
                console.log('ç‚¹å‡»ç³»ç»ŸèƒŒæ™¯:', bg.id); // è°ƒè¯•ç”¨
                changeBackground(bg.id);
            };
            
            const preview = document.createElement('div');
            preview.className = 'bg-preview';
            
            if (bg.type === 'gradient') {
                preview.style.background = bg.value;
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
            } else if (bg.type === 'image') {
                preview.style.background = `url('${bg.value}')`;
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
            }
            
            const name = document.createElement('div');
            name.className = 'bg-name';
            name.textContent = bg.name;
            
            bgItem.appendChild(preview);
            bgItem.appendChild(name);
            container.appendChild(bgItem);
        });
        
        // æ¸²æŸ“è‡ªå®šä¹‰èƒŒæ™¯
        if (customBackgroundsList.length > 0) {
            // æ·»åŠ åˆ†éš”çº¿æ ‡é¢˜
            const separator = document.createElement('div');
            separator.style.gridColumn = '1 / span 3';
            separator.style.marginTop = '20px';
            separator.style.padding = '10px';
            separator.style.borderTop = '1px solid #eee';
            separator.style.color = '#666';
            separator.style.fontSize = '12px';
            separator.style.fontWeight = 'bold';
            separator.textContent = 'æˆ‘çš„èƒŒæ™¯';
            container.appendChild(separator);
            
            customBackgroundsList.forEach(bg => {
                const bgItem = document.createElement('div');
                bgItem.className = `bg-item ${state.currentBackground === bg.id ? 'active' : ''}`;
                bgItem.onclick = function() {
                    console.log('ç‚¹å‡»è‡ªå®šä¹‰èƒŒæ™¯:', bg.id); // è°ƒè¯•ç”¨
                    changeBackground(bg.id);
                };
                
                const preview = document.createElement('div');
                preview.className = 'bg-preview';
                
                if (bg.type === 'gradient') {
                    preview.style.background = bg.value;
                    preview.style.backgroundSize = 'cover';
                    preview.style.backgroundPosition = 'center';
                } else if (bg.type === 'image') {
                    preview.style.background = `url('${bg.value}')`;
                    preview.style.backgroundSize = 'cover';
                    preview.style.backgroundPosition = 'center';
                }
                
                const name = document.createElement('div');
                name.className = 'bg-name';
                name.textContent = bg.name;
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.className = 'bg-delete-btn';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '-5px';
                deleteBtn.style.right = '-5px';
                deleteBtn.style.background = '#FF5252';
                deleteBtn.style.color = 'white';
                deleteBtn.style.border = 'none';
                deleteBtn.style.borderRadius = '50%';
                deleteBtn.style.width = '20px';
                deleteBtn.style.height = '20px';
                deleteBtn.style.fontSize = '14px';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.zIndex = '10';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    deleteCustomBackground(bg.id);
                };
                
                bgItem.style.position = 'relative';
                bgItem.appendChild(preview);
                bgItem.appendChild(name);
                bgItem.appendChild(deleteBtn);
                container.appendChild(bgItem);
            });
        }
        

    }
	
	function deleteCustomBackground(bgId) {
	    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰èƒŒæ™¯å—ï¼Ÿ')) {
	        return;
	    }
	    
	    // ä»è‡ªå®šä¹‰èƒŒæ™¯åˆ—è¡¨ä¸­åˆ é™¤
	    const bgIndex = customBackgrounds.findIndex(bg => bg.id === bgId);
	    if (bgIndex !== -1) {
	        customBackgrounds.splice(bgIndex, 1);
	    }
	    
	    // ä»èƒŒæ™¯åˆ—è¡¨ä¸­åˆ é™¤
	    const allBgIndex = backgrounds.findIndex(bg => bg.id === bgId);
	    if (allBgIndex !== -1) {
	        backgrounds.splice(allBgIndex, 1);
	    }
	    
	    // å¦‚æœå½“å‰ä½¿ç”¨çš„æ˜¯è¢«åˆ é™¤çš„èƒŒæ™¯ï¼Œåˆ‡æ¢åˆ°é»˜è®¤èƒŒæ™¯
	    if (state.currentBackground === bgId) {
	        state.currentBackground = 'default';
	        applyBackground(backgrounds.find(b => b.id === 'default'));
	    }
	    
	    // é‡æ–°æ¸²æŸ“èƒŒæ™¯é€‰æ‹©å™¨
	    renderBackgroundSelector();
	    
	    // ä¿å­˜çŠ¶æ€
	    saveState();
	    
	    showToast("è‡ªå®šä¹‰èƒŒæ™¯å·²åˆ é™¤");
	}
	
	function validateBackgrounds() {
	    console.log('éªŒè¯èƒŒæ™¯æ•°æ®...');
	    
	    // ç¡®ä¿é»˜è®¤èƒŒæ™¯å­˜åœ¨
	    if (!backgrounds.some(bg => bg.id === 'default')) {
	        console.warn('é»˜è®¤èƒŒæ™¯ä¸¢å¤±ï¼Œé‡æ–°æ·»åŠ ');
	        backgrounds.push({
	            id: 'default',
	            name: 'é»˜è®¤',
	            type: 'gradient',
	            value: 'linear-gradient(180deg, #E3FDFD 0%, #FFFFFF 100%)'
	        });
	    }
	    
	    // ç¡®ä¿æ‰€æœ‰å†…ç½®èƒŒæ™¯éƒ½å­˜åœ¨
	    const requiredBackgrounds = [
	        { id: 'sunset', name: 'æ—¥è½', type: 'gradient', value: 'linear-gradient(180deg, #FFD3A5 0%, #FD6585 100%)' },
	        { id: 'night', name: 'æ˜Ÿç©º', type: 'gradient', value: 'linear-gradient(180deg, #0C164D 0%, #190B22 100%)' },
	        { id: 'forest', name: 'æ£®æ—', type: 'gradient', value: 'linear-gradient(180deg, #C1DFC4 0%, #DEECDD 100%)' },
	        { id: 'ocean', name: 'æµ·æ´‹', type: 'gradient', value: 'linear-gradient(180deg, #A1C4FD 0%, #C2E9FB 100%)' },
	        { id: 'pastel', name: 'é©¬å¡é¾™', type: 'gradient', value: 'linear-gradient(180deg, #FFD6E7 0%, #FFE6D6 100%)' }
	    ];
	    
	    requiredBackgrounds.forEach(requiredBg => {
	        if (!backgrounds.some(bg => bg.id === requiredBg.id)) {
	            console.warn('èƒŒæ™¯ä¸¢å¤±ï¼Œé‡æ–°æ·»åŠ :', requiredBg.name);
	            backgrounds.push(requiredBg);
	        }
	    });
	    
	    console.log('èƒŒæ™¯éªŒè¯å®Œæˆï¼Œå½“å‰èƒŒæ™¯æ•°é‡:', backgrounds.length);
	}
	
	// åœ¨loadStateå‡½æ•°ä¸­è°ƒç”¨
	// åœ¨loadStateå‡½æ•°çš„é€‚å½“ä½ç½®æ·»åŠ ï¼š
	validateBackgrounds();

    function changeBackground(bgId) {
        console.log('æ”¹å˜èƒŒæ™¯åˆ°:', bgId); // è°ƒè¯•ç”¨
        
        const bg = backgrounds.find(b => b.id === bgId);
        if (!bg) {
            console.error('èƒŒæ™¯æœªæ‰¾åˆ°:', bgId);
            showToast("èƒŒæ™¯ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤èƒŒæ™¯");
            bgId = 'default';
            return changeBackground('default');
        }
        
        // ä¿å­˜æ—§èƒŒæ™¯ç”¨äºæ¯”è¾ƒ
        const oldBgId = state.currentBackground;
        
        state.currentBackground = bgId;
        applyBackground(bg);
        
        // æ›´æ–°èƒŒæ™¯é€‰æ‹©å™¨
        renderBackgroundSelector();
        
        // ä¿å­˜çŠ¶æ€
        saveState();
        
        // å´½å´½çš„ååº”ï¼ˆåªåœ¨åˆ‡æ¢ä¸åŒèƒŒæ™¯æ—¶ï¼‰
        if (oldBgId !== bgId) {
            setTimeout(() => {
                const reactions = [
                    "æˆ¿é—´å˜æ¼‚äº®äº†ï¼",
                    "æ–°çš„èƒŒæ™¯ï¼å–œæ¬¢ï¼",
                    "é¢œè‰²å¥½ç¾",
                    "è°¢è°¢ä½ è£…é¥°æˆ¿é—´"
                ];
                showDialogueText(reactions[Math.floor(Math.random() * reactions.length)]);
                updateMood(5);
            }, 500);
        }
        
        showToast(`èƒŒæ™¯å·²æ›´æ¢ä¸º: ${bg.name}`);
    }

    function handleBackgroundUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.match('image.*')) {
            showToast("è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶");
            return;
        }
        
        if (file.size > 3 * 1024 * 1024) {
            showToast("å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡3MB");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const timestamp = Date.now();
            const customBg = {
                id: 'custom_' + timestamp,
                name: 'è‡ªå®šä¹‰èƒŒæ™¯',
                type: 'image',
                value: e.target.result
            };
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è‡ªå®šä¹‰èƒŒæ™¯ï¼Œé¿å…é‡å¤æ·»åŠ 
            const existingIndex = customBackgrounds.findIndex(bg => 
                bg.value === e.target.result || bg.id === customBg.id
            );
            
            if (existingIndex === -1) {
                // æ·»åŠ åˆ°è‡ªå®šä¹‰èƒŒæ™¯åˆ—è¡¨
                customBackgrounds.push(customBg);
                
                // æ·»åŠ åˆ°èƒŒæ™¯åˆ—è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                if (!backgrounds.some(bg => bg.id === customBg.id)) {
                    backgrounds.push(customBg);
                }
            } else {
                // ä½¿ç”¨å·²å­˜åœ¨çš„è‡ªå®šä¹‰èƒŒæ™¯
                customBg = customBackgrounds[existingIndex];
            }
            
            // è®¾ç½®å½“å‰èƒŒæ™¯
            state.currentBackground = customBg.id;
            
            // åº”ç”¨èƒŒæ™¯
            applyBackground(customBg);
            
            // æ›´æ–°èƒŒæ™¯é€‰æ‹©å™¨
            renderBackgroundSelector();
            
            // å…³é—­æ¨¡æ€æ¡†
            closeModal('bg-modal');
            
            showToast("è‡ªå®šä¹‰èƒŒæ™¯å·²åº”ç”¨");
            
            // ä¿å­˜çŠ¶æ€
            saveState();
            
            // å´½å´½çš„ååº”
            setTimeout(() => {
                const reactions = [
                    "èƒŒæ™¯æ¢äº†ï¼å¥½çœ‹ï¼",
                    "æ–°çš„èƒŒæ™¯å›¾ï¼Œå–œæ¬¢ï¼",
                    "æˆ¿é—´å˜æ ·äº†å‘¢",
                    "è°¢è°¢ä½ è£…é¥°æˆ¿é—´"
                ];
                showDialogueText(reactions[Math.floor(Math.random() * reactions.length)]);
                updateMood(5);
            }, 500);
            
            // è®°å½•åˆ°è§‚æµ‹è®°å½•
            recordSystem.addRecord(
                'æ›´æ¢èƒŒæ™¯',
                `è§‚æµ‹è€…æ›´æ¢äº†æˆ¿é—´èƒŒæ™¯ä¸ºè‡ªå®šä¹‰å›¾ç‰‡ã€‚`,
                ['è®¾ç½®', 'èƒŒæ™¯']
            );
        };
        reader.readAsDataURL(file);
    }
	
	function refreshBackground() {
	    const roomView = document.getElementById('room-view');
	    const bg = backgrounds.find(b => b.id === state.currentBackground);
	    
	    if (bg) {
	        applyBackground(bg);
	    } else {
	        // å›é€€åˆ°é»˜è®¤èƒŒæ™¯
	        state.currentBackground = 'default';
	        applyBackground(backgrounds.find(b => b.id === 'default'));
	        saveState();
	    }
	}

    // === å¤©æ°”ç³»ç»Ÿ ===
    function initWeather() {
        const now = Date.now();
        if (!state.lastWeatherChange || now - state.lastWeatherChange > 3600000) {
            changeWeatherRandomly();
        } else {
            updateWeatherDisplay();
        }
    }

    function changeWeatherRandomly() {
        const weatherKeys = Object.keys(weatherTypes);
        const newWeather = weatherKeys[Math.floor(Math.random() * weatherKeys.length)];
        const oldWeather = state.currentWeather;
        state.currentWeather = newWeather;
        state.lastWeatherChange = Date.now();
        
        // è®°å½•å¤©æ°”å˜åŒ–åˆ°å†å²è®°å½•ä¸­
        if (!state.weatherHistory) {
            state.weatherHistory = [];
        }
        // åªè®°å½•ä¸åŒçš„å¤©æ°”
        if (oldWeather !== newWeather) {
            state.weatherHistory.push(newWeather);
            // é™åˆ¶å†å²è®°å½•é•¿åº¦ï¼Œé¿å…å ç”¨è¿‡å¤šç©ºé—´
            if (state.weatherHistory.length > 20) {
                state.weatherHistory = state.weatherHistory.slice(-20);
            }
            // æ›´æ–°å¤©æ°”ä½“éªŒè¿›åº¦ä»»åŠ¡
            updateTaskProgress('try_different_weather');
        }
        
        updateWeatherDisplay();
        
        const weatherEffect = weatherTypes[newWeather].moodEffect;
        updateMood(weatherEffect);
        
        if (oldWeather !== newWeather) {
            recordSystem.addRecord(
                `å¤©æ°”å˜åŒ–ï¼š${weatherTypes[oldWeather]?.name || 'æœªçŸ¥'} â†’ ${weatherTypes[newWeather].name}`,
                `è§‚æµ‹ç¯å¢ƒå¤©æ°”å‘ç”Ÿå˜åŒ–ã€‚æ–°çš„å¤©æ°”çŠ¶å†µï¼š${weatherTypes[newWeather].name}ã€‚å¯èƒ½å½±å“è§‚æµ‹å¯¹è±¡æƒ…ç»ªã€‚`,
                ['ç¯å¢ƒ', 'å¤©æ°”']
            );
        }
        
        saveState();
    }

    function updateWeatherDisplay() {
        const weather = weatherTypes[state.currentWeather];
        const weatherEffect = document.getElementById('weather-effect');
        
        weatherEffect.className = 'weather-effect';
        
        if (weather.effectClass) {
            weatherEffect.classList.add(weather.effectClass);
        }
    }

    function interactWithWindow() {
        const weather = weatherTypes[state.currentWeather];
        const responses = weather.windowResponses;
        const text = responses[Math.floor(Math.random() * responses.length)];
        
        showDialogueText(text);
        
        addTrust(0.5);
        
        if (Math.random() < 0.1) {
            setTimeout(() => {
                changeWeatherRandomly();
                showToast(`å¤©æ°”å˜æˆäº†${weatherTypes[state.currentWeather].emoji}${weatherTypes[state.currentWeather].name}`);
            }, 1000);
        }
    }

    // === å¿ƒæƒ…ç³»ç»Ÿ - ä¼˜åŒ–ï¼šæ–°å¢å¿ƒæƒ…è¡°å‡å’Œç¨³å®šæ€§ ===
    function startMoodDecayTimer() {
        if (moodDecayTimer) clearInterval(moodDecayTimer);
        
        moodDecayTimer = setInterval(() => {
            const now = Date.now();
            const moodDuration = now - state.moodStartTime;
            const currentMood = moodTypes[state.currentMood];
            
            if (currentMood && currentMood.maxDuration) {
                // å¦‚æœå¿ƒæƒ…æŒç»­æ—¶é—´è¶…è¿‡æœ€å¤§æŒç»­æ—¶é—´ï¼Œå¼€å§‹è¡°å‡
                if (moodDuration > currentMood.maxDuration) {
                    // é€‚é…æ–°çš„å¿ƒæƒ…å€¼åŸºæ•°ï¼Œè°ƒæ•´è¡°å‡ç‡
                    const decayAmount = currentMood.decayRate * 5 * (moodDuration - currentMood.maxDuration) / 1000;
                    state.moodValue = Math.max(0, state.moodValue - decayAmount);
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢å¿ƒæƒ…ï¼ˆé€‚é…æ–°çš„å¿ƒæƒ…å€¼åŸºæ•°ï¼‰
                    if (state.moodValue <= 100) {
                        if (state.currentMood === 'excited') {
                            updateMoodTo('happy');
                        } else if (state.currentMood === 'happy') {
                            updateMoodTo('calm');
                        } else if (state.currentMood === 'calm') {
                            updateMoodTo('sad');
                        }
                    }
                }
            }
            
            // æ¯5ç§’å°å¹…éšæœºæ³¢åŠ¨ï¼ˆé€‚é…æ–°çš„å¿ƒæƒ…å€¼åŸºæ•°ï¼‰
            if (Math.random() < 0.2) {
                const randomChange = (Math.random() - 0.5) * 2.5;
                state.moodValue = Math.max(0, Math.min(500, state.moodValue + randomChange));
            }
            
        }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    }

    function updateMoodIndicator() {
        const indicator = document.getElementById('mood-indicator');
        const moodEmoji = document.getElementById('mood-emoji');
        const moodText = document.getElementById('mood-text');
        
        const mood = moodTypes[state.currentMood];
        if (mood) {
            indicator.style.display = 'flex';
            moodEmoji.textContent = mood.emoji;
            moodText.textContent = mood.name;
            indicator.style.background = mood.color + '30';
            indicator.style.border = `1px solid ${mood.color}`;
        } else {
            indicator.style.display = 'none';
        }
    }

    function updateMoodTo(newMood) {
        if (state.currentMood === newMood) return;
        
        const oldMood = state.currentMood;
        state.currentMood = newMood;
        state.moodStartTime = Date.now();
        state.moodDuration = 0;
        
        updateMoodIndicator();
        recordSystem.recordMoodChange(oldMood, newMood);
        
        if (Math.random() < 0.3) {
            checkDiaryGeneration();
        }
        
        const mood = moodTypes[newMood];
        showToast(`å´½å´½çš„å¿ƒæƒ…å˜æˆäº†${mood.emoji}${mood.name}`);
        
        saveState();
    }

    function updateMood(change) {
        const oldMood = state.currentMood;
        const oldMoodValue = state.moodValue;
        
        const now = Date.now();
        
        // ä¼˜åŒ–é¢‘ç¹æˆ³åŠ¨çš„å†·å´æœºåˆ¶ - åŠ¨æ€è¡°å‡æ•ˆæœ
        const timeSinceLastChange = now - state.moodChangeCooldown;
        const cooldownFactor = Math.min(1, Math.max(0.1, timeSinceLastChange / 3000));
        
        // è¿ç»­äº¤äº’æƒ©ç½š - è¶Šé¢‘ç¹æˆ³åŠ¨ï¼Œæ•ˆæœè¶Šä½
        if (timeSinceLastChange < 2000) {
            // éå¸¸é¢‘ç¹çš„äº¤äº’ï¼Œæ•ˆæœå¤§å¹…é™ä½
            change *= 0.3 * cooldownFactor;
        } else if (timeSinceLastChange < 5000) {
            // é¢‘ç¹äº¤äº’ï¼Œæ•ˆæœé™ä½
            change *= 0.6 * cooldownFactor;
        }
        
        state.moodChangeCooldown = now;
        
        // å¢å¼ºä¿¡ä»»å€¼å¯¹å¿ƒæƒ…å€¼å¢é•¿çš„å½±å“
        const trustFactor = state.trust / 100;
        let trustModifier = 1;
        if (state.trust < 30) {
            trustModifier = 0.5 + (state.trust / 30) * 0.5; // 0.5 - 1.0
        } else if (state.trust > 70) {
            trustModifier = 1.0 + ((state.trust - 70) / 30) * 0.5; // 1.0 - 1.5
        }
        change *= trustModifier;
        
        // å¢åŠ å¤©æ°”å˜åŒ–å¯¹å¿ƒæƒ…å€¼çš„åŠ¨æ€å½±å“
        const weatherEffect = weatherTypes[state.currentWeather].moodEffect;
        const weatherModifier = 1 + (weatherEffect / 100);
        change *= weatherModifier;
        
        // åº”ç”¨å¤©æ°”çš„åŸºç¡€å½±å“ï¼ˆé€‚é…æ–°çš„å¿ƒæƒ…å€¼åŸºæ•°ï¼‰
        state.moodValue += weatherEffect * 0.5;
        
        // è°ƒæ•´å¿ƒæƒ…å€¼å¢é•¿æ›²çº¿ï¼Œä½¿å…¶æ›´åŠ å¹³æ»‘è‡ªç„¶
        // æ¥è¿‘æ»¡å€¼æ—¶å¢é•¿æ›´æ…¢
        const moodValueFactor = 1 - (state.moodValue / 1000);
        change *= Math.max(0.5, moodValueFactor);
        
        // åº”ç”¨å¿ƒæƒ…å˜åŒ–ï¼ˆå¿ƒæƒ…å€¼åŸºæ•°åŠ å¤§åˆ°0-500ï¼‰
        state.moodValue = Math.max(0, Math.min(500, state.moodValue + change));
        
        let newMood = state.currentMood;
        
        // ä¼˜åŒ–å¿ƒæƒ…åˆ¤å®šé€»è¾‘ï¼Œè°ƒæ•´å¹³é™çŠ¶æ€ä¸ºæœ€å¤§åŒºé—´
        // æ–°çš„çŠ¶æ€åˆ’åˆ†ï¼š
        // - è­¦æƒ• (anxious): < 100
        // - éš¾è¿‡ (sad): 100-200
        // - å¹³é™ (calm): 200-400ï¼ˆæœ€å¤§åŒºé—´ï¼‰
        // - å¼€å¿ƒ (happy): 400-450
        // - å…´å¥‹ (excited): > 450
        if (state.moodValue >= 450) {
            newMood = 'excited';
        } else if (state.moodValue >= 400) {
            newMood = 'happy';
        } else if (state.moodValue >= 200) {
            newMood = 'calm'; // æœ€å¤§åŒºé—´
        } else if (state.moodValue >= 100) {
            newMood = 'sad';
        } else {
            newMood = 'anxious';
        }
        
        if (newMood !== state.currentMood) {
            updateMoodTo(newMood);
        }
        
        if (change > 0) {
            state.consecutivePositiveInteractions++;
            state.consecutiveNegativeInteractions = 0;
            
            // è°ƒæ•´è¿ç»­æ­£é¢äº¤äº’çš„å¥–åŠ±æœºåˆ¶ï¼ˆé€‚é…æ–°çš„å¿ƒæƒ…å€¼åŸºæ•°ï¼‰
            if (state.consecutivePositiveInteractions >= 5) {
                const bonus = Math.min(15, (state.consecutivePositiveInteractions - 4) * 2.5);
                state.moodValue = Math.min(500, state.moodValue + bonus);
                if (state.consecutivePositiveInteractions === 5) {
                    showToast("è¿ç»­çš„å…³çˆ±è®©å´½å´½å¾ˆå¼€å¿ƒï¼");
                }
            }
        } else if (change < 0) {
            state.consecutiveNegativeInteractions++;
            state.consecutivePositiveInteractions = 0;
            
            // è°ƒæ•´è¿ç»­è´Ÿé¢äº¤äº’çš„æƒ©ç½šæœºåˆ¶ï¼ˆé€‚é…æ–°çš„å¿ƒæƒ…å€¼åŸºæ•°ï¼‰
            if (state.consecutiveNegativeInteractions >= 5) {
                const penalty = Math.min(15, (state.consecutiveNegativeInteractions - 4) * 2.5);
                state.moodValue = Math.max(0, state.moodValue - penalty);
                if (state.consecutiveNegativeInteractions === 5) {
                    showToast("å´½å´½æ„Ÿåˆ°å¾ˆå—ä¼¤...");
                }
            }
        }
        
        saveState();
    }

    function getCurrentMood() {
        return state.currentMood;
    }

    function affectMoodByInteraction(type) {
        let change = 0;
        let trustBonus = 0;
        
        switch(type) {
            case 'pat':
                change = +8;
                trustBonus = 0.3;
                break;
            case 'poke':
                change = +5;
                trustBonus = 0.2;
                break;
            case 'feed':
                change = +12;
                trustBonus = 0.5;
                break;
            case 'gift':
                change = +15;
                trustBonus = 0.8;
                break;
            case 'ignore':
                change = -5;
                break;
            case 'hurt':
                change = -20;
                trustBonus = -1;
                break;
            case 'chat':
                change = +6;
                trustBonus = 0.4;
                break;
        }
        
        const currentMood = getCurrentMood();
        
        // ä¼˜åŒ–ä¸åŒå¿ƒæƒ…çŠ¶æ€ä¸‹çš„äº¤äº’æ•ˆæœ
        if (currentMood === 'sad' || currentMood === 'anxious') {
            // ä½å¿ƒæƒ…çŠ¶æ€ä¸‹ï¼Œç§¯æäº¤äº’æ•ˆæœå¢å¼º
            change *= 1.3;
        } else if (currentMood === 'happy' || currentMood === 'excited') {
            // é«˜å¿ƒæƒ…çŠ¶æ€ä¸‹ï¼Œç§¯æäº¤äº’æ•ˆæœå‡å¼±
            change *= 0.7;
        }
        
        updateMood(change);
        
        // ä¿¡ä»»å€¼å¥–åŠ±ä¹Ÿä¸äº¤äº’é¢‘ç‡ç›¸å…³
        const now = Date.now();
        const timeSinceLastChange = now - state.moodChangeCooldown;
        if (timeSinceLastChange < 2000) {
            trustBonus *= 0.5;
        }
        
        if (trustBonus !== 0) {
            addTrust(trustBonus);
        }
    }

    // === å¿ƒç†æ´»åŠ¨ç³»ç»Ÿ ===
    function getTrustPhase() {
        if (state.trust >= 85) return 'p5';
        else if (state.trust >= 70) return 'p4';
        else if (state.trust >= 50) return 'p3';
        else if (state.trust >= 30) return 'p2';
        else if (state.trust >= 15) return 'p1';
        else return 'p0';
    }

    function showDialogue(type) {
        const phase = getTrustPhase();
        const mood = getCurrentMood();
        const moodResponses = mentalActivities[phase] ? mentalActivities[phase][type] : null;
        
        if (moodResponses && moodResponses[mood] && moodResponses[mood].length > 0) {
            const list = moodResponses[mood];
            const text = list[Math.floor(Math.random() * list.length)];
            showDialogueText(text);
        } else {
            const defaultResponses = ["...", "å—¯...", "æˆ‘åœ¨å¬", "æ€ä¹ˆäº†ï¼Ÿ", "å“¦..."];
            const text = defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
            showDialogueText(text);
        }
    }

    function showSpecialDialogue(text) {
        showDialogueText(text);
    }

    function showDialogueText(text) {
        const bubble = document.getElementById('bubble');
        bubble.innerText = text;
        bubble.style.opacity = 1;
        bubble.style.top = "-110px";
        
        setTimeout(() => {
            bubble.style.opacity = 0;
            bubble.style.top = "-100px";
        }, 3500);
    }

    // === å¯¹è¯ç³»ç»Ÿ ===
    function renderChat() {
        const container = document.getElementById('chat-container');
        container.innerHTML = '';
        
        state.chatHistory.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${msg.sender}-message`;
            
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${msg.sender}-bubble`;
            bubble.innerText = msg.text;
            
            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
        });
        
        container.scrollTop = container.scrollHeight;
    }

    function sendChat() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        
        if (text === '') return;
        
        state.chatHistory.push({
            sender: 'user',
            text: text,
            time: new Date().toLocaleTimeString()
        });
        
        input.value = '';
        
        setTimeout(() => {
            const response = getChatResponse(text);
            state.chatHistory.push({
                sender: 'zaizai',
                text: response,
                time: new Date().toLocaleTimeString()
            });
            
            renderChat();
            affectMoodByInteraction('chat');
            saveState();
        }, 1000 + Math.random() * 1000);
        
        renderChat();
        saveState();
    }

    function getChatResponse(userMessage) {
        const phase = getTrustPhase();
        const mood = getCurrentMood();
        const responses = chatResponses[phase];
        const lowerMsg = userMessage.toLowerCase();
        
        if (!responses) {
            const defaultResponses = ["...", "å—¯", "æˆ‘åœ¨å¬", "è¿™æ ·å•Š"];
            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        }
        
        if (responses.special) {
            for (const [keyword, moodResponses] of Object.entries(responses.special)) {
                if (lowerMsg.includes(keyword.toLowerCase()) && moodResponses[mood]) {
                    return moodResponses[mood][Math.floor(Math.random() * moodResponses[mood].length)];
                }
            }
        }
        
        if (lowerMsg.includes('ï¼Ÿ') || lowerMsg.includes('?') || 
            lowerMsg.includes('ä¸ºä»€ä¹ˆ') || lowerMsg.includes('æ€ä¹ˆ') || 
            lowerMsg.includes('ä»€ä¹ˆ') || lowerMsg.includes('å¦‚ä½•') ||
            lowerMsg.includes('å—') || lowerMsg.includes('å‘¢')) {
            if (responses.questions && responses.questions[mood]) {
                return responses.questions[mood][Math.floor(Math.random() * responses.questions[mood].length)];
            }
        }
        
        if (lowerMsg.includes('ä½ å¥½') || lowerMsg.includes('å—¨') || lowerMsg.includes('hello') || 
            lowerMsg.includes('hi') || lowerMsg.includes('æ—©') || lowerMsg.includes('æ™š') ||
            lowerMsg.includes('å“ˆå–½') || lowerMsg.includes('å–‚')) {
            if (responses.greetings && responses.greetings[mood]) {
                return responses.greetings[mood][Math.floor(Math.random() * responses.greetings[mood].length)];
            }
        }
        
        if (lowerMsg.includes('æˆ‘') || lowerMsg.includes('ä½ ') || lowerMsg.includes('ä»–') ||
            lowerMsg.includes('å¥¹') || lowerMsg.includes('å®ƒ')) {
            if (responses.statements && responses.statements[mood]) {
                return responses.statements[mood][Math.floor(Math.random() * responses.statements[mood].length)];
            }
        }
        
        if (responses.statements && responses.statements[mood]) {
            return responses.statements[mood][Math.floor(Math.random() * responses.statements[mood].length)];
        }
        
        const fallbackResponses = ["...", "å—¯", "æˆ‘åœ¨å¬", "è¿™æ ·å•Š", "å“¦", "æ˜ç™½äº†"];
        return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
    }

    // å´½å´½ä¸»åŠ¨å¯¹è¯
    function startAutoChat() {
        if (autoChatTimer) clearInterval(autoChatTimer);
        
        autoChatTimer = setInterval(() => {
            const now = Date.now();
            
            if (now - state.lastMemoCheck > 30000) {
                checkMemoReminder();
                state.lastMemoCheck = now;
            }
            
            if (now - state.lastActiveChat > 45000 && Math.random() < 0.25) {
                const phase = getTrustPhase();
                const activeChatList = activeChats[phase];
                
                if (activeChatList && activeChatList.length > 0) {
                    const chat = activeChatList[0];
                    if (Math.random() < chat.chance) {
                        let message;
                        
                        const hasUncompletedMemos = state.memos.some(memo => !memo.completed);
                        if (hasUncompletedMemos && state.trust >= 30 && chat.memoMessages && !state.memoReminded) {
                            message = chat.memoMessages[Math.floor(Math.random() * chat.memoMessages.length)];
                            state.memoReminded = true;
                        } else {
                            message = chat.messages[Math.floor(Math.random() * chat.messages.length)];
                        }
                        
                        state.chatHistory.push({
                            sender: 'zaizai',
                            text: message,
                            time: new Date().toLocaleTimeString()
                        });
                        
                        if (document.getElementById('chat-modal').style.display === 'flex') {
                            renderChat();
                        }
                        
                        state.lastActiveChat = now;
                        saveState();
                    }
                }
            }
            
            autoUseFurniture();
            
            if (Math.random() < 0.08) {
                const moodChange = Math.random() < 0.5 ? -1 : +1;
                updateMood(moodChange);
            }
            
            if (Math.random() < 0.02) {
                changeWeatherRandomly();
            }
            
        }, 15000);
    }

    // === å¤‡å¿˜å½•ç³»ç»Ÿ ===
    function addMemo() {
        const input = document.getElementById('memo-input');
        const text = input.value.trim();
        
        if (text === '') {
            showToast("è¯·è¾“å…¥å†…å®¹");
            return;
        }
        
        if (state.memos.length >= 10) {
            showToast("å¤‡å¿˜å½•æœ€å¤šåªèƒ½æ·»åŠ 10æ¡");
            return;
        }
        
        const newMemo = {
            id: Date.now().toString(),
            text: text,
            completed: false,
            createdAt: new Date().toLocaleString()
        };
        
        state.memos.push(newMemo);
        input.value = '';
        
        renderMemos();
        saveState();
        showToast("å¤‡å¿˜å½•å·²æ·»åŠ ");
        
        state.memoReminded = false;
        
        if (state.trust >= 20 && Math.random() < 0.3) {
            setTimeout(() => {
                const responses = [
                    "ä½ å†™äº†æ–°çš„å¤‡å¿˜å½•å‘¢",
                    "æˆ‘ä¼šå¸®ä½ è®°ä½çš„",
                    "è¦è®°å¾—å®Œæˆå“¦",
                    "æˆ‘çœ‹åˆ°äº†ä½ å†™çš„ä¸œè¥¿"
                ];
                showDialogueText(responses[Math.floor(Math.random() * responses.length)]);
            }, 1000);
        }
    }

    function renderMemos() {
        const container = document.getElementById('memo-list');
        
        if (!state.memos || state.memos.length === 0) {
            container.innerHTML = '<div class="empty-memo">è¿˜æ²¡æœ‰å¤‡å¿˜å½•ï¼Œæ·»åŠ ç¬¬ä¸€æ¡å§ï¼</div>';
            return;
        }
        
        container.innerHTML = state.memos.map(memo => `
            <div class="memo-item ${memo.completed ? 'completed' : ''}" data-id="${memo.id}">
                <div class="memo-content">${memo.text}</div>
                <div class="memo-actions">
                    ${memo.completed ? 
                        '<span class="memo-completed">å·²å®Œæˆ</span>' : 
                        `<button class="memo-action-btn complete" onclick="toggleMemo('${memo.id}')">å®Œæˆ</button>`
                    }
                    <button class="memo-action-btn delete" onclick="deleteMemo('${memo.id}')">åˆ é™¤</button>
                </div>
            </div>
        `).join('');
    }

    function toggleMemo(memoId) {
        const memo = state.memos.find(m => m.id.toString() === memoId);
        
        if (memo) {
            memo.completed = !memo.completed;
            renderMemos();
            saveState();
            
            if (memo.completed) {
                showToast("ä»»åŠ¡å®Œæˆï¼");
                affectMoodByInteraction('pat');
                addTrust(0.5);
            } else {
                showToast("å·²æ ‡è®°ä¸ºæœªå®Œæˆ");
            }
        }
    }

    function deleteMemo(memoId) {
        const memoIndex = state.memos.findIndex(m => m.id.toString() === memoId);
        
        if (memoIndex !== -1) {
            state.memos.splice(memoIndex, 1);
            renderMemos();
            saveState();
            showToast("å¤‡å¿˜å½•å·²åˆ é™¤");
        }
    }

    function checkMemoReminder() {
        const hasUncompletedMemos = state.memos.some(memo => !memo.completed);
        
        if (hasUncompletedMemos && !state.memoReminded && Math.random() < 0.3) {
            state.memoReminded = false;
        }
    }

    // === ä¿¡ä»»å€¼ç³»ç»Ÿ ===
    function addTrust(val) {
        const oldTrust = state.trust;
        const now = Date.now();
        
        if (val > 0) {
            if (state.trustCooldown && now - state.lastTrustGain < 10000) {
                val *= 0.3;
            }
            
            const trustFactor = Math.max(0.1, 1 - (state.trust / 100) * 0.8);
            val *= trustFactor;
            
            const mood = getCurrentMood();
            if (mood === 'happy' || mood === 'excited') {
                val *= 1.5;
            } else if (mood === 'sad' || mood === 'anxious') {
                val *= 0.5;
            }
            
            val = Math.round(val * 10) / 10;
            
            if (val < 0.1 && val > 0) {
                val = 0.1;
            }
        }
        
        state.trust = Math.min(100, state.trust + val);
        
        if (val > 0) {
            state.lastTrustGain = now;
            state.trustCooldown = true;
            
            setTimeout(() => {
                state.trustCooldown = false;
            }, 10000);
        }
        
        recordSystem.recordTrustChange(oldTrust, state.trust);
        
        updateUI();
        checkStoryProgress();
        
        // æ›´æ–°ä¿¡ä»»å€¼ç›¸å…³çš„è¿›åº¦ä»»åŠ¡
        updateTaskProgress('increase_trust');
        
        checkItemUnlocks();
        saveState();
    }

    // === æ—¥ç¨‹è¡ŒåŠ¨ç³»ç»Ÿ ===
    function doSchedule(actionId, baseReward, timeCost) {
        const action = scheduleActions.find(a => a.id === actionId);
        if (!action) return;
        
        if (state.hunger <= action.hungerCost) {
            showToast("å´½å´½å¤ªé¥¿äº†ï¼Œæ— æ³•è¡ŒåŠ¨ï¼");
            return;
        }
        
        const now = Date.now();
        if (state.lastScheduleTime && now - state.lastScheduleTime < 30000) {
            showToast("å´½å´½éœ€è¦ä¼‘æ¯ä¸€ä¸‹...");
            return;
        }
        
        state.lastScheduleTime = now;
        
        state.money += action.reward;
        state.hunger = Math.max(0, state.hunger - action.hungerCost);
        addTrust(action.trustGain);
        
        let eventMessage = "";
        if (action.risk > 0 && Math.random() < action.risk) {
            const events = [
                { message: "å´½å´½åœ¨æ¢ç´¢ä¸­å—äº†ç‚¹è½»ä¼¤", effect: { hunger: -5, mood: -10 } },
                { message: "å´½å´½å‘ç°äº†ä¸€äº›æœ‰ç”¨çš„ä¸œè¥¿", effect: { money: 30, mood: +5 } },
                { message: "å´½å´½é‡åˆ°äº†å¥‡æ€ªçš„ç°è±¡ï¼Œä½†å®‰å…¨è¿”å›", effect: { trust: 2, mood: -5 } },
                { message: "å´½å´½å‘ç°äº†æ–°çš„æ—¥è®°ç´ æ", effect: { mood: +8 } }
            ];
            const event = events[Math.floor(Math.random() * events.length)];
            eventMessage = `ï¼ˆ${event.message}ï¼‰`;
            
            if (event.effect.money) state.money += event.effect.money;
            if (event.effect.hunger) state.hunger = Math.max(0, state.hunger + event.effect.hunger);
            if (event.effect.trust) addTrust(event.effect.trust);
            if (event.effect.mood) updateMood(event.effect.mood);
        }
        
        let rewardText = action.reward > 0 ? `è·å¾— ${action.reward}ğŸ’°` : '';
        let trustText = action.trustGain > 0 ? `ä¿¡ä»»å€¼+${action.trustGain.toFixed(1)}` : '';
        let message = `è¡ŒåŠ¨ç»“æŸï¼Œ${rewardText} ${trustText} ${eventMessage}`.trim();
        showToast(message);
        
        // å®é™…å®Œæˆæ—¥ç¨‹åæ›´æ–°ä»»åŠ¡è¿›åº¦
        updateTaskProgress('complete_schedule');
        
        if (Math.random() > 0.6) checkDiaryGeneration();
        
        checkItemUnlocks();
        
        showDialogue('idle');
        
        if (actionId === 'explore' && Math.random() < action.risk) {
            affectMoodByInteraction('hurt');
        } else if (actionId === 'talk') {
            affectMoodByInteraction('chat');
        } else {
            affectMoodByInteraction('pat');
        }
        
        updateUI();
        checkStoryProgress();
        saveState();
        
        recordSystem.addRecord(
            `æ—¥ç¨‹è¡ŒåŠ¨ï¼š${action.name}`,
            `è§‚æµ‹å¯¹è±¡æ‰§è¡Œäº†${action.name}è¡ŒåŠ¨ã€‚è€—æ—¶ï¼š${action.time}å°æ—¶ã€‚ç»“æœï¼š${message}`,
            ['æ—¥ç¨‹', 'è¡ŒåŠ¨']
        );
    }

    // === æˆ¿é—´æ”¹é€ åŠŸèƒ½ - ä¿®å¤ï¼šç»¿æ¤æ”¹ä¸ºå¯è´­ä¹° ===
    function renderRoomShop() {
        const list = document.getElementById('room-shop-list');
        const availableItems = furnitureItems.filter(item => 
            !state.purchasedFurniture.includes(item.id)
        );
        
        if (availableItems.length === 0) {
            list.innerHTML = "<div style='text-align:center;color:#ccc;margin-top:20px'>æ‰€æœ‰å®¶å…·éƒ½å·²è´­ä¹°ï¼</div>";
            return;
        }
        
        list.innerHTML = availableItems.map(item => `
            <div class="furniture-item">
                <div class="furniture-header">
                    <span class="furniture-title">${item.emoji} ${item.name}</span>
                    <span class="furniture-price">${item.price}ğŸ’°</span>
                </div>
                <div class="furniture-desc">${item.desc}</div>
                <div class="furniture-effect">æ•ˆæœï¼š${item.effect}</div>
                <button class="btn-action" style="width:100%; margin-top:10px;" onclick="buyFurniture('${item.id}')">è´­ä¹°</button>
            </div>
        `).join('');
    }

    function buyFurniture(furnitureId) {
        const furniture = furnitureItems.find(f => f.id === furnitureId);
        if (!furniture) return;
        
        if (state.money >= furniture.price) {
            state.money -= furniture.price;
            state.purchasedFurniture.push(furnitureId);
            
            if (!state.firstFurnitureBought) {
                state.firstFurnitureBought = true;
                recordSystem.recordKeyInteraction('first_furniture', furniture.name);
            }
            
            // å®é™…è´­ä¹°å®¶å…·åæ›´æ–°ä»»åŠ¡è¿›åº¦
            const buyFurnitureTask = state.tasks.find(t => t.id === 'buy_furniture');
            if (buyFurnitureTask) {
                buyFurnitureTask.progress = 1;
                renderTaskList();
            }
            renderFurniture();
            
            showToast(`è´­ä¹°æˆåŠŸï¼${furniture.name}å·²æ·»åŠ åˆ°æˆ¿é—´`);
            updateUI();
            
            setTimeout(() => {
                const phase = getTrustPhase();
                const mood = getCurrentMood();
                const messages = mentalActivities[phase] ? mentalActivities[phase].furniture : null;
                const furnitureType = furniture.id.includes('bed') ? 'bed' : 
                                   furniture.id.includes('desk') ? 'desk' :
                                   furniture.id.includes('bookshelf') ? 'bookshelf' :
                                   furniture.id.includes('plant') ? 'plant' : 'lamp';
                
                if (messages && messages[furnitureType]) {
                    showDialogueText(messages[furnitureType]);
                } else {
                    const defaultResponses = [
                        "æ–°çš„å®¶å…·ï¼",
                        "è°¢è°¢ï¼Œæˆ‘å¾ˆå–œæ¬¢",
                        "æˆ¿é—´å˜å¾—æ›´å¥½äº†",
                        "æ„Ÿè§‰æ›´èˆ’é€‚äº†"
                    ];
                    showDialogueText(defaultResponses[Math.floor(Math.random() * defaultResponses.length)]);
                }
                
                affectMoodByInteraction('gift');
            }, 1000);
            
            saveState();
            
            recordSystem.addRecord(
                `å®¶å…·æ·»ç½®ï¼š${furniture.name}`,
                `è§‚æµ‹è€…ä¸ºæˆ¿é—´æ·»ç½®äº†${furniture.name}ã€‚æˆ¿é—´èˆ’é€‚åº¦æå‡ã€‚èŠ±è´¹ï¼š${furniture.price}é‡‘å¸ã€‚`,
                ['å®¶å…·', 'è´­ä¹°']
            );
        } else {
            showToast("é‡‘å¸ä¸è¶³ï¼");
        }
    }

    function renderFurniture() {
        const container = document.getElementById('furniture-container');
        container.innerHTML = '';
        
        state.purchasedFurniture.forEach(furnitureId => {
            const furniture = furnitureItems.find(f => f.id === furnitureId);
            if (furniture) {
                const item = document.createElement('div');
                item.className = 'room-item';
                item.id = furniture.id;
                item.title = furniture.name;
                item.innerHTML = furniture.emoji;
                item.style.left = furniture.position.x + 'px';
                item.style.top = furniture.position.y + 'px';
                item.style.fontSize = furniture.size;
                item.onclick = () => interactWithFurniture(furniture.id);
                container.appendChild(item);
            }
        });
    }

    function interactWithFurniture(furnitureId) {
        const charWrapper = document.getElementById('character-wrapper');
        const charRect = charWrapper.getBoundingClientRect();
        const furnitureEl = document.getElementById(furnitureId);
        
        if (!furnitureEl) return;
        
        const furnitureRect = furnitureEl.getBoundingClientRect();
        const distance = Math.sqrt(
            Math.pow(charRect.left - furnitureRect.left, 2) + 
            Math.pow(charRect.top - furnitureRect.top, 2)
        );
        
        if (distance < 200) {
            const furniture = furnitureItems.find(f => f.id === furnitureId) || 
                             { id: furnitureId, name: furnitureId.includes('bed') ? 'åºŠ' : 'ç‰©å“' };
            
            useFurniture(furniture);
        } else {
            showToast("å´½å´½ä¸åœ¨é™„è¿‘...");
        }
    }

    function useFurniture(furniture) {
        const phase = getTrustPhase();
        const mood = getCurrentMood();
        const messages = mentalActivities[phase] ? mentalActivities[phase].furniture : null;
        
        let furnitureType = 'bed';
        if (furniture.id.includes('desk')) furnitureType = 'desk';
        else if (furniture.id.includes('bookshelf')) furnitureType = 'bookshelf';
        else if (furniture.id.includes('plant')) furnitureType = 'plant';
        else if (furniture.id.includes('lamp')) furnitureType = 'lamp';
        
        if (messages && messages[furnitureType]) {
            showDialogueText(messages[furnitureType]);
        } else {
            const reactions = furnitureReactions[furniture.id.split('_')[1]] || furnitureReactions.bed;
            if (reactions && reactions.use) {
                showDialogueText(reactions.use[Math.floor(Math.random() * reactions.use.length)]);
            } else {
                const defaultResponses = [
                    "ä½¿ç”¨ä¸­...",
                    "è¿™ä¸ªå®¶å…·å¾ˆå¥½ç”¨",
                    "æ„Ÿè§‰ä¸é”™",
                    "è°¢è°¢ä½ çš„ç¤¼ç‰©"
                ];
                showDialogueText(defaultResponses[Math.floor(Math.random() * defaultResponses.length)]);
            }
        }
        
        if (!state.furnitureUsage[furniture.id]) {
            state.furnitureUsage[furniture.id] = 0;
        }
        state.furnitureUsage[furniture.id]++;
        
        const furnitureEl = document.getElementById(furniture.id);
        if (furnitureEl) {
            furnitureEl.classList.add('using-furniture');
            setTimeout(() => {
                furnitureEl.classList.remove('using-furniture');
            }, 2000);
        }
        
        if (furniture.id.includes('bed')) {
            state.hunger = Math.min(100, state.hunger + 15);
            affectMoodByInteraction('pat');
        } else if (furniture.id.includes('desk')) {
            addTrust(1);
            affectMoodByInteraction('pat');
        } else if (furniture.id.includes('plant')) {
            affectMoodByInteraction('pat');
            updateMood(5);
        } else if (furniture.id.includes('lamp')) {
            affectMoodByInteraction('pat');
            updateMood(3);
        }
        
        updateUI();
        saveState();
    }

    function autoUseFurniture() {
        if (state.purchasedFurniture.length === 0) return;
        
        const phase = getTrustPhase();
        const mood = getCurrentMood();
        const furnitureList = state.purchasedFurniture.map(id => furnitureItems.find(f => f.id === id)).filter(f => f);
        
        furnitureList.forEach(furniture => {
            const useChance = furniture.useChance || 0.2;
            if (Math.random() < useChance) {
                setTimeout(() => {
                    const messages = mentalActivities[phase] ? mentalActivities[phase].furniture : null;
                    let furnitureType = 'bed';
                    if (furniture.id.includes('desk')) furnitureType = 'desk';
                    else if (furniture.id.includes('bookshelf')) furnitureType = 'bookshelf';
                    else if (furniture.id.includes('plant')) furnitureType = 'plant';
                    else if (furniture.id.includes('lamp')) furnitureType = 'lamp';
                    
                    if (messages && messages[furnitureType]) {
                        showDialogueText(messages[furnitureType]);
                    }
                    
                    updateMood(3);
                }, Math.random() * 5000 + 2000);
            }
        });
    }

    // === æ—¥è®°ç³»ç»Ÿ ===
    function checkDiaryGeneration() {
        const now = Date.now();
        const lastGen = state.lastDiaryGeneration || 0;
        
        if (now - lastGen < 86400000) {
            return;
        }
        
        const mood = getCurrentMood();
        const moodEntries = diaryContentLibrary[mood];
        
        if (!moodEntries || moodEntries.length === 0) {
            return;
        }
        
        const availableEntries = moodEntries.filter(entry => 
            entry.requireTrust <= state.trust && 
            !state.diaryEntries.some(de => de.title === entry.title)
        );
        
        if (availableEntries.length === 0) {
            if (Math.random() < 0.3) {
                generateRandomDiary(mood);
            }
            return;
        }
        
        let selectedEntry;
        if (state.trust < 15) {
            selectedEntry = availableEntries[0];
        } else if (state.trust < 30) {
            selectedEntry = availableEntries[Math.min(1, availableEntries.length - 1)];
        } else {
            const weights = availableEntries.map((_, index) => 
                Math.pow(0.8, index)
            );
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;
            
            for (let i = 0; i < availableEntries.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    selectedEntry = availableEntries[i];
                    break;
                }
            }
        }
        
        if (selectedEntry) {
            createNewDiaryEntry(selectedEntry, mood);
        }
    }

    function generateRandomDiary(mood) {
        const diaryTemplates = {
            happy: [
                { title: "å¿«ä¹çš„å°äº‹", content: "ä»Šå¤©å‘ç”Ÿäº†ä¸€ä»¶å°äº‹ï¼Œä½†è®©æˆ‘å¾ˆå¼€å¿ƒã€‚è™½ç„¶ä¸çŸ¥é“åŸå› ï¼Œä½†è¿™ç§æ¸©æš–çš„æ„Ÿè§‰è®©æˆ‘æƒ³è®°å½•ä¸‹æ¥ã€‚" },
                { title: "å¾®ç¬‘çš„ç†ç”±", content: "ä¸çŸ¥ä¸è§‰é—´ï¼Œæˆ‘å¼€å§‹æœŸå¾…æ¯ä¸€å¤©äº†ã€‚è¿™ä¸ªæˆ¿é—´å¥½åƒä¹Ÿæ²¡é‚£ä¹ˆç³Ÿç³•ã€‚" }
            ],
            calm: [
                { title: "å¹³å‡¡çš„ä¸€å¤©", content: "ä»Šå¤©å¾ˆå¹³é™ã€‚æˆ‘æ•´ç†äº†ä¸€ä¸‹æˆ¿é—´ï¼Œçœ‹äº†çœ‹çª—å¤–ã€‚æ—¶é—´æ…¢æ…¢æµé€ï¼Œä½†æˆ‘å¹¶ä¸ç€æ€¥ã€‚" },
                { title: "å†…å¿ƒçš„å¹³é™", content: "æˆ‘å‘ç°ï¼Œå½“æˆ‘ä¸å†ææƒ§çš„æ—¶å€™ï¼Œè¿™ä¸ªæˆ¿é—´å…¶å®æŒºèˆ’é€‚çš„ã€‚" }
            ]
        };
        
        const templates = diaryTemplates[mood] || [
            { title: "ä»Šå¤©çš„è®°å½•", content: `ä»Šå¤©æ˜¯ç¬¬${state.day}å¤©ã€‚å¿ƒæƒ…ï¼š${moodTypes[mood].name}ã€‚` }
        ];
        
        const template = templates[Math.floor(Math.random() * templates.length)];
        const newDiary = {
            id: Date.now().toString(),
            title: template.title,
            date: `ç¬¬${state.day}å¤©`,
            mood: moodTypes[mood].emoji + " " + moodTypes[mood].name,
            content: template.content,
            createdAt: Date.now()
        };
        
        state.diaryEntries.push(newDiary);
        state.lastDiaryGeneration = Date.now();
        
        // æ›´æ–°æ”¶é›†æ—¥è®°è¿›åº¦ä»»åŠ¡
        updateTaskProgress('collect_diary_entries');
        
        const diaryBook = document.getElementById('diary-book');
        diaryBook.innerText = 'ğŸ“”âœ¨';
        diaryBook.style.display = 'block';
        
        setTimeout(() => {
            diaryBook.innerText = 'ğŸ“”';
        }, 2000);
        
        saveState();
    }

    function createNewDiaryEntry(entry, mood) {
        const newDiary = {
            id: Date.now().toString(),
            title: entry.title,
            date: `ç¬¬${state.day}å¤©`,
            mood: moodTypes[mood].emoji + " " + moodTypes[mood].name,
            content: entry.content,
            createdAt: Date.now()
        };
        
        state.diaryEntries.push(newDiary);
        state.lastDiaryGeneration = Date.now();
        
        // æ›´æ–°æ”¶é›†æ—¥è®°è¿›åº¦ä»»åŠ¡
        updateTaskProgress('collect_diary_entries');
        
        const diaryBook = document.getElementById('diary-book');
        diaryBook.innerText = 'ğŸ“”âœ¨';
        diaryBook.style.animation = 'float 1s infinite ease-in-out';
        diaryBook.style.display = 'block';
        
        setTimeout(() => {
            diaryBook.innerText = 'ğŸ“”';
            diaryBook.style.animation = 'float 3s infinite ease-in-out';
        }, 2000);
        
        showToast("å‘ç°äº†ä¸€ç¯‡æ–°çš„æ—¥è®°ï¼");
        
        recordSystem.addRecord(
            'æ—¥è®°ç”Ÿæˆ',
            `è§‚æµ‹å¯¹è±¡å†™ä¸‹äº†æ–°çš„æ—¥è®°ï¼š${entry.title}ã€‚`,
            ['æ—¥è®°', 'å¿ƒç†']
        );
        
        saveState();
    }

    function openDiary() {
        const container = document.getElementById('diary-container');
        
        if (state.diaryEntries.length === 0) {
            container.innerHTML = `
                <div style='text-align:center;color:#999; margin-top:20px;'>
                    <p>æ—¥è®°æœ¬æ˜¯ç©ºçš„ã€‚</p>
                    <p style='font-size:11px; margin-top:10px;'>å´½å´½è¿˜æ²¡æœ‰å†™æ—¥è®°...æå‡ä¿¡ä»»å€¼æˆ–ç­‰å¾…ä»–å¿ƒæƒ…å˜åŒ–æ—¶å¯èƒ½ä¼šå†™æ—¥è®°</p>
                </div>
            `;
        } else {
            const sortedEntries = [...state.diaryEntries].sort((a, b) => b.createdAt - a.createdAt);
            
            container.innerHTML = sortedEntries.map(d => `
                <div class="diary-paper">
                    <div class="diary-date">
                        <span>${d.title} - ${d.date}</span>
                        <span class="diary-mood">${d.mood}</span>
                    </div>
                    ${d.content}
                </div>
            `).join('');
            
            if (!state.firstDiaryRead && state.diaryEntries.length > 0) {
                state.firstDiaryRead = true;
                recordSystem.recordKeyInteraction('first_diary', '');
            }
            
            // å®é™…é˜…è¯»æ—¥è®°åæ›´æ–°ä»»åŠ¡è¿›åº¦
            updateTaskProgress('read_diary');
            addTrust(0.3);
        }
        
        openModal('diary-modal');
    }

    // === å•†åº—ç³»ç»Ÿ ===
    function renderShop() {
        const list = document.getElementById('shop-list');
        const allItems = [...baseItems, ...unlockableItems];
        
        const availableItems = allItems.filter(item => 
            item.unlockCondition === null || 
            state.unlockedItems.includes(item.id) || 
            item.unlockCondition(state)
        );
        
        if (availableItems.length === 0) {
            list.innerHTML = "<div style='text-align:center;color:#ccc;margin-top:20px'>å•†åº—æš‚æ—¶æ²¡æœ‰å¯è´­ä¹°çš„ç‰©å“</div>";
            return;
        }
        
        list.innerHTML = availableItems.map(item => {
            const isNewlyUnlocked = !state.unlockedItems.includes(item.id) && 
                                   (item.unlockCondition === null || item.unlockCondition(state));
            
            if (isNewlyUnlocked && !state.unlockedItems.includes(item.id)) {
                state.unlockedItems.push(item.id);
                saveState();
            }
            
            const itemClass = isNewlyUnlocked ? 'item-row item-unlocked' : 'item-row';
            
            return `
                <div class="${itemClass}">
                    <div>
                        <strong>${item.name}</strong><br>
                        <span style="color:#aaa;font-size:10px">${item.desc}</span>
                        ${isNewlyUnlocked ? '<div class="unlock-condition">âœ¨ æ–°è§£é”ï¼</div>' : ''}
                    </div>
                    <button class="btn-action" onclick="buyItem('${item.id}')">${item.price}ğŸ’°</button>
                </div>
            `;
        }).join('');
        
        const lockedItems = unlockableItems.filter(item => 
            !state.unlockedItems.includes(item.id) && 
            item.unlockCondition && 
            !item.unlockCondition(state)
        );
        
        if (lockedItems.length > 0) {
            list.innerHTML += `
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #eee;">
                    <h4 style="color: #888; font-size: 12px; margin-bottom: 10px;">å¾…è§£é”ç‰©å“</h4>
                    ${lockedItems.map(item => `
                        <div class="item-row locked-item">
                            <div>
                                <strong style="color:#aaa">${item.name}</strong><br>
                                <span style="color:#ccc;font-size:10px">${item.desc}</span>
                                <div class="unlock-condition">ğŸ”’ ${getUnlockConditionText(item)}</div>
                            </div>
                            <span style="color:#ccc">${item.price}ğŸ’°</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    }

    function getUnlockConditionText(item) {
        if (item.unlockCondition) {
            if (item.id === 'book') return "ä¿¡ä»»å€¼è¾¾åˆ°25è§£é”";
            if (item.id === 'radio') return "ä¿¡ä»»å€¼è¾¾åˆ°45è§£é”";
            if (item.id === 'teddy') return "ä¿¡ä»»å€¼è¾¾åˆ°65è§£é”";
            if (item.id === 'lamp') return "ä¿¡ä»»å€¼è¾¾åˆ°35è§£é”";
            if (item.id === 'cake') return "å–‚é£Ÿ8æ¬¡åè§£é”";
            if (item.id === 'puzzle') return "æ¸¸æˆå¤©æ•°è¾¾åˆ°15å¤©è§£é”";
            if (item.id === 'blanket') return "ç´¯è®¡è·å¾—800é‡‘å¸è§£é”";
            if (item.id === 'camera') return "ä¿¡ä»»å€¼è¾¾åˆ°80è§£é”";
        }
        return "æœªçŸ¥æ¡ä»¶";
    }

    function checkItemUnlocks() {
        unlockableItems.forEach(item => {
            if (item.unlockCondition && item.unlockCondition(state) && !state.unlockedItems.includes(item.id)) {
                state.unlockedItems.push(item.id);
                showToast(`âœ¨ æ–°å•†å“è§£é”ï¼š${item.name}ï¼`);
                
                recordSystem.addRecord(
                    `å•†å“è§£é”ï¼š${item.name}`,
                    `å•†åº—è§£é”æ–°å•†å“ï¼š${item.name}ã€‚è§£é”æ¡ä»¶å·²æ»¡è¶³ï¼š${getUnlockConditionText(item)}ã€‚`,
                    ['å•†åº—', 'è§£é”']
                );
                
                saveState();
            }
        });
    }

    function buyItem(id) {
        const allItems = [...baseItems, ...unlockableItems];
        const item = allItems.find(i => i.id === id);
        
        if (!item) {
            showToast("å•†å“ä¸å­˜åœ¨");
            return;
        }
        
        if (item.unlockCondition && !state.unlockedItems.includes(item.id) && !item.unlockCondition(state)) {
            showToast("è¯¥å•†å“å°šæœªè§£é”");
            return;
        }
        
        if (state.money >= item.price) {
            state.money -= item.price;
            state.inventory.push(item);
            showToast("è´­ä¹°æˆåŠŸï¼Œå·²å­˜å…¥èƒŒåŒ…");
            
            // å®é™…è´­ä¹°ç‰©å“åæ›´æ–°ä»»åŠ¡è¿›åº¦
            updateTaskProgress('buy_item');
            // æ›´æ–°ç§¯ç´¯è´¢å¯Œè¿›åº¦ä»»åŠ¡
            updateTaskProgress('accumulate_money');
            
            updateUI();
            saveState();
            
            recordSystem.addRecord(
                `è´­ä¹°ç‰©å“ï¼š${item.name}`,
                `è§‚æµ‹è€…è´­ä¹°äº†${item.name}ã€‚èŠ±è´¹ï¼š${item.price}é‡‘å¸ã€‚ç‰©å“å·²å­˜å…¥èƒŒåŒ…ã€‚`,
                ['å•†åº—', 'è´­ä¹°']
            );
        } else {
            showToast("ä½™é¢ä¸è¶³");
        }
    }

    function renderBag() {
        const list = document.getElementById('bag-list');
        if (state.inventory.length === 0) {
            list.innerHTML = "<div style='text-align:center;color:#ccc;margin-top:20px'>èƒŒåŒ…æ˜¯ç©ºçš„</div>";
            return;
        }
        list.innerHTML = state.inventory.map((item, idx) => `
            <div class="item-row">
                <div>
                    <strong>${item.name}</strong><br>
                    <span style="color:#aaa;font-size:10px">${item.desc}</span>
                </div>
                <button class="btn-action" onclick="useItem(${idx})">ç»™äºˆ</button>
            </div>
        `).join('');
    }

    function useItem(idx) {
        const item = state.inventory[idx];
        state.inventory.splice(idx, 1);
        
        const mood = getCurrentMood();
        const reactions = itemReactions[item.id];
        
        let dialogue = "";
        if (reactions && reactions[mood]) {
            const moodReactions = reactions[mood];
            dialogue = moodReactions[Math.floor(Math.random() * moodReactions.length)];
        } else {
            if (item.type === 'food') {
                switch(mood) {
                    case 'anxious': dialogue = "é£Ÿç‰©...è°¢è°¢"; break;
                    case 'calm': dialogue = "æˆ‘æ”¶ä¸‹äº†"; break;
                    case 'happy': dialogue = "è°¢è°¢ï¼çœ‹èµ·æ¥å¾ˆå¥½åƒ"; break;
                    case 'excited': dialogue = "å“‡ï¼é£Ÿç‰©ï¼è°¢è°¢ä½ ï¼"; break;
                    default: dialogue = "è°¢è°¢";
                }
            } else {
                switch(mood) {
                    case 'anxious': dialogue = "ç¤¼ç‰©ï¼Ÿä¸ºä»€ä¹ˆç»™æˆ‘è¿™ä¸ªï¼Ÿ"; break;
                    case 'calm': dialogue = "è°¢è°¢ä½ çš„ç¤¼ç‰©"; break;
                    case 'happy': dialogue = "ç¤¼ç‰©ï¼å¥½å¼€å¿ƒï¼"; break;
                    case 'excited': dialogue = "å¤ªæ£’äº†ï¼è°¢è°¢ä½ ï¼"; break;
                    default: dialogue = "è°¢è°¢";
                }
            }
        }
        
        showDialogueText(dialogue);
        
        if (item.type === 'food') {
            state.hunger = Math.min(100, state.hunger + 30);
            state.foodEaten++;
            
            if (!state.firstFeedDone) {
                state.firstFeedDone = true;
                recordSystem.recordKeyInteraction('first_feed', '');
            }
            
            affectMoodByInteraction('feed');
            
            // å®é™…å–‚é£Ÿåæ›´æ–°ä»»åŠ¡è¿›åº¦
            updateTaskProgress('feed_zaizai');
            saveState();
        } else {
            if (!state.firstGiftDone) {
                state.firstGiftDone = true;
                recordSystem.recordKeyInteraction('first_gift', item.name);
            }
            
            affectMoodByInteraction('gift');
        }
        
        renderBag();
        updateUI();
        closeModal('bag-modal');
        
        setTimeout(checkDiaryGeneration, 1000);
        checkItemUnlocks();
        saveState();
        
        recordSystem.addRecord(
            `ä½¿ç”¨ç‰©å“ï¼š${item.name}`,
            `è§‚æµ‹è€…å‘è§‚æµ‹å¯¹è±¡æä¾›äº†${item.name}ã€‚è§‚æµ‹å¯¹è±¡ååº”ï¼š${dialogue}`,
            ['äº’åŠ¨', item.type === 'food' ? 'å–‚é£Ÿ' : 'ç¤¼ç‰©']
        );
    }

    // === å‰§æƒ…ç³»ç»Ÿ ===
    function checkStoryProgress() {
        if (state.currentChapter < storyChapters.length) {
            const nextStory = storyChapters[state.currentChapter];
            if (state.trust >= nextStory.t) {
                showStoryChapter(nextStory);
                state.currentChapter++;
                
                recordSystem.recordStoryProgress(nextStory.title);
                
                saveState();
            }
        }
    }

    function showStoryChapter(chapter) {
        document.getElementById('story-chapter-title').innerText = chapter.title;
        document.getElementById('story-title').innerText = '';
        document.getElementById('story-content').innerHTML = chapter.content;
        
        const choiceContainer = document.getElementById('story-choice');
        choiceContainer.innerHTML = '';
        
        if (chapter.choices && chapter.choices.length > 0) {
            chapter.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'story-btn';
                button.innerText = choice.text;
                button.onclick = () => {
                    choice.effect();
                    document.getElementById('continue-story-btn').style.display = 'block';
                    choiceContainer.innerHTML = '';
                    state.storyChoices.push({ chapter: chapter.title, choice: choice.text });
                };
                choiceContainer.appendChild(button);
            });
            document.getElementById('continue-story-btn').style.display = 'none';
        } else {
            document.getElementById('continue-story-btn').style.display = 'block';
        }
        
        openModal('story-modal');
        
        if (state.trust >= 30) {
            document.getElementById('diary-book').style.display = 'block';
        }
    }

    // === ä»»åŠ¡ç³»ç»Ÿ ===
function renderTaskList() {
    const container = document.getElementById('task-list');
    
    if (!state.tasks || state.tasks.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#ccc;margin-top:20px">æš‚æ— ä»»åŠ¡</div>';
        return;
    }
    
    // æŒ‰ç±»å‹åˆ†ç»„ï¼šæ¯æ—¥ä»»åŠ¡ã€è¿›åº¦ä»»åŠ¡ã€æˆå°±ä»»åŠ¡
    const dailyTasks = state.tasks.filter(t => t.type === 'daily');
    const progressTasks = state.tasks.filter(t => t.type === 'progress');
    const achievementTasks = state.tasks.filter(t => t.type === 'achievement');
    
    let html = '';
    
    // æ¯æ—¥ä»»åŠ¡
    if (dailyTasks.length > 0) {
        html += '<h4 style="color: #888; font-size: 12px; margin-bottom: 10px; margin-top: 0;">æ¯æ—¥ä»»åŠ¡</h4>';
        html += dailyTasks.map(task => renderTaskItem(task)).join('');
    }
    
    // è¿›åº¦ä»»åŠ¡
    if (progressTasks.length > 0) {
        html += '<h4 style="color: #888; font-size: 12px; margin-bottom: 10px; margin-top: 20px;">è¿›åº¦ä»»åŠ¡</h4>';
        html += progressTasks.map(task => renderTaskItem(task)).join('');
    }
    
    // æˆå°±ä»»åŠ¡
    if (achievementTasks.length > 0) {
        html += '<h4 style="color: #888; font-size: 12px; margin-bottom: 10px; margin-top: 20px;">æˆå°±ä»»åŠ¡</h4>';
        html += achievementTasks.map(task => renderTaskItem(task)).join('');
    }
    
    container.innerHTML = html;
}

function renderTaskItem(task) {
    const progressPercent = task.maxProgress > 0 ? (task.progress / task.maxProgress) * 100 : 0;
    const isCompleted = task.progress >= task.maxProgress;
    const isClaimable = isCompleted && !task.claimed;
    
    // æ ¹æ®ä»»åŠ¡ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ·å¼
    let typeBadge = '';
    switch(task.type) {
        case 'daily':
            typeBadge = '<span style="font-size:9px; color:#4CAF50; background:#E8F5E9; padding:1px 5px; border-radius:8px;">æ¯æ—¥</span>';
            break;
        case 'progress':
            typeBadge = '<span style="font-size:9px; color:#2196F3; background:#E3F2FD; padding:1px 5px; border-radius:8px;">è¿›åº¦</span>';
            break;
        case 'achievement':
            typeBadge = '<span style="font-size:9px; color:#FF9800; background:#FFF3E0; padding:1px 5px; border-radius:8px;">æˆå°±</span>';
            break;
    }
    
    return `
        <div class="task-item">
            <div class="task-info">
                <div class="task-title">
                    ${task.title} ${typeBadge}
                </div>
                <div class="task-desc">${task.desc}</div>
                <div class="task-progress">
                    <div class="task-progress-fill" style="width: ${progressPercent}%"></div>
                </div>
                <div style="font-size:10px; color:#888; margin-top:3px;">
                    è¿›åº¦: ${task.progress}/${task.maxProgress}
                </div>
            </div>
            <div>
                <span class="task-reward">+${task.reward}ğŸ’°</span>
                <button class="task-btn" 
                        onclick="claimTaskReward('${task.id}')" 
                        ${isClaimable ? '' : 'disabled'}
                        style="${isClaimable ? 'background: var(--primary-pink);' : ''}">
                    ${isCompleted ? (task.claimed ? 'å·²é¢†å–' : 'é¢†å–') : 'è¿›è¡Œä¸­'}
                </button>
            </div>
        </div>
    `;
}

    function updateAchievementProgress() {
        // éå†æ‰€æœ‰æˆå°±ä»»åŠ¡ï¼Œæ ¹æ®å®é™…æƒ…å†µæ›´æ–°è¿›åº¦
        state.tasks.forEach(task => {
            if (task.type === 'achievement' && task.progress < task.maxProgress) {
                switch(task.id) {
                    case 'first_feed':
                        // åˆæ¬¡å–‚é£Ÿæˆå°±
                        if (state.firstFeedDone) {
                            task.progress = 1;
                        }
                        break;
                    case 'first_gift':
                        // åˆæ¬¡é€ç¤¼æˆå°±
                        if (state.firstGiftDone) {
                            task.progress = 1;
                        }
                        break;
                    case 'first_diary':
                        // åˆæ¬¡è¯»æ—¥è®°æˆå°±
                        if (state.firstDiaryRead) {
                            task.progress = 1;
                        }
                        break;
                    case 'trust_30':
                        // ä¿¡ä»»å€¼è¾¾åˆ°30ç‚¹æˆå°±
                        if (state.trust >= 30) {
                            task.progress = 1;
                        }
                        break;
                    case 'trust_60':
                        // ä¿¡ä»»å€¼è¾¾åˆ°60ç‚¹æˆå°±
                        if (state.trust >= 60) {
                            task.progress = 1;
                        }
                        break;
                    case 'trust_100':
                        // ä¿¡ä»»å€¼è¾¾åˆ°100ç‚¹æˆå°±
                        if (state.trust >= 100) {
                            task.progress = 1;
                        }
                        break;
                    case 'feed_10':
                        // ç´¯ç§¯å–‚é£Ÿ10æ¬¡æˆå°±
                        task.progress = Math.min(task.maxProgress, state.foodEaten);
                        break;
                    case 'interact_50':
                        // ç´¯ç§¯ä¸å´½å´½äº’åŠ¨50æ¬¡æˆå°±
                        task.progress = Math.min(task.maxProgress, state.interactionCount);
                        break;
                    case 'collect_all_furniture':
                        // è´­ä¹°æ‰€æœ‰å®¶å…·æˆå°±
                        // åŠ¨æ€è®¡ç®—éœ€è¦è´­ä¹°çš„å®¶å…·æ•°é‡
                        const totalFurniture = furnitureItems.length;
                        task.maxProgress = totalFurniture;
                        task.progress = state.purchasedFurniture.length;
                        if (state.purchasedFurniture.length >= totalFurniture) {
                            task.progress = task.maxProgress;
                        }
                        break;
                }
            }
        });
    }

    function updateTaskProgress(taskId) {
        const task = state.tasks.find(t => t.id === taskId);
        if (!task) return;
        
        // æ ¹æ®å®é™…å®Œæˆæƒ…å†µæ›´æ–°ä»»åŠ¡è¿›åº¦
        switch(taskId) {
            case 'daily_login':
                // ç™»å½•ä»»åŠ¡ï¼šåªæœ‰åœ¨å½“å¤©ç¬¬ä¸€æ¬¡ç™»å½•æ—¶è‡ªåŠ¨å®Œæˆ
                if (!state.dailyLoginClaimed) {
                    task.progress = 1;
                }
                break;
            case 'feed_zaizai':
                // å–‚é£Ÿä»»åŠ¡ï¼šé€šè¿‡feedå‡½æ•°è°ƒç”¨æ—¶æ›´æ–°ï¼Œè¿™é‡Œä¸è‡ªåŠ¨å®Œæˆ
                // ä¿æŒå½“å‰è¿›åº¦ï¼Œç”±å®é™…å–‚é£Ÿæ“ä½œæ›´æ–°
                break;
            case 'play_with_zaizai':
                // äº’åŠ¨ä»»åŠ¡ï¼šåŸºäºå®é™…äº’åŠ¨æ¬¡æ•°
                task.progress = Math.min(task.maxProgress, state.interactionCount);
                break;
            case 'complete_schedule':
                // æ—¥ç¨‹ä»»åŠ¡ï¼šé€šè¿‡completeScheduleå‡½æ•°è°ƒç”¨æ—¶æ›´æ–°
                // ä¿æŒå½“å‰è¿›åº¦ï¼Œç”±å®é™…å®Œæˆæ—¥ç¨‹æ“ä½œæ›´æ–°
                break;
            case 'increase_trust':
                // ä¿¡ä»»ä»»åŠ¡ï¼šåŸºäºå®é™…ä¿¡ä»»å€¼å¢é•¿
                // è®¡ç®—å½“å‰ä¿¡ä»»å€¼çš„æ•´æ•°éƒ¨åˆ†ï¼ˆæ¯10ç‚¹ä¸ºä¸€ä¸ªé˜¶æ®µï¼‰
                const currentTrustStage = Math.floor(state.trust / 10) * 10;
                task.progress = Math.min(task.maxProgress, currentTrustStage);
                break;
            case 'buy_item':
                // è´­ä¹°ç‰©å“ä»»åŠ¡ï¼šé€šè¿‡buyItemå‡½æ•°è°ƒç”¨æ—¶æ›´æ–°
                // ä¿æŒå½“å‰è¿›åº¦ï¼Œç”±å®é™…è´­ä¹°æ“ä½œæ›´æ–°
                break;
            case 'read_diary':
                // é˜…è¯»æ—¥è®°ä»»åŠ¡ï¼šé€šè¿‡readDiaryå‡½æ•°è°ƒç”¨æ—¶æ›´æ–°
                // ä¿æŒå½“å‰è¿›åº¦ï¼Œç”±å®é™…é˜…è¯»æ“ä½œæ›´æ–°
                break;
            case 'buy_furniture':
                // è´­ä¹°å®¶å…·ä»»åŠ¡ï¼šé€šè¿‡buyFurnitureå‡½æ•°è°ƒç”¨æ—¶æ›´æ–°
                // ä¿æŒå½“å‰è¿›åº¦ï¼Œç”±å®é™…è´­ä¹°æ“ä½œæ›´æ–°
                break;
            case 'play_game':
                // ç©æ¸¸æˆä»»åŠ¡ï¼šé€šè¿‡æ¸¸æˆå®Œæˆæ—¶æ›´æ–°
                // ä¿æŒå½“å‰è¿›åº¦ï¼Œç”±å®é™…æ¸¸æˆå®Œæˆæ“ä½œæ›´æ–°
                break;
            // æ–°å¢é•¿çº¿è¿›åº¦ä»»åŠ¡
            case 'collect_diary_entries':
                task.progress = Math.min(task.maxProgress, state.diaryEntries.length);
                break;
            case 'accumulate_money':
                task.progress = Math.min(task.maxProgress, Math.floor(state.money / 100));
                break;
            case 'interact_multiple_times':
                task.progress = Math.min(task.maxProgress, state.interactionCount);
                break;
            case 'try_different_weather':
                const uniqueWeathers = new Set(state.weatherHistory || []).size;
                task.progress = Math.min(task.maxProgress, uniqueWeathers);
                break;
        }
        
        // æ›´æ–°æˆå°±ä»»åŠ¡è¿›åº¦
        updateAchievementProgress();
        
        // è¿›åº¦ä»»åŠ¡å åŠ å¼é€»è¾‘ï¼šå®Œæˆå½“å‰é˜¶æ®µåè‡ªåŠ¨æ›´æ–°è‡³ä¸‹ä¸€é˜¶æ®µ
        if (task.type === 'progress' && task.progress >= task.maxProgress) {
            // ç¡®å®šå½“å‰ä»»åŠ¡çš„é˜¶æ®µå’Œä¸‹ä¸€é˜¶æ®µç›®æ ‡
            let nextStage = 0;
            let nextMaxProgress = 0;
            let nextReward = 0;
            
            switch(taskId) {
                case 'increase_trust':
                    // ä¿¡ä»»å€¼ä»»åŠ¡ï¼šæ¯10ç‚¹ä¸ºä¸€ä¸ªé˜¶æ®µï¼Œå¥–åŠ±é€’å¢
                    nextStage = Math.floor(task.maxProgress / 10) + 1;
                    nextMaxProgress = nextStage * 10;
                    nextReward = 50 + (nextStage - 1) * 20;
                    task.title = `æå‡ä¿¡ä»»${nextStage}`;
                    task.desc = `æå‡ä¿¡ä»»å€¼${nextMaxProgress}ç‚¹`;
                    break;
                case 'collect_diary_entries':
                    // æ”¶é›†æ—¥è®°ä»»åŠ¡ï¼šæ¯10ç¯‡ä¸ºä¸€ä¸ªé˜¶æ®µ
                    nextStage = Math.floor(task.maxProgress / 10) + 1;
                    nextMaxProgress = nextStage * 10;
                    nextReward = 200 + (nextStage - 1) * 100;
                    task.title = `æ”¶é›†æ—¥è®°${nextStage}`;
                    task.desc = `æ”¶é›†${nextMaxProgress}ç¯‡æ—¥è®°`;
                    break;
                case 'accumulate_money':
                    // ç§¯ç´¯è´¢å¯Œä»»åŠ¡ï¼šæ¯1000é‡‘å¸ä¸ºä¸€ä¸ªé˜¶æ®µ
                    nextStage = Math.floor(task.maxProgress / 10) + 1;
                    nextMaxProgress = nextStage * 10;
                    nextReward = 300 + (nextStage - 1) * 150;
                    task.title = `ç§¯ç´¯è´¢å¯Œ${nextStage}`;
                    task.desc = `ç§¯ç´¯${nextMaxProgress * 100}é‡‘å¸`;
                    break;
                case 'interact_multiple_times':
                    // é¢‘ç¹äº’åŠ¨ä»»åŠ¡ï¼šæ¯50æ¬¡ä¸ºä¸€ä¸ªé˜¶æ®µ
                    nextStage = Math.floor(task.maxProgress / 50) + 1;
                    nextMaxProgress = nextStage * 50;
                    nextReward = 150 + (nextStage - 1) * 50;
                    task.title = `é¢‘ç¹äº’åŠ¨${nextStage}`;
                    task.desc = `ä¸å´½å´½äº’åŠ¨${nextMaxProgress}æ¬¡`;
                    break;
                case 'try_different_weather':
                    // ä½“éªŒå¤©æ°”ä»»åŠ¡ï¼šæœ€å¤š5ç§å¤©æ°”ï¼Œå®Œæˆåä¸å†è¿›é˜¶
                    if (task.maxProgress < 5) {
                        nextMaxProgress = Math.min(task.maxProgress + 1, 5);
                        nextReward = 100 + (nextMaxProgress - 1) * 20;
                        task.title = `ä½“éªŒå¤©æ°”`;
                        task.desc = `ä½“éªŒ${nextMaxProgress}ç§ä¸åŒå¤©æ°”`;
                    } else {
                        // å·²å®Œæˆæ‰€æœ‰å¤©æ°”ä½“éªŒï¼Œä¸å†è¿›é˜¶
                        return;
                    }
                    break;
                default:
                    return;
            }
            
            // æ›´æ–°ä»»åŠ¡åˆ°ä¸‹ä¸€é˜¶æ®µ
            task.maxProgress = nextMaxProgress;
            task.reward = nextReward;
            task.claimed = false;
            
            // æ˜¾ç¤ºä»»åŠ¡è¿›é˜¶æç¤º
            showToast(`ä»»åŠ¡è¿›é˜¶ï¼š${task.title}`);
        }
        
        renderTaskList();
        saveState();
    }

function claimTaskReward(taskId) {
    const task = state.tasks.find(t => t.id === taskId);
    if (!task) {
        console.error('æ‰¾ä¸åˆ°ä»»åŠ¡:', taskId);
        return;
    }
    
    if (task.claimed) {
        showToast("ä»»åŠ¡å¥–åŠ±å·²é¢†å–");
        return;
    }
    
    if (task.progress >= task.maxProgress) {
        state.money += task.reward;
        task.claimed = true;
        
        // æ›´æ–°å¯¹åº”çš„ä»»åŠ¡å®ŒæˆçŠ¶æ€
        switch(taskId) {
            case 'daily_login':
                state.dailyLoginClaimed = true;
                break;
            case 'feed_zaizai':
                state.feedTaskClaimed = true;
                break;
            case 'complete_schedule':
                state.scheduleTaskClaimed = true;
                break;
            case 'buy_item':
                state.buyTaskClaimed = true;
                break;
            case 'read_diary':
                state.diaryTaskClaimed = true;
                break;
            case 'buy_furniture':
                state.furnitureTaskClaimed = true;
                break;
            case 'play_game':
                state.gameTaskClaimed = true;
                break;
        }
        
        showToast(`ä»»åŠ¡å®Œæˆï¼è·å¾— ${task.reward}ğŸ’°`);
        updateUI();
        renderTaskList();
        
        // å´½å´½çš„ååº”
        setTimeout(() => {
            const reactions = [
                "å®Œæˆä»»åŠ¡äº†ï¼å¥½å‰å®³ï¼",
                "é‡‘å¸å¢åŠ äº†å‘¢ï¼",
                "ç»§ç»­åŠ æ²¹ï¼",
                "åšå¾—å¥½ï¼"
            ];
            showDialogueText(reactions[Math.floor(Math.random() * reactions.length)]);
            updateMood(5);
            addTrust(1);
        }, 500);
        
        saveState();
        
        // è®°å½•åˆ°è§‚æµ‹è®°å½•
        recordSystem.addRecord(
            `å®Œæˆä»»åŠ¡ï¼š${task.title}`,
            `å®Œæˆæ¯æ—¥ä»»åŠ¡ï¼š${task.title}ã€‚è·å¾—å¥–åŠ±ï¼š${task.reward}é‡‘å¸ã€‚`,
            ['ä»»åŠ¡', 'å®Œæˆ']
        );
    } else {
        showToast("ä»»åŠ¡å°šæœªå®Œæˆ");
    }
}

    // === è§‚æµ‹è®°å½•ç³»ç»Ÿ ===
    function renderRecords() {
        const container = document.getElementById('record-list');
        
        if (!state.records || state.records.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; color:#999; padding:40px 20px;">
                    <p>è¿˜æ²¡æœ‰è§‚æµ‹è®°å½•ã€‚</p>
                    <p style="font-size:12px; margin-top:10px;">ç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•é‡è¦äº‹ä»¶å’Œå´½å´½çš„å¿ƒç†å˜åŒ–</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = state.records.map(record => `
            <div class="record-item">
                <div class="record-header">
                    <span class="record-title">${record.title}</span>
                    <span class="record-time">Day ${record.gameDay} | ${record.time}</span>
                </div>
                <div class="record-content">${record.content}</div>
                <div>
                    ${record.tags.map(tag => `
                        <span class="record-tag tag-${tag}">${tag}</span>
                    `).join('')}
                </div>
                <div style="font-size:10px; color:#aaa; margin-top:5px;">
                    ä¿¡ä»»ç­‰çº§: ${recordSystem.getTrustLevel(record.trustLevel)} (${record.trustLevel}ç‚¹)
                </div>
            </div>
        `).join('');
    }

    function exportRecords() {
        if (!state.records || state.records.length === 0) {
            showToast("æ²¡æœ‰å¯å¯¼å‡ºçš„è®°å½•");
            return;
        }
        
        let exportText = "=== å¼‚ç•Œè§‚æµ‹çª—å£ - è§‚æµ‹è®°å½• ===\n";
        exportText += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n`;
        exportText += `æ¸¸æˆå¤©æ•°: ${state.day}\n`;
        exportText += `å½“å‰ä¿¡ä»»å€¼: ${state.trust.toFixed(1)}\n`;
        exportText += `å½“å‰å¿ƒæƒ…: ${moodTypes[state.currentMood]?.name || 'æœªçŸ¥'}\n`;
        exportText += "=".repeat(40) + "\n\n";
        
        state.records.forEach((record, index) => {
            exportText += `[è®°å½• ${index + 1}] ${record.title}\n`;
            exportText += `æ—¶é—´: Day ${record.gameDay} | ${record.time}\n`;
            exportText += `ä¿¡ä»»ç­‰çº§: ${recordSystem.getTrustLevel(record.trustLevel)} (${record.trustLevel}ç‚¹)\n`;
            exportText += `æ ‡ç­¾: ${record.tags.join(', ')}\n`;
            exportText += `å†…å®¹: ${record.content}\n`;
            exportText += "-".repeat(40) + "\n";
        });
        
        const blob = new Blob([exportText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `è§‚æµ‹è®°å½•_Day${state.day}_${new Date().getTime()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast("è§‚æµ‹è®°å½•å·²å¯¼å‡º");
    }

    // === ç•ªèŒ„é’Ÿç³»ç»Ÿ ===
    function openPomodoro() {
        openModal('pomodoro-modal');
        renderPomodoroTasks();
        updatePomodoroDisplay();
        
        // ä¿®å¤ï¼šæ›´æ–°ç•ªèŒ„é’Ÿå¤´åƒæ˜¾ç¤º
        const fullscreenImg = document.getElementById('fullscreen-img');
        if (state.customAvatar) {
            fullscreenImg.src = state.customAvatar;
        }
    }

    function renderPomodoroTasks() {
        const container = document.getElementById('pomodoro-tasks');
        if (pomodoro.tasks.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">è¿˜æ²¡æœ‰ä»»åŠ¡è®°å½•</div>';
            return;
        }
        
        container.innerHTML = pomodoro.tasks.map((task, index) => `
            <div class="task-item" style="margin-bottom: 8px; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:13px;">${task.name}</span>
                    <span style="font-size:12px;color:#666;">${formatTime(task.duration)}</span>
                </div>
                <div style="font-size:11px;color:#888;margin-top:4px;">
                    ${new Date(task.timestamp).toLocaleString()}
                </div>
            </div>
        `).join('');
    }

    function startPomodoro() {
        const taskInput = document.getElementById('pomodoro-task');
        const durationSelect = document.getElementById('pomodoro-duration');
        
        pomodoro.currentTask = taskInput.value.trim() || 'ä¸“æ³¨æ—¶é—´';
        pomodoro.totalTime = parseInt(durationSelect.value);
        pomodoro.timeLeft = pomodoro.totalTime;
        
        if (pomodoro.timer) {
            clearInterval(pomodoro.timer);
        }
        
        pomodoro.isRunning = true;
        pomodoro.isPaused = false;
        
        document.getElementById('pomodoro-start').style.display = 'none';
        document.getElementById('pomodoro-pause').style.display = 'inline-block';
        
        enterFullscreenMode();
        
        pomodoro.timer = setInterval(updatePomodoroTimer, 1000);
        
        const startMsgs = pomodoroDialogue.start;
        showFullscreenDialogue(startMsgs[Math.floor(Math.random() * startMsgs.length)]);
        
        setInterval(() => {
            if (pomodoro.isRunning && !pomodoro.isPaused && pomodoro.inFullscreen) {
                const tickMsgs = pomodoroDialogue.tick;
                if (Math.random() < 0.1) {
                    showFullscreenDialogue(tickMsgs[Math.floor(Math.random() * tickMsgs.length)]);
                }
                
                if (pomodoro.timeLeft <= 300 && Math.random() < 0.3) {
                    const almostMsgs = pomodoroDialogue.almost;
                    showFullscreenDialogue(almostMsgs[Math.floor(Math.random() * almostMsgs.length)]);
                }
            }
        }, 30000);
    }

    function enterFullscreenMode() {
        closeModal('pomodoro-modal');
        pomodoro.inFullscreen = true;
        
        // ä¿®å¤ï¼šæ›´æ–°ç•ªèŒ„é’Ÿå…¨å±æ¨¡å¼çš„å¤´åƒæ˜¾ç¤º
        const fullscreenImg = document.getElementById('fullscreen-img');
        if (state.customAvatar) {
            fullscreenImg.src = state.customAvatar;
        } else {
            fullscreenImg.src = 'https://api.dicebear.com/9.x/avataaars/svg?seed=Felix&backgroundColor=ffdfbf';
        }
        
        document.getElementById('fullscreen-task').textContent = pomodoro.currentTask;
        document.getElementById('pomodoro-fullscreen').style.display = 'flex';
        
        fullscreenImg.onclick = handleFullscreenPoke;
        
        updateFullscreenDisplay();
    }

    function handleFullscreenPoke() {
        if (!pomodoro.isRunning || pomodoro.isPaused) return;
        
        const pokeMsgs = pomodoroDialogue.poke;
        const msg = pokeMsgs[Math.floor(Math.random() * pokeMsgs.length)];
        showFullscreenDialogue(msg);
        
        const img = document.getElementById('fullscreen-img');
        img.style.transform = 'scale(1.1)';
        setTimeout(() => {
            img.style.transform = 'scale(1)';
        }, 200);
    }

    function showFullscreenDialogue(text) {
        const bubble = document.getElementById('fullscreen-bubble');
        bubble.textContent = text;
        bubble.style.opacity = '1';
        
        setTimeout(() => {
            bubble.style.opacity = '0';
        }, 2000);
    }

    function updatePomodoroTimer() {
        if (!pomodoro.isRunning || pomodoro.isPaused) return;
        
        pomodoro.timeLeft--;
        
        if (pomodoro.inFullscreen) {
            updateFullscreenDisplay();
        } else {
            updatePomodoroDisplay();
        }
        
        if (pomodoro.timeLeft <= 0) {
            finishPomodoro(true);
        }
    }

    function updateFullscreenDisplay() {
        const minutes = Math.floor(pomodoro.timeLeft / 60);
        const seconds = pomodoro.timeLeft % 60;
        document.getElementById('fullscreen-timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (pomodoro.timeLeft <= 60) {
            document.getElementById('fullscreen-status').textContent = 'æœ€å1åˆ†é’Ÿï¼';
        } else if (pomodoro.timeLeft <= 300) {
            document.getElementById('fullscreen-status').textContent = 'å¿«å®Œæˆäº†ï¼';
        } else {
            const progress = ((pomodoro.totalTime - pomodoro.timeLeft) / pomodoro.totalTime * 100).toFixed(0);
            document.getElementById('fullscreen-status').textContent = `å·²å®Œæˆ ${progress}%`;
        }
    }

    function updatePomodoroDisplay() {
        const minutes = Math.floor(pomodoro.timeLeft / 60);
        const seconds = pomodoro.timeLeft % 60;
        document.getElementById('pomodoro-timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById('pomodoro-status').textContent = 
            pomodoro.isRunning ? (pomodoro.isPaused ? 'å·²æš‚åœ' : 'è¿›è¡Œä¸­') : 'å‡†å¤‡å¼€å§‹';
    }

    function pausePomodoro() {
        if (!pomodoro.isRunning) return;
        
        pomodoro.isPaused = !pomodoro.isPaused;
        document.getElementById('pomodoro-pause').textContent = 
            pomodoro.isPaused ? 'ç»§ç»­' : 'æš‚åœ';
        
        showFullscreenDialogue(pomodoro.isPaused ? 'ä¼‘æ¯ä¸€ä¸‹ä¹Ÿå¥½' : 'ç»§ç»­ä¸“æ³¨å§ï¼');
    }

    function resetPomodoro() {
        if (pomodoro.timer) {
            clearInterval(pomodoro.timer);
            pomodoro.timer = null;
        }
        
        pomodoro.isRunning = false;
        pomodoro.isPaused = false;
        pomodoro.timeLeft = pomodoro.totalTime;
        
        document.getElementById('pomodoro-start').style.display = 'inline-block';
        document.getElementById('pomodoro-pause').style.display = 'none';
        
        updatePomodoroDisplay();
    }

    // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¼¹çª—
    function showCustomConfirm(message, onYes, onNo) {
        const modal = document.getElementById('custom-confirm-modal');
        const yesBtn = document.getElementById('confirm-yes');
        const noBtn = document.getElementById('confirm-no');
        
        // æ›´æ–°å¼¹çª—å†…å®¹
        modal.querySelector('p').textContent = message;
        
        // æ˜¾ç¤ºå¼¹çª—
        modal.style.display = 'flex';
        
        // å®šä¹‰äº‹ä»¶å¤„ç†å‡½æ•°
        function handleConfirmYes() {
            modal.style.display = 'none';
            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
            yesBtn.removeEventListener('click', handleConfirmYes);
            noBtn.removeEventListener('click', handleConfirmNo);
            if (onYes) onYes();
        }
        
        function handleConfirmNo() {
            modal.style.display = 'none';
            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
            yesBtn.removeEventListener('click', handleConfirmYes);
            noBtn.removeEventListener('click', handleConfirmNo);
            if (onNo) onNo();
        }
        
        // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
        yesBtn.addEventListener('click', handleConfirmYes);
        noBtn.addEventListener('click', handleConfirmNo);
    }
    
    function finishPomodoro(success = true) {
        // å¦‚æœæ˜¯ç”¨æˆ·ä¸»åŠ¨ç‚¹å‡»å®Œæˆï¼Œä¸”æ—¶é—´æœªåˆ°ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¼¹çª—
        if (success && pomodoro.timeLeft > 0) {
            // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¼¹çª—
            showCustomConfirm('ä½ ç¡®å®šå·²ç»æˆåŠŸå®Œæˆä»»åŠ¡äº†å—ï¼Ÿ', 
                // ç¡®å®šæŒ‰é’®å›è°ƒ
                function() {
                    // ç”¨æˆ·ç¡®è®¤å®Œæˆä»»åŠ¡ï¼Œç»§ç»­æ‰§è¡Œå®Œæˆé€»è¾‘
                    completePomodoro(true);
                }, 
                // å–æ¶ˆæŒ‰é’®å›è°ƒ
                function() {
                    // ç”¨æˆ·å–æ¶ˆï¼Œä¸åšä»»ä½•æ“ä½œï¼Œç»§ç»­å€’è®¡æ—¶
                    return;
                }
            );
            return;
        }
        
        // æ­£å¸¸å®Œæˆæˆ–æ”¾å¼ƒä»»åŠ¡
        completePomodoro(success);
    }
    
    // å®é™…å®Œæˆç•ªèŒ„é’Ÿçš„é€»è¾‘
    function completePomodoro(success) {
        if (pomodoro.timer) {
            clearInterval(pomodoro.timer);
            pomodoro.timer = null;
        }
        
        pomodoro.isRunning = false;
        pomodoro.inFullscreen = false;
        
        if (success && pomodoro.currentTask) {
            const actualDuration = pomodoro.totalTime - pomodoro.timeLeft;
            pomodoro.tasks.unshift({
                name: pomodoro.currentTask,
                duration: actualDuration,
                timestamp: Date.now(),
                completed: true
            });
            
            if (pomodoro.tasks.length > 20) {
                pomodoro.tasks = pomodoro.tasks.slice(0, 20);
            }
            
            // è®¡ç®—é‡‘å¸å¥–åŠ±ï¼šæ—¶é—´è¶Šé•¿ï¼Œå¥–åŠ±è¶Šå¤šï¼Œæå‰å®Œæˆåˆ™å‡å°‘
            const baseReward = Math.floor(pomodoro.totalTime / 60) * 2; // åŸºç¡€å¥–åŠ±ï¼šæ¯åˆ†é’Ÿ2é‡‘å¸
            const completionRate = actualDuration / pomodoro.totalTime;
            const finalReward = Math.max(1, Math.floor(baseReward * completionRate));
            
            // å‘æ”¾é‡‘å¸å¥–åŠ±
            state.money += finalReward;
            
            // æ˜¾ç¤ºå¥–åŠ±ä¿¡æ¯
            const finishMsgs = pomodoroDialogue.finish;
            showToast(`${finishMsgs[Math.floor(Math.random() * finishMsgs.length)]} è·å¾— ${finalReward}ğŸ’°`);
            
            addTrust(2);
            updateMood(8);
            updateUI();
            
            recordSystem.addRecord(
                'ç•ªèŒ„é’Ÿä¸“æ³¨å®Œæˆ',
                `å®Œæˆç•ªèŒ„é’Ÿä¸“æ³¨ï¼š${pomodoro.currentTask}ï¼Œæ—¶é•¿ï¼š${formatTime(actualDuration)}ã€‚è·å¾— ${finalReward} é‡‘å¸ã€‚`,
                ['ç•ªèŒ„é’Ÿ', 'ä¸“æ³¨']
            );
        } else {
            // ç”¨æˆ·æ”¾å¼ƒä»»åŠ¡çš„æƒ…å†µ
            const cancelMsgs = pomodoroDialogue.cancel;
            showToast(cancelMsgs[Math.floor(Math.random() * cancelMsgs.length)]);
            
            updateMood(-3);
        }
        
        document.getElementById('pomodoro-fullscreen').style.display = 'none';
        resetPomodoro();
    }

    function cancelPomodoro() {
        // æ”¾å¼ƒä»»åŠ¡ï¼Œè°ƒç”¨finishPomodoro(false)å¤„ç†å¤±è´¥é€»è¾‘
        finishPomodoro(false);
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}åˆ†${secs}ç§’`;
    }

    // === å°æ¸¸æˆç³»ç»Ÿ - ä¿®å¤ç‰ˆ ===
    
    // 2048æ¸¸æˆ - ä¿®å¤æ•°å­—å—å®šä½é—®é¢˜
    function startGame2048() {
        closeModal('game-select-modal');
        
        if (!game2048.initialized) {
            initGame2048();
        } else {
            restartGame2048();
        }
        
        openModal('game2048-modal');
        
        // æ·»åŠ é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', handleGame2048Key);
        
        if (!state.gameHistory) state.gameHistory = [];
        state.gameHistory.push({
            game: '2048',
            startTime: new Date().toLocaleString(),
            score: 0
        });
    }
    
    function initGame2048() {
        game2048.grid = [];
        game2048.score = 0;
        game2048.gameOver = false;
        game2048.tiles = [];
        game2048.initialized = true;
        game2048.touchDirection = null;
        game2048.touchInterval = null;
        
        for (let i = 0; i < 4; i++) {
            game2048.grid[i] = [0, 0, 0, 0];
        }
        
        addRandomTile();
        addRandomTile();
        
        renderGame2048();
    }
    
    function restartGame2048() {
        initGame2048();
        document.getElementById('game2048-score').textContent = '0';
    }
    
    function closeGame2048() {
        closeModal('game2048-modal');
        document.removeEventListener('keydown', handleGame2048Key);
        
        // æ¸…é™¤è§¦æ‘¸é—´éš”
        if (game2048.touchInterval) {
            clearInterval(game2048.touchInterval);
            game2048.touchInterval = null;
        }
        
        if (game2048.score > 0) {
            const coins = Math.floor(game2048.score / 100);
            if (coins > 0) {
                state.money += coins;
                showToast(`æ¸¸æˆç»“æŸï¼è·å¾— ${coins} é‡‘å¸`);
                updateUI();
                
                // å®é™…å®Œæˆæ¸¸æˆåæ›´æ–°ä»»åŠ¡è¿›åº¦
                updateTaskProgress('play_game');
                
                saveState();
                
                if (state.gameHistory && state.gameHistory.length > 0) {
                    const lastGame = state.gameHistory[state.gameHistory.length - 1];
                    lastGame.endTime = new Date().toLocaleString();
                    lastGame.finalScore = game2048.score;
                    lastGame.coinsEarned = coins;
                    
                    recordSystem.addRecord(
                        'å°æ¸¸æˆï¼š2048',
                        `å®Œæˆ2048æ¸¸æˆã€‚æœ€ç»ˆåˆ†æ•°ï¼š${game2048.score}ï¼Œè·å¾—é‡‘å¸ï¼š${coins}ã€‚`,
                        ['æ¸¸æˆ', '2048']
                    );
                }
            }
        }
    }
    
    function handleGame2048Key(e) {
        if (game2048.gameOver) return;
        
        let moved = false;
        
        switch(e.key) {
            case 'ArrowUp':
            case 'w':
            case 'W':
                moved = moveUp();
                break;
            case 'ArrowDown':
            case 's':
            case 'S':
                moved = moveDown();
                break;
            case 'ArrowLeft':
            case 'a':
            case 'A':
                moved = moveLeft();
                break;
            case 'ArrowRight':
            case 'd':
            case 'D':
                moved = moveRight();
                break;
        }
        
        if (moved) {
            addRandomTile();
            renderGame2048();
            
            if (isGameOver()) {
                game2048.gameOver = true;
                setTimeout(() => {
                    showToast("æ¸¸æˆç»“æŸï¼");
                }, 500);
            }
        }
    }
    
    // 2048è§¦å±æ§åˆ¶
    function handleGame2048Touch(direction) {
        if (game2048.gameOver) return;
        
        game2048.touchDirection = direction;
        
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡ç§»åŠ¨
        executeGame2048Move(direction);
        
        // è®¾ç½®é‡å¤ç§»åŠ¨çš„é—´éš”
        if (game2048.touchInterval) {
            clearInterval(game2048.touchInterval);
        }
        
        game2048.touchInterval = setInterval(() => {
            executeGame2048Move(direction);
        }, 200);
        
        return false;
    }
    
    function clearGame2048Touch() {
        if (game2048.touchInterval) {
            clearInterval(game2048.touchInterval);
            game2048.touchInterval = null;
        }
        game2048.touchDirection = null;
    }
    
    function executeGame2048Move(direction) {
        let moved = false;
        
        switch(direction) {
            case 'up':
                moved = moveUp();
                break;
            case 'down':
                moved = moveDown();
                break;
            case 'left':
                moved = moveLeft();
                break;
            case 'right':
                moved = moveRight();
                break;
        }
        
        if (moved) {
            addRandomTile();
            renderGame2048();
            
            if (isGameOver()) {
                game2048.gameOver = true;
                if (game2048.touchInterval) {
                    clearInterval(game2048.touchInterval);
                    game2048.touchInterval = null;
                }
                setTimeout(() => {
                    showToast("æ¸¸æˆç»“æŸï¼");
                }, 500);
            }
        }
    }
    
    function moveUp() {
        let moved = false;
        
        for (let col = 0; col < 4; col++) {
            let column = [];
            for (let row = 0; row < 4; row++) {
                if (game2048.grid[row][col] !== 0) {
                    column.push(game2048.grid[row][col]);
                }
            }
            
            for (let i = 0; i < column.length - 1; i++) {
                if (column[i] === column[i + 1]) {
                    column[i] *= 2;
                    game2048.score += column[i];
                    column.splice(i + 1, 1);
                }
            }
            
            while (column.length < 4) {
                column.push(0);
            }
            
            for (let row = 0; row < 4; row++) {
                if (game2048.grid[row][col] !== column[row]) {
                    moved = true;
                }
                game2048.grid[row][col] = column[row];
            }
        }
        
        if (moved) {
            document.getElementById('game2048-score').textContent = game2048.score;
        }
        
        return moved;
    }
    
    function moveDown() {
        let moved = false;
        
        for (let col = 0; col < 4; col++) {
            let column = [];
            for (let row = 3; row >= 0; row--) {
                if (game2048.grid[row][col] !== 0) {
                    column.push(game2048.grid[row][col]);
                }
            }
            
            for (let i = 0; i < column.length - 1; i++) {
                if (column[i] === column[i + 1]) {
                    column[i] *= 2;
                    game2048.score += column[i];
                    column.splice(i + 1, 1);
                }
            }
            
            while (column.length < 4) {
                column.push(0);
            }
            
            for (let row = 3; row >= 0; row--) {
                if (game2048.grid[row][col] !== column[3 - row]) {
                    moved = true;
                }
                game2048.grid[row][col] = column[3 - row];
            }
        }
        
        if (moved) {
            document.getElementById('game2048-score').textContent = game2048.score;
        }
        
        return moved;
    }
    
    function moveLeft() {
        let moved = false;
        
        for (let row = 0; row < 4; row++) {
            let line = [];
            for (let col = 0; col < 4; col++) {
                if (game2048.grid[row][col] !== 0) {
                    line.push(game2048.grid[row][col]);
                }
            }
            
            for (let i = 0; i < line.length - 1; i++) {
                if (line[i] === line[i + 1]) {
                    line[i] *= 2;
                    game2048.score += line[i];
                    line.splice(i + 1, 1);
                }
            }
            
            while (line.length < 4) {
                line.push(0);
            }
            
            for (let col = 0; col < 4; col++) {
                if (game2048.grid[row][col] !== line[col]) {
                    moved = true;
                }
                game2048.grid[row][col] = line[col];
            }
        }
        
        if (moved) {
            document.getElementById('game2048-score').textContent = game2048.score;
        }
        
        return moved;
    }
    
    function moveRight() {
        let moved = false;
        
        for (let row = 0; row < 4; row++) {
            let line = [];
            for (let col = 3; col >= 0; col--) {
                if (game2048.grid[row][col] !== 0) {
                    line.push(game2048.grid[row][col]);
                }
            }
            
            for (let i = 0; i < line.length - 1; i++) {
                if (line[i] === line[i + 1]) {
                    line[i] *= 2;
                    game2048.score += line[i];
                    line.splice(i + 1, 1);
                }
            }
            
            while (line.length < 4) {
                line.push(0);
            }
            
            for (let col = 3; col >= 0; col--) {
                if (game2048.grid[row][col] !== line[3 - col]) {
                    moved = true;
                }
                game2048.grid[row][col] = line[3 - col];
            }
        }
        
        if (moved) {
            document.getElementById('game2048-score').textContent = game2048.score;
        }
        
        return moved;
    }
    
    function addRandomTile() {
        let emptyCells = [];
        
        for (let row = 0; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                if (game2048.grid[row][col] === 0) {
                    emptyCells.push({row, col});
                }
            }
        }
        
        if (emptyCells.length > 0) {
            const cell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
            game2048.grid[cell.row][cell.col] = Math.random() < 0.9 ? 2 : 4;
        }
    }
    
    function isGameOver() {
        for (let row = 0; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                if (game2048.grid[row][col] === 0) {
                    return false;
                }
            }
        }
        
        for (let row = 0; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                const value = game2048.grid[row][col];
                
                if (col < 3 && game2048.grid[row][col + 1] === value) {
                    return false;
                }
                
                if (row < 3 && game2048.grid[row + 1][col] === value) {
                    return false;
                }
            }
        }
        
        return true;
    }
    
    // ä¿®å¤renderGame2048å‡½æ•°ï¼Œç¡®ä¿æ•°å­—å—å‡†ç¡®å¯¹é½
    function renderGame2048() {
        const gridContainer = document.getElementById('game2048-grid');
        gridContainer.innerHTML = '';
        
        // è·å–ç½‘æ ¼çš„å®é™…å°ºå¯¸
        const gridRect = gridContainer.getBoundingClientRect();
        const cellSize = 60; // æ¯ä¸ªæ•°å­—å—çš„å¤§å°
        const gap = 10; // é—´éš”
        
        // å…ˆç»˜åˆ¶èƒŒæ™¯æ ¼å­
        for (let row = 0; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                const cell = document.createElement('div');
                cell.className = 'game2048-cell';
                gridContainer.appendChild(cell);
            }
        }
        
        // å†ç»˜åˆ¶æ•°å­—å—
        for (let row = 0; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                const value = game2048.grid[row][col];
                if (value !== 0) {
                    const tile = document.createElement('div');
                    tile.className = `game2048-tile tile-${value}`;
                    tile.textContent = value;
                    
                    // å‡†ç¡®è®¡ç®—ä½ç½®
                    const left = col * (cellSize + gap) + gap;
                    const top = row * (cellSize + gap) + gap;
                    
                    tile.style.width = `${cellSize}px`;
                    tile.style.height = `${cellSize}px`;
                    tile.style.left = `${left}px`;
                    tile.style.top = `${top}px`;
                    tile.style.lineHeight = `${cellSize}px`;
                    
                    // æ ¹æ®æ•°å­—å¤§å°è°ƒæ•´å­—ä½“
                    if (value >= 1000) {
                        tile.style.fontSize = '20px';
                    } else if (value >= 100) {
                        tile.style.fontSize = '22px';
                    } else if (value >= 10) {
                        tile.style.fontSize = '24px';
                    } else {
                        tile.style.fontSize = '28px';
                    }
                    
                    tile.style.textAlign = 'center';
                    tile.style.display = 'flex';
                    tile.style.alignItems = 'center';
                    tile.style.justifyContent = 'center';
                    
                    gridContainer.appendChild(tile);
                }
            }
        }
    }
    
    // æ‰“ç –å—æ¸¸æˆ - ä¿®å¤ç‰ˆ
    function startBrickBreaker() {
        closeModal('game-select-modal');
        
        brickBreaker.canvas = document.getElementById('brickbreaker-canvas');
        brickBreaker.ctx = brickBreaker.canvas.getContext('2d');
        
        initBrickBreaker();
        openModal('game-brickbreaker-modal');
        
        // æ·»åŠ é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', handleBrickBreakerKey);
        
        if (!state.gameHistory) state.gameHistory = [];
        state.gameHistory.push({
            game: 'æ‰“ç –å—',
            startTime: new Date().toLocaleString(),
            score: 0
        });
        
        brickBreaker.gameRunning = true;
        requestAnimationFrame(gameLoopBrickBreaker);
    }
    
    function initBrickBreaker() {
        // åˆå§‹åŒ–ç”»å¸ƒ
        const canvas = document.getElementById('brickbreaker-canvas');
        brickBreaker.canvas = canvas;
        brickBreaker.ctx = canvas.getContext('2d');
        
        // åˆå§‹åŒ–æŒ¡æ¿
        brickBreaker.paddle = { 
            x: 150, 
            y: 380, 
            width: 80, 
            height: 10 
        };
        
        // åˆå§‹åŒ–çƒ
        brickBreaker.ball = { 
            x: 150, 
            y: 370, 
            radius: 8, 
            dx: 3, 
            dy: -3 
        };
        
            // åˆå§‹åŒ–ç –å— - ä¿®å¤å³ä¾§ç –å—æº¢å‡ºé—®é¢˜
            brickBreaker.bricks = [];
            const brickRowCount = 5;
            const brickColumnCount = 8;
            const brickWidth = 35;
            const brickHeight = 15;
            const brickPadding = 5;
            const brickOffsetTop = 50;
            
            // è®¡ç®—æ€»å®½åº¦å¹¶å±…ä¸­ç –å—
            const totalBricksWidth = brickColumnCount * brickWidth + (brickColumnCount - 1) * brickPadding;
            const brickOffsetLeft = (brickBreaker.canvas.width - totalBricksWidth) / 2;
            
            for (let c = 0; c < brickColumnCount; c++) {
                brickBreaker.bricks[c] = [];
                for (let r = 0; r < brickRowCount; r++) {
                    const brickX = c * (brickWidth + brickPadding) + brickOffsetLeft;
                    const brickY = r * (brickHeight + brickPadding) + brickOffsetTop;
                    brickBreaker.bricks[c][r] = { 
                        x: brickX, 
                        y: brickY, 
                        width: brickWidth, 
                        height: brickHeight, 
                        visible: true 
                    };
                }
            }
        
        brickBreaker.score = 0;
        brickBreaker.paddleDirection = 0;
        brickBreaker.touchInterval = null;
        
        document.getElementById('brickbreaker-score').textContent = '0';
    }
    
    function gameLoopBrickBreaker(timestamp) {
        if (!brickBreaker.gameRunning) return;
        
        brickBreaker.ctx.clearRect(0, 0, brickBreaker.canvas.width, brickBreaker.canvas.height);
        
        drawBricks();
        drawPaddle();
        drawBall();
        
        // æ›´æ–°æŒ¡æ¿ä½ç½®
        if (brickBreaker.paddleDirection !== 0) {
            brickBreaker.paddle.x += brickBreaker.paddleSpeed * brickBreaker.paddleDirection;
            brickBreaker.paddle.x = Math.max(0, Math.min(brickBreaker.paddle.x, brickBreaker.canvas.width - brickBreaker.paddle.width));
        }
        
        brickBreaker.ball.x += brickBreaker.ball.dx;
        brickBreaker.ball.y += brickBreaker.ball.dy;
        
        // è¾¹ç•Œç¢°æ’æ£€æµ‹
        if (brickBreaker.ball.x + brickBreaker.ball.radius > brickBreaker.canvas.width || brickBreaker.ball.x - brickBreaker.ball.radius < 0) {
            brickBreaker.ball.dx = -brickBreaker.ball.dx;
        }
        
        if (brickBreaker.ball.y - brickBreaker.ball.radius < 0) {
            brickBreaker.ball.dy = -brickBreaker.ball.dy;
        }
        
        // æ¸¸æˆç»“æŸæ¡ä»¶
        if (brickBreaker.ball.y + brickBreaker.ball.radius > brickBreaker.canvas.height) {
            brickBreaker.gameRunning = false;
            showToast("æ¸¸æˆç»“æŸï¼çƒæ‰ä¸‹å»äº†");
            return;
        }
        
        // æŒ¡æ¿ç¢°æ’æ£€æµ‹
        if (
            brickBreaker.ball.x + brickBreaker.ball.radius > brickBreaker.paddle.x &&
            brickBreaker.ball.x - brickBreaker.ball.radius < brickBreaker.paddle.x + brickBreaker.paddle.width &&
            brickBreaker.ball.y + brickBreaker.ball.radius > brickBreaker.paddle.y &&
            brickBreaker.ball.y - brickBreaker.ball.radius < brickBreaker.paddle.y + brickBreaker.paddle.height
        ) {
            brickBreaker.ball.dy = -Math.abs(brickBreaker.ball.dy);
            
            // æ ¹æ®å‡»ä¸­æŒ¡æ¿çš„ä½ç½®è°ƒæ•´åå¼¹è§’åº¦
            const hitPos = (brickBreaker.ball.x - brickBreaker.paddle.x) / brickBreaker.paddle.width;
            brickBreaker.ball.dx = 5 * (hitPos - 0.5);
        }
        
        // ç –å—ç¢°æ’æ£€æµ‹
        for (let c = 0; c < brickBreaker.bricks.length; c++) {
            for (let r = 0; r < brickBreaker.bricks[c].length; r++) {
                const brick = brickBreaker.bricks[c][r];
                if (brick.visible) {
                    if (
                        brickBreaker.ball.x + brickBreaker.ball.radius > brick.x &&
                        brickBreaker.ball.x - brickBreaker.ball.radius < brick.x + brick.width &&
                        brickBreaker.ball.y + brickBreaker.ball.radius > brick.y &&
                        brickBreaker.ball.y - brickBreaker.ball.radius < brick.y + brick.height
                    ) {
                        brickBreaker.ball.dy = -brickBreaker.ball.dy;
                        brick.visible = false;
                        brickBreaker.score += 10;
                        document.getElementById('brickbreaker-score').textContent = brickBreaker.score;
                        
                        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç –å—éƒ½è¢«å‡»ç¢
                        let allBricksGone = true;
                        for (let c2 = 0; c2 < brickBreaker.bricks.length; c2++) {
                            for (let r2 = 0; r2 < brickBreaker.bricks[c2].length; r2++) {
                                if (brickBreaker.bricks[c2][r2].visible) {
                                    allBricksGone = false;
                                    break;
                                }
                            }
                            if (!allBricksGone) break;
                        }
                        
                        if (allBricksGone) {
                            brickBreaker.gameRunning = false;
                            showToast("æ­å–œï¼ä½ å‡»ç¢äº†æ‰€æœ‰ç –å—ï¼");
                            return;
                        }
                    }
                }
            }
        }
        
        brickBreaker.animationId = requestAnimationFrame(gameLoopBrickBreaker);
    }
    
    function drawBricks() {
        for (let c = 0; c < brickBreaker.bricks.length; c++) {
            for (let r = 0; r < brickBreaker.bricks[c].length; r++) {
                const brick = brickBreaker.bricks[c][r];
                if (brick.visible) {
                    brickBreaker.ctx.fillStyle = `hsl(${r * 60}, 70%, 50%)`;
                    brickBreaker.ctx.fillRect(brick.x, brick.y, brick.width, brick.height);
                    brickBreaker.ctx.strokeStyle = '#000';
                    brickBreaker.ctx.strokeRect(brick.x, brick.y, brick.width, brick.height);
                }
            }
        }
    }
    
    function drawPaddle() {
        brickBreaker.ctx.fillStyle = '#FF6B6B';
        brickBreaker.ctx.fillRect(brickBreaker.paddle.x, brickBreaker.paddle.y, brickBreaker.paddle.width, brickBreaker.paddle.height);
        brickBreaker.ctx.strokeStyle = '#000';
        brickBreaker.ctx.strokeRect(brickBreaker.paddle.x, brickBreaker.paddle.y, brickBreaker.paddle.width, brickBreaker.paddle.height);
    }
    
    function drawBall() {
        brickBreaker.ctx.beginPath();
        brickBreaker.ctx.arc(brickBreaker.ball.x, brickBreaker.ball.y, brickBreaker.ball.radius, 0, Math.PI * 2);
        brickBreaker.ctx.fillStyle = '#4ECDC4';
        brickBreaker.ctx.fill();
        brickBreaker.ctx.strokeStyle = '#000';
        brickBreaker.ctx.stroke();
        brickBreaker.ctx.closePath();
    }
    
    function handleBrickBreakerKey(e) {
        switch(e.key) {
            case 'ArrowLeft':
            case 'a':
            case 'A':
                brickBreaker.paddleDirection = -1;
                break;
            case 'ArrowRight':
            case 'd':
            case 'D':
                brickBreaker.paddleDirection = 1;
                break;
        }
    }
    
    // è§¦å±æ§åˆ¶å‡½æ•°
    function startMovePaddleLeft() {
        brickBreaker.paddleDirection = -1;
        
        if (brickBreaker.touchInterval) {
            clearInterval(brickBreaker.touchInterval);
        }
        
        brickBreaker.touchInterval = setInterval(() => {
            brickBreaker.paddleDirection = -1;
        }, 50);
    }
    
    function startMovePaddleRight() {
        brickBreaker.paddleDirection = 1;
        
        if (brickBreaker.touchInterval) {
            clearInterval(brickBreaker.touchInterval);
        }
        
        brickBreaker.touchInterval = setInterval(() => {
            brickBreaker.paddleDirection = 1;
        }, 50);
    }
    
    function stopPaddle() {
        brickBreaker.paddleDirection = 0;
        
        if (brickBreaker.touchInterval) {
            clearInterval(brickBreaker.touchInterval);
            brickBreaker.touchInterval = null;
        }
    }
    
    function closeBrickBreaker() {
        closeModal('game-brickbreaker-modal');
        document.removeEventListener('keydown', handleBrickBreakerKey);
        
        if (brickBreaker.animationId) {
            cancelAnimationFrame(brickBreaker.animationId);
        }
        
        if (brickBreaker.touchInterval) {
            clearInterval(brickBreaker.touchInterval);
            brickBreaker.touchInterval = null;
        }
        
        brickBreaker.gameRunning = false;
        brickBreaker.paddleDirection = 0;
        
        if (brickBreaker.score > 0) {
            const coins = Math.floor(brickBreaker.score / 10);
            if (coins > 0) {
                state.money += coins;
                showToast(`æ¸¸æˆç»“æŸï¼è·å¾— ${coins} é‡‘å¸`);
                updateUI();
                
                // å®é™…å®Œæˆæ¸¸æˆåæ›´æ–°ä»»åŠ¡è¿›åº¦
                updateTaskProgress('play_game');
                
                saveState();
                
                if (state.gameHistory && state.gameHistory.length > 0) {
                    const lastGame = state.gameHistory[state.gameHistory.length - 1];
                    lastGame.endTime = new Date().toLocaleString();
                    lastGame.finalScore = brickBreaker.score;
                    lastGame.coinsEarned = coins;
                    
                    recordSystem.addRecord(
                        'å°æ¸¸æˆï¼šæ‰“ç –å—',
                        `å®Œæˆæ‰“ç –å—æ¸¸æˆã€‚æœ€ç»ˆåˆ†æ•°ï¼š${brickBreaker.score}ï¼Œè·å¾—é‡‘å¸ï¼š${coins}ã€‚`,
                        ['æ¸¸æˆ', 'æ‰“ç –å—']
                    );
                }
            }
        }
    }
    
    function restartBrickBreaker() {
        if (brickBreaker.animationId) {
            cancelAnimationFrame(brickBreaker.animationId);
        }
        if (brickBreaker.touchInterval) {
            clearInterval(brickBreaker.touchInterval);
            brickBreaker.touchInterval = null;
        }
        initBrickBreaker();
        brickBreaker.gameRunning = true;
        brickBreaker.paddleDirection = 0;
        requestAnimationFrame(gameLoopBrickBreaker);
    }
    
    // ä¿„ç½—æ–¯æ–¹å—æ¸¸æˆ - ä¿®å¤ç‰ˆ
    function startTetris() {
        closeModal('game-select-modal');
        
        tetris.canvas = document.getElementById('tetris-canvas');
        tetris.ctx = tetris.canvas.getContext('2d');
        
        initTetris();
        openModal('game-tetris-modal');
        
        // æ·»åŠ é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', handleTetrisKey);
        
        if (!state.gameHistory) state.gameHistory = [];
        state.gameHistory.push({
            game: 'ä¿„ç½—æ–¯æ–¹å—',
            startTime: new Date().toLocaleString(),
            score: 0
        });
        
        tetris.lastTime = 0;
        tetris.touchAction = null;
        tetris.touchInterval = null;
        requestAnimationFrame(gameLoopTetris);
    }
    
    function initTetris() {
        // åˆå§‹åŒ–ç½‘æ ¼ - ä¿®å¤ï¼šç¡®ä¿æ­£ç¡®åˆå§‹åŒ–
        const rows = 20;
        const cols = 10;
        
        tetris.grid = [];
        for (let r = 0; r < rows; r++) {
            tetris.grid[r] = [];
            for (let c = 0; c < cols; c++) {
                tetris.grid[r][c] = 0;
            }
        }
        
        // æ–¹å—å½¢çŠ¶å®šä¹‰ - ä¿®å¤ï¼šä½¿ç”¨æ›´æ¸…æ™°çš„å½¢çŠ¶æ•°ç»„
        tetris.shapes = [
            // I
            [
                [1,1,1,1]
            ],
            // O
            [
                [1,1],
                [1,1]
            ],
            // T
            [
                [0,1,0],
                [1,1,1]
            ],
            // Z
            [
                [1,1,0],
                [0,1,1]
            ],
            // S
            [
                [0,1,1],
                [1,1,0]
            ],
            // J
            [
                [1,0,0],
                [1,1,1]
            ],
            // L
            [
                [0,0,1],
                [1,1,1]
            ]
        ];
        
        // æ–¹å—é¢œè‰²
        tetris.colors = [
            '#FF6B6B', // çº¢è‰²
            '#4ECDC4', // é’è‰²
            '#FFD166', // é»„è‰²
            '#06D6A0', // ç»¿è‰²
            '#118AB2', // è“è‰²
            '#EF476F', // ç²‰è‰²
            '#7B68EE'  // ç´«è‰²
        ];
        
        // åˆ›å»ºæ–°æ–¹å—
        createNewPiece();
        
        tetris.score = 0;
        tetris.gameOver = false;
        tetris.dropCounter = 0;
        tetris.dropInterval = 1000;
        tetris.blockSize = 20;
        
        document.getElementById('tetris-score').textContent = '0';
    }
    
    function createNewPiece() {
        const shapeIndex = Math.floor(Math.random() * tetris.shapes.length);
        tetris.currentPiece = {
            shape: JSON.parse(JSON.stringify(tetris.shapes[shapeIndex])), // æ·±æ‹·è´
            color: tetris.colors[shapeIndex],
            shapeIndex: shapeIndex, // ä¿å­˜å½¢çŠ¶ç´¢å¼•
            x: Math.floor((10 - tetris.shapes[shapeIndex][0].length) / 2), // å±…ä¸­æ˜¾ç¤º
            y: 0
        };
    }
    
    function gameLoopTetris(time) {
        if (tetris.gameOver) return;
        
        const deltaTime = time - tetris.lastTime;
        tetris.lastTime = time;
        
        tetris.dropCounter += deltaTime;
        if (tetris.dropCounter > tetris.dropInterval) {
            dropPiece();
            tetris.dropCounter = 0;
        }
        
        // ç»˜åˆ¶æ¸¸æˆ
        drawTetrisGrid();
        drawCurrentPiece();
        
        tetris.animationId = requestAnimationFrame(gameLoopTetris);
    }
    
    function drawTetrisGrid() {
        const blockSize = tetris.blockSize;
        
        // æ¸…é™¤ç”»å¸ƒ
        tetris.ctx.fillStyle = '#000';
        tetris.ctx.fillRect(0, 0, tetris.canvas.width, tetris.canvas.height);
        
        // ç»˜åˆ¶ç½‘æ ¼çº¿
        tetris.ctx.strokeStyle = '#333';
        tetris.ctx.lineWidth = 0.5;
        
        // ç»˜åˆ¶å·²é”å®šçš„æ–¹å—
        for (let r = 0; r < 20; r++) {
            for (let c = 0; c < 10; c++) {
                // ç»˜åˆ¶ç½‘æ ¼çº¿
                tetris.ctx.strokeRect(c * blockSize, r * blockSize, blockSize, blockSize);
                
                // ç»˜åˆ¶æ–¹å—
                if (tetris.grid[r][c] > 0) {
                    const colorIndex = tetris.grid[r][c] - 1;
                    if (colorIndex >= 0 && colorIndex < tetris.colors.length) {
                        // ç»˜åˆ¶æ–¹å—ä¸»ä½“
                        tetris.ctx.fillStyle = tetris.colors[colorIndex];
                        tetris.ctx.fillRect(c * blockSize + 1, r * blockSize + 1, blockSize - 2, blockSize - 2);
                        
                        // ç»˜åˆ¶æ–¹å—è¾¹æ¡†
                        tetris.ctx.strokeStyle = '#FFF';
                        tetris.ctx.lineWidth = 1;
                        tetris.ctx.strokeRect(c * blockSize + 0.5, r * blockSize + 0.5, blockSize - 1, blockSize - 1);
                        tetris.ctx.strokeStyle = '#333';
                        tetris.ctx.lineWidth = 0.5;
                    }
                }
            }
        }
    }
    
    function drawCurrentPiece() {
        if (!tetris.currentPiece || tetris.gameOver) return;
        
        const piece = tetris.currentPiece;
        const blockSize = tetris.blockSize;
        
        tetris.ctx.fillStyle = piece.color;
        
        for (let r = 0; r < piece.shape.length; r++) {
            for (let c = 0; c < piece.shape[r].length; c++) {
                if (piece.shape[r][c]) {
                    const x = (piece.x + c) * blockSize;
                    const y = (piece.y + r) * blockSize;
                    
                    // ç»˜åˆ¶æ–¹å—ä¸»ä½“
                    tetris.ctx.fillRect(x + 1, y + 1, blockSize - 2, blockSize - 2);
                    
                    // ç»˜åˆ¶æ–¹å—è¾¹æ¡†
                    tetris.ctx.strokeStyle = '#FFF';
                    tetris.ctx.lineWidth = 1;
                    tetris.ctx.strokeRect(x + 0.5, y + 0.5, blockSize - 1, blockSize - 1);
                    tetris.ctx.strokeStyle = '#333';
                    tetris.ctx.lineWidth = 0.5;
                }
            }
        }
    }
    
    function dropPiece() {
        if (!tetris.currentPiece || tetris.gameOver) return;
        
        // å°è¯•å‘ä¸‹ç§»åŠ¨
        tetris.currentPiece.y++;
        
        // å¦‚æœå‘ç”Ÿç¢°æ’ï¼Œå›é€€å¹¶é”å®šæ–¹å—
        if (checkTetrisCollision()) {
            tetris.currentPiece.y--;
            lockPiece();
            clearLines();
            
            // åˆ›å»ºæ–°æ–¹å—
            createNewPiece();
            
            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸï¼ˆæ–°æ–¹å—ç”Ÿæˆæ—¶å°±å‘ç”Ÿç¢°æ’ï¼‰
            if (checkTetrisCollision()) {
                tetris.gameOver = true;
                showToast("æ¸¸æˆç»“æŸï¼æ–¹å—å †åˆ°é¡¶éƒ¨äº†");
                if (tetris.animationId) {
                    cancelAnimationFrame(tetris.animationId);
                    tetris.animationId = null;
                }
            }
        }
    }
    
    function checkTetrisCollision() {
        const piece = tetris.currentPiece;
        if (!piece) return true;
        
        // æ£€æŸ¥å½“å‰æ–¹å—çš„æ¯ä¸ªå°æ–¹å—
        for (let r = 0; r < piece.shape.length; r++) {
            for (let c = 0; c < piece.shape[r].length; c++) {
                if (piece.shape[r][c]) {
                    const newX = piece.x + c;
                    const newY = piece.y + r;
                    
                    // æ£€æŸ¥è¾¹ç•Œ
                    if (newX < 0 || newX >= 10) {
                        return true; // è¶…å‡ºå·¦å³è¾¹ç•Œ
                    }
                    
                    if (newY >= 20) {
                        return true; // è¶…å‡ºåº•éƒ¨
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸å·²æœ‰æ–¹å—é‡å ï¼ˆåªæ£€æŸ¥åœ¨ç½‘æ ¼å†…çš„ä½ç½®ï¼‰
                    if (newY >= 0 && tetris.grid[newY] && tetris.grid[newY][newX] > 0) {
                        return true; // ä¸å·²æœ‰æ–¹å—ç¢°æ’
                    }
                }
            }
        }
        
        return false;
    }
    
    function lockPiece() {
        const piece = tetris.currentPiece;
        if (!piece) return;
        
        for (let r = 0; r < piece.shape.length; r++) {
            for (let c = 0; c < piece.shape[r].length; c++) {
                if (piece.shape[r][c]) {
                    const gridY = piece.y + r;
                    const gridX = piece.x + c;
                    
                    // ç¡®ä¿ä½ç½®åœ¨ç½‘æ ¼å†…
                    if (gridY >= 0 && gridY < 20 && gridX >= 0 && gridX < 10) {
                        // ä½¿ç”¨å½¢çŠ¶ç´¢å¼• + 1 æ¥ä¿å­˜æ–¹å—ç±»å‹ï¼ˆ0è¡¨ç¤ºç©ºï¼‰
                        tetris.grid[gridY][gridX] = piece.shapeIndex + 1;
                    }
                }
            }
        }
    }
    
    function clearLines() {
        let linesCleared = 0;
        
        // ä»åº•éƒ¨å‘ä¸Šæ£€æŸ¥
        for (let r = 19; r >= 0; r--) {
            let isFull = true;
            
            // æ£€æŸ¥è¯¥è¡Œæ˜¯å¦å¡«æ»¡
            for (let c = 0; c < 10; c++) {
                if (tetris.grid[r][c] === 0) {
                    isFull = false;
                    break;
                }
            }
            
            // å¦‚æœå¡«æ»¡ï¼Œæ¸…é™¤è¯¥è¡Œ
            if (isFull) {
                // å°†ä¸Šé¢çš„æ‰€æœ‰è¡Œå‘ä¸‹ç§»åŠ¨ä¸€è¡Œ
                for (let y = r; y > 0; y--) {
                    for (let c = 0; c < 10; c++) {
                        tetris.grid[y][c] = tetris.grid[y - 1][c];
                    }
                }
                
                // æ¸…ç©ºæœ€é¡¶éƒ¨ä¸€è¡Œ
                for (let c = 0; c < 10; c++) {
                    tetris.grid[0][c] = 0;
                }
                
                linesCleared++;
                
                // ç”±äºç§»åŠ¨äº†è¡Œï¼Œéœ€è¦å†æ¬¡æ£€æŸ¥å½“å‰è¡Œ
                r++;
            }
        }
        
        // è®¡ç®—åˆ†æ•°
        if (linesCleared > 0) {
            const points = [0, 40, 100, 300, 1200];
            tetris.score += points[linesCleared];
            document.getElementById('tetris-score').textContent = tetris.score;
            
            // éšç€åˆ†æ•°å¢åŠ ï¼ŒåŠ å¿«ä¸‹è½é€Ÿåº¦
            tetris.dropInterval = Math.max(100, 1000 - Math.floor(tetris.score / 100) * 50);
        }
    }
    
    function handleTetrisKey(e) {
        if (tetris.gameOver) return;
        
        switch(e.key) {
            case 'ArrowLeft':
                movePiece(-1, 0);
                break;
            case 'ArrowRight':
                movePiece(1, 0);
                break;
            case 'ArrowDown':
                softDrop();
                break;
            case 'ArrowUp':
                rotatePiece();
                break;
            case ' ':
                hardDrop();
                break;
        }
    }
    
    function handleTetrisTouch(action) {
        if (tetris.gameOver) return;
        
        const now = Date.now();
        if (tetris.lastTouchTime && now - tetris.lastTouchTime < 100) {
            return;
        }
        tetris.lastTouchTime = now;
        
        switch(action) {
            case 'left':
                movePiece(-1, 0);
                break;
            case 'right':
                movePiece(1, 0);
                break;
            case 'down':
                softDrop();
                break;
            case 'up':
                rotatePiece();
                break;
            case 'fastdrop':
                hardDrop();
                break;
        }
        
        return false;
    }
    
    function clearTetrisTouch() {
        tetris.lastTouchTime = null;
    }
    
    function movePiece(dx, dy) {
        if (!tetris.currentPiece || tetris.gameOver) return false;
        
        // ä¿å­˜åŸæ¥çš„ä½ç½®
        const originalX = tetris.currentPiece.x;
        const originalY = tetris.currentPiece.y;
        
        // å°è¯•ç§»åŠ¨
        tetris.currentPiece.x += dx;
        tetris.currentPiece.y += dy;
        
        // æ£€æŸ¥ç¢°æ’
        if (checkTetrisCollision()) {
            // å¦‚æœç¢°æ’ï¼Œæ¢å¤åˆ°åŸæ¥çš„ä½ç½®
            tetris.currentPiece.x = originalX;
            tetris.currentPiece.y = originalY;
            return false;
        }
        
        return true;
    }
    
    function softDrop() {
        if (!tetris.currentPiece || tetris.gameOver) return;
        
        // å°è¯•å‘ä¸‹ç§»åŠ¨
        if (!movePiece(0, 1)) {
            // å¦‚æœæ— æ³•ç§»åŠ¨ï¼Œé”å®šæ–¹å—
            lockPiece();
            clearLines();
            createNewPiece();
        }
    }
    
    function hardDrop() {
        if (!tetris.currentPiece || tetris.gameOver) return;
        
        // ä¸€ç›´å‘ä¸‹ç§»åŠ¨ç›´åˆ°ç¢°æ’
        while (movePiece(0, 1)) {
            // ç»§ç»­ä¸‹è½
        }
        
        // é”å®šæ–¹å—
        lockPiece();
        clearLines();
        createNewPiece();
    }
    
    function rotatePiece() {
        if (!tetris.currentPiece || tetris.gameOver) return;
        
        // ä¿å­˜åŸå§‹å½¢çŠ¶
        const originalShape = JSON.parse(JSON.stringify(tetris.currentPiece.shape));
        const originalX = tetris.currentPiece.x;
        
        // è®¡ç®—æ—‹è½¬åçš„å½¢çŠ¶
        const rows = originalShape.length;
        const cols = originalShape[0].length;
        
        const rotated = [];
        for (let c = 0; c < cols; c++) {
            rotated[c] = [];
            for (let r = rows - 1; r >= 0; r--) {
                rotated[c][rows - 1 - r] = originalShape[r][c];
            }
        }
        
        // å°è¯•åº”ç”¨æ—‹è½¬
        tetris.currentPiece.shape = rotated;
        
        // æ£€æŸ¥æ—‹è½¬åæ˜¯å¦ä¼šå‘ç”Ÿç¢°æ’
        if (checkTetrisCollision()) {
            // å¦‚æœç¢°æ’ï¼Œå°è¯•å¢™è¸¢ï¼ˆwall kickï¼‰
            let kickOffset = 1;
            const maxKickAttempts = 2;
            
            for (let attempt = 0; attempt < maxKickAttempts; attempt++) {
                // å°è¯•å‘å·¦ç§»åŠ¨
                tetris.currentPiece.x = originalX - kickOffset;
                if (!checkTetrisCollision()) {
                    return; // å¢™è¸¢æˆåŠŸ
                }
                
                // å°è¯•å‘å³ç§»åŠ¨
                tetris.currentPiece.x = originalX + kickOffset;
                if (!checkTetrisCollision()) {
                    return; // å¢™è¸¢æˆåŠŸ
                }
                
                // é‡ç½®ä½ç½®
                tetris.currentPiece.x = originalX;
                kickOffset++;
            }
            
            // æ‰€æœ‰å¢™è¸¢å°è¯•éƒ½å¤±è´¥ï¼Œæ¢å¤åŸå§‹å½¢çŠ¶
            tetris.currentPiece.shape = originalShape;
        }
    }
    
    function closeTetris() {
        closeModal('game-tetris-modal');
        document.removeEventListener('keydown', handleTetrisKey);
        
        if (tetris.animationId) {
            cancelAnimationFrame(tetris.animationId);
        }
        
        if (tetris.touchInterval) {
            clearInterval(tetris.touchInterval);
            tetris.touchInterval = null;
        }
        
        // è®¡ç®—é‡‘å¸å¥–åŠ±
        if (tetris.score > 0) {
            const coins = Math.floor(tetris.score / 50);
            if (coins > 0) {
                state.money += coins;
                showToast(`æ¸¸æˆç»“æŸï¼è·å¾— ${coins} é‡‘å¸`);
                updateUI();
                
                // å®é™…å®Œæˆæ¸¸æˆåæ›´æ–°ä»»åŠ¡è¿›åº¦
                updateTaskProgress('play_game');
                
                saveState();
                
                if (state.gameHistory && state.gameHistory.length > 0) {
                    const lastGame = state.gameHistory[state.gameHistory.length - 1];
                    lastGame.endTime = new Date().toLocaleString();
                    lastGame.finalScore = tetris.score;
                    lastGame.coinsEarned = coins;
                    
                    recordSystem.addRecord(
                        'å°æ¸¸æˆï¼šä¿„ç½—æ–¯æ–¹å—',
                        `å®Œæˆä¿„ç½—æ–¯æ–¹å—æ¸¸æˆã€‚æœ€ç»ˆåˆ†æ•°ï¼š${tetris.score}ï¼Œè·å¾—é‡‘å¸ï¼š${coins}ã€‚`,
                        ['æ¸¸æˆ', 'ä¿„ç½—æ–¯æ–¹å—']
                    );
                }
            }
        }
    }
    
    function restartTetris() {
        if (tetris.animationId) {
            cancelAnimationFrame(tetris.animationId);
        }
        if (tetris.touchInterval) {
            clearInterval(tetris.touchInterval);
            tetris.touchInterval = null;
        }
        initTetris();
        tetris.lastTime = 0;
        tetris.touchAction = null;
        tetris.gameOver = false;
        requestAnimationFrame(gameLoopTetris);
    }

    // === è‡ªå®šä¹‰å¤´åƒç³»ç»Ÿ ===
    function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.match('image.*')) {
            showToast("è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶");
            return;
        }
        
        if (file.size > 2 * 1024 * 1024) {
            showToast("å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB");
            return;
        }
        
        selectedAvatarFile = file;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatar-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        showToast("å›¾ç‰‡å·²é€‰æ‹©ï¼Œç‚¹å‡»åº”ç”¨æŒ‰é’®è®¾ç½®å¤´åƒ");
    }

    function applyCustomAvatar() {
        if (!selectedAvatarFile) {
            showToast("è¯·å…ˆé€‰æ‹©å›¾ç‰‡");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const imgData = e.target.result;
            
            // åˆ›å»ºä¸´æ—¶å›¾ç‰‡æ£€æŸ¥é€æ˜åº¦
            const tempImg = new Image();
            tempImg.onload = function() {
                // æ›´æ–°æ‰€æœ‰å¤´åƒæ˜¾ç¤º
                document.getElementById('zaizai-img').src = imgData;
                document.getElementById('avatar-preview').src = imgData;
                document.getElementById('fullscreen-img').src = imgData;
                
                // å¦‚æœæ˜¯PNGå›¾ç‰‡ï¼Œæ·»åŠ æ°”æ³¡æ•ˆæœç±»
                if (selectedAvatarFile.type === 'image/png') {
                    document.getElementById('zaizai-img').classList.add('transparent-avatar-effect');
                    document.getElementById('avatar-preview').classList.add('transparent-avatar-effect');
                    document.getElementById('fullscreen-img').classList.add('transparent-avatar-effect');
                }
                
                state.customAvatar = imgData;
                
                showToast("å¤´åƒæ›´æ¢æˆåŠŸï¼é€æ˜æ•ˆæœå·²åº”ç”¨");
                closeModal('avatar-modal');
                
                recordSystem.addRecord(
                    'æ›´æ¢å¤´åƒ',
                    'è§‚æµ‹è€…æ›´æ¢äº†è§‚æµ‹å¯¹è±¡çš„å¤´åƒï¼Œåº”ç”¨äº†é€æ˜æ°”æ³¡æ•ˆæœã€‚',
                    ['è®¾ç½®', 'å¤´åƒ']
                );
                
                saveState();
            };
            tempImg.src = imgData;
        };
        reader.readAsDataURL(selectedAvatarFile);
    }

// === ä»»åŠ¡ç³»ç»Ÿè¾…åŠ©å‡½æ•° ===

// åˆå§‹åŒ–ä»»åŠ¡
function initializeTasks() {
    state.tasks = JSON.parse(JSON.stringify(taskList));
    
    // è®¾ç½®æ¯æ—¥ç™»å½•ä»»åŠ¡çš„åˆå§‹çŠ¶æ€
    const dailyLoginTask = state.tasks.find(t => t.id === 'daily_login');
    if (dailyLoginTask) {
        dailyLoginTask.progress = state.dailyLoginClaimed ? 1 : 0;
    }
    
    // è®¾ç½®äº’åŠ¨ä»»åŠ¡è¿›åº¦
    const playTask = state.tasks.find(t => t.id === 'play_with_zaizai');
    if (playTask) {
        playTask.progress = Math.min(playTask.maxProgress, state.interactionCount);
    }
    
    // è®¾ç½®ä¿¡ä»»ä»»åŠ¡è¿›åº¦
    const trustTask = state.tasks.find(t => t.id === 'increase_trust');
    if (trustTask) {
        trustTask.progress = Math.min(trustTask.maxProgress, Math.floor(state.trust));
    }
    
    console.log('ä»»åŠ¡åˆå§‹åŒ–å®Œæˆï¼Œå…±', state.tasks.length, 'ä¸ªä»»åŠ¡');
}

// ä¿®å¤ä»»åŠ¡æ•°æ®
function fixTasksData() {
    const currentTaskIds = state.tasks.map(t => t.id);
    const allTaskIds = taskList.map(t => t.id);
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç¼ºå¤±çš„ä»»åŠ¡
    const missingTaskIds = allTaskIds.filter(id => !currentTaskIds.includes(id));
    
    if (missingTaskIds.length > 0) {
        console.log('å‘ç°ç¼ºå¤±çš„ä»»åŠ¡:', missingTaskIds);
        
        // æ·»åŠ ç¼ºå¤±çš„ä»»åŠ¡
        missingTaskIds.forEach(missingId => {
            const template = taskList.find(t => t.id === missingId);
            if (template) {
                const newTask = JSON.parse(JSON.stringify(template));
                
                // è®¾ç½®åˆå§‹è¿›åº¦
                switch(missingId) {
                    case 'daily_login':
                        newTask.progress = state.dailyLoginClaimed ? 1 : 0;
                        break;
                    case 'play_with_zaizai':
                        newTask.progress = Math.min(newTask.maxProgress, state.interactionCount);
                        break;
                    case 'increase_trust':
                        newTask.progress = Math.min(newTask.maxProgress, Math.floor(state.trust));
                        break;
                    case 'complete_schedule':
                        newTask.progress = state.scheduleTaskClaimed ? 1 : 0;
                        break;
                    case 'buy_item':
                        newTask.progress = state.buyTaskClaimed ? 1 : 0;
                        break;
                    case 'read_diary':
                        newTask.progress = state.diaryTaskClaimed ? 1 : 0;
                        break;
                    case 'buy_furniture':
                        newTask.progress = state.furnitureTaskClaimed ? 1 : 0;
                        break;
                    case 'play_game':
                        newTask.progress = state.gameTaskClaimed ? 1 : 0;
                        break;
                }
                
                state.tasks.push(newTask);
                console.log('æ·»åŠ ä»»åŠ¡:', newTask.title);
            }
        });
        
        saveState();
    }
}

    // === é€šç”¨UIæ›´æ–° ===
    function updateUI() {
        document.getElementById('money-display').innerText = `ğŸ’° ${Math.floor(state.money)}`;
        document.getElementById('hunger-bar').style.width = `${state.hunger}%`;
        document.getElementById('trust-bar').style.width = `${state.trust}%`;
        document.getElementById('day-display').innerText = `Day ${state.day}`;
        
        if (state.trust >= 30) {
            document.getElementById('diary-book').style.display = 'block';
        }
    }

    function openModal(id) { 
        document.getElementById(id).style.display = 'flex'; 
        
        if (id === 'task-list-modal') {
            renderTaskList();
        }
        else if (id === 'shop-modal') {
            renderShop();
        }
        else if (id === 'room-shop-modal') {
            renderRoomShop();
        }
        else if (id === 'chat-modal') {
            renderChat();
            document.getElementById('chat-input').focus();
        }
        else if (id === 'memo-modal') {
            renderMemos();
            document.getElementById('memo-input').focus();
        }
        else if (id === 'record-modal') {
            renderRecords();
        }
        else if (id === 'bg-modal') {
            renderBackgroundSelector();
        }
        else if (id === 'pomodoro-modal') {
            const fullscreenImg = document.getElementById('fullscreen-img');
            if (state.customAvatar) {
                fullscreenImg.src = state.customAvatar;
            }
        }
    }
    
    function closeModal(id) { 
        document.getElementById(id).style.display = 'none'; 
        
        if (id === 'chat-modal') {
            document.getElementById('chat-input').blur();
        }
        else if (id === 'memo-modal') {
            document.getElementById('memo-input').blur();
        }
        else if (id === 'game2048-modal') {
            clearGame2048Touch();
        }
        else if (id === 'game-brickbreaker-modal') {
            stopPaddle();
        }
        else if (id === 'game-tetris-modal') {
            clearTetrisTouch();
        }
    }
    
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    }

</script>
</body>
</html>